/* (c) Mathigon, generated by Mathigon Studio */
(()=>{var sl=Object.defineProperty;var ld=Object.prototype.hasOwnProperty;var hd=Object.getOwnPropertyDescriptor,nl=Object.getOwnPropertySymbols,cd=Object.prototype.propertyIsEnumerable;var rl=(i,t,e)=>t in i?sl(i,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[t]=e,ne=(i,t)=>{for(var e in t||(t={}))ld.call(t,e)&&rl(i,e,t[e]);if(nl)for(var e of nl(t))cd.call(t,e)&&rl(i,e,t[e]);return i};var Ee=(i,t,e,s)=>{for(var n=s>1?void 0:s?hd(t,e):t,r=i.length-1,o;r>=0;r--)(o=i[r])&&(n=(s?o(t,e,n):o(n))||n);return s&&n&&sl(t,e,n),n};var O=(i,t,e)=>new Promise((s,n)=>{var r=l=>{try{a(e.next(l))}catch(h){n(h)}},o=l=>{try{a(e.throw(l))}catch(h){n(h)}},a=l=>l.done?s(l.value):Promise.resolve(l.value).then(r,o);a((e=e.apply(i,t)).next())});function Ae(i=10){return Math.random().toString(36).substr(2,i)}function J(i,...t){return t.includes(i)}var ud=(i,t)=>i.concat(t);function fr(i,t,e=ud){for(let s of Object.keys(t))s in i&&Array.isArray(i[s])&&Array.isArray(t[s])?i[s]=e(i[s],t[s]):s in i&&i[s]instanceof Object&&t[s]instanceof Object?fr(i[s],t[s]):i[s]=t[s]}function ts(i,t=0){return t?+setTimeout(i,t):(i(),0)}function Bs(i){return new Promise(t=>setTimeout(t,i))}function Fs(){let i=()=>{},t=()=>{},e=new Promise((s,n)=>{i=s,t=n});return e.catch(s=>s),{promise:e,resolve:i,reject:t}}var ol=class extends Error{constructor(i){super("[Cache Error]");this.data=i}};function qt(i){let t=new Map;return function(...e){let s=e.join("--");if(!t.has(s))try{t.set(s,i(...e))}catch(r){t.set(s,new ol(r))}let n=t.get(s);if(n instanceof ol)throw n.data;return n}}function Zs(i,t=0,e=!1){let s=!1,n=!1;return(...r)=>{s?n=!0:(e?n=!0:i(...r),s=!0,setTimeout(()=>{n&&i(...r),s=n=!1},t))}}function dd(i){return function(t,e){if(!t||Array.isArray(this)||i.includes(t))return e}}function Be(i,t,e){if(!i)return t;try{return JSON.parse(i,e?dd(e):void 0)||t}catch(s){return t}}function zt(i,t){return new Array(t).fill(i)}function al(i,t,e){let s=[];for(let n=0;n<t;++n)s.push(zt(i,e));return s}function D(i,t){let e=[];for(let s=0;s<t;++s)e.push(i(s));return e}function ll(i,t,e){let s=[];for(let n=0;n<t;++n){let r=[];for(let o=0;o<e;++o)r.push(i(n,o));s.push(r)}return s}function hl(i,t,e=1){let s=[];if(t===void 0&&i>=0)for(let n=0;n<i;n+=e)s.push(n);else if(t===void 0)for(let n=0;n>i;n-=e)s.push(n);else if(i<=t)for(let n=i;n<=t;n+=e)s.push(n);else for(let n=i;n>=t;n-=e)s.push(n);return s}function I(i,t=0){return i[i.length-1-t]}function N(i){return i.reduce((t,e)=>t+e,0)}function Us(i,t,e=!1){return i.slice(0).sort((s,n)=>{let r=t(s),o=t(n);return r<o?e?1:-1:r>o?e?-1:1:0})}function cl(i){let t=0;return()=>i[t++%i.length]}function Rt(i){return i.filter((t,e)=>i.indexOf(t)===e)}function Bt(i){return i.reduce((t,e)=>t.concat(Array.isArray(e)?Bt(e):e),[])}function js(i){let t=0;return i.map(e=>t+=e)}function $i(i,t){let e=[];for(let s=0;s<i.length;s+=t)e.push(i.slice(s,s+t));return e}function es(i,t=1){let e=i.length;t=(t%e+e)%e;let s=i.slice(0,t);return i.slice(t).concat(s)}function Ws(...i){return i.reduce((t,e)=>t.concat(e),[])}var ul=class{constructor(i){let t=i.length,e=i.map(s=>({val:s}));for(let[s,n]of e.entries())n.next=e[(s+1)%t],n.prev=e[(s-1+t)%t];this.root=e[0]}*traverse(){let i=this.root;for(;i;)if(yield i,i=i.next,i===this.root)return}get array(){return Array.from(this.traverse())}delete(i){if(i===this.root){if(i.next===i)return this.root=void 0;this.root=i.next}i.prev.next=i.next,i.next.prev=i.prev}};function ht(i,t=/\s+/){return i?i.trim().split(t):[]}function dl(i){return i.toLowerCase().replace(/^-/,"").replace(/-(.)/g,(t,e)=>e.toUpperCase())}var xi=class{constructor(){this.events=new Map}on(i,t){for(let e of ht(i))this.events.has(e)||this.events.set(e,[]),this.events.get(e).push(t)}one(i,t){let e=s=>{this.off(i,e),t(s)};this.on(i,e)}off(i,t){for(let e of ht(i))this.events.has(e)&&this.events.set(e,this.events.get(e).filter(s=>s!==t))}trigger(i,t){for(let e of ht(i))if(this.events.has(e))for(let s of this.events.get(e))s(t)}},pd=/^#?([a-f\d])([a-f\d])([a-f\d])$/i,fd=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})?$/i,md=/rgba?\(([0-9,]+), ?([0-9,]+), ?([0-9,]+)(, ?([0-9,]+))?\)/,gd=["#22ab24","#009ea6","#0f82f2","#6d3bbf","#cd0e66","#eb4726","#fd8c00"];function pl(i){return i.length===1?`0${i}`:i}function fl(i,t){if(t<=0)return V.from(i[0]);if(t>=1)return V.from(I(i));let e=Math.floor(t*(i.length-1)),s=t*(i.length-1)-e;return V.mix(i[e+1],i[e],s)}function mr(i,t,e){return e<0&&(e+=1),e>1&&(e-=1),e<1/6?i+(t-i)*6*e:e<1/2?t:e<2/3?i+(t-i)*(2/3-e)*6:i}var V=class{constructor(i,t,e,s=1){this.r=i,this.g=t,this.b=e,this.a=s}get hex(){let i=[this.r,this.g,this.b].map(e=>pl(Math.round(e).toString(16))),t=this.a>=1?"":pl(Math.round(this.a*255).toString(16));return`#${i.join("")}${t}`}get rgb(){return`rgba(${[this.r,this.g,this.b].map(t=>Math.round(t)).join(",")},${this.a})`}get brightness(){return(this.r*299+this.g*587+this.g*114)/1e3}get hsl(){let i=this.r/255,t=this.g/255,e=this.b/255,s=Math.max(i,t,e),n=Math.min(i,t,e),r=(n+s)/2,o=s-n;if(s===n)return[0,0,Math.round(r*100)];let a=i===s?(t-e)/o:t===s?2+(e-i)/o:4+(i-t)/o;a=Math.min(a*60,360),a<0&&(a+=360);let l=r<=.5?o/(s+n):o/(2-s-n);return[Math.round(a),Math.round(l*100),Math.round(r*100)]}get chroma(){return Math.max(this.r,this.g,this.b)-Math.min(this.r,this.g,this.b)}toString(){return this.rgb}copy(){return new V(this.r,this.g,this.b,this.a)}static from(i){return typeof i!="string"?i:i.startsWith("#")?V.fromHex(i):V.fromRgb(i)}static fromRgb(i){let t=i.match(md);if(!t)return new V(0,0,0);let e=t[4]?+t[5]||0:1;return new V(+t[1],+t[2],+t[3],e)}static fromHex(i){i=i.replace(pd,(e,s,n,r)=>s+s+n+n+r+r);let t=fd.exec(i);return t?new V(parseInt(t[1],16),parseInt(t[2],16),parseInt(t[3],16),t[4]?parseInt(t[4],16)/255:1):new V(0,0,0)}static fromHsl(i,t,e){if(i/=360,t/=100,e/=100,t===0){let l=Math.round(e*255);return new V(l,l,l)}let s=e<.5?e*(1+t):e+t-e*t,n=2*e-s,r=mr(n,s,i+1/3),o=mr(n,s,i),a=mr(n,s,i-1/3);return new V(Math.round(r*255),Math.round(o*255),Math.round(a*255))}static rainbow(i){return D(t=>fl(gd,t/(i-1)),i)}static gradient(i,t){return D(e=>fl(i,e/(t-1)),t)}static shades(i,t,e=.5){let s=V.mix("#fff",i,e),n=V.mix("#000",i,e);return V.gradient([s,i,n],t)}static mix(i,t,e=.5){return i=V.from(i),t=V.from(t),new V(e*i.r+(1-e)*t.r,e*i.g+(1-e)*t.g,e*i.b+(1-e)*t.b,e*i.a+(1-e)*t.a)}static mixMany(i,t){t||(t=i.map(()=>1));let e=N(t),s=i.map(w=>w.hsl),n=s.map(w=>w[0]),r=n.map(w=>w<180?w+360:w),o=t.map((w,x)=>w*Math.sqrt(i[x].chroma)),a=N(o),l=N(n.map((w,x)=>w*o[x]))/a,h=N(r.map((w,x)=>w*o[x]))/a,d=N(n.map((w,x)=>Math.abs(w-l)*o[x])),p=N(r.map((w,x)=>Math.abs(w-h)*o[x])),m=d<=p?l:h%360,g=N(s.map((w,x)=>t[x]*w[1]))/e,M=N(s.map((w,x)=>t[x]*w[2]))/e;return V.fromHsl(m,g,M)}};function Ks(i){return i[Symbol.iterator]().next().value}function ml(i,t){for(let e of i)if(!t(e))return!1;return!0}function Ve(i,t){for(let e of i)if(t(e))return!0;return!1}function*Ti(i,t){for(let e of i)for(let s of t(e))yield s}function*gr(i,t){for(let e of i)for(let s of t)yield[e,s]}function Fe(i,t,e=Infinity,s){let n,r=e;for(let o of i){let a=t(o);if(a<r&&(n=o,r=a,s!==void 0&&r<s))return n}return n}var Xs=class{constructor(...i){this.values=i}map(i){let t=this.values;return new Xs(function*(){let e=0;for(let s of t)for(let n of s)yield i(n,e),e+=1}())}every(i){let t=0;for(let e of this.values)for(let s of e){if(!i(s,t))return!1;t+=1}return!0}some(i){let t=0;for(let e of this.values)for(let s of e){if(i(s,t))return!0;t+=1}return!1}slice(i,t){let e=this.values;return new Xs(function*(){let s=0;for(let n of e)for(let r of n)s<i||t!==void 0&&s>i+t||(yield r,s+=1)}())}filter(i){let t=this.values;return new Xs(function*(){let e=0;for(let s of t)for(let n of s)i(n,e)&&(yield n),e+=1}())}concat(i){this.values.push(i)}[Symbol.iterator](){let i=this.values;return function*(){for(let t of i)for(let e of t)yield e}()}static make(i,t){return new Xs(function*(){let e=0;for(;t===void 0||e<t;)yield i(e),e+=1}())}};var gl=Object.defineProperty,wd=i=>gl(i,"__esModule",{value:!0}),wr=(i,t)=>{wd(i);for(var e in t)gl(i,e,{get:t[e],enumerable:!0})},wl=1e-6;function b(i,t,e=wl){return isNaN(i)||isNaN(t)?!1:Math.abs(i-t)<e}function W(i,t,e,s=wl){return t>e&&([t,e]=[e,t]),i>t+s&&i<e-s}var yl=/(\d+)(\d{3})/,yd=["","k","m","b","t","q"];function vd(i){let[t,e]=i.split(".");for(;yl.test(t);)t=t.replace(yl,"$1,$2");return t+(e?`.${e}`:"")}function bd(i,t=6){if(!t)return`${i}`;let e=`${Math.abs(Math.floor(i))}`.length,s=i<0?1:0;if(e<=t-s)return`${Ft(i,t-e-s-1)}`;let n=Math.floor(Math.log10(Math.abs(i))/3);return Ft(i/Math.pow(10,3*n),t-(e%3||3)-s-1)+yd[n]}function rt(i,t=0,e=!0){let s=bd(i,t).replace("-","\u2013");return e?vd(s):s}var $d=/^-?0,[0-9]+$/,xd=/^-?([0-9]+(,[0-9]{3})*)?\.?[0-9]*$/,Td=/^-?[0-9]+(\.[0-9]{3})*,?[0-9]*$/;function yr(i){return i=i.replace(/^–/,"-").trim(),!i||i.match(/[^0-9.,-]/)?NaN:$d.test(i)?parseFloat(i.replace(/,/,".")):xd.test(i)?parseFloat(i.replace(/,/g,"")):Td.test(i)?parseFloat(i.replace(/\./g,"").replace(/,/,".")):NaN}var vr=["","one","two","three","four","five","six","seven","eight","nine","ten","eleven","twelve","thirteen","fourteen","fifteen","sixteen","seventeen","eighteen","nineteen"],vl=["","","twenty","thirty","forty","fifty","sixty","seventy","eighty","ninety"],Sd=[""," thousand"," million"," billion"," trillion"," quadrillion"," quintillion"," sextillion"];function Md(i){let[t,e,s]=i.split(""),n=t==="0"?"":` ${vr[+t]} hundred`;return e+s==="00"?n:+e<2?`${n} ${vr[+(e+s)]}`:s==="0"?`${n} ${vl[+e]}`:`${n} ${vl[+e]}-${vr[+s]}`}function br(i){if(i===0)return"zero";let t=Math.round(Math.abs(i)).toString(),e=Math.ceil(t.length/3),s=t.padStart(3*e,"0"),n="";for(let r=0;r<e;r+=1){let o=s.substr(r*3,3);o!=="000"&&(n+=Md(o)+Sd[e-1-r])}return n.trim()}function Ft(i,t=0){let e=Math.pow(10,t);return Math.round(i*e)/e}function K(i,t=1){return Math.round(i/t)*t}function T(i,t=-Infinity,e=Infinity){return Math.min(e,Math.max(t,i))}function it(i,t,e=.5){return i+(t-i)*e}function Dt(i){return i*i}function ct(i,t){return(i%t+t)%t}function $r(i,t,e){if(b(i,0)&&b(t,0))return[];if(b(i,0))return[-e/t];let s=-t/2/i,n=Math.sqrt(t*t-4*i*e)/2/i;return[s+n,s-n]}function $l(i,t=0){let e=i.slice(0),s=bl(e);return t?s.filter(n=>n.length===t):s}function bl(i){if(i.length===1)return[[],i];let t=i.pop(),e=bl(i),s=[];for(let n of e)s.push(n,[...n,t]);return s}function Ze(...i){let[t,...e]=i;if(e.length>1)return Ze(t,Ze(...e));let s=Math.abs(t),n=Math.abs(e[0]);for(;n;)[s,n]=[n,s%n];return s}function Ue(...i){let[t,...e]=i;return e.length>1?Ue(t,Ue(...e)):Math.abs(t*e[0])/Ze(t,e[0])}function xr(i){if(i%1!=0||i<2)return!1;if(i%2==0)return i===2;if(i%3==0)return i===3;let t=Math.sqrt(i);for(let e=5;e<=t;e+=6)if(i%e==0||i%(e+2)==0)return!1;return!0}function we(i){if(i===1)return[];if(xr(i))return[i];let t=Math.sqrt(i);for(let e=2;e<=t;++e)if(i%e==0)return we(e).concat(we(i/e));return[]}var ot={};wr(ot,{determinant:()=>Vd,fill:()=>xl,identity:()=>Tl,inverse:()=>Pl,product:()=>Ys,reflection:()=>Ed,rotation:()=>Pd,scalarProduct:()=>Ad,shear:()=>Cd,sum:()=>Sl,transpose:()=>Ml});function xl(i,t,e){return al(i,t,e)}function Tl(i=2){let t=xl(0,i,i);for(let e=0;e<i;++e)t[e][e]=1;return t}function Pd(i){let t=Math.sin(i),e=Math.cos(i);return[[e,-t],[t,e]]}function Cd(i){return[[1,i],[0,1]]}function Ed(i){let t=Math.sin(2*i),e=Math.cos(2*i);return[[e,t],[t,-e]]}function Sl(...i){let[t,...e]=i,s=e.length>1?Sl(...e):e[0];if(t.length!==s.length||t[0].length!==s[0].length)throw new Error("Matrix sizes don\u2019t match");let n=[];for(let r=0;r<t.length;++r){let o=[];for(let a=0;a<t[r].length;++a)o.push(t[r][a]+s[r][a]);n.push(o)}return n}function Ad(i,t){return i.map(e=>e.map(s=>s*t))}function Ys(...i){let[t,...e]=i,s=e.length>1?Ys(...e):e[0];if(t[0].length!==s.length)throw new Error("Matrix sizes don\u2019t match.");let n=[];for(let r=0;r<t.length;++r){let o=[];for(let a=0;a<s[0].length;++a){let l=0;for(let h=0;h<s.length;++h)l+=t[r][h]*s[h][a];o.push(l)}n.push(o)}return n}function Ml(i){let t=[];for(let e=0;e<i[0].length;++e){let s=[];for(let n=0;n<i.length;++n)s.push(i[n][e]);t.push(s)}return t}function Vd(i){if(i.length!==i[0].length)throw new Error("Not a square matrix.");let t=i.length;if(t===1)return i[0][0];if(t===2)return i[0][0]*i[1][1]-i[0][1]*i[1][0];let e=0;for(let s=0;s<t;++s){let n=i[0][s],r=i[0][s];for(let o=1;o<t;++o)r*=i[o][s+o%t],n*=i[o][s-o%t];e+=r-n}return e}function Pl(i){let t=i.length;if(t!==i[0].length)throw new Error("Not a square matrix.");let e=Tl(t),s=ll((n,r)=>i[n][r],t,t);for(let n=0;n<t;++n){let r=s[n][n];if(!r){for(let o=n+1;o<t;++o)if(s[o][n]!==0){for(let a=0;a<t;++a)[s[o][a],s[n][a]]=[s[n][a],s[o][a]],[e[o][a],e[n][a]]=[e[n][a],e[o][a]];break}if(r=s[n][n],!r)throw new Error("Matrix not invertible.")}for(let o=0;o<t;++o)s[n][o]=s[n][o]/r,e[n][o]=e[n][o]/r;for(let o=0;o<t;++o){if(o===n)continue;let a=s[o][n];for(let l=0;l<t;++l)s[o][l]-=a*s[n][l],e[o][l]-=a*e[n][l]}}return e}var Tt={};wr(Tt,{bernoulli:()=>El,binomial:()=>Rd,cauchy:()=>qd,chiCDF:()=>Bd,exponential:()=>Gd,find:()=>Ld,geometric:()=>Hd,integer:()=>Od,integrate:()=>Al,normal:()=>_d,normalPDF:()=>zd,poisson:()=>Dd,shuffle:()=>kd,smart:()=>Id,uniform:()=>Nd,weighted:()=>Cl});function kd(i){i=i.slice(0);for(let t=i.length-1;t>0;--t){let e=Math.floor(Math.random()*(t+1));[i[t],i[e]]=[i[e],i[t]]}return i}function Od(i,t){let e=t===void 0?0:i,s=t===void 0?i:t-i+1;return e+Math.floor(s*Math.random())}function Cl(i){let t=Math.random()*N(i),e=0;return i.findIndex(s=>(e+=s)>=t)}function Ld(i){return i[Math.floor(i.length*Math.random())]}var Js=new Map;function Id(i,t){t||(t=Ae()),Js.has(t)||Js.set(t,zt(1,i));let e=Js.get(t),s=Cl(e.map(n=>n*n));return e[s]-=1,e[s]<=0&&Js.set(t,e.map(n=>n+1)),s}function El(i=.5){return Math.random()<i?1:0}function Rd(i=1,t=.5){let e=0;for(let s=0;s<i;++s)e+=El(t);return e}function Dd(i=1){if(i<=0)return 0;let t=Math.exp(-i),e=1,s=0;for(;e>t;++s)e*=Math.random();return s-1}function Nd(i=0,t=1){return i+(t-i)*Math.random()}function _d(i=0,t=1){let e=Math.random(),s=Math.random();return Math.sqrt(-2*Math.log(e))*Math.cos(2*Math.PI*s)*Math.sqrt(t)+i}function Gd(i=1){return i<=0?0:-Math.log(Math.random())/i}function Hd(i=.5){if(!(i<=0||i>1))return Math.floor(Math.log(Math.random())/Math.log(1-i))}function qd(){let i,t,e;do t=2*Math.random()-1,e=2*Math.random()-1,i=t*t+e*e;while(i>=1);return t/e}function zd(i,t=1,e=0){return Math.exp(-((i-t)**2)/(2*e))/Math.sqrt(2*Math.PI*e)}var Vl=7,kl=[.9999999999998099,676.5203681218851,-1259.1392167224028,771.3234287776531,-176.6150291621406,12.507343278686905,-.13857109526572012,9984369578019572e-21,15056327351493116e-23];function Ol(i){if(i<.5)return Math.PI/(Math.sin(Math.PI*i)*Ol(1-i));i-=1;let t=kl[0];for(let s=1;s<Vl+2;s++)t+=kl[s]/(i+s);let e=i+Vl+.5;return Math.sqrt(2*Math.PI)*Math.pow(e,i+.5)*Math.exp(-e)*t}function Al(i,t,e,s=1){let n=0;for(let r=t;r<e;r+=s)n+=i(r)*s||0;return n}function Bd(i,t){let e=Al(s=>Math.pow(s,(t-2)/2)*Math.exp(-s/2),0,i);return 1-e/Math.pow(2,t/2)/Ol(t/2)}var Fd={};wr(Fd,{bestPolynomial:()=>Kd,coefficient:()=>Il,exponential:()=>Ud,linear:()=>Zd,logarithmic:()=>jd,polynomial:()=>Ll,power:()=>Wd});function Xd(i,t){let e=1,s=i[0];for(let n=1;n<i.length;++n)e*=t,s+=e*i[n];return s}function Zd(i,t=!1){let e=0,s=0,n=0,r=0,o=i.length;for(let h=0;h<o;h++)e+=i[h][0],s+=i[h][1],n+=i[h][0]*i[h][0],r+=i[h][0]*i[h][1];if(t){let h=r/n;return[0,h]}let a=(o*r-e*s)/(o*n-e*e);return[s/o-a*e/o,a]}function Ud(i){let t=[0,0,0,0,0,0];for(let r of i)t[0]+=r[0],t[1]+=r[1],t[2]+=r[0]*r[0]*r[1],t[3]+=r[1]*Math.log(r[1]),t[4]+=r[0]*r[1]*Math.log(r[1]),t[5]+=r[0]*r[1];let e=t[1]*t[2]-t[5]*t[5],s=Math.exp((t[2]*t[3]-t[5]*t[4])/e),n=(t[1]*t[4]-t[5]*t[3])/e;return[s,n]}function jd(i){let t=[0,0,0,0],e=i.length;for(let r of i)t[0]+=Math.log(r[0]),t[1]+=r[1]*Math.log(r[0]),t[2]+=r[1],t[3]+=Math.pow(Math.log(r[0]),2);let s=(e*t[1]-t[2]*t[0])/(e*t[3]-t[0]*t[0]);return[(t[2]-s*t[0])/e,s]}function Wd(i){let t=[0,0,0,0],e=i.length;for(let r of i)t[0]+=Math.log(r[0]),t[1]+=Math.log(r[1])*Math.log(r[0]),t[2]+=Math.log(r[1]),t[3]+=Math.pow(Math.log(r[0]),2);let s=(e*t[1]-t[2]*t[0])/(e*t[3]-t[0]*t[0]);return[Math.exp((t[2]-s*t[0])/e),s]}function Ll(i,t=2){let e=i.map(l=>hl(t+1).map(h=>Math.pow(l[0],h))),s=Ml(e),n=i.map(l=>[l[1]]),r=Ys(s,e),o=Pl(r);return Ys(o,s,n).map(l=>l[0])}function Il(i,t){let s=i.reduce((o,a)=>o+a[1],0)/i.length,n=i.reduce((o,a)=>o+(a[1]-s)**2,0),r=i.reduce((o,a)=>o+(a[1]-t(a[0]))**2,0);return 1-r/n}function Kd(i,t=.85,e=8){if(!(i.length<=1))for(let s=1;s<e;++s){let n=Ll(i,s),r=a=>Xd(n,a);if(Il(i,r)>=t)return{order:s,coefficients:n,fn:r}}}function Si(i){return i.length?N(i)/i.length:0}function Mi(i,t){let e=i.length;if(!e)return 0;let s=i.slice(0).sort((r,o)=>r-o);if(t===1)return s[e-1];let n=e*t;return Number.isInteger(n)?(s[n-1]+s[n])/2:s[Math.floor(n)]}var Zt=2*Math.PI;function je(i,t){let e=Math.atan2(i.y-(t?t.y:0),i.x-(t?t.x:0));return ct(e,Zt)}var u=class{constructor(i=0,t=0){this.x=i,this.y=t,this.type="point"}get unitVector(){return b(this.length,0)?new u(1,0):this.scale(1/this.length)}get length(){return Math.sqrt(this.x**2+this.y**2)}get inverse(){return new u(-this.x,-this.y)}get flip(){return new u(this.y,this.x)}get perpendicular(){return new u(-this.y,this.x)}get array(){return[this.x,this.y]}distanceFromLine(i){return u.distance(this,i.project(this))}clamp(i,t=0){let e=T(this.x,i.xMin+t,i.xMax-t),s=T(this.y,i.yMin+t,i.yMax-t);return new u(e,s)}changeCoordinates(i,t){let e=t.xMin+(this.x-i.xMin)/i.dx*t.dx,s=t.yMin+(this.y-i.yMin)/i.dy*t.dy;return new u(e,s)}add(i){return u.sum(this,i)}subtract(i){return u.difference(this,i)}round(i=1){return new u(K(this.x,i),K(this.y,i))}floor(){return new u(Math.floor(this.x),Math.floor(this.y))}mod(i,t=i){return new u(this.x%i,this.y%t)}angle(i=y){return je(this,i)}snap(i,t=5){return b(this.x,i.x,t)?new u(i.x,this.y):b(this.y,i.y,t)?new u(this.x,i.y):this}static average(...i){let t=N(i.map(s=>s.x))/i.length,e=N(i.map(s=>s.y))/i.length;return new u(t,e)}static dot(i,t){return i.x*t.x+i.y*t.y}static sum(i,t){return new u(i.x+t.x,i.y+t.y)}static difference(i,t){return new u(i.x-t.x,i.y-t.y)}static distance(i,t){return Math.sqrt(Dt(i.x-t.x)+Dt(i.y-t.y))}static manhattan(i,t){return Math.abs(i.x-t.x)+Math.abs(i.y-t.y)}static interpolate(i,t,e=.5){return new u(it(i.x,t.x,e),it(i.y,t.y,e))}static interpolateList(i,t=.5){let e=i.length-1,s=Math.floor(T(t,0,1)*e);return u.interpolate(i[s],i[s+1],e*t-s)}static fromPolar(i,t=1){return new u(t*Math.cos(i),t*Math.sin(i))}static random(i){let t=Tt.uniform(i.xMin,i.xMax),e=Tt.uniform(i.yMin,i.yMax);return new u(t,e)}static equals(i,t,e){return b(i.x,t.x,e)&&b(i.y,t.y,e)}static colinear(i,t,e,s){let n=i.x-t.x,r=i.y-t.y,o=t.x-e.x,a=t.y-e.y;return b(n*a,o*r,s)}transform(i){let t=i[0][0]*this.x+i[0][1]*this.y+i[0][2],e=i[1][0]*this.x+i[1][1]*this.y+i[1][2];return new u(t,e)}rotate(i,t=y){if(b(i,0))return this;let e=this.x-t.x,s=this.y-t.y,n=Math.cos(i),r=Math.sin(i),o=e*n-s*r+t.x,a=e*r+s*n+t.y;return new u(o,a)}reflect(i){let t=i.p2.x-i.p1.x,e=i.p2.y-i.p1.y,s=this.x-i.p1.x,n=this.y-i.p1.y,r=(t*n-e*s)/(t*t+e*e),o=this.x+2*r*e,a=this.y-2*r*t;return new u(o,a)}scale(i,t=i){return new u(this.x*i,this.y*t)}shift(i,t=i){return new u(this.x+i,this.y+t)}translate(i){return this.shift(i.x,i.y)}equals(i,t){return u.equals(this,i,t)}toString(){return`Point(x: ${this.x}, y: ${this.y})`}},y=new u(0,0),We=class{constructor(i,t,e){this.c=i,this.start=t,this.angle=e,this.type="arc"}get radius(){return u.distance(this.c,this.start)}get end(){return this.start.rotate(this.angle,this.c)}get startAngle(){return je(this.start,this.c)}contract(i){return new this.constructor(this.c,this.at(i/2),this.angle*(1-i))}get minor(){return this.angle<=Math.PI?this:new this.constructor(this.c,this.end,Zt-this.angle)}get major(){return this.angle>=Math.PI?this:new this.constructor(this.c,this.end,Zt-this.angle)}get center(){return this.at(.5)}project(i){let t=this.startAngle,e=t+this.angle,s=je(i,this.c);return e>Zt&&s<e-Zt&&(s+=Zt),s=T(s,t,e),this.c.shift(this.radius,0).rotate(s,this.c)}at(i){return this.start.rotate(this.angle*i,this.c)}contains(i){return i.equals(this.project(i))}transform(i){return new this.constructor(this.c.transform(i),this.start.transform(i),this.angle)}rotate(i,t=y){return b(i,0)?this:new this.constructor(this.c.rotate(i,t),this.start.rotate(i,t),this.angle)}reflect(i){return new this.constructor(this.c.reflect(i),this.start.reflect(i),this.angle)}scale(i,t=i){return new this.constructor(this.c.scale(i,t),this.start.scale(i,t),this.angle)}shift(i,t=i){return new this.constructor(this.c.shift(i,t),this.start.shift(i,t),this.angle)}translate(i){return this.shift(i.x,i.y)}equals(){return!1}},Ke=class extends We{constructor(){super(...arguments);this.type="sector"}contains(i){return u.distance(i,this.c)<=this.radius&&new St(this.start,this.c,i).rad<=this.angle}},pt=class{constructor(i,t){this.p1=i,this.p2=t,this.type="line"}make(i,t){return new pt(i,t)}get length(){return u.distance(this.p1,this.p2)}get lengthSquared(){return(this.p1.x-this.p2.x)**2+(this.p1.y-this.p2.y)**2}get midpoint(){return u.average(this.p1,this.p2)}get slope(){return(this.p2.y-this.p1.y)/(this.p2.x-this.p1.x)}get intercept(){return this.p1.y+this.slope*this.p1.x}get angle(){return je(this.p2,this.p1)}get unitVector(){return this.p2.subtract(this.p1).unitVector}get perpendicularVector(){return new u(this.p2.y-this.p1.y,this.p1.x-this.p2.x).unitVector}parallel(i){let t=u.sum(i,u.difference(this.p2,this.p1));return new pt(i,t)}perpendicular(i){return new pt(i,u.sum(i,this.perpendicularVector))}get perpendicularBisector(){return this.perpendicular(this.midpoint)}distanceSquared(i){let t=this.project(i);return(i.x-t.x)**2+(i.y-t.y)**2}offset(i){let t=u.difference(this.p2,this.p1),e=u.difference(i,this.p1);return u.dot(t,e)/this.lengthSquared}project(i){return this.at(this.offset(i))}side(i,t){let e=u.difference(this.p2,this.p1),s=u.difference(i,this.p1),n=s.x*e.y-s.y*e.x;return b(n,0,t)?0:Math.sign(n)}contains(i,t){return this.side(i,t)===0}at(i){return u.interpolate(this.p1,this.p2,i)}transform(i){return new this.constructor(this.p1.transform(i),this.p2.transform(i))}rotate(i,t=y){return b(i,0)?this:new this.constructor(this.p1.rotate(i,t),this.p2.rotate(i,t))}reflect(i){return new this.constructor(this.p1.reflect(i),this.p2.reflect(i))}scale(i,t=i){return this.make(this.p1.scale(i,t),this.p2.scale(i,t))}shift(i,t=i){return this.make(this.p1.shift(i,t),this.p2.shift(i,t))}translate(i){return this.shift(i.x,i.y)}equals(i,t){return this.contains(i.p1,t)&&this.contains(i.p2,t)}toString(){return`Line(p1: ${this.p1}, p2: ${this.p2})`}};var j=class extends pt{constructor(){super(...arguments);this.type="segment"}contains(i,t){return pt.prototype.contains.call(this,i,t)?this.p1.equals(i,t)||this.p2.equals(i,t)?!0:b(this.p1.x,this.p2.x,t)?W(i.y,this.p1.y,this.p2.y):W(i.x,this.p1.x,this.p2.x):!1}make(i,t){return new j(i,t)}project(i){let t=u.difference(this.p2,this.p1),e=u.difference(i,this.p1),s=T(u.dot(t,e)/this.lengthSquared,0,1);return u.sum(this.p1,t.scale(s))}contract(i){return new j(this.at(i),this.at(1-i))}equals(i,t,e=!1){return i.type!=="segment"?!1:this.p1.equals(i.p1,t)&&this.p2.equals(i.p2,t)||!e&&this.p1.equals(i.p2,t)&&this.p2.equals(i.p1,t)}toString(){return`Segment(p1: ${this.p1}, p2: ${this.p2})`}},qg=180/Math.PI,Yd=Math.PI/180;function Tr(i){return i*Yd}var St=class{constructor(i,t,e){this.a=i,this.b=t,this.c=e,this.type="angle"}static fromDegrees(i){return St.fromRadians(i*(Math.PI/180))}static fromRadians(i){let t=new u(1,0),e=t.rotate(i);return new St(t,y,e)}get rad(){let i=Math.atan2(this.a.y-this.b.y,this.a.x-this.b.x),e=Math.atan2(this.c.y-this.b.y,this.c.x-this.b.x)-i;return e<0&&(e+=Zt),e}get deg(){return this.rad*180/Math.PI}get isRight(){return b(this.rad,Math.PI/2,Math.PI/360)}get bisector(){if(this.b.equals(this.a)||this.b.equals(this.c))return;let i=Math.atan2(this.a.y-this.b.y,this.a.x-this.b.x),t=Math.atan2(this.c.y-this.b.y,this.c.x-this.b.x),e=(i+t)/2;i>t&&(e+=Math.PI);let s=Math.cos(e)+this.b.x,n=Math.sin(e)+this.b.y;return new pt(this.b,new u(s,n))}get sup(){return this.rad<Math.PI?this:new St(this.c,this.b,this.a)}get arc(){return new We(this.b,this.a,this.rad)}project(){return this.c}at(){return this.c}contains(){return!1}transform(i){return new St(this.a.transform(i),this.b.transform(i),this.c.transform(i))}rotate(i,t){return b(i,0)?this:new St(this.a.rotate(i,t),this.b.rotate(i,t),this.c.rotate(i,t))}reflect(i){return new St(this.a.reflect(i),this.b.reflect(i),this.c.reflect(i))}scale(i,t=i){return new St(this.a.scale(i,t),this.b.scale(i,t),this.c.scale(i,t))}shift(i,t=i){return new St(this.a.shift(i,t),this.b.shift(i,t),this.c.shift(i,t))}translate(i){return new St(this.a.translate(i),this.b.translate(i),this.c.translate(i))}equals(i){return!1}},Xe=1e-6;function Sr(i,t,e){let s=(e.x-t.x)*(i.y-t.y),n=(e.y-t.y)*(i.x-t.x);return s-n>=-Xe}function Rl(i,t,e){let s=i.y-t.y,n=e.x-t.x,r=i.x-t.x,o=e.y-t.y,a=r*n+s*o;if(a<Xe)return!1;let l=n*n+o*o;return a-l<=-Xe}function Dl(i,t){return b(i.x,t.x)?b(i.y,t.y)?0:i.y<t.y?-1:1:i.x<t.x?-1:1}function Nl(i){return i<=-Xe?-2:i<Xe?-1:i-1<=-Xe?0:i-1<Xe?1:2}function Jd(i,t,e,s){let n=t.x-i.x,r=t.y-i.y,o=s.x-e.x,a=s.y-e.y,l=n*a-r*o;if(b(l,0))return!1;let h=i.x-e.x,d=i.y-e.y,p=(o*d-a*h)/l,m=(n*d-r*h)/l,g=new u(i.x+p*n,i.y+p*r);return{alongA:Nl(p),alongB:Nl(m),pt:g}}var Pi=class{constructor(){this.root={root:!0,next:void 0}}exists(i){return i!==void 0&&i!==this.root}get head(){return this.root.next}insertBefore(i,t){let e=this.root,s=this.root.next;for(;s;){if(t(s)){i.prev=s.prev,i.next=s,s.prev.next=i,s.prev=i;return}e=s,s=s.next}e.next=i,i.prev=e,i.next=void 0}findTransition(i){let t=this.root,e=this.root.next;for(;e&&!i(e);)t=e,e=e.next;return{before:t===this.root?void 0:t,after:e,insert:s=>(s.prev=t,s.next=e,t.next=s,e&&(e.prev=s),s)}}static node(i){let t=i;return t.remove=()=>{t.prev&&(t.prev.next=t.next),t.next&&(t.next.prev=t.prev),t.prev=t.next=void 0},t}};function Mr(i,t,e){let s={above:e.myFill.above,below:e.myFill.below};return{start:i,end:t,myFill:s}}function Qd(i,t,e,s,n,r){let o=Dl(t,n);return o!==0?o:u.equals(e,r)?0:i!==s?i?1:-1:Sr(e,s?n:r,s?r:n)?1:-1}function Pr(i,t,e){i.insertBefore(t,s=>Qd(!!t.isStart,t.pt,e,!!s.isStart,s.pt,s.other.pt)<0)}function tp(i,t,e){let s=Pi.node({isStart:!0,pt:t.start,seg:t,primary:e});return Pr(i,s,t.end),s}function ep(i,t,e,s){let n=Pi.node({pt:e.end,seg:e,primary:s,other:t});t.other=n,Pr(i,n,t.pt)}function Qs(i,t,e){let s=tp(i,t,e);return ep(i,s,t,e),s}function ip(i,t,e){t.other.remove(),t.seg.end=e,t.other.pt=e,Pr(i,t.other,t.pt)}function Yt(i,t,e){let s=Mr(e,t.seg.end,t.seg);return ip(i,t,e),Qs(i,s,!!t.primary)}function sp(i,t){let e=i.seg.start,s=i.seg.end,n=t.seg.start,r=t.seg.end;return u.colinear(e,n,r)?u.colinear(s,n,r)||Sr(s,n,r)?1:-1:Sr(e,n,r)?1:-1}function Cr(i,t,e){let s=t.seg,n=e.seg,r=s.start,o=s.end,a=n.start,l=n.end,h=Jd(r,o,a,l);if(h===!1){if(!u.colinear(r,o,a)||u.equals(r,l)||u.equals(o,a))return!1;let d=u.equals(r,a),p=u.equals(o,l);if(d&&p)return e;let m=!d&&Rl(r,a,l),g=!p&&Rl(o,a,l);if(d)return g?Yt(i,e,o):Yt(i,t,l),e;m&&(p||(g?Yt(i,e,o):Yt(i,t,l)),Yt(i,e,r))}else h.alongA===0&&(h.alongB===-1?Yt(i,t,a):h.alongB===0?Yt(i,t,h.pt):h.alongB===1&&Yt(i,t,l)),h.alongB===0&&(h.alongA===-1?Yt(i,e,r):h.alongA===0?Yt(i,e,h.pt):h.alongA===1&&Yt(i,e,o));return!1}function _l(i,t){var e,s;let n=new Pi,r=[];for(;i.head;){let o=i.head;if(o.isStart){let a=function(){if(h){let m=Cr(i,o,h);if(m)return m}return d?Cr(i,o,d):!1},l=n.findTransition(m=>sp(o,m.ev)>0),h=(e=l.before)==null?void 0:e.ev,d=(s=l.after)==null?void 0:s.ev,p=a();if(p&&(t?(o.seg.myFill.below?o.seg.myFill.above!==o.seg.myFill.below:!0)&&(p.seg.myFill.above=!p.seg.myFill.above):p.seg.otherFill=o.seg.myFill,o.other.remove(),o.remove()),i.head!==o)continue;if(t){let m=o.seg.myFill.below?o.seg.myFill.above!==o.seg.myFill.below:!0;o.seg.myFill.below=d?d.seg.myFill.above:!1,o.seg.myFill.above=m?!o.seg.myFill.below:o.seg.myFill.below}else if(o.seg.otherFill===void 0){let m=d?o.primary===d.primary?d.seg.otherFill.above:d.seg.myFill.above:!1;o.seg.otherFill={above:m,below:m}}o.other.status=l.insert(Pi.node({ev:o}))}else{let a=o.status;if(a===void 0)throw new Error("[Euclid.js] Zero-length segment detected!");if(n.exists(a.prev)&&n.exists(a.next)&&Cr(i,a.prev.ev,a.next.ev),a.remove(),!o.primary){let l=o.seg.myFill;o.seg.myFill=o.seg.otherFill,o.seg.otherFill=l}r.push(o.seg)}i.head.remove()}return r}function np(i){let t=[],e=[];return i.forEach(s=>{let n=s.start,r=s.end;if(u.equals(n,r))return;let o={index:0,matchesHead:!1,matchesPt1:!1},a={index:0,matchesHead:!1,matchesPt1:!1},l=o;function h(w,x,k){l.index=w,l.matchesHead=x,l.matchesPt1=k;let v=l===o;return l=v?a:void 0,!v}for(let w=0;w<t.length;w++){let x=t[w],k=x[0],v=I(x);if(u.equals(k,n)){if(h(w,!0,!0))break}else if(u.equals(k,r)){if(h(w,!0,!1))break}else if(u.equals(v,n)){if(h(w,!1,!0))break}else if(u.equals(v,r)&&h(w,!1,!1))break}if(l===o){t.push([n,r]);return}if(l===a){let w=o.index,x=o.matchesPt1?r:n,k=o.matchesHead,v=t[w],C=k?v[0]:v[v.length-1],dt=k?v[1]:v[v.length-2],ze=k?v[v.length-1]:v[0],bi=k?v[v.length-2]:v[1];if(u.colinear(dt,C,x)&&(k?v.shift():v.pop(),C=dt),u.equals(ze,x)){t.splice(w,1),u.colinear(bi,ze,C)&&(k?v.pop():v.shift()),e.push(v);return}k?v.unshift(x):v.push(x);return}function d(w){t[w].reverse()}function p(w,x){let k=t[w],v=t[x],C=k[k.length-1],dt=k[k.length-2],ze=v[0],bi=v[1];u.colinear(dt,C,ze)&&(k.pop(),C=dt),u.colinear(C,ze,bi)&&v.shift(),t[w]=k.concat(v),t.splice(x,1)}let m=o.index,g=a.index,M=t[m].length<t[g].length;o.matchesHead?a.matchesHead?M?(d(m),p(m,g)):(d(g),p(g,m)):p(g,m):a.matchesHead?p(m,g):M?(d(m),p(g,m)):(d(g),p(m,g))}),e}function rp(i,t){let e=[];for(let s of i){let n=(s.myFill.above?8:0)+(s.myFill.below?4:0)+(s.otherFill&&s.otherFill.above?2:0)+(s.otherFill&&s.otherFill.below?1:0);t[n]!==0&&e.push({start:s.start,end:s.end,myFill:{above:t[n]===1,below:t[n]===2}})}return e}function Gl(i){let t=new Pi;for(let e of i)for(let s=0;s<e.length;s++){let n=s?e[s-1]:I(e),r=e[s],o=Dl(n,r);if(o===0)continue;let a=o<0?n:r,l=o<0?r:n;Qs(t,{start:a,end:l,myFill:{}},!0)}return _l(t,!0)}function Er(i,t,e){let s=new Pi;for(let r of Gl(i))Qs(s,Mr(r.start,r.end,r),!0);for(let r of Gl(t))Qs(s,Mr(r.start,r.end,r),!1);let n=rp(_l(s,!1),e);return np(n)}var op=[0,2,1,0,2,2,0,0,1,0,1,0,0,0,0,0],ap=[0,0,0,0,0,2,0,2,0,0,1,1,0,2,1,0],lp=[0,0,0,0,2,0,2,0,1,1,0,0,0,1,2,0],hp=(i,t)=>Er(i,t,op),cp=(i,t)=>Er(i,t,ap),up=(i,t)=>Er(i,t,lp),_=class{constructor(i=y,t=1){this.c=i,this.r=t,this.type="circle"}get circumference(){return Zt*this.r}get area(){return Math.PI*this.r**2}get arc(){let i=this.c.shift(this.r,0);return new We(this.c,i,Zt)}tangentAt(i){let t=this.at(i),e=this.c.rotate(Math.PI/2,t);return new pt(t,e)}collision(i){let t=this.c.x<i.p.x?i.p.x:this.c.x>i.p.x+i.w?i.p.x+i.w:this.c.x,e=this.c.y<i.p.y?i.p.y:this.c.y>i.p.y+i.h?i.p.y+i.h:this.c.y;return u.distance(this.c,new u(t,e))<=this.r}project(i){let t=i.subtract(this.c).unitVector.scale(this.r);return u.sum(this.c,t)}at(i){let t=Zt*i;return this.c.shift(this.r*Math.cos(t),this.r*Math.sin(t))}contains(i){return u.distance(i,this.c)<=this.r}transform(i){let t=Math.abs(i[0][0])+Math.abs(i[1][1]);return new _(this.c.transform(i),this.r*t/2)}rotate(i,t=y){return b(i,0)?this:new _(this.c.rotate(i,t),this.r)}reflect(i){return new _(this.c.reflect(i),this.r)}scale(i,t=i){return new _(this.c.scale(i,t),this.r*(i+t)/2)}shift(i,t=i){return new _(this.c.shift(i,t),this.r)}translate(i){return this.shift(i.x,i.y)}equals(i,t){return b(this.r,i.r,t)&&this.c.equals(i.c,t)}toString(){return`Circle(c: ${this.c}, r: ${this.r})`}};function re(i){return["polygon","polyline","rectangle","triangle"].includes(i.type)}function tn(i){return["polygon","triangle"].includes(i.type)}function en(i){return i.type==="polyline"}function Ar(i){return i.type==="rectangle"}function At(i){return["line","ray","segment"].includes(i.type)}function Vr(i){return i.type==="line"}function dp(i){return i.type==="ray"}function Ci(i){return i.type==="segment"}function st(i){return i.type==="circle"}function Ei(i){return i.type==="arc"}function ye(i){return i.type==="sector"}function pp(i){return i.type==="angle"}function gt(i){return i.type==="point"}function fp(i,t){return b(i.p1.x,i.p2.x)?W(t.y,i.p1.y,i.p2.y):W(t.x,i.p1.x,i.p2.x)}function mp(i,t){return b(i.p1.x,i.p2.x)?(t.y-i.p1.y)/(i.p2.y-i.p1.y)>0:(t.x-i.p1.x)/(i.p2.x-i.p1.x)>0}function gp(i,t){let e=i.p1.x-i.p2.x,s=i.p1.y-i.p2.y,n=t.p1.x-t.p2.x,r=t.p1.y-t.p2.y,o=e*r-s*n;if(b(o,0))return[];let a=i.p1.x*i.p2.y-i.p1.y*i.p2.x,l=t.p1.x*t.p2.y-t.p1.y*t.p2.x,h=a*n-e*l,d=a*r-s*l;return[new u(h/o,d/o)]}function wp(i,t){let e=u.distance(i.c,t.c);if(e>i.r+t.r)return[];if(e<Math.abs(i.r-t.r))return[];if(b(e,0)&&b(i.r,t.r))return[];if(b(e,i.r+t.r))return[new pt(i.c,t.c).midpoint];let s=(Dt(i.r)-Dt(t.r)+Dt(e))/(2*e),n=Math.sqrt(Dt(i.r)-Dt(s)),r=(t.c.x-i.c.x)*s/e+(t.c.y-i.c.y)*n/e+i.c.x,o=(t.c.y-i.c.y)*s/e-(t.c.x-i.c.x)*n/e+i.c.y,a=(t.c.x-i.c.x)*s/e-(t.c.y-i.c.y)*n/e+i.c.x,l=(t.c.y-i.c.y)*s/e+(t.c.x-i.c.x)*n/e+i.c.y;return[new u(r,o),new u(a,l)]}function Hl(i,t){let e=i.p2.x-i.p1.x,s=i.p2.y-i.p1.y,n=Dt(e)+Dt(s),r=t.c.x,o=t.c.y,a=(i.p1.x-r)*(i.p2.y-o)-(i.p2.x-r)*(i.p1.y-o),l=Dt(t.r)*n-Dt(a);if(l<0)return[];let h=a*s/n,d=-a*e/n;if(b(l,0))return[t.c.shift(h,d)];let p=e*(s<0?-1:1)*Math.sqrt(l)/n,m=Math.abs(s)*Math.sqrt(l)/n;return[t.c.shift(h+p,d+m),t.c.shift(h-p,d-m)]}function yp(i,t){let e=[];At(i)&&At(t)?e=gp(i,t):At(i)&&st(t)?e=Hl(i,t):st(i)&&At(t)?e=Hl(t,i):st(i)&&st(t)&&(e=wp(i,t));for(let s of[i,t])s.type==="segment"&&(e=e.filter(n=>fp(s,n))),s.type==="ray"&&(e=e.filter(n=>mp(s,n)));return e}function It(...i){if(i.length<2)return[];if(i.length>2)return Bt($l(i,2).map(s=>It(...s)));let[t,e]=i;if(re(e)&&([t,e]=[e,t]),re(t)){let s=At(e)?t.points.filter(n=>e.contains(n)):[];for(let n of t.edges)s.push(...It(n,e));return s}return yp(t,e)}var P=class{constructor(...i){this.type="polygon",this.points=i}get circumference(){if(this.points.length<=1)return 0;let i=u.distance(this.points[0],I(this.points));for(let t=1;t<this.points.length;++t)i+=u.distance(this.points[t-1],this.points[t]);return i}get signedArea(){let i=this.points,t=i.length,e=i[t-1].x*i[0].y-i[0].x*i[t-1].y;for(let s=1;s<t;++s)e+=i[s-1].x*i[s].y-i[s].x*i[s-1].y;return e/2}get area(){return Math.abs(this.signedArea)}get centroid(){let i=this.points,t=i.length,e=0;for(let n=0;n<t;++n)e+=i[n].x;let s=0;for(let n=0;n<t;++n)s+=i[n].y;return new u(e/t,s/t)}get edges(){let i=this.points,t=i.length,e=[];for(let s=0;s<t;++s)e.push(new j(i[s],i[(s+1)%t]));return e}get radius(){let i=this.centroid,t=this.points.map(e=>u.distance(e,i));return Math.max(...t)}get oriented(){if(this.signedArea>=0)return this;let i=[...this.points].reverse();return new this.constructor(...i)}cut(i){let t=this.radius/i.length*10,e=i.at(-t),s=i.at(t),n=i.perpendicularVector.scale(i.length*t),r=[e,s,s.add(n),e.add(n)],o=cp([this.points],[r]),a=up([this.points],[r]);return[...o,...a].map(l=>new P(...l))}static collision(i,t){if(i.points.some(e=>t.contains(e))||t.points.some(e=>i.contains(e)))return!0;for(let e of i.edges)for(let s of t.edges)if(It(e,s)[0])return!0;return!1}static union(...i){let[t,...e]=i;if(!e.length)return[t];let s=[t.points],n=e.length>1?P.union(...e).map(r=>r.points):[i[1].points];return hp(s,n).map(r=>new P(...r))}static regular(i,t=1){let e=Zt/i,s=Math.PI/2-e/2,n=D(r=>u.fromPolar(s+e*r,t),i);return new P(...n)}static interpolate(i,t,e=.5){let s=i.points.map((n,r)=>u.interpolate(n,t.points[r],e));return new P(...s)}static convexHull(...i){if(i.length<=3)return new P(...i);let t=i.sort((r,o)=>r.x!==o.x?r.x-o.x:r.y-o.y),e=t.slice(0).reverse(),s=[],n=[];for(let[r,o]of[[t,s],[e,n]]){for(let a of r){for(;o.length>=2;){let l=o[o.length-1],h=o[o.length-2];if((l.x-h.x)*(a.y-h.y)>=(a.x-h.x)*(l.y-h.y))o.pop();else break}o.push(a)}o.pop()}return new P(...s.concat(n))}contains(i){let t=!1;for(let e of this.edges){if(e.p1.equals(i)||e.contains(i))return!1;if(e.p1.y>i.y==e.p2.y>i.y)continue;let s=(e.p2.x-e.p1.x)/(e.p2.y-e.p1.y);i.x<s*(i.y-e.p1.y)+e.p1.x&&(t=!t)}return t}at(i){return u.interpolateList([...this.points,this.points[0]],i)}project(i){let t,e=Infinity;for(let s of this.edges){let n=s.project(i),r=u.distance(i,n);r<e&&(t=n,e=r)}return t||this.points[0]}centerAt(i=y){return this.translate(i.subtract(this.centroid))}transform(i){return new this.constructor(...this.points.map(t=>t.transform(i)))}rotate(i,t=y){if(b(i,0))return this;let e=this.points.map(s=>s.rotate(i,t));return new this.constructor(...e)}reflect(i){let t=this.points.map(e=>e.reflect(i));return new this.constructor(...t)}scale(i,t=i){let e=this.points.map(s=>s.scale(i,t));return new this.constructor(...e)}shift(i,t=i){let e=this.points.map(s=>s.shift(i,t));return new this.constructor(...e)}translate(i){return this.shift(i.x,i.y)}equals(i,t,e){let s=this.points.length;if(s!==i.points.length)return!1;let n=e?this:this.oriented,r=e?i:i.oriented;for(let o=0;o<s;++o)if(n.points.every((a,l)=>a.equals(r.points[(l+o)%s],t)))return!0;return!1}},Ye=class extends P{constructor(){super(...arguments);this.type="polyline"}get length(){let i=0;for(let t=1;t<this.points.length;++t)i+=u.distance(this.points[t-1],this.points[t]);return i}get edges(){let i=[];for(let t=0;t<this.points.length-1;++t)i.push(new j(this.points[t],this.points[t+1]));return i}},kr=class extends P{constructor(){super(...arguments);this.type="triangle"}get circumcircle(){let[i,t,e]=this.points,s=2*(i.x*(t.y-e.y)+t.x*(e.y-i.y)+e.x*(i.y-t.y)),n=(i.x**2+i.y**2)*(t.y-e.y)+(t.x**2+t.y**2)*(e.y-i.y)+(e.x**2+e.y**2)*(i.y-t.y),r=(i.x**2+i.y**2)*(e.x-t.x)+(t.x**2+t.y**2)*(i.x-e.x)+(e.x**2+e.y**2)*(t.x-i.x),o=new u(n/s,r/s),a=u.distance(o,this.points[0]);return new _(o,a)}get incircle(){let i=this.edges,t=i.map(d=>d.length),e=t[0]+t[1]+t[2],[s,n,r]=this.points,o=t[1]*s.x+t[2]*n.x+t[0]*r.x,a=t[1]*s.y+t[2]*n.y+t[0]*r.y,l=new u(o/e,a/e),h=l.distanceFromLine(i[0]);return new _(l,h)}get orthocenter(){let[i,t,e]=this.points,s=new pt(i,t).perpendicular(e),n=new pt(i,e).perpendicular(t);return It(s,n)[0]}},$=class{constructor(i,t=1,e=t){this.p=i,this.w=t,this.h=e,this.type="rectangle"}static aroundPoints(i){let t=Infinity,e=-Infinity,s=Infinity,n=-Infinity;for(let r of i)t=t<r.x?t:r.x,e=e>r.x?e:r.x,s=s<r.y?s:r.y,n=n>r.y?n:r.y;return new $(new u(t,s),e-t,n-s)}get center(){return new u(this.p.x+this.w/2,this.p.y+this.h/2)}get centroid(){return this.center}get circumference(){return 2*Math.abs(this.w)+2*Math.abs(this.h)}get area(){return Math.abs(this.w*this.h)}get edges(){return this.polygon.edges}get points(){return this.polygon.points}get polygon(){let i=new u(this.p.x+this.w,this.p.y),t=new u(this.p.x+this.w,this.p.y+this.h),e=new u(this.p.x,this.p.y+this.h);return new P(this.p,i,t,e)}collision(i){return this.p.x<i.p.x+i.w&&this.p.x+this.w>i.p.x&&this.p.y<i.p.y+i.h&&this.p.y+this.h>i.p.y}contains(i,t){return W(i.x,this.p.x,this.p.x+this.w,t)&&W(i.y,this.p.y,this.p.y+this.h,t)}project(i){let t;for(let e of this.edges){let s=e.project(i);(!t||u.distance(i,s)<u.distance(i,t))&&(t=s)}return t}at(i){return this.p}transform(i){return this.polygon.transform(i)}rotate(i,t=y){return b(i,0)?this:this.polygon.rotate(i,t)}reflect(i){return this.polygon.reflect(i)}scale(i,t=i){return new $(this.p.scale(i,t),this.w*i,this.h*t)}shift(i,t=i){return new $(this.p.shift(i,t),this.w,this.h)}translate(i){return this.shift(i.x,i.y)}equals(i){return!1}toString(){return`Rectangle(p: ${this.p}, w: ${this.w}, h: ${this.h})`}},Vt=class{constructor(i,t,e,s){this.xMin=i,this.xMax=t,this.yMin=e,this.yMax=s}contains(i){return this.containsX(i)&&this.containsY(i)}containsX(i){return W(i.x,this.xMin,this.xMax)}containsY(i){return W(i.y,this.yMin,this.yMax)}resize(i,t){return new Vt(this.xMin,this.xMax+i,this.yMin,this.yMax+t)}get dx(){return this.xMax-this.xMin}get dy(){return this.yMax-this.yMin}get xRange(){return[this.xMin,this.xMax]}get yRange(){return[this.yMin,this.yMax]}get rect(){return new $(new u(this.xMin,this.yMin),this.dx,this.dy)}get center(){return new u(this.xMin+this.dx/2,this.yMin+this.dy/2)}get flip(){return new Vt(this.yMin,this.yMax,this.xMin,this.xMax)}};function ql(i,t,e={}){if(e.fill&&(i.fillStyle=e.fill),e.opacity&&(i.globalAlpha=e.opacity),e.stroke&&(i.strokeStyle=e.stroke,i.lineWidth=e.strokeWidth||1,e.lineCap&&(i.lineCap=e.lineCap),e.lineJoin&&(i.lineJoin=e.lineJoin)),i.beginPath(),Ci(t))i.moveTo(t.p1.x,t.p1.y),i.lineTo(t.p2.x,t.p2.y);else if(st(t))i.arc(t.c.x,t.c.y,t.r,0,Zt);else if(tn(t)){i.moveTo(t.points[0].x,t.points[0].y);for(let s of t.points.slice(1))i.lineTo(s.x,s.y);i.closePath()}else if(en(t)){i.moveTo(t.points[0].x,t.points[0].y);for(let s of t.points.slice(1))i.lineTo(s.x,s.y)}e.fill&&i.fill(),e.stroke&&i.stroke()}function Or(i,t,e){let n=t.x*(e.y-i.y)+i.x*(t.y-e.y)+e.x*(i.y-t.y)>0?1:0,r=u.distance(t,i);return[i.x,`${i.y}A${r}`,r,0,n,1,e.x,e.y].join(",")}function vp(i,t={}){return i.isRight&&!t.round?20:24+20*(1-T(i.rad,0,Math.PI)/Math.PI)}function bp(i,t={}){let e=i.a,s=i.b,n=i.c,r=t.size||vp(i,t),o=u.difference(e,s).unitVector,a=u.difference(n,s).unitVector;e=u.sum(s,o.scale(r)),n=u.sum(s,a.scale(r));let l=t.fill?`M${s.x},${s.y}L`:"M";if(i.isRight&&!t.round){let h=u.sum(e,a.scale(r));l+=`${e.x},${e.y}L${h.x},${h.y}L${n.x},${n.y}`}else l+=Or(e,s,n);return t.fill&&(l+="Z"),l}function Nt(...i){return`M${i.map(t=>`${t.x},${t.y}`).join("L")}`}function zl(i,t){let e=i.perpendicularVector.scale(6),s=i.unitVector.scale(3),n=i.midpoint;switch(t){case"bar":return Nt(n.add(e),n.add(e.inverse));case"bar2":return Nt(n.add(s).add(e),n.add(s).add(e.inverse))+Nt(n.add(s.inverse).add(e),n.add(s.inverse).add(e.inverse));case"arrow":return Nt(n.add(s.inverse).add(e),n.add(s),n.add(s.inverse).add(e.inverse));case"arrow2":return Nt(n.add(s.scale(-2)).add(e),n,n.add(s.scale(-2)).add(e.inverse))+Nt(n.add(e),n.add(s.scale(2)),n.add(e.inverse));default:return""}}function sn(i,t){if(!i||!t)return"";let e=t.perpendicular,s=i.add(t.scale(9)).add(e.scale(9)),n=i.add(t.scale(9)).add(e.scale(-9));return Nt(s,i,n)}function $p(i,t){let e="";return J(t,"start","both")&&(e+=sn(i.p1,i.unitVector)),J(t,"end","both")&&(e+=sn(i.p2,i.unitVector.inverse)),e}function xp(i,t){let e="";if(J(t,"start","both")){let s=new pt(i.c,i.start).perpendicularVector.inverse;e+=sn(i.start,s)}if(J(t,"end","both")){let s=new pt(i.c,i.end).perpendicularVector;e+=sn(i.end,s)}return e}function oe(i,t={}){if(pp(i))return bp(i,t);if(Ci(i)){if(i.p1.equals(i.p2))return"";let e=Nt(i.p1,i.p2);return t.mark&&(e+=zl(i,t.mark)),t.arrows&&(e+=$p(i,t.arrows)),e}if(dp(i)){if(!t.box)return"";let e=It(i,t.box)[0];return e?Nt(i.p1,e):""}if(Vr(i)){if(!t.box)return"";let e=It(i,t.box);if(e.length<2)return"";let s=Nt(e[0],e[1]);return t.mark&&(s+=zl(i,t.mark)),s}if(st(i))return`M ${i.c.x-i.r} ${i.c.y} a ${i.r},${i.r} 0 1 0 ${2*i.r} 0 a ${i.r} ${i.r} 0 1 0 ${-2*i.r} 0`;if(Ei(i)){let e=`M${Or(i.start,i.c,i.end)}`;return t.arrows&&(e+=xp(i,t.arrows)),e}return ye(i)?`M ${i.c.x} ${i.c.y} L ${Or(i.start,i.c,i.end)} Z`:en(i)?Nt(...i.points):tn(i)?`${Nt(...i.points)}Z`:Ar(i)?`${Nt(...i.polygon.points)}Z`:""}var Ut=(i,t,e)=>new Promise((s,n)=>{var r=l=>{try{a(e.next(l))}catch(h){n(h)}},o=l=>{try{a(e.throw(l))}catch(h){n(h)}},a=l=>l.done?s(l.value):Promise.resolve(l.value).then(r,o);a((e=e.apply(i,t)).next())});function Tp(i){let t=[];for(let e of Object.keys(i)){let s=i[e];if(e=encodeURIComponent(e),s==null){t.push(e);continue}s=Array.isArray(s)?s.join(","):`${s}`,s=s.replace(/(\r)?\n/g,`\r
`),s=encodeURIComponent(s),s=s.replace(/%20/g,"+"),t.push(`${e}=${s}`)}return t.join("&")}function Lr(i,t){return Ut(this,null,function*(){let e=t instanceof FormData,s={method:"POST",body:e?t:t?Tp(t):void 0,headers:{"X-CSRF-Token":window.csrfToken||""}};e||(s.headers["Content-Type"]="application/x-www-form-urlencoded");let n=i.includes("?")?"&xhr=1":"?xhr=1",r=yield fetch(i+n,s);if(!r.ok)throw new Error(`Fetch error ${r.status}: ${i}`);return r.text()})}function nn(i,t=!1){return new Promise(e=>{let s=new Image;t||(s.crossOrigin="Anonymous"),s.onload=()=>e(s),s.src=i})}var is=new Map;function Sp(i,t){is.has(i)?fr(is.get(i),t,(e,s)=>Rt(e.concat(s))):is.set(i,t)}function Bl(){if(!!window.navigator.onLine)for(let[i,t]of is)is.delete(i),Lr(i,{data:JSON.stringify(t)}).catch(e=>{console.error("Failed to send POST request:",e),Sp(i,t)})}var Mp=Zs(Bl,5e3);window.addEventListener("online",Mp);window.onbeforeunload=Bl;var ae=class{constructor(i,t=1,e=!0){this.src=i,this.defaultVolume=t,this.player=new Audio,this.player.src=i,e&&(this.player.preload="auto")}play(i){this.player.currentTime=0,this.player.volume=i||this.defaultVolume,this.player.play()}},Fl={"===":(i,t)=>i===t,"!==":(i,t)=>i!==t,"||":(i,t)=>i||t,"&&":(i,t)=>i&&t,"==":(i,t)=>i==t,"!=":(i,t)=>i!=t,"<=":(i,t)=>i<=t,">=":(i,t)=>i>=t,"**":(i,t)=>i**t,"<":(i,t)=>i<t,">":(i,t)=>i>t,"+":(i,t)=>i+t,"-":(i,t)=>i-t,"*":(i,t)=>i*t,"/":(i,t)=>i/t,"%":(i,t)=>i%t},Zl={"-":i=>-i,"+":i=>+i,"!":i=>!i},Ul={"||":1,"&&":2,"==":3,"!=":3,"===":3,"!==":3,"<":4,">":4,"<=":4,">=":4,"+":5,"-":5,"*":6,"/":6,"%":6,"**":7},jl={true:!0,false:!1,undefined:void 0},Pp=/\s/,Ir=/[0-9]/,Rr=/[a-zA-Zα-ωΑ-Ω$_]/,Cp=/[0-9a-zA-Zα-ωΑ-Ω$_]/;function Ep(i){let t=i.length,e=0;function s(w){throw new Error(`${w} at character ${e} of "${i}"`)}function n(){for(;Pp.test(i[e]);)e+=1}function r(){let w="";for(;Ir.test(i[e]);)w+=i[e++];if(i[e]===".")for(w+=i[e++];Ir.test(i[e]);)w+=i[e++];let x=i[e];if(x&&Rr.test(x)){let k=w+i[e];s(`Variable names cannot start with a number (${k})`)}else x==="."&&s("Unexpected period");return{type:5,value:parseFloat(w)}}function o(){let w=i[e];e+=1;let x=!1,k="";for(;e<t;){let v=i[e++];if(v===w){x=!0;break}k+=v}return x||s(`Unclosed quote after "${k}"`),{type:5,value:k}}function a(){let w=i[e];for(Rr.test(i[e])||s(`Unexpected ${w}`),e+=1;e<t&&Cp.test(i[e]);)w+=i[e++];return w in jl?{type:5,value:jl[w]}:{type:4,name:w}}function l(w){let x=[],k=!1,v;for(;e<t;)if(i[e]===w){v&&x.push(v),k=!0,e+=1;break}else i[e]===","?(x.push(v||{type:5,value:void 0}),e+=1):v=g();return k||s(`Expected ${w}`),x}function h(){let w;if(i[e]==="("){if(e+=1,w=g(),n(),i[e]===")")return e+=1,w;s("Unclosed (")}else w=a();for(n();".[(".includes(i[e]);)i[e]==="."?(e++,n(),w={type:6,object:w,computed:!1,property:a()}):i[e]==="["?(e++,w={type:6,object:w,computed:!0,property:g()},n(),i[e]!=="]"&&s("Unclosed ["),e++):i[e]==="("&&(e++,w={type:2,args:l(")"),callee:w}),n();return w}function d(){n();for(let w of[3,2,1]){let x=i.substr(e,w);if(x in Fl)return e+=w,x}}function p(){n();let w=i[e];if(Ir.test(w)||w===".")return r();if(w==="'"||w==='"')return o();if(w==="[")return e+=1,{type:0,elements:l("]")};if(w in Zl)return e+=1,{type:7,operator:w,argument:p()};if(Rr.test(w)||w==="(")return h();s("Expression parsing error")}function m(){let w=p(),x=d();if(!x)return w;let k=p();k||s(`Expected expression after ${x}`);let v,C=[w,x,k];for(;x=d();){let ze=Ul[x],bi=x;for(;C.length>2&&ze<=Ul[C[C.length-2]];)k=C.pop(),x=C.pop(),w=C.pop(),v={type:1,operator:x,left:w,right:k},C.push(v);v=p(),v||s(`Expected expression after ${bi}`),C.push(bi,v)}let dt=C.length-1;for(v=C[dt];dt>1;)v={type:1,operator:C[dt-1],left:C[dt-2],right:v},dt-=2;return v}function g(){let w=m();if(n(),w&&i[e]==="?"){e+=1;let x=g();if(x||s("Expected expression"),n(),i[e]===":"){e++;let k=g();return k||s("Expected expression"),{type:3,test:w,consequent:x,alternate:k}}else s("Expected :")}else return w}let M=g();return e<i.length&&s(`Unexpected "${i[e]}"`),M}var rn=[void 0,void 0];function jt(i,t,e){switch(i.type){case 0:let s=i.elements.map(M=>jt(M,t,e)[0]);return s.some(M=>M===void 0)?rn:[s,void 0];case 1:let n=jt(i.left,t,e)[0],r=jt(i.right,t,e)[0];return"+-**/%".includes(i.operator)&&(n===void 0||r===void 0)?rn:[Fl[i.operator](n,r),void 0];case 2:let[o,a]=jt(i.callee,t,e),l=i.args.map(M=>jt(M,t,e)[0]);return l.some(M=>M===void 0)||typeof o!="function"?rn:[o.apply(a,l),void 0];case 3:let h=jt(i.consequent,t,e),d=jt(i.alternate,t,e);return jt(i.test,t,e)[0]?h:d;case 4:return[e[i.name]||t[i.name],void 0];case 5:return[i.value,void 0];case 6:let p=jt(i.object,t,e)[0],m=i.computed?jt(i.property,t,e)[0]:i.property.name;return p?[p[m],p]:[void 0,void 0];case 7:let g=jt(i.argument,t,e)[0];return g===void 0&&i.operator!=="!"?rn:[Zl[i.operator](g),void 0]}}function Jt(i){let t=Ep(i);return t?(e={},s={})=>jt(t,e,s)[0]:(e={})=>{}}var Ap=/\${([^}]+)}/g;function Wl(i){let t=i.split(Ap),e=t.map((s,n)=>n%2?Jt(s.replace(/×/g,"*")):void 0);return s=>t.map((n,r)=>{if(!(r%2))return n;let o=e[r](s);return typeof o=="number"&&o<0?`\u2013${-o}`:o}).join("")}var ss="ontouchstart"in window,Ai="onpointerdown"in window;function le(i){if(i.touches){let t=i.targetTouches.length?i.targetTouches:i.changedTouches;return new u(t[0].clientX,t[0].clientY)}else return new u(i.clientX||0,i.clientY||0)}function Vp(i){return i.touches||[]}function Qt(i,t){return le(i).transform(t.inverseTransformMatrix)}function kp(i,t){let e=le(i),s=t.bounds,n=(e.x-s.left)*t.canvasWidth/s.width,r=(e.y-s.top)*t.canvasHeight/s.height;return new u(n,r)}function Op(i){if(i instanceof PointerEvent&&i.pointerType==="mouse")return R(i.target);let t=le(i);return R(document.elementFromPoint(t.x,t.y)||void 0)}function Lp(i){if(i._data.tapEvent)return;i._data.tapEvent=!0;let t;i.on("pointerdown",e=>t=le(e)),i.on("pointerup",e=>{if(!t)return;let s=le(e);u.distance(t,s)<6&&i.trigger("tap",e),t=void 0}),i.on("pointercancel",()=>t=void 0)}function Ip(i){i._data.clickOutsideEvent||(i._data.clickOutsideEvent=!0,X.on("pointerdown",t=>{var e,s;let n=t.target,r=(s=(e=i._el).getRootNode)==null?void 0:s.call(e),o=le(t);(r==null?void 0:r.host)&&(n=r.elementFromPoint(o.x,o.y)),!(!n||i._el===n||i._el.contains(n))&&i.trigger("clickOutside",t)}))}function Rp(i,t){let e=t.$box||i,s=le;e.type==="svg"?s=m=>Qt(m,e.$ownerSVG):e.type==="canvas"&&(s=m=>kp(m,e));let n=t.justInside?i:X,r,o,a=!1,l=0;i.css("touch-action")==="auto"&&i.css("touch-action","none"),i.addClass("noselect");function h(m){m.handled||Vp(m).length>1||(m.preventDefault(),a=!1,l=m.pointerId||0,n.on("pointermove",d),n.on("pointerstop",p),r=o=s(m),t.down&&t.down(r))}function d(m){if(!r||l&&m.pointerId!==l)return;m.preventDefault();let g=s(m);u.distance(g,o)<.5||(!a&&t.start&&t.start(r),t.move&&t.move(g,r,o),o=g,a=!0)}function p(m,g=!1){!r||l&&m.pointerId!==l||(m.preventDefault(),n.off("pointermove",d),n.off("pointerstop",p),t.up&&t.up(o,r),a&&t.end&&t.end(o,r),!a&&t.click&&!g&&t.click(r),r=void 0)}E.onKey("escape",()=>{if(!r)return;a&&t.move&&t.move(r,r,o),o=r;let m=document.createEvent("MouseEvent");m.pointerId=l,p(m,!0)}),i.on("pointerdown",h),t.justInside&&i.on("mouseleave",p),t.accessible&&(i.setAttr("tabindex","0"),document.addEventListener("keydown",m=>{if(![37,38,39,40].includes(m.keyCode)||i!==E.getActiveInput())return;let g=i.boxCenter,M=s({clientX:g.x,clientY:g.y}),w=m.keyCode===37?-25:m.keyCode===39?25:0,x=m.keyCode===38?-25:m.keyCode===40?25:0,k=M.shift(w,x);t.down&&t.down(M),t.start&&t.start(M),t.move&&t.move(k,M,M),t.end&&t.end(k,M)}))}function Dp(i){if(i._data.scrollEvents)return;i._data.scrollEvents=!0;let t=!1,e;function s(){let l=i.scrollTop;if(l===e){t=!1;return}e=l,i.trigger("scroll",{top:e}),window.requestAnimationFrame(s)}function n(){t||window.requestAnimationFrame(s),t=!0}(i.type==="window"?window:i._el).addEventListener("scroll",n);function o(){window.addEventListener("touchmove",n),window.addEventListener("touchend",a)}function a(){window.removeEventListener("touchmove",n),window.removeEventListener("touchend",a)}i._el.addEventListener("touchstart",function(l){l.handled||o()})}var Dr;function Np(i){for(let t of i){let e=t.isIntersecting?"enterViewport":"exitViewport";setTimeout(()=>R(t.target).trigger(e))}}function Kl(i){if(!i._data.intersectionEvents){if(i._data.intersectionEvents=!0,!window.IntersectionObserver){let t=!1;X.on("scroll",()=>{let e=i.isInViewport;t&&!e?(i.trigger("exitViewport"),t=!1):e&&!t&&(i.trigger("enterViewport"),t=!0)});return}Dr||(Dr=new IntersectionObserver(Np)),Dr.observe(i._el)}}function _p(i,t=!1){if(t&&(i._data.resizeObserver&&i._data.resizeObserver.disconnect(),i._data.resizeObserver=void 0),!i._data.resizeObserver){if(window.ResizeObserver){let e=new window.ResizeObserver(()=>i.trigger("resize"));e.observe(i._el),i._data.resizeObserver=e}else if(window.MutationObserver){let e=new MutationObserver(()=>i.trigger("resize"));e.observe(i._el,{attributes:!0,childList:!0,characterData:!0,subtree:!0}),i._data.resizeObserver=e}}}function Xl(i){if(i._data.pointerPositionEvents)return;i._data.pointerPositionEvents=!0;let t=i.parent,e;t.on("pointerend",()=>e=void 0),t.on("pointermove",s=>{let n=e,r=Op(s);e=r.equals(i)||r.hasParent(i),n!==void 0&&e&&!n&&i.trigger("pointerenter",s),!e&&n&&i.trigger("pointerleave",s)})}function Nr(i,t){t._data[`_${i}`]||(t._data[`_${i}`]=!0,Ai?t.on(i.replace("mouse","pointer"),e=>{e.pointerType==="mouse"&&t.trigger(i,e)}):ss||t._el.addEventListener(i,e=>t.trigger(i,e)))}function Gp(i){i.on("keydown",t=>{if(t.metaKey||t.ctrlKey||E.isAndroid&&t.keyCode===229)return;let e=t.key||String.fromCharCode(t.which),s=e.toLowerCase(),n=!!t.shiftKey;i.trigger("key",{code:t.keyCode,key:s,char:e,shift:n})}),E.isAndroid&&i.type==="input"&&i.on("input",t=>{let e=t.data[t.data.length-1],s=e.toLowerCase();i.trigger("key",{code:void 0,key:s,char:e}),i.value=""})}var on={scrollwheel:"DOMMouseScroll mousewheel",pointerdown:Ai?"pointerdown":ss?"touchstart":"mousedown",pointermove:Ai?"pointermove":ss?"touchmove":"mousemove",pointerup:Ai?"pointerup":ss?"touchend":"mouseup",pointercancel:Ai?"pointercancel":"touchcancel",pointerstop:Ai?"pointerup pointercancel":ss?"touchend touchcancel":"mouseup"},an={scroll:Dp,tap:Lp,clickOutside:Ip,key:Gp,mousedown:Nr.bind(void 0,"mousedown"),mousemove:Nr.bind(void 0,"mousemove"),mouseup:Nr.bind(void 0,"mouseup"),pointerenter:Xl,pointerleave:Xl,enterViewport:Kl,exitViewport:Kl,resize:_p};function Hp(i,t,e,s){if(t in an)an[t](i,!1);else if(t in on){let n=ht(on[t]);for(let r of n)i._el.addEventListener(r,e,s)}else i._el.addEventListener(t,e,s)}function qp(i,t,e){if(t in an)(!i._events[t]||!i._events[t].length)&&an[t](i,!0);else if(e&&t in on){let s=ht(on[t]);for(let n of s)i._el.removeEventListener(n,e)}else e&&i._el.removeEventListener(t,e)}var ln=0,_r=new Map;function Yl(i,t){_r.set(i,t)}function zp(i){if(ln++,i(),ln--,ln===0){for(let[t,e]of _r.entries())t(e);_r.clear()}}function ke(i,t){let e=new Map,s=new Map,n=new Set,r,o=0;function a(v){r=v;let C=v(k,!0);return r=void 0,C}function l(v){for(let C of e.values())C.has(v)&&C.delete(v);n.delete(v)}function h(v,C){return n.add(v),C?void 0:v(k,!0)}function d(v,C){s.has(v)&&l(s.get(v));let dt=()=>{i[v]=C(k),r===dt&&(r=void 0),p(v)};s.set(v,dt),a(dt)}function p(v){if(ln>0){for(let C of e.get(v)||[])Yl(C,i);for(let C of n)Yl(C,i)}else{for(let C of e.get(v)||[])C(i);for(let C of n)C(i)}}function m(){for(let v of e.values())for(let C of v)C(i);for(let v of n)v(i)}function g(v){zp(()=>{for(let[C,dt]of Object.entries(v))k[C]=dt})}function M(){for(o+=1;`_x${o}`in i;)o+=1;return`_x${o}`}function w(){i={},e.clear(),s.clear(),o=0}function x(v){!t||t.watch(()=>k[v]=t[v])}let k=new Proxy(i,{get(v,C){return C==="watch"?a:C==="unwatch"?l:C==="watchAll"?h:C==="setComputed"?d:C==="forceUpdate"?m:C==="assign"?g:C==="getKey"?M:C==="clear"?w:C==="_internal"?[i,e]:(r&&(e.has(C)||e.set(C,new Set),e.get(C).add(r)),C in i||x(C),i[C])},set(v,C,dt){return i[C]===dt||(i[C]=dt,s.has(C)&&(l(s.get(C)),s.delete(C)),p(C)),!0},deleteProperty(v,C){return delete i[C],e.delete(C),s.delete(C),!0}});return k}var Bp={A:7,C:6,H:1,L:2,M:2,Q:4,S:4,T:2,V:1,Z:0},Fp=/[astvzqmhlc]([^astvzqmhlc]*)/ig,Zp=/-?[0-9]*\.?[0-9]+(?:e[-+]?\d+)?/ig;function hn(i){let t=[],e;for(let s of i.match(Fp)||[]){let n=s[0].toUpperCase();if(n==="Z"){t.push({type:"Z",points:[]});continue}let r=(s.slice(1).match(Zp)||[]).map(a=>+a),o=n===s[0];for(let[a,l]of $i(r,Bp[n]).entries()){let h=[],d=n==="M"&&a>0?"L":n,p;n==="H"?(d="L",h=[new u(l[0],o&&(e==null?void 0:e.y)||0)]):n==="V"?(d="L",h=[new u(o&&(e==null?void 0:e.x)||0,l[0])]):n==="A"?(d="A",h=[new u(l[5],l[6])],p=l.slice(0,5)):"MLCSQT".includes(n)&&(h=$i(l,2).map(m=>new u(m[0],m[1]))),!o&&e&&(h=h.map(m=>m.translate(e))),e=I(h),t.push({type:d,points:h,options:p})}}return t}function Je(i){return i?hn(i).map(e=>I(e.points)).filter(e=>!!e):[]}var cn=class{constructor(i){this._el=i,this._data={},this._events={},this.type="default",i._view=this}get id(){return this._el.id}get data(){return this._el.dataset}get tagName(){return this._el.tagName.toUpperCase()}equals(i){return this._el===i._el}addClass(i){for(let t of ht(i))this._el.classList.add(t)}removeClass(i){for(let t of ht(i))this._el.classList.remove(t)}hasClass(i){return this._el.classList.contains(i)}toggleClass(i){return this._el.classList.toggle(i)}setClass(i,t){t?this.addClass(i):this.removeClass(i)}attr(i){return this._el.getAttribute(i)||""}hasAttr(i){return this._el.hasAttribute(i)}setAttr(i,t){t===void 0?this.removeAttr(i):this._el.setAttribute(i,t.toString())}removeAttr(i){this._el.removeAttribute(i)}get attributes(){return Array.from(this._el.attributes||[])}get html(){return this._el.innerHTML||""}set html(i){this._el.innerHTML=i}get text(){return this._el.textContent||""}set text(i){this._el.textContent=i}set textStr(i){this._el.textContent=`${i}`}blur(){this._el.blur()}focus(){this._el.focus()}getParentModel(){let i=this.parent;return i?i.model||i.getParentModel():void 0}bindModel(i,t=!0){var e;if(!this.model){if(this.model=i,this.hasAttr(":for"))return this.makeDynamicList(i);for(let{name:s,value:n}of this.attributes)this.makeDynamicAttribute(s,n,i);for(let s of this.childNodes)if(s instanceof Text){if((e=s.textContent)==null?void 0:e.includes("${")){let n=Wl(s.textContent);i.watch(()=>s.textContent=n(i)||"")}}else t&&s.bindModel(i)}}bindVariable(i,t){}makeDynamicAttribute(i,t,e){if(i.startsWith("@")){let s=i.slice(1),n=Jt(t);this.on(s,r=>n(e,{$event:r}))}else if(i===":show"){let s=Jt(t);e.watch(()=>this.toggle(!!s(e)))}else if(i===":if"){let s=Jt(t),n=R(document.createComment(""));this.insertBefore(n);let r=!0;e.watch(()=>{let o=!!s(e);o!==r&&(o&&n.insertBefore(this),o||this.detach(),r=o)})}else if(i===":html"){let s=Jt(t);e.watch(()=>this.html=s(e)||"")}else if(i===":draw"){let s=Jt(t);e.watch(()=>this.draw(s(e)))}else if(i===":class"){let s=Jt(t),n=`${this.attr("class")} `;e.watch(()=>this.setAttr("class",n+s(e)))}else if(i===":bind")this.bindVariable(e,t);else if(i.startsWith(":")){let s=Jt(t),n=i.slice(1);e.watch(()=>this.setAttr(n,s(e)))}else if(t.includes("${")){let s=Wl(t);e.watch(()=>this.setAttr(i,s(e)||""))}(i.startsWith("@")||i.startsWith(":"))&&this.removeAttr(i)}makeDynamicList(i){let[t,e]=this.attr(":for").split(" in ");this.removeAttr(":for");let s=Jt(e),n=R(document.createComment(""));this.insertBefore(n),this.detach();let r=[],o=0;i.watch(()=>{let a=s(i);Array.isArray(a)||(a=[]);for(let l=a.length;l<o;++l)r[l].detach();for(let l=o;l<r.length;++l)n.insertBefore(r[l]);for(let l=r.length;l<a.length;++l){let h=this.copy(!0);h.bindModel(ke({[t]:void 0},i)),n.insertBefore(h),r.push(h)}o=a.length;for(let l=0;l<o;++l)r[l].model[t]=a[l]})}get bounds(){return this._el.getBoundingClientRect()}get boundsRect(){let i=this.bounds;return new $(new u(i.x,i.y),i.width,i.height)}contains(i){return this.boundsRect.contains(i)}get isInViewport(){if(this.height===0)return!1;let i=this.bounds;return W(i.top,-i.height,E.height)}get topLeftPosition(){let i=this.bounds;return new u(i.left,i.top)}get boxCenter(){let i=this.bounds;return new u(i.left+i.width/2,i.top+i.height/2)}get scrollWidth(){return this._el.scrollWidth}get scrollHeight(){return this._el.scrollHeight}get scrollTop(){return this._el.scrollTop}set scrollTop(i){this._el.scrollTop=i,this.trigger("scroll",{top:i,left:this.scrollLeft})}get scrollLeft(){return this._el.scrollLeft}set scrollLeft(i){this._el.scrollLeft=i,this.trigger("scroll",{top:this.scrollTop,left:i})}scrollTo(i,t=1e3,e="cubic"){i<0&&(i=0);let s=this.scrollTop,n=i-s;this._data.scrollAnimation&&this._data.scrollAnimation.cancel(),this._data.scrollAnimation=z(r=>{let o=s+n*Y(e,r);this.scrollTop=o,this.trigger("scroll",{top:o})},t)}scrollBy(i,t=1e3,e="cubic"){!i||this.scrollTo(this.scrollTop+i,t,e)}css(i,t){if(t===void 0){if(typeof i=="string")return window.getComputedStyle(this._el).getPropertyValue(i);{let e=Object.keys(i);for(let s of e)this._el.style.setProperty(s,`${i[s]}`)}}else typeof i=="string"&&this._el.style.setProperty(i,`${t}`)}get transform(){return this.css("transform").replace("none","")}get transformMatrix(){let i=this.transform;if(!i)return[[1,0,0],[0,1,0]];let t=i.match(/matrix\(([0-9,.\s-]*)\)/);if(!t||!t[1])return[[1,0,0],[0,1,0]];let e=t[1].split(",");return[[+e[0],+e[2],+e[4]],[+e[1],+e[3],+e[5]]]}get scale(){let i=this.transformMatrix;return[i[0][0],i[1][1]]}setTransform(i,t=0,e=1){let s="";i&&(s+=`translate(${K(i.x,.1)}px,${K(i.y,.1)}px)`),t&&(s+=` rotate(${t}rad)`),e&&(s+=` scale(${e})`),this._el.style.transform=s}translate(i,t){this.setTransform(new u(i,t))}show(){this.hasAttr("hidden")&&this.removeAttr("hidden"),this.data.display==="visibility"?this._el.style.visibility="visible":this._el.style.display=this.data.display||"block"}hide(){this.data.display==="visibility"?this._el.style.visibility="hidden":this._el.style.display="none"}toggle(i){i?this.show():this.hide()}is(i){return this._el.matches?this._el.matches(i):Array.from(document.querySelectorAll(i)).includes(this._el)}index(){let i=0,t=this._el;for(;(t=t.previousSibling||void 0)!==void 0;)++i;return i}prepend(i){let t=this._el.childNodes;t.length?this._el.insertBefore(i._el,t[0]):this._el.appendChild(i._el)}append(i){this._el.appendChild(i instanceof Text?i:i._el)}insertBefore(i){this.parent._el.insertBefore(i._el,this._el)}insertAfter(i){let t=this._el.nextSibling;t?this.parent._el.insertBefore(i._el,t):this.parent._el.appendChild(i._el)}get next(){return R(this._el.nextSibling)}get prev(){return R(this._el.previousSibling)}$(i){return R(i,this)}$$(i){return he(i,this)}get parent(){return R(this._el.parentElement||void 0)}parents(i){let t=[],e=this.parent;for(;e;)(!i||e.is(i))&&t.push(e),e=e.parent;return t}hasParent(...i){let t=i.map(s=>s._el),e=this._el.parentNode;for(;e;){if(J(e,...t))return!0;e=e.parentNode}return!1}get children(){return Array.from(this._el.children||[],i=>R(i))}get childNodes(){return Array.from(this._el.childNodes,i=>{if(!(i instanceof Comment))return i instanceof Text?i:R(i)}).filter(i=>i)}restartAnimation(){let i=this.next,t=this.parent;this.detach(),i?i.insertBefore(this):t.append(this)}detach(){this._el&&this._el.parentNode&&this._el.parentNode.removeChild(this._el)}remove(){this.detach()}removeChildren(){for(;this._el.firstChild;)this._el.removeChild(this._el.firstChild)}on(i,t,e){for(let s of ht(i))s in this._events?this._events[s].includes(t)||this._events[s].push(t):this._events[s]=[t],Hp(this,s,t,e)}one(i,t,e){let s=n=>{this.off(i,s),t(n)};this.on(i,s,e)}off(i,t){for(let e of ht(i))e in this._events&&(this._events[e]=t?this._events[e].filter(s=>s!==t):[]),qp(this,e,t)}trigger(i,t={}){for(let e of ht(i)){if(!this._events[e])return;for(let s of this._events[e])s.call(this,t)}}onKeyDown(i,t){let e=ht(i).map(s=>_t[s]||s);this._el.addEventListener("keydown",s=>{e.indexOf(s.keyCode)>=0&&t(s)})}onAttr(i,t){new MutationObserver(s=>{for(let n of s)n.type==="attributes"&&n.attributeName===i&&t(this.attr(i))}).observe(this._el,{attributes:!0}),t(this.attr(i),!0)}onPromise(i,t=!1){return t?Promise.resolve():new Promise(e=>this.one("solve",()=>e()))}animate(i,t=400,e=0,s="ease-in-out"){return kt(this,i,t,e,s)}enter(i="fade",t=500,e=0){return Up(this,i,t,e)}exit(i="fade",t=500,e=0,s=!1){return jp(this,i,t,e,s)}effect(i){this.one("animationend",()=>this.removeClass(`effects-${i}`)),this.addClass(`effects-${i}`)}copy(i=!0,t=!0,e){let s=R(this._el.cloneNode(i));return t&&s.copyInlineStyles(this,i,e),s}copyInlineStyles(i,t=!0,e){let s=window.getComputedStyle(i._el);for(let n of e||Array.from(s))this.css(n,s.getPropertyValue(n));if(t){let n=this.children,r=i.children;for(let o=0;o<n.length;++o){let a=n[o].tagName==="foreignObject"?void 0:e;n[o].copyInlineStyles(r[o],!0,a)}}}},Qe=class extends cn{get offsetTop(){return this._el.offsetTop}get offsetLeft(){return this._el.offsetLeft}get offsetParent(){return R(this._el.offsetParent||void 0)}get width(){return this._el.offsetWidth}get height(){return this._el.offsetHeight}get innerWidth(){let i=parseFloat(this.css("padding-left")),t=parseFloat(this.css("padding-right"));return this._el.clientWidth-i-t}get innerHeight(){let i=parseFloat(this.css("padding-bottom")),t=parseFloat(this.css("padding-top"));return this._el.clientHeight-i-t}get outerWidth(){let i=parseFloat(this.css("margin-left")),t=parseFloat(this.css("margin-right"));return this.width+i+t||0}get outerHeight(){let i=parseFloat(this.css("margin-bottom")),t=parseFloat(this.css("margin-top"));return this.height+i+t||0}get positionTop(){let i=this._el,t=0;for(;i;)t+=i.offsetTop,i=i.offsetParent;return t}get positionLeft(){let i=this._el,t=0;for(;i;)t+=i.offsetLeft,i=i.offsetParent;return t}offset(i){if(i._el===this._el.offsetParent){let t=this.offsetTop+i._el.clientTop,e=this.offsetLeft+i._el.clientLeft,s=t+this.height,n=e+this.width;return{top:t,left:e,bottom:s,right:n}}else{let t=i._el.getBoundingClientRect(),e=this._el.getBoundingClientRect();return{top:e.top-t.top,left:e.left-t.left,bottom:e.bottom-t.top,right:e.right-t.left}}}},Jl=["font-family","font-size","font-style","font-weight","letter-spacing","text-decoration","color","display","visibility","alignment-baseline","baseline-shift","text-anchor","clip","clip-path","clip-rule","mask","opacity","filter","fill","fill-rule","marker","marker-start","marker-mid","marker-end","stroke","stroke-dasharray","stroke-dashoffset","stroke-linecap","stroke-linejoin","stroke-width","text-rendering","transform","dominant-baseline","transform-origin","transform-box","paint-order"],Ql=class extends cn{constructor(){super(...arguments);this.type="svg"}get $ownerSVG(){return R(this._el.ownerSVGElement||void 0)}get width(){return this.bounds.width}get height(){return this.bounds.height}get positionLeft(){let i=this._el.getBBox().x+this._el.getCTM().e;return this.$ownerSVG.positionLeft+i}get positionTop(){let i=this._el.getBBox().y+this._el.getCTM().f;return this.$ownerSVG.positionTop+i}get inverseTransformMatrix(){let i=this._el.getScreenCTM().inverse(),t=[[i.a,i.c,i.e],[i.b,i.d,i.f]];if(E.isFirefox){let e=this.transformMatrix;t[0][2]-=e[0][2],t[1][2]-=e[1][2]}return t}setTransform(i,t=0,e=1){let s=i?`translate(${K(i.x,.1)} ${K(i.y,.1)})`:"",n=b(t,0)?"":`rotate(${t*180/Math.PI})`,r=b(e,1)?"":`scale(${e})`;this.setAttr("transform",[s,n,r].join(" "))}get strokeLength(){if(this._el instanceof SVGGeometryElement)return this._el.getTotalLength();{let i=this.bounds;return 2*i.height+2*i.width}}getPointAtLength(i){if(this._el instanceof SVGGeometryElement){let t=this._el.getPointAtLength(i);return new u(t.x,t.y)}else return new u(0,0)}getPointAt(i){return this.getPointAtLength(i*this.strokeLength)}get points(){return Je(this.attr("d"))}set points(i){let t=i.length?`M${i.map(e=>`${e.x},${e.y}`).join("L")}`:"";this.setAttr("d",t)}addPoint(i){let t=`${this.attr("d")} L ${i.x},${i.y}`;this.setAttr("d",t)}get center(){let i=+this.attr(this.tagName==="TEXT"?"x":"cx"),t=+this.attr(this.tagName==="TEXT"?"y":"cy");return new u(i,t)}setCenter(i){this.setAttr(this.tagName==="TEXT"?"x":"cx",i.x),this.setAttr(this.tagName==="TEXT"?"y":"cy",i.y)}setLine(i,t){this.setAttr("x1",i.x),this.setAttr("y1",i.y),this.setAttr("x2",t.x),this.setAttr("y2",t.y)}setRect(i){this.setAttr("x",i.p.x),this.setAttr("y",i.p.y),this.setAttr("width",i.w),this.setAttr("height",i.h)}draw(i,t={}){if(!i)return this.setAttr("d","");let e={mark:this.attr("mark"),arrows:this.attr("arrows"),size:+this.attr("size")||void 0,fill:this.hasClass("fill"),round:this.hasAttr("round")};this.setAttr("d",oe(i,Object.assign(t,e)))}},Wp=class extends Ql{get viewBox(){return this._el.viewBox.baseVal||{width:0,height:0}}get $ownerSVG(){return this}get positionLeft(){return parseInt(this.css("margin-left"))+this.parent.positionLeft}get positionTop(){return parseInt(this.css("margin-top"))+this.parent.positionTop}get svgWidth(){return this.viewBox.width||this.width}get svgHeight(){return this.viewBox.height||this.height}drawPath(i,t={},e={}){let s=c("path",t,this);return s.draw(i,e),s}pngImage(i,t,e){return Ut(this,null,function*(){let s=this.copy(!0,!0,Jl);t||(t=i||this.svgHeight),i||(i=this.svgWidth),s.setAttr("width",i),s.setAttr("height",t),s.setAttr("viewBox",e||this.attr("viewBox")||`0 0 ${this.svgWidth} ${this.svgHeight}`),s.setAttr("xmlns","http://www.w3.org/2000/svg");let n=s.$$('image[href^="http"]');yield Promise.all(n.map(h=>Ut(this,null,function*(){let d=yield nn(h.attr("href")),p=c("canvas",{width:d.width,height:d.height});p.ctx.drawImage(d,0,0,d.width,d.height);let m=yield p.pngImage;h.setAttr("href",m)})));let r=new XMLSerializer().serializeToString(s._el),o=`data:image/svg+xml;utf8,${encodeURIComponent(r)}`,a=c("canvas",{width:i,height:t});a.ctx.fillStyle=Mt.css("background-color")||"white",a.ctx.fillRect(0,0,i,t);let l=yield nn(o);return a.ctx.drawImage(l,0,0,i,t),a.pngImage})}svgImage(i,t,e){return Ut(this,null,function*(){let s=this.copy(!0,!0,Jl);t||(t=i||this.svgHeight),i||(i=this.svgWidth),s.setAttr("width",i),s.setAttr("height",t),s.setAttr("viewBox",e||this.attr("viewBox")||`0 0 ${this.svgWidth} ${this.svgHeight}`),s.setAttr("xmlns","http://www.w3.org/2000/svg");let n=new XMLSerializer().serializeToString(s._el);return`data:image/svg+xml;utf8,${encodeURIComponent(n)}`})}downloadImage(i,t="png",e,s,n){let r=E.isIOS?window.open("","_blank"):void 0;this[t==="svg"?"svgImage":"pngImage"](e,s,n).then(a=>{if(r)return r.location.href=a;c("a",{download:i,href:a,target:"_blank"})._el.dispatchEvent(new MouseEvent("click",{view:window,bubbles:!1,cancelable:!0}))})}},th=class extends Qe{constructor(){super(...arguments);this.type="window"}get width(){return window.innerWidth}get height(){return window.innerHeight}get innerWidth(){return window.innerWidth}get innerHeight(){return window.innerHeight}get outerWidth(){return window.outerWidth}get outerHeight(){return window.outerHeight}get scrollWidth(){return document.body.scrollWidth}get scrollHeight(){return document.body.scrollHeight}get scrollTop(){return window.pageYOffset}set scrollTop(i){document.body.scrollTop=document.documentElement.scrollTop=i,this.trigger("scroll",{top:i,left:this.scrollLeft})}get scrollLeft(){return window.pageXOffset}set scrollLeft(i){document.body.scrollLeft=document.documentElement.scrollLeft=i,this.trigger("scroll",{top:this.scrollTop,left:i})}},Kp=class extends Qe{constructor(){super(...arguments);this.type="form"}get action(){return this._el.action}get formData(){let i={};for(let t of Array.from(this._el.elements)){let e=t.name||t.id;e&&(i[e]=t.value)}return i}get isValid(){return this._el.checkValidity()}},Xp=class extends Qe{constructor(){super(...arguments);this.type="input"}get checked(){return this._el.checked||!1}set checked(i){this._el.checked=i}get value(){return this._el.value}set value(i){this._el.value=i}bindVariable(i,t){let e=this._el.type==="number",s=this._el.type==="checkbox";if(t in i?s?this.checked=i[t]:this.value=i[t]:this.value&&(s?i[t]=this.checked:i[t]=this.value),e){let n=this.hasAttr("min")?+this.attr("min"):-Infinity,r=this.hasAttr("max")?+this.attr("max"):Infinity;this.change(o=>i[t]=T(+o,n,r)),this.on("blur",()=>this.value=i[t])}else s?this.on("change",()=>i[t]=this.checked):this.change(n=>i[t]=n);i.watch(()=>{s?this.checked=i[t]:this.value=i[t],this.trigger("model-change",{defaultPrevented:!0})})}setInputPattern(i){if(isNaN(+i))return;let t=i.match(/^[0-9]+$/);this.setAttr("inputmode",t?"numeric":"decimal"),t&&this.setAttr("pattern","[0-9]*")}change(i){let t=this.value||"";this.on("change keyup input paste model-change",e=>{this.value!==t&&(t=this.value.trim(),e.defaultPrevented||i(t))})}validate(i){this.change(t=>this.setValidity(i(t)))}setValidity(i){this._el.setCustomValidity(i)}get isValid(){return this._el.checkValidity()}},Yp=class extends Qe{constructor(){super(...arguments);this.type="canvas"}getContext(i="2d",t={}){return this._el.getContext(i,t)}get pngImage(){return this._el.toDataURL("image/png")}get canvasWidth(){return this._el.width}get canvasHeight(){return this._el.height}get ctx(){return this._ctx||(this._ctx=this.getContext()),this._ctx}draw(i,t={}){this.ctx.save(),ql(this.ctx,i,t),this.ctx.restore()}clear(){this.ctx.clearRect(0,0,this.canvasWidth,this.canvasHeight)}fill(i){this.ctx.save(),this.ctx.fillStyle=i,this.ctx.fillRect(0,0,this.canvasWidth,this.canvasHeight),this.ctx.restore()}clearCircle(i,t){this.ctx.save(),this.ctx.globalCompositeOperation="destination-out",this.ctx.beginPath(),this.ctx.arc(i.x,i.y,t,0,2*Math.PI,!1),this.ctx.fill(),this.ctx.restore()}downloadImage(i){let t=this.pngImage;c("a",{download:i,href:t,target:"_blank"})._el.dispatchEvent(new MouseEvent("click",{view:window,bubbles:!1,cancelable:!0}))}},Jp=class extends Qe{play(){return this._el.play()||Promise.resolve()}pause(){return this._el.pause()}},eh=["path","rect","circle","ellipse","polygon","polyline","g","defs","marker","line","text","tspan","pattern","mask","svg","foreignObject","image","use"];function R(i,t){if(!i)return;let e=t?t._el:document.documentElement,s=typeof i=="string"?e.querySelector(i):i;if(!s)return;if(s._view)return s._view;let n=(s.tagName||"").toLowerCase();return n==="svg"?new Wp(s):n==="canvas"?new Yp(s):n==="form"?new Kp(s):n==="input"||n==="select"||n==="textarea"?new Xp(s):n==="video"||n==="audio"?new Jp(s):eh.includes(n)?new Ql(s):new Qe(s)}function he(i,t){let e=t?t._el:document.documentElement,s=i?e.querySelectorAll(i):[];return Array.from(s,n=>R(n))}function c(i,t={},e){let s=eh.includes(i)?document.createElementNS("http://www.w3.org/2000/svg",i):document.createElement(i);for(let[r,o]of Object.entries(t))o!==void 0&&(r==="id"?s.id=o:r==="html"?s.innerHTML=o:r==="text"?s.textContent=o:r==="path"?s.setAttribute("d",oe(o)):s.setAttribute(r,o));let n=R(s);return e&&e.append(n),n}var X=new th(document.body),Mt=new th(document.documentElement),_t={backspace:8,tab:9,enter:13,shift:16,ctrl:17,alt:18,pause:19,capslock:20,escape:27,space:32,pageup:33,pagedown:34,end:35,home:36,left:37,up:38,right:39,down:40,insert:45,delete:46},un="_M",Vi=window.navigator.userAgent.toLowerCase(),ih={};for(let[i,t]of Object.entries(_t))ih[t]=i;var Qp=/android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i,sh=/iphone|ipad|ipod/i,tf=/^((?!chrome|android).)*safari/i,nh,ef=class{constructor(){this.isMobile=Qp.test(Vi),this.isRetina=(window.devicePixelRatio||1)>1,this.isTouch=!!window.Touch||"ontouchstart"in window,this.isChrome=!!window.chrome,this.isFirefox=Vi.indexOf("firefox")>=0,this.isAndroid=Vi.indexOf("android")>=0,this.isIOS=sh.test(Vi),this.isSafari=sh.test(Vi)||tf.test(Vi),this.loadQueue=[],this.loaded=!1,this.width=window.innerWidth,this.height=window.innerHeight,this.resizeCallbacks=[],this.theme={name:"light",isDark:!1},this.themeChangedCallbacks=[],this.themeOverride="",this.darkQuery=(nh=window.matchMedia)==null?void 0:nh.call(window,"(prefers-color-scheme: dark)");var i,t;window.onload=()=>this.afterLoad(),document.addEventListener("DOMContentLoaded",()=>this.afterLoad());let e=Zs(()=>this.applyResize());window.addEventListener("resize",e);try{(i=this.darkQuery)==null||i.addEventListener("change",()=>this.applyThemeChange())}catch(n){(t=this.darkQuery)==null||t.addListener(()=>this.applyThemeChange())}let s=this.getCookie("theme");s&&this.setTheme(s);try{this.localStorage=window.localStorage}catch(n){console.warn("Unable to access Local Storage in this context.")}}afterLoad(){if(!this.loaded){this.loaded=!0;for(let i of this.loadQueue)i();setTimeout(()=>this.resize())}}ready(i){this.loaded?i():this.loadQueue.push(i)}redraw(){document.body.offsetHeight}applyResize(){let i=window.innerWidth,t=window.innerHeight;if(!(this.width===i&&this.height===t)){this.width=i,this.height=t;for(let e of this.resizeCallbacks)e({width:this.width,height:this.height});X.trigger("scroll",{top:X.scrollTop})}}onResize(i){i({width:this.width,height:this.height}),this.resizeCallbacks.push(i)}offResize(i){let t=this.resizeCallbacks.indexOf(i);t>=0&&this.resizeCallbacks.splice(t,1)}resize(){this.applyResize()}applyThemeChange(){let i=this.theme.name,t=i==="dark"||i==="auto"&&this.darkQuery.matches;if(t!==this.theme.isDark){this.theme.isDark=t,Mt.setAttr("theme",this.themeOverride||(t?"dark":"light"));for(let e of this.themeChangedCallbacks)e(this.theme)}}setTheme(i){i!==this.theme.name&&(this.theme.name=i,this.setCookie("theme",i),this.applyThemeChange())}onThemeChange(i){this.themeChangedCallbacks.push(i)}getHash(){return window.location.hash.slice(1)}setHash(i){let t=document.body.scrollTop;window.location.hash=i,document.body.scrollTop=t}setURL(i,t=""){window.history.replaceState({},t,i),t&&(window.document.title=t)}getCookies(){let i=document.cookie.split(";"),t={};for(let e=0,s=i.length;e<s;++e){let n=i[e].split("=");t[decodeURIComponent(n[0]).trim()]=decodeURIComponent(n[1])}return t}getCookie(i){let t=document.cookie.match(new RegExp(`(^|;) ?${i}=([^;]*)(;|$)`));return t?t[2]:void 0}setCookie(i,t,e=60*60*24*365){let s=window.location.hostname.replace(/^[a-z]{2}\./,"");document.cookie=`${i}=${t};path=/;max-age=${e};domain=${s}`}deleteCookie(i){this.setCookie(i,"",-1)}setStorage(i,t){var e,s;let n=(i||"").split("."),r=Be(((e=this.localStorage)==null?void 0:e.getItem(un))||void 0,{}),o=r;for(let a=0;a<n.length-1;++a)o[n[a]]===void 0&&(o[n[a]]={}),o=o[n[a]];o[n[n.length-1]]=t,(s=this.localStorage)==null||s.setItem(un,JSON.stringify(r))}getStorage(i){var t;let e=Be((t=this.localStorage)==null?void 0:t.getItem(un),{});if(!i)return e;let s=(i||"").split("."),n=s.pop();for(let r of s){if(!(r in e))return;e=e[r]}return e[n]}deleteStorage(i){var t;i?this.setStorage(i,void 0):(t=this.localStorage)==null||t.setItem(un,"")}getActiveInput(){let i=document.activeElement;return(i==null?void 0:i.shadowRoot)&&(i=i.shadowRoot.activeElement),i===document.body?void 0:R(i)}onKey(i,t,e=!1){let s=ht(i),n=e?"keyup":"keydown";document.addEventListener(n,r=>{let o=ih[r.keyCode]||r.key;if(!s.includes(o))return;let a=this.getActiveInput();a&&a.is("input, textarea, [contenteditable]")||a&&["space","enter","tab"].includes(o)&&a.is("button, a, [tabindex]")||t(r,o)})}},E=window.BoostBrowser||new ef;window.BoostBrowser=E;var sf=/\bTrident\/[567]\b|\bMSIE (?:9|10)\.0\b/,nf=/\bAppleWebKit\/(\d+)\b/,rf=/\bEdge\/12\.(\d+)\b/,of=sf.test(navigator.userAgent)||+(navigator.userAgent.match(rf)||[])[1]<10547||+(navigator.userAgent.match(nf)||[])[1]<537,Gr={};function af(){if(!of)return;Array.from(document.querySelectorAll("svg > use")).forEach(function(t){let e=t.getAttribute("xlink:href"),[s,n]=e.split("#");if(!s.length||!n)return;let r=t.parentNode;r.removeChild(t),s in Gr||(Gr[s]=fetch(s).then(a=>a.text())),Gr[s].then(a=>{let l=document.implementation.createHTMLDocument("");l.documentElement.innerHTML=a;let d=l.getElementById(n).cloneNode(!0),p=document.createDocumentFragment();for(;d.childNodes.length;)p.appendChild(d.firstChild);r.appendChild(p)})})}function rh(){document.addEventListener("keydown",i=>{if(i.keyCode===_t.enter||i.keyCode===_t.space){let t=E.getActiveInput();t&&t.hasAttr("tabindex")&&t.tagName!=="TEXTAREA"&&(i.preventDefault(),t.trigger("pointerdown",i),t.trigger("pointerstop",i),X.trigger("pointerstop",i),t.trigger("click",i))}})}var dn=!1;setTimeout(()=>dn=!0);var lf="cubic-bezier(0.175, 0.885, 0.32, 1.275)",hf="cubic-bezier(0.68, -0.275, 0.825, 0.115)",ti={cancel:()=>{},promise:Promise.resolve()};function z(i,t){if(t===0)return i(1,0,()=>{}),ti;let e=Date.now(),s=Fs(),n=0,r=!0,o=()=>{r=!1,s.reject()};function a(){r&&(!t||n<=t)&&window.requestAnimationFrame(a);let l=Date.now()-e;i(t?Math.min(1,l/t):l,l-n,o),t&&l>=t&&s.resolve(),n=l}return a(),{cancel:o,promise:s.promise}}function pn(i,t=0,e=0){switch(i){case"quad":return t**2;case"cubic":return t**3;case"quart":return t**4;case"quint":return t**5;case"circ":return 1-Math.sqrt(1-t**2);case"sine":return 1-Math.cos(t*Math.PI/2);case"exp":return t<=0?0:Math.pow(2,10*(t-1));case"back":return e||(e=1.70158),t*t*((e+1)*t-e);case"elastic":return e||(e=.3),-Math.pow(2,10*(t-1))*Math.sin(((t-1)*2/e-.5)*Math.PI);case"swing":return .5-Math.cos(t*Math.PI)/2;case"spring":return 1-Math.cos(t*4.5*Math.PI)*Math.exp(-t*6);case"bounce":return t<1/11?1/64-7.5625*(.5/11-t)*(.5/11-t):t<3/11?1/16-7.5625*(2/11-t)*(2/11-t):t<7/11?1/4-7.5625*(5/11-t)*(5/11-t):1-7.5625*(1-t)*(1-t);default:return t}}function Y(i,t=0,e=0){if(t===0)return 0;if(t===1)return 1;let[s,n]=i.split("-");return n==="in"?pn(s,t,e):n==="out"?1-pn(s,1-t,e):t<=.5?pn(s,2*t,e)/2:1-pn(s,2*(1-t),e)/2}function kt(i,t,e=400,s=0,n="ease-in-out"){if(!dn)return Object.keys(t).forEach(w=>{let x=t[w];i.css(w,Array.isArray(x)?x[1]:x)}),ti;n==="bounce-in"&&(n=lf),n==="bounce-out"&&(n=hf);let r="";E.isSafari&&(r=i._el.style.transition,i.css("transition","none"),E.redraw());let o=i._data.animation;o&&o.cancel();let a={},l={},h=Fs(),d=window.getComputedStyle(i._el);Object.keys(t).forEach(w=>{let x=t[w],k=dl(w);l[k]=Array.isArray(x)?x[0]:d.getPropertyValue(w),a[k]=Array.isArray(x)?x[1]:x,s&&i.css(w,l[k])});let p=a.height;a.height==="auto"&&(a.height=`${N(i.children.map(w=>w.outerHeight))}px`);let m,g=!1;ts(()=>{g||(m=i._el.animate([l,a],{duration:e,easing:n,fill:"forwards"}),m.onfinish=()=>{i._el&&Object.keys(t).forEach(w=>i.css(w,w==="height"?p:a[w])),E.isSafari&&i.css("transition",r),h.resolve(),m.cancel()})},s);let M={cancel(){g=!0,i._el&&Object.keys(t).forEach(w=>i.css(w,i.css(w))),m&&m.cancel()},promise:h.promise};return setTimeout(()=>i._data.animation=M),M}var cf=/matrix\([0-9.\-\s]+,[0-9.\-\s]+,[0-9.\-\s]+,[0-9.\-\s]+,([0-9.\-\s]+),([0-9.\-\s]+)\)/;function Up(i,t="fade",e=500,s=0){if(i.show(),!dn)return ti;let n=+i.css("opacity")||1;if(t==="fade")return kt(i,{opacity:[0,n]},e,s);if(t==="pop"){let r=i.transform.replace(/scale\([0-9.]*\)/,"").replace(cf,"translate($1px,$2px)");return kt(i,{opacity:[0,n]},e,s),kt(i,{transform:[`${r} scale(0.5)`,`${r} scale(1)`]},e,s,"bounce-in")}else{if(t==="descend")return kt(i,{opacity:[0,1],transform:["translateY(-50%)","none"]},e,s);if(t.startsWith("draw")){let r=i.strokeLength;i.css("stroke-dasharray",`${r}px`),i.css("opacity")||i.css("opacity",1);let o=t==="draw-reverse"?`${2*r}px`:0,a={"stroke-dashoffset":[`${r}px`,o]},l=kt(i,a,e,s,"linear");return l.promise.then(()=>i.css("stroke-dasharray","")),l}else if(t.startsWith("slide")){let r={opacity:[0,n],transform:["translateY(50px)","none"]};return t.includes("down")&&(r.transform[0]="translateY(-50px)"),t.includes("right")&&(r.transform[0]="translateX(-50px)"),t.includes("left")&&(r.transform[0]="translateX(50px)"),kt(i,r,e,s)}else if(t.startsWith("reveal")){let r={opacity:[0,n],height:[0,"auto"]};return t.includes("left")&&(r.transform=["translateX(-50%)","none"]),t.includes("right")&&(r.transform=["translateX(50%)","none"]),kt(i,r,e,s)}}return ti}function jp(i,t="fade",e=400,s=0,n=!1){if(!i._el)return ti;if(!dn)return i.hide(),ti;if(i.css("display")==="none")return ti;let r;if(t==="fade")r=kt(i,{opacity:[1,0]},e,s);else if(t==="pop"){let o=i.transform.replace(/scale\([0-9.]*\)/,"");kt(i,{opacity:[1,0]},e,s),r=kt(i,{transform:[`${o} scale(1)`,`${o} scale(0.5)`]},e,s,"bounce-out")}else if(t==="ascend")r=kt(i,{opacity:[1,0],transform:["none","translateY(-50%)"]},e,s);else if(t.startsWith("draw")){let o=i.strokeLength;i.css("stroke-dasharray",o);let l={"stroke-dashoffset":[t==="draw-reverse"?`${2*o}px`:0,`${o}px`]};r=kt(i,l,e,s,"linear")}else if(t.startsWith("slide")){let o={opacity:0,transform:"translateY(50px)"};t.includes("up")&&(o.transform="translateY(-50px)"),r=kt(i,o,e,s)}else if(t.startsWith("reveal")){let o={opacity:0,height:0};t.includes("left")&&(o.transform="translateX(-50%)"),t.includes("right")&&(o.transform="translateX(50%)"),r=kt(i,o,e,s)}return r.promise.then(()=>n?i.remove():i.hide()),r}var uf=cl(["#cd0e66","#0f82f2","#22ab24","#fd8c00"]),df=class{constructor(i){this.index=i,this.color=uf(),this.tilt=Math.floor(Math.random()*10)-10,this.tiltAngleIncrement=Math.random()*.07+.05,this.tiltAngle=0,this.x=Math.random()*E.width,this.y=(Math.random()-1)*E.height,this.r=Tt.uniform(10,30)}draw(i){i.beginPath(),i.lineWidth=this.r/2,i.strokeStyle=this.color,i.moveTo(this.x+this.tilt+this.r/4,this.y),i.lineTo(this.x+this.tilt,this.y+this.tilt+this.r/4),i.stroke()}update(i,t){this.tiltAngle+=this.tiltAngleIncrement,this.y+=(Math.cos(i)+3+this.r/2)/2,this.x+=Math.sin(i),this.tilt=Math.sin(this.tiltAngle-this.index/3)*15,this.x<-20?(this.x=-20,this.y=Math.random()*E.height,this.tilt=Math.floor(Math.random()*10)-20):this.x>E.width+20?(this.x=E.width+20,this.y=Math.random()*E.height,this.tilt=Math.floor(Math.random()*10)-20):t&&this.y>E.height&&(this.x=Math.random()*E.width,this.y=-10,this.tilt=Math.floor(Math.random()*10)-20)}},pf="position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999",ei=void 0;function fn(i=2e3,t=150){ei||(ei=c("canvas",{style:pf},X)),ei.setAttr("width",E.width),ei.setAttr("height",E.height),ei.show();let e=ei.ctx,s=D(r=>new df(r),t),n=z(r=>{e.clearRect(0,0,E.width,E.height);let o=r<i,a=0;for(let l of s)l.draw(e),l.update(r,o),l.y<E.height&&(a+=1);a||(n.cancel(),ei.hide())})}var oh=class extends xi{constructor(i,t={}){super();this.$el=i,this.startPos=new u(0,0),this.position=new u(0,0),this.disabled=!1,this.options=Object.assign({moveX:!0,moveY:!0,withinBounds:!0},t),E.onResize(()=>this.updateBounds()),Rp(i,{start:()=>{this.disabled||(this.startPos=this.position,this.trigger("start"),Mt.addClass("grabbing"))},move:(e,s)=>{this.disabled||(this.setPosition(this.startPos.x+e.x-s.x,this.startPos.y+e.y-s.y),this.trigger("drag",{posn:this.position,pointerPosn:e}),this.checkTarget(e))},end:(e,s)=>{this.disabled||(this.trigger(e.equals(s)?"click":"end",{$target:this.$over}),this.options.$targets&&!this.$over&&this.options.resetOnMiss&&this.resetPosition(),this.$over=void 0,Mt.removeClass("grabbing"))},click:()=>this.trigger("click"),accessible:!0})}addTarget(i){var t;this.options.$targets||(this.options.$targets=[]),(t=this.options.$targets)==null||t.push(i)}removeTarget(i){var t,e;this.options.$targets=(t=this.options.$targets)==null?void 0:t.filter(s=>s!==i),((e=this.options.$targets)==null?void 0:e.length)||(this.options.$targets=void 0)}checkTarget(i){if(!this.options.$targets)return;let t=this.options.$targets.find(e=>e.boundsRect.contains(i));t!==this.$over&&(this.$over&&this.trigger("exit-target",{$target:this.$over}),t&&this.trigger("enter-target",{$target:t}),this.$over=t)}updateBounds(){if(!this.options.withinBounds)return this.bounds=void 0;if(this.options.bounds)return this.bounds=this.options.bounds;let i=this.bounds,t=this.options.$parent||this.$el.parent,e=t.type==="svg"?t.svgWidth:t.width,s=t.type==="svg"?t.svgHeight:t.height;this.bounds=new Vt(0,e,0,s),!e&&!s&&setTimeout(()=>this.updateBounds()),i&&this.setPosition(this.position.x*this.bounds.dx/i.dx||0,this.position.y*this.bounds.dy/i.dy||0)}setPosition(i,t){var e;let s=new u(this.options.moveX?i:0,this.options.moveY?t:0);this.bounds&&(s=s.clamp(this.bounds,(e=this.options.margin)!=null?e:0)),s=s.round(this.options.snap||1),this.options.round&&(s=this.options.round(s)),!s.equals(this.position)&&(this.position=s,this.options.useTransform?this.$el.translate(s.x,s.y):(this.options.moveX&&this.$el.css("left",`${s.x}px`),this.options.moveY&&this.$el.css("top",`${s.y}px`)),this.trigger("move",{posn:s}))}resetPosition(i=250){return Ut(this,null,function*(){let t=this.position;this.$el.css({"pointer-events":"none"}),yield z(e=>{let s=u.interpolate(t,this.startPos,e);this.setPosition(s.x,s.y)},i).promise,this.$el.css({"pointer-events":"initial"})})}},ff="position: fixed; top: 0; left: 0; width: 100%; height: 4px; background: #0f82f2; pointer-events: none; z-index: 9999; will-change: transform;";function ah(i,t){let e=t.regex.exec(i);if(e){e.shift();let s={};for(let[n,r]of t.params.entries())s[r]=e[n];return s}else return}function mf(i,t,e){return Ut(this,null,function*(){return i.template?typeof i.template=="string"?i.template:i.template(t):(yield fetch(e+(e.indexOf("?")>=0?"&xhr=1":"?xhr=1"))).text()})}var lh=document.readyState==="complete";window.addEventListener("load",()=>setTimeout(()=>lh=!0));"scrollRestoration"in window.history&&(window.history.scrollRestoration="manual");var gf=class extends xi{constructor(){super(...arguments);this.$viewport=X,this.views=[],this.active={path:"",hash:""},this.preloaded=!1,this.transition=!1,this.noLoad=!1,this.initialise=()=>{}}setup(i={}){i.$viewport&&(this.$viewport=i.$viewport),i.initialise&&(this.initialise=i.initialise),i.preloaded&&(this.preloaded=i.preloaded),i.transition&&(this.transition=i.transition),i.noLoad&&(this.noLoad=i.noLoad),i.click&&X.on("click",t=>this.onLinkClick(t)),i.history&&window.addEventListener("popstate",t=>Ut(this,null,function*(){var e;if(!lh||!((e=t.state)==null?void 0:e.path))return;(yield this.load(t.state.path,t.state.hash))||window.history.pushState(this.active,"",this.active.path+this.active.hash)}))}view(i,{enter:t,exit:e,template:s}={}){let n=(i.match(/:\w+/g)||[]).map(p=>p.substr(1)),r=`${i.replace(/:\w+/g,"([\\w-]+)").replace("/","\\/")}\\/?`,o=i.includes("?")?"":"(\\?.*)?",l={regex:new RegExp(`^${r}${o}$`,"i"),params:n,enter:t,exit:e,template:s};this.views.push(l);let h=window.location.pathname+window.location.search,d=ah(h,l);!d||(this.active={path:h,hash:window.location.hash},window.history.replaceState(this.active,"",this.active.path+this.active.hash),E.ready(()=>{setTimeout(()=>{this.preloaded?(this.initialise(this.$viewport,d),l.enter&&l.enter(this.$viewport,d)):this.loadView(l,d)})}))}paths(...i){for(let t of i)this.view(t)}getView(i){for(let t of this.views){let e=ah(i,t);if(e)return{view:t,params:e}}}load(i,t){return Ut(this,null,function*(){if(i===this.active.path&&t!==this.active.hash)return this.trigger("hashChange",t.slice(1)),this.trigger("change",i+t),this.active={path:i,hash:t},!0;let e=this.getView(i);return!e||this.beforeChange&&!(yield this.beforeChange())?!1:(this.active={path:i,hash:t},this.trigger("change",i+t),window.ga&&window.ga("send","pageview",i+t),this.noLoad?e.view.enter&&e.view.enter(this.$viewport,e.params):this.loadView(e.view,e.params),!0)})}loadView(i){return Ut(this,arguments,function*(t,e={}){this.showLoadingBar();let s=this.active.path,n=yield mf(t,e,s);if(this.active.path!==s)return;yield this.$viewport.animate({opacity:0},200).promise,this.$viewport.removeChildren(),X.scrollTop=0,this.$viewport.html=n,E.resize(),af(),this.$viewport.animate({opacity:1},200),this.hideLoadingBar();let r=this.$viewport.$("title");r&&(document.title=r.text),this.initialise(this.$viewport,e),t.enter&&t.enter(this.$viewport,e),this.trigger("afterChange",{$viewport:this.$viewport})})}onLinkClick(i){if(i.metaKey||i.ctrlKey||i.shiftKey||i.defaultPrevented)return;let t=i.target;for(;t&&t.nodeName!=="A";)t=t.parentNode;if(!t||t.nodeName!=="A")return;let e=t;if(e.target||e.origin!==window.location.origin||e.hasAttribute("download")||e.getAttribute("rel")==="external")return;let s=e.getAttribute("href");s&&s.indexOf("mailto:")>-1||this.getView(e.pathname+e.search)&&(i.preventDefault(),this.goTo(e.pathname+e.search,e.hash))}goTo(i,t=""){return Ut(this,null,function*(){let e=this.active.path+this.active.hash;(yield this.load(i,t))&&e!==this.active.path+this.active.hash&&window.history.pushState(this.active,"",i+t)})}replace(i,t=""){this.active={path:i,hash:t},window.history.replaceState(this.active,"",i+t)}back(){window.history.back()}forward(){window.history.forward()}showLoadingBar(){this.$loadingBar||(this.$loadingBar=c("div",{style:ff},X)),this.$loadingBar.css({transform:"translateX(-100%)",opacity:1}),this.$loadingBar.show(),this.animation=z(i=>{this.$loadingBar.css("transform",`translateX(-${10+90*Math.exp(-4*i)}%)`)},3e3)}hideLoadingBar(){return Ut(this,null,function*(){var i,t,e;(i=this.animation)==null||i.cancel(),yield(t=this.$loadingBar)==null?void 0:t.animate({transform:"none",opacity:0}).promise,(e=this.$loadingBar)==null||e.hide()})}},ns=new gf;function wf(i,t){let e=Array.from(i.childNodes);i.innerHTML=t;let s={};for(let n of Array.from(i.querySelectorAll("slot")))s[n.getAttribute("name")||""]=n;for(let n of e){let r=n.getAttribute&&n.getAttribute("slot")||"",o=s[r]||s[""];o&&o.parentNode.insertBefore(n,o)}for(let n of Object.values(s))n.parentNode.removeChild(n)}function hh(i){let t=[];for(let e of Array.from(i.children))e.tagName.startsWith("X-")?t.push(e):t.push(...hh(e));return t}var ch=new Map,yf=class extends HTMLElement{constructor(){super(...arguments);this.wasConnected=!1,this.isReady=!1}connectedCallback(){return Ut(this,null,function*(){if(this.wasConnected){this._view.trigger("connected");return}this.wasConnected=!0,this.isReady=!1,this._view.created();let i=ch.get(this._view.tagName)||{};i.template&&wf(this,i.template);let t=hh(this).filter(e=>!e.isReady).map(e=>new Promise(s=>e.addEventListener("ready",s)));yield Promise.all(t),this._view.ready(),this.dispatchEvent(new CustomEvent("ready")),this.isReady=!0})}disconnectedCallback(){this._view.trigger("disconnected")}},yt=class extends Qe{created(){}ready(){}};function vt(i,t={}){return function(e){class s extends yf{constructor(){super();this._view=new e(this)}}ch.set(i.toUpperCase(),t),window.customElements.define(i,s)}}function mn(i,t,e,s){let n,r;t:for(let[o,a]of e)for(let l of t){let h=(s?s(o,l):o).subtract(l),d=h.length;if(d<i&&(i=d,n=h,r=a,d<1))break t}return n?{shift:n,target:r}:void 0}function uh(i){if(gt(i))return[i];if(re(i))return i.points;if(Ci(i))return[i.p1,i.p2];if(st(i))return[i.c.shift(i.r,0),i.c.shift(-i.r,0),i.c.shift(0,i.r),i.c.shift(0,-i.r)];if(ye(i)||Ei(i)){let t=[i.start,i.end];ye(i)&&t.push(i.c);let e=i.radius;for(let[s,n]of[[e,0],[0,e],[-e,0],[0,-e]]){let r=i.c.shift(s,n);We.prototype.contains.call(i,r)&&t.push(r)}return t}return[]}function Oe(...i){return $.aroundPoints(function*(){for(let t of i)for(let e of uh(t))yield e}())}function gn(i,t,e=0){if(!i.size&&!t.size)return new Vt(0,100,0,100);let s=$.aroundPoints(function*(){for(let n of i.values())if(n.transformed)for(let r of uh(n.transformed))yield r;for(let n of t.values()){yield n.segments[0].p1;for(let r of n.segments)yield r.p2}}());return new Vt(s.p.x-e,s.p.x+s.w+e,s.p.y-e,s.p.y+s.h+e)}function rs(i,t,e){if(gt(t))return i.contains(t);if(tn(t))return P.collision(i.polygon,t);if(Ar(t))return t.collision(i);if(At(t))return It(t,i).length>0||i.contains(t.p1);if(st(t))return e==="geo"?It(t,i).length>0||i.contains(t.at(0)):t.collision(i);if(ye(t)){let s=new P(t.c,t.start,t.at(.25),t.at(.5),t.at(.75),t.end);return P.collision(i.polygon,s)}return!1}var Hr=class{constructor(t){this.$parent=t;this.visible=!1;this.$el=c("div",{class:"tile-error",hidden:!0},t.$html),this.$text=c("span",{},this.$el),this.$button=c("button",{text:"Select Errors"},this.$el),this.$button.on("click",()=>{t.selection.clear(),this.error&&t.selection.select(this.error.locations),this.hide()})}show(t,e){this.visible&&this.error===e||(this.visible=!0,this.$el.setTransform(t),this.$text.html=e.message,this.$button.toggle(!!(e==null?void 0:e.locations.length)),this.$el.enter("pop",200),this.error=e)}hide(){!this.visible||(this.visible=!1,this.$el.exit("pop",200),this.error=void 0)}},qr=new Map;function A(i){if(!i||!E.theme.isDark)return i;if(qr.has(i))return qr.get(i);let t=V.fromHex(i),e=t.hsl;W(e[2],20,80)||(e[2]=100-e[2]);let s=V.fromHsl(...e);s.a=t.a;let n=s.hex;return qr.set(i,n),n}function dh(i){let t=i==null?void 0:i.items;if(!!(t==null?void 0:t.length))for(let e=0;e<t.length;++e){if(!t[e].type.startsWith("image/"))continue;let s=t[e].getAsFile();if(s)return s}}function os(i,t,e){return i.hasAttr(t)?i.attr(t)!=="no":e}function wn(i,t){return At(i)?i.offset(t):st(i)?new pt(i.c,t).angle/2/Math.PI:Ei(i)?new St(i.start,i.c,t).rad/i.angle:.5}var vf=80,bf=[5,2,1];function as(i,t,e,s=.01){let n=i?i.split(","):[];if(n.length===3)return n.map(m=>+m);let r=n.length>0?+n[0]:e?e[0]:0,o=n.length>1?+n[1]:e?e[1]:t;if(b(r,o))return[r-1,o+1,1];s&&(o+=.01*(o-r));let a=Math.floor(Math.abs(t)/vf),l=(o-r)/a,h=Math.floor(Math.log10(l)),d=Math.pow(10,h),p=bf.find(m=>d*m<=l)*d;return o=p*Math.ceil(o/p),r=p*Math.floor(r/p),[r,o,p]}function yn(i,t=4e3){let e=R(`x-alert[key=${i}]`);return e==null?void 0:e.open(t)}function ph(i,t,e=Infinity,s){let n,r=e;for(let o of i){let a=t(o);if(a<r&&(n=o,r=a,s!==void 0&&r<s))return n}return n}var ki=class{constructor(...t){this.values=t}map(t){let e=this.values;return new ki(function*(){let s=0;for(let n of e)for(let r of n)yield t(r,s),s+=1}())}every(t){let e=0;for(let s of this.values)for(let n of s){if(!t(n,e))return!1;e+=1}return!0}some(t){let e=0;for(let s of this.values)for(let n of s){if(t(n,e))return!0;e+=1}return!1}slice(t,e){let s=this.values;return new ki(function*(){let n=0;for(let r of s)for(let o of r)n<t||e!==void 0&&n>t+e||(yield o,n+=1)}())}filter(t){let e=this.values;return new ki(function*(){let s=0;for(let n of e)for(let r of n)t(r,s)&&(yield r),s+=1}())}concat(t){this.values.push(t)}[Symbol.iterator](){let t=this.values;return function*(){for(let e of t)for(let s of e)yield s}()}static make(t,e){return new ki(function*(){let s=0;for(;e===void 0||s<e;)yield t(s),s+=1}())}};var fh=6,$f="M8.1-1.7l-14-8.8c-0.6-0.4-1.4-0.4-2-0.1c-0.6,0.4-1,1-1,1.7V8.8c0,0.7,0.4,1.4,1,1.7c0.3,0.2,0.6,0.3,1,0.3c0.4,0,0.7-0.1,1.1-0.3l14-8.8C8.6,1.3,9,0.7,9,0S8.6-1.3,8.1-1.7z",ls=!1;function mh(i){if(!Array.isArray(i))return mh([i,0]);let[t,e]=i;if(t instanceof u)return[[t,e]];if(st(t)&&(t=new $(t.c.shift(-t.r),2*t.r,2*t.r)),!(t instanceof P)&&!(t instanceof $))return[[y,0]];let s=t.edges.map(n=>[n.midpoint,n.perpendicularBisector.angle]);return es(s,e+1)}var zr=class{constructor(t,e,s){this.tile=t;this.name=e;this.options={};this.cables=new Set;s&&this.setOptions(s)}get location(){let t=this.options.location;return Array.isArray(t)?t[0]:t}get type(){return(this.location||this.tile.path)instanceof u?"POINT":"REGION"}get points(){let t=this.options.location||this.tile.path||y;return mh(t).map(e=>[this.tile.worldPosn(e[0]),e[1]])}setOptions(t,e=!0){Object.assign(this.options,t),e&&this.redraw()}redraw(){for(let t of this.cables)t.redraw()}},Br=class extends zr{sendMessage(t){for(let e of this.cables.values())e.enqueueMessage(t,!1);gh()}addCable(t,e=!1){this.cables.add(t),e&&this.tile.$parent.change({changed:[this.tile]}),!t.to&&!t.dragging&&this.cables.size>1&&this.removeCable(t,!1),this.redraw()}removeCable(t,e=!0){this.cables.delete(t),t.delete(),e&&this.redraw()}redraw(){if(Ve(this.cables,t=>t.to))for(let t of this.cables)!t.to&&!t.dragging&&this.removeCable(t);this.cables.size||this.addCable(new Ot(this)),super.redraw()}delete(){for(let t of this.cables)t.delete()}},Fr=class extends zr{setOptions(t,e=!0){Object.assign(this.options,t);let s=Array.isArray(t.location)?t.location[0]:t.location;s instanceof u?this.$dot=c("circle",{class:"link-dot persist",r:fh,cx:s.x,cy:s.y},this.tile.$el):this.$dot&&this.$dot.remove(),e&&this.redraw()}addCable(t,e){e&&this.tile.highlight(!0),this.cables.add(t),this.options.connect&&this.options.connect(t)}removeCable(t,e){var s,n;e&&this.tile.highlight(!1),(n=(s=this.options).disconnect)==null||n.call(s,t),this.cables.delete(t)}delete(){for(let t of this.cables)t.from.removeCable(t)}validateConnection(t){return Zr(t,this)}},Ur=[],jr=!1;function gh(){var t,e;if(jr)return;jr=!0;let i=0;for(;Ur.length;){if(i>=1e3)throw new Error("Queue overflow!");let[s,n]=Ur.shift();((t=s.to)==null?void 0:t.options.message)&&((e=s.to)==null||e.options.message(n,s)),i++}jr=!1}function Zr(i,t){if(i.tile===t.tile||t.options.max&&[...t.cables].filter(r=>r.from!==i||r.to!==t).length>=t.options.max)return!1;let e=t.options.tileTypes;if(e){let n=i.tile.type;if(!e.includes(n))return!1}let s=i.options.tileTypes;if(s){let n=t.tile.type;if(!s.includes(n))return!1}return!0}var Ot=class{constructor(t,e){this.from=t;this.to=e;this.dragging=!1;let s=this.from.tile.$parent,n=t.options.persistent?"":"dashed";this.$group=c("g",{class:"link-bar",style:"display:none"},s.$cables),this.$line=c("path",{style:"pointer-events: none",class:n},this.$group),this.$originDot=c("circle",{class:"link-dot",r:fh},this.$group),this.$handle=c("path",{class:"link-handle",d:$f},this.$group),this.connectTo(e),s.events.listen(this.$handle,{start:()=>{s.selection.add(t.tile,!0),ls=this.dragging=!0},move:({posn:o})=>{this.connectTo(s.getInputAt(o,this.from),o)},end:()=>{ls=this.dragging=!1,this.to&&this.to.tile.highlight(!1),this.redraw(),t.addCable(this,!0)}});let r;s.events.listen(this.$originDot,{start:()=>{s.selection.add(t.tile,!0),r=new Ot(this.from),ls=r.dragging=!0,this.from.addCable(r)},move:({posn:o})=>{r.connectTo(s.getInputAt(o,this.from),o)},end:()=>{r.to&&r.to.tile.highlight(!1),r.redraw(),ls=r.dragging=!1,t.addCable(r,!0),r=void 0}})}connectTo(t,e){this.to&&this.to!==t&&this.to.removeCable(this,!0),t?Zr(this.from,t)&&(this.to=t,t.addCable(this,e!==void 0),this.from.options.connect&&this.from.options.connect(this)):this.to=void 0,this.redraw(e)}redraw(t){var M;if(!(this.from.options.persistent||this.from.tile.isActive||((M=this.to)==null?void 0:M.tile.isActive)))return this.$group.hide();if(this.from.tile.$parent.$cables.append(this.$group),this.$group.show(),!this.to&&!t){let[w,x]=this.from.points[0],k=x+this.from.tile.rot*F,v=new _(y,20).at(k/(Math.PI*2));this.$handle.setTransform(w.add(v),k),this.$line.setAttr("d",""),this.$originDot.hide();return}let s=this.to?this.to.points:[[t,0]],n=gr(this.from.points,s),[r,o]=Fe(n,([w,x])=>u.distance(w[0],x[0])),a=o[1]+(this.to?this.to.tile.rot*F:Math.PI),l=this.to?new _(y,10).at(a/(Math.PI*2)):y,h=o[0].add(l),d=u.distance(r[0],h),p=Math.max(d*.7,40),m=r[0].add(u.fromPolar(r[1]+this.from.tile.rot*F,d*.7)),g=o[0].add(u.fromPolar(a,p));this.$line.setAttr("d",`M${h.x} ${h.y}C${g.x} ${g.y},${m.x} ${m.y},${r[0].x} ${r[0].y}`),this.$handle.setTransform(h,a+Math.PI),this.$originDot.setTransform(r[0]),this.$originDot.show()}delete(){this.connectTo(),this.$group.remove()}enqueueMessage(t,e=!0){if(Ur.push([this,t]),e&&gh(),!this.from.options.highlights)return;let n=t.type==="number"&&t.value===1?E.theme.isDark?"#eef":"#9eccfa":f.blue;this.$line.setAttr("style",`stroke: ${n};`),this.$handle.setAttr("style",`stroke: ${n}; fill: ${n};`)}serialize(){return this.to?{fromPort:this.from.name,toTileId:this.to.tile.id,toPort:this.to.name}:void 0}static unSerialize(t,e,s){var o,a;let n=s.tiles.get(t),r=s.tiles.get(e.toTileId);if(n&&r){let l=(o=n.outPorts)==null?void 0:o.get(e.fromPort||"main"),h=(a=r.inPorts)==null?void 0:a.get(e.toPort||"main");l&&h&&Zr(l,h)&&l.addCable(new Ot(l,h))}}static get isMoving(){return ls}};var nt=180/Math.PI,F=Math.PI/180,f={grey:"#cccccc",darkGrey:"#242436",red:"#cd0e66",orange:"#eb4726",yellow:"#fd8c00",lime:"#bfc212",green:"#22ab24",teal:"#009ea6",blue:"#0f82f2",purple:"#6d3bbf"},xf="M12.5,0H0V25H12.5a12.5,12.5,0,0,0,0-25Z",Tf="M0,0V12.5a12.5,12.5,0,0,0,25,0V0Z",Sf="M22.1,19.5l-9.2-16a1,1,0,0,0-1.8,0l-9.2,16A1,1,0,0,0,2.7,21H21.3A1,1,0,0,0,22.1,19.5Zm-8.7-11v2.4l-.4,4.4H11.1l-.4-4.4V8.5ZM12,19.4a1.6,1.6,0,0,1-1.6-1.6,1.6,1.6,0,1,1,3.2,0A1.6,1.6,0,0,1,12,19.4Z",vn=new Map,S=class{constructor(t,e,s){this.$parent=t;this.options="";this.colour="";this.posn=y;this.rot=0;this.snapAngles=[0,90];this.canDragToSelect=!0;this.canRotate=!0;this.canMove=!0;this.$el=s||c("g",{class:"tile"},t.$tiles[2]),this.id=e||Ae(10),t.tiles.set(this.id,this),vn.set(this.$el._el,this)}makeHandle(t,e,s){let r=c(t==="c"?"circle":"path",{class:"handle"},this.$el);t==="h"&&r.setAttr("d",xf),t==="v"&&r.setAttr("d",Tf),t==="c"&&r.setAttr("r",10);let o="",a;return this.$parent.events.listen(r,{start:()=>{this.$parent.selection.add(this,!0),o=this.options,a=this.size},move:({posn:l})=>e(this.relativePosn(l),l),click:()=>s==null?void 0:s(),end:()=>{(this.options!==o||this.size!==a)&&this.$parent.change({changed:[this]})}}),r}is(t){return this.type===t}setColour(t,e){this.colour=t}setSize(t){this.size=t}setOrder(t){t!==this.order&&(this.order=t,this.$container.append(this.$el))}lock(t=!0){t!==!!this.locked&&(this.$el.css("pointer-events",t?"none":"all"),this.locked=t,t&&this.$parent.selection.remove(this))}hide(t=!0){t!==!!this.hidden&&(this.$el.toggle(!t),this.hidden=t,t&&this.$parent.selection.remove(this))}flip(t){this.flipped=!this.flipped}click(t){}doubleClick(t){}format(t){}blur(){}get $container(){let t=this.order==="back"?0:this.order==="front"?2:1;return this.$parent.$tiles[t*2+(this.isActive?1:0)]}select(){this.isActive=!0,this.$el.addClass("active"),this.$container.append(this.$el),this.redrawCables()}deselect(){this.isActive=!1,this.$el.removeClass("active"),this.$container.append(this.$el),this.redrawCables()}redrawCables(){var t,e;for(let s of((t=this.inPorts)==null?void 0:t.values())||[])s.redraw();for(let s of((e=this.outPorts)==null?void 0:e.values())||[])s.redraw()}watchPolypadOptions(t){this.polypadOptionCallbacks||(this.polypadOptionCallbacks=[]),this.polypadOptionCallbacks.push(t),this.$parent.options.watch(t)}moveStart(){this.startPosn=this.posn}move(t,e){t&&(this.posn=this.startPosn.add(t),this.transform(!0))}showErrorIcon(t){var e;if(this.currentError=t,!t)return(e=this.$errorIcon)==null?void 0:e.detach();this.$errorIcon||(this.$errorIcon=c("g",{style:"cursor: pointer"}),c("circle",{cx:12,cy:12,r:12,fill:"transparent"},this.$errorIcon),c("path",{d:Sf,fill:f.yellow},this.$errorIcon),this.transform(),this.$parent.events.listen(this.$errorIcon,{click:()=>{let s=this.$errorIcon.transformMatrix,n=this.posn.shift(s[0][2],s[1][2]);this.$parent.warningBanner.show(n,this.currentError)}})),this.$el.append(this.$errorIcon)}moveEnd(){this.collision&&this.collide(this.collision)}highlight(t=!0){}findNearby(t,e,s=this.posn){for(let n of this.$parent.tiles.values())if(n!==this&&n.is(t)&&u.distance(s,n.posn)<e)return n}setCollision(t){var e;t&&t===this.collision||((e=this.collision)==null||e.highlight(!1),this.collision=t,t==null||t.highlight(!0))}collide(t){}transform(t=!1){var s;let e=this.rot*F;this.$el.setTransform(this.posn,e),this.customTransform(this.posn,e),this.redrawCables(),!t&&this.path&&(this.transformed=this.path.rotate(e).translate(this.posn),this.snapPoints=this.getSnapPoints().map(n=>n.rotate(e).translate(this.posn)),this.snapLines=this.getSnapLines().map(n=>n.rotate(e).translate(this.posn)),(s=this.$errorIcon)==null||s.setTransform(Oe(this.path).p.shift(-28,5)))}customTransform(t,e){}setTransform(t,e=this.rot){this.posn=t,this.rot=ct(e,360),this.transform()}animateTo(t,e=this.posn,s=400){return this.setTransform(t),z(n=>{n=Y("sine",n),this.$el.setTransform(u.interpolate(e,t,n),this.rot*F)},s).promise}static makeThumbnail(t,e,s,n){}getSnapPoints(){return this.path?gt(this.path)?[this.path]:re(this.path)?this.path.points:At(this.path)?[this.path.p1,this.path.p2]:st(this.path)?[this.path.c,this.path.c.shift(0,this.path.r),this.path.c.shift(0,-this.path.r),this.path.c.shift(this.path.r,0),this.path.c.shift(-this.path.r,0)]:ye(this.path)?[this.path.c,this.path.start,this.path.end]:Ei(this.path)?[this.path.start,this.path.end]:[]:[]}getSnapLines(){return[]}delete(){var t,e;for(let s of this.polypadOptionCallbacks||[])this.$parent.options.unwatch(s);this.$parent.selection.remove(this);for(let s of((t=this.inPorts)==null?void 0:t.values())||[])s.delete();for(let s of((e=this.outPorts)==null?void 0:e.values())||[])s.delete();this.$parent.tiles.delete(this.id),this.$parent.mathContext.removeSource(this),vn.delete(this.$el._el),this.$el.remove()}copy(t={},e=25){let s=new this.constructor(this.options,this.$parent);return this.colour&&s.setColour(this.colour),this.flipped&&s.flip(),s.setTransform(this.posn.shift(e,e),this.rot),this.size&&s.setSize(this.size),s}relativePosn(t){return t.subtract(this.posn).rotate(-this.rot*F)}worldPosn(t){return t.rotate(this.rot*F).add(this.posn)}get center(){return this.path?Oe(this.path).center:y}get ariaDescription(){return`${this.type}: ${this.options}`}static action(t,e,s){}applyChange(t){var e,s,n,r,o,a;if(t.options!==this.options){let l=[...t.cables||this.getCableData("out"),...this.getCableData("in")];this.delete(),t=Object.assign(this.serialize(),t);let h=S.unSerialize(t,this.$parent);for(let d of l)Ot.unSerialize(h.id,d,this.$parent);return}if((t.x||t.y||t.rot)&&this.setTransform(new u((s=(e=t.x)!=null?e:this.posn.x)!=null?s:0,(r=(n=t.y)!=null?n:this.posn.y)!=null?r:0),(a=(o=t.rot)!=null?o:this.rot)!=null?a:0),t.colour&&t.colour!==this.colour&&this.setColour(t.colour),!t.flipped!=!this.flipped&&this.flip(),!t.locked!=!this.locked&&this.lock(!!t.locked),!t.hidden!=!this.hidden&&this.hide(!!t.hidden),this.fixed=!!t.fixed,t.size&&t.size!==this.size&&this.setSize(t.size),t.order!==this.order&&this.setOrder(t.order),t.cables){for(let l of this.getCables("out"))l.from.removeCable(l);for(let l of t.cables)Ot.unSerialize(this.id,l,this.$parent)}this.serialize()}makeInPort(t,e){this.inPorts||(this.inPorts=new Map),this.inPorts.has(t)||this.inPorts.set(t,new Fr(this,t));let s=this.inPorts.get(t);return s.setOptions(e,!1),s}makeOutPort(t,e){this.outPorts||(this.outPorts=new Map),this.outPorts.has(t)||this.outPorts.set(t,new Br(this,t));let s=this.outPorts.get(t);return s.setOptions(e,!1),s}deleteInPort(t){var e;typeof t=="string"&&(t=(e=this.inPorts)==null?void 0:e.get(t)),!(!t||!this.inPorts)&&(this.inPorts.delete(t.name),t.delete())}deleteOutPort(t){var e;typeof t=="string"&&(t=(e=this.outPorts)==null?void 0:e.get(t)),!(!t||!this.outPorts)&&(this.outPorts.delete(t.name),t.delete())}emitMessage(t,e){var s;typeof t=="string"&&(t=(s=this.outPorts)==null?void 0:s.get(t)),t==null||t.sendMessage(e)}*getCables(t){let e=t==="in"?this.inPorts:this.outPorts;if(!!e)for(let s of e.values())for(let n of s.cables)n.to&&(yield n)}*getCableData(t){for(let e of this.getCables(t))yield e.serialize()}getPortAt(t,e){if(!this.inPorts)return;t=this.relativePosn(t);let s=Array.from(this.inPorts.values()).filter(r=>!e||r.validateConnection(e));for(let r of s.filter(o=>o.type==="REGION"))if((r.location||this.path).contains(t))return r;let n=s.filter(r=>r.type==="POINT");return ph(n,r=>u.distance(t,r.location))}serialize(){return this.lastSavedData={id:this.id,name:this.type,options:this.options,x:this.posn.x,y:this.posn.y,rot:this.rot,size:this.size||void 0,flipped:this.flipped||void 0,locked:this.locked||void 0,fixed:this.fixed||void 0,hidden:this.hidden||void 0,order:this.order,colour:this.colour,cables:Array.from(this.getCableData("out"))}}static unSerialize(t,e,s=!1){if(!(t==null?void 0:t.name))return;let n=e.newTile(t.name,t.options||"",s?void 0:t.id);return t.flipped&&n.flip(),n.setTransform(new u(t.x,t.y),t.rot),t.colour&&n.setColour(t.colour),t.size&&n.setSize(t.size),n.setOrder(t.order||void 0),t.hidden&&n.hide(!0),t.fixed&&(n.fixed=!0),t.locked&&n.lock(),n.lastSavedData=t,n}};var H=class{constructor(t=0,e=0,s=0){this.x=t;this.y=e;this.z=s}transform(t){if(t instanceof bn&&(t=t.matrix),t.length!==4||t[0].length!==4)throw new Error("Must use a 4x4 matrix for 3D transforms!");let[[e],[s],[n],[r]]=ot.product(t,[[this.x],[this.y],[this.z],[1]]);return new H(e/r,s/r,n/r)}equals(t){return b(this.x,t.x)&&b(this.y,t.y)&&b(this.z,t.z)}fixFloat(){return new H(b(this.x,0)?0:this.x,b(this.y,0)?0:this.y,b(this.z,0)?0:this.z)}add(t){return this.x+=t.x||0,this.y+=t.y||0,this.z+=t.z||0,this}multiply(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this}lerp(t,e){return new H(it(this.x,t.x||0,e),it(this.y,t.y||0,e),it(this.z,t.z||0,e))}scale(t){return new H(this.x*t,this.y*t,this.z*t)}get magnitude(){return Math.hypot(this.x,this.y,this.z)}get normalize(){return this.scale(1/this.magnitude)}get asArray(){return[this.x,this.y,this.z]}get inverse(){return new H(-this.x,-this.y,-this.z)}get xy(){return new u(this.x,this.y)}[Symbol.iterator](){return this.asArray.values()}static get zero(){return new H(0,0,0)}static get oneZ(){return new H(0,0,1)}static get one(){return new H(1,1,1)}static all(t){return new H(t,t,t)}static from2D(t){return new H(t.x,t.y,0)}static average(t){return new H(Si(t.map(e=>e.x)),Si(t.map(e=>e.y)),Si(t.map(e=>e.z)))}static dot(t,e){return t.x*e.x+t.y*e.y+t.z*e.z}static cross(t,e){let s=t.y*e.z-t.z*e.y,n=t.z*e.x-t.x*e.z,r=t.x*e.y-t.y*e.x;return new H(s,n,r)}};var U={translate({x:i,y:t,z:e}){return[[1,0,0,i],[0,1,0,t],[0,0,1,e],[0,0,0,1]]},rotateX(i){let t=Math.cos(i),e=Math.sin(i);return[[1,0,0,0],[0,t,-e,0],[0,e,t,0],[0,0,0,1]]},rotateY(i){let t=Math.cos(i),e=Math.sin(i);return[[t,0,e,0],[0,1,0,0],[-e,0,t,0],[0,0,0,1]]},rotateZ(i){let t=Math.cos(i),e=Math.sin(i);return[[t,-e,0,0],[e,t,0,0],[0,0,1,0],[0,0,0,1]]},rotateAxis({x:i,y:t,z:e},s){let n=Math.hypot(i,t,e);n=1/n,i*=n,t*=n,e*=n;let r=Math.sin(s),o=Math.cos(s),a=1-o;return[[i*i*a+o,i*t*a-e*r,i*e*a+t*r,0],[t*i*a+e*r,t*t*a+o,t*e*a-i*r,0],[e*i*a-t*r,e*t*a+i*r,e*e*a+o,0],[0,0,0,1]]},fromEulerAngles(i,t,e){return ot.product(U.rotateX(i),U.rotateY(t),U.rotateZ(e))},scale({x:i,y:t,z:e}){return[[i,0,0,0],[0,t,0,0],[0,0,e,0],[0,0,0,1]]},scaleAll(i){return[[i,0,0,0],[0,i,0,0],[0,0,i,0],[0,0,0,1]]},perspective(i,t,e,s){let n=e*Math.tan(Math.PI/180*i/2),r=-n,o=n*t,a=-o;return[[2*e/(o-a),0,(o+a)/(o-a),0],[0,2*e/(n-r),(n+r)/(n-r),0],[0,0,-((s+e)/(s-e)),-(2*s*e/(s-e))],[0,0,-1,0]]},transformPoint(i,t){return t instanceof H?t.transform(i):new H(t.x,t.y).transform(i)}},bn=class{constructor(){this.matrix=ot.identity(4)}clear(){return this.matrix=ot.identity(4),this}translate(t=0,e=0,s=0){return this.matrix=ot.product(this.matrix,U.translate({x:t,y:e,z:s})),this}rotate(t=0,e=0,s=0){return this.matrix=ot.product(this.matrix,U.rotateZ(s),U.rotateY(e),U.rotateX(t)),this}scale(t){return this.matrix=ot.product(this.matrix,U.scale(t)),this}dragToRotate(t,e,s=100){let n=new H(t.x,t.y,s**3/(s**2+t.length**2)).normalize,r=new H(e.x,e.y,s**3/(s**2+e.length**2)).normalize,o=T(H.dot(n,r),-1,1),a=H.cross(n,r),l=U.rotateAxis(a,2*Math.acos(o));return this.matrix=ot.product(l,this.matrix),this}isRotationMatrix(){if(!b(ot.determinant(this.matrix),1))return!1;let t=ot.transpose(this.matrix);return ot.product(this.matrix,t).every((s,n)=>s.every((r,o)=>b(r,n===o?1:0)))}toEulerAngles(){let t=this.matrix,e=Math.sqrt(t[0][0]*t[0][0]+t[1][0]*t[1][0]);if(b(e,0)){let a=Math.atan2(-t[1][2],t[1][1]),l=Math.atan2(-t[2][0],e);return[a,l,0]}let n=Math.atan2(t[2][1],t[2][2]),r=Math.atan2(-t[2][0],e),o=Math.atan2(t[1][0],t[0][0]);return[n,r,o]}};var Mf=new V(0,0,0);function Pf(i){let t=i.r,e=i.c.x,s=i.c.y,n=.5523*t;return`M${e} ${s-t}C${e+n} ${s-t} ${e+t} ${s-n} ${e+t} ${s}C${e+t} ${s+n} ${e+n} ${s+t} ${e} ${s+t}C${e-n} ${s+t} ${e-t} ${s+n} ${e-t} ${s}C${e-t} ${s-n} ${e-n} ${s-t} ${e} ${s-t}`}var Wr=class{constructor(){this.transform=new bn;this.visible=!0}getTransformed(t){let e=this;do t=t.transform(e.transform);while(e=e.parent);return t}get normal(){return this.getTransformed(H.oneZ).add(this.getTransformed(H.zero).inverse).normalize}project(t,e={fov:120}){if(e.fov===!1)return new u(t.x,t.y);let s=Math.exp(t.z/e.fov);return new u(t.x*s,t.y*s)}*getProjectedVertices(t){for(let e of this.getVertices())yield this.project(e,t)}},Wt=class extends Wr{constructor(t,e={},s){super();this.children=[];this.sorting=!1;this.$el=c("g",e,s);for(let n of t)this.addChild(n)}addChild(t){return t.parent&&t.parent.removeChild(t),this.children.push(t),this.$el&&t.$el&&this.$el.append(t.$el),t.parent=this,t}removeChild(t){let e=this.children.indexOf(t);e>=0&&this.children.splice(e,1),t.$el&&t.$el.remove(),t.parent=void 0}render(t){if(!!this.visible){if(this.sorting)for(let e of Us(this.children,s=>s.zIndex))this.$el.append(e.$el);for(let e of this.children)e.render(t)}}*getFaces(){for(let t of this.children)for(let e of t.getFaces())yield e}*getVertices(){for(let t of this.children)for(let e of t.getVertices())yield e}get zIndex(){return Si(this.children.map(t=>t.zIndex))}},Gt=class extends Wr{constructor(t,e={},s){super();this.shape=t;if(t==null)this.commands=[];else if(typeof t=="string")this.commands=hn(t);else{let r=st(t)?Pf(t):oe(t);this.commands=hn(r)}let n=u.average(...this.commands.filter(r=>r.points.length).map(r=>u.average(...r.points)));this.centroid=new H(n.x,n.y,0),s&&(this.color=s),this.$el=c("path",e)}render(t){if(!this.visible)return;if(t==null?void 0:t.hideBackface){let s=this.getTransformed(H.zero).z>0;if(this.$el.toggle(s),!s)return}if(this.color){let s=V.mix(this.color,Mf,(Math.abs(this.normal.z)+1)/2);this.$el.setAttr("fill",s),this.$el.setAttr("stroke",s)}let e=this.commands.map(s=>{let n=s.points.map(r=>{let o=this.project(this.getTransformed(new H(r.x,r.y)),t);return`${o.x},${o.y}`});return s.type+n.join(",")}).join("");this.$el.setAttr("d",e)}get zIndex(){return this.getTransformed(this.centroid).z}*getFaces(){yield this}*getVertices(){if(!(typeof this.shape=="string"||!re(this.shape)))for(let t of this.commands)for(let e of t.points)yield this.getTransformed(new H(e.x,e.y))}};var B=P.regular(3),Oi=P.regular(4),Kt=P.regular(5),$n={shape:B,children:[{shape:B,dihedral:70.53,rot:180},{shape:B,dihedral:70.53,parentEdge:1,rot:300},{shape:B,dihedral:70.53,parentEdge:2,rot:60}]},xn={shape:Oi,children:[{shape:Oi,dihedral:90,myEdge:2,children:[{shape:Oi,dihedral:90,myEdge:2}]},{shape:Oi,dihedral:90,parentEdge:1,rot:270},{shape:Oi,dihedral:90,parentEdge:2},{shape:Oi,dihedral:90,parentEdge:3,rot:90}]},Tn={shape:B,children:[{shape:B,dihedral:109.47,rot:180},{shape:B,dihedral:109.47,parentEdge:1,rot:300,children:[{shape:B,dihedral:109.47,parentEdge:1,rot:300}]},{shape:B,dihedral:109.47,parentEdge:2,rot:60,children:[{shape:B,dihedral:109.47,parentEdge:1,rot:300},{shape:B,dihedral:109.47,parentEdge:2,rot:60,children:[{shape:B,dihedral:109.47,parentEdge:1,rot:300}]}]}]},Sn={shape:Kt,children:[{shape:Kt,dihedral:116.57,rot:180},{shape:Kt,dihedral:116.57,parentEdge:1,rot:252},{shape:Kt,dihedral:116.57,parentEdge:2,rot:324},{shape:Kt,dihedral:116.57,parentEdge:3,rot:36},{shape:Kt,dihedral:116.57,parentEdge:4,rot:108,children:[{shape:Kt,dihedral:116.57,parentEdge:2,rot:324,children:[{shape:Kt,dihedral:116.57,parentEdge:3,rot:36,children:[{shape:Kt,dihedral:116.57,parentEdge:1,rot:252},{shape:Kt,dihedral:116.57,parentEdge:2,rot:324},{shape:Kt,dihedral:116.57,parentEdge:3,rot:36},{shape:Kt,dihedral:116.57,parentEdge:4,rot:108}]}]}]}]},Mn={shape:B,children:[{shape:B,dihedral:138.19,rot:180},{shape:B,dihedral:138.19,parentEdge:1,rot:300,children:[{shape:B,dihedral:138.19,parentEdge:1,rot:300,children:[{shape:B,dihedral:138.19,parentEdge:2,rot:60,children:[{shape:B,dihedral:138.19,parentEdge:1,rot:300,children:[{shape:B,dihedral:138.19,parentEdge:1,rot:300}]},{shape:B,dihedral:138.19,parentEdge:2,rot:60}]},{shape:B,dihedral:138.19,parentEdge:1,rot:300}]},{shape:B,dihedral:138.19,parentEdge:2,rot:60}]},{shape:B,dihedral:138.19,parentEdge:2,rot:60,children:[{shape:B,dihedral:138.19,parentEdge:2,rot:60,children:[{shape:B,dihedral:138.19,parentEdge:1,rot:300,children:[{shape:B,dihedral:138.19,parentEdge:2,rot:60,children:[{shape:B,dihedral:138.19,parentEdge:1,rot:300,children:[{shape:B,dihedral:138.19,parentEdge:1,rot:300}]},{shape:B,dihedral:138.19,parentEdge:2,rot:60}]},{shape:B,dihedral:138.19,parentEdge:1,rot:300}]},{shape:B,dihedral:138.19,parentEdge:2,rot:60}]},{shape:B,dihedral:138.19,parentEdge:1,rot:300}]}]};function wh(i,t,e){let s=P.regular(i).scale(t*Pt(i)),n=new $(y,t,e).polygon,r=[{shape:s,rot:180,parentEdge:2}],o=D(a=>({shape:n,parentEdge:a,rot:360/i*a,children:a?void 0:r}),i);return{shape:s,children:o}}function yh(i,t,e){let s=P.regular(i).scale(t*Pt(i)),n=new P(new u(-t/2,0),new u(t/2,0),new u(0,-e)),r=nt*Math.acos(t/e/2/Math.tan(Math.PI/i)),o=D(a=>({shape:n,dihedral:r,parentEdge:a,rot:180+360/i*a}),i);return{shape:s,children:o}}var Cf=ot.identity(4);function vh(i,t,e,s){var g;let n=t.shape.edges[i.parentEdge||0],r=i.shape.edges[i.myEdge||0],o=(i.dihedral||90)/nt,a=s(i);e.addChild(a);let l=H.from2D(n.midpoint),h=H.from2D(r.midpoint),d=H.from2D(n.unitVector),p=i.rot?i.rot*F:0,m=((g=i.children)==null?void 0:g.map(M=>vh(M,i,e,s)))||[];return[a,l,h,d,p,o,m]}function hs(i,t,e=1){var o;let s=t(i),n=new Wt([s]);n.sorting=!0;let r=((o=i.children)==null?void 0:o.map(a=>vh(a,i,n,t)))||[];return Kr(r,n,e),{group:new Wt([n]),foldTree:r}}function bh(i,t,e=Cf){let[s,n,r,o,a,l,h]=i,d=it(Math.PI,l,t),p=U.rotateAxis(o,Math.PI-d);a&&(p=ot.product(p,U.rotateZ(a)));let m=r.transform(p),g=U.translate(m.inverse.add(n));s.transform.matrix=ot.product(e,g,p);for(let M of h||[])bh(M,t,s.transform.matrix)}function Kr(i,t,e){t.transform.clear();for(let r of i)bh(r,e);let s=Array.from(t.getFaces()).map(r=>r.getTransformed(r.centroid)),n=H.average(s).inverse;t.transform.translate(n.x,n.y,n.z)}function Ef(i,t,e){let s=Math.cos(i),n=Math.cos(t),r=Math.cos(e),o=Math.sin(t),a=Math.acos((r-s*n)/(Math.sin(i)*o)),l=Math.acos((s-n*r)/(o*Math.sin(e)));return[a,l]}function $h(i,t){return Math.asin(Math.cos(i*t)/Math.cos(i/2))}var Af=[60,90,108],Vf=[{internal:[60,90,90,90],dihedral:[144.74,135,135,135]},{internal:[60,60,60,60,90],dihedral:[153.23,153.23,153.23,142.98,142.98]},{internal:[60,90,108,90],dihedral:[159.09,148.28,148.28,159.09]},{internal:[60,60,60,60,108],dihedral:[164.18,164.18,152.93,152.93,152.93]}];function kf(...i){let t=i.length;if(t===3)return Ef(i[0],i[1],i[2]);let e=i.map(n=>Math.round(n*nt));if((t===4||t===5)&&e.includes(60)&&e.every(n=>Af.includes(n))){for(let n of Vf)if(n.internal.length===t){for(let r=0;r<i.length;++r)if(e.every((o,a)=>o===n.internal[(a+r)%t]))return es(n.dihedral,r).slice(0,t-1).map(o=>o*F)}}if(t===4&&e.filter(n=>n===60).length===3){let n=e.findIndex(h=>h!==60),r=(Math.PI-i[n])/4,o=Math.acos(-1/Math.sqrt(3)*Math.tan(r)),a=Math.acos(1-2/3*((3-Math.tan(r)**2)/4+(Math.sin(3*r)/Math.sin(2*r))**2));return es([o,a,a,o],4-n).slice(0,t-1)}let s=Math.PI/N(i);return D(n=>{let r=$h(i[n],s),o=$h(i[n+1],s);return r+o},i.length-1)}var Xr=(i,t)=>ct(i+1,t.size),Yr=(i,t)=>ct(i-1,t.size);function Of(i,t){let e=i.polygon.points[Yr(t,i)],s=i.polygon.points[t],n=i.polygon.points[Xr(t,i)];return new St(n,s,e).sup.rad}function Lf(i){let t=i.find(a=>a.neighbours.filter(l=>l).length===1),e=Yr(t.neighbours.findIndex(a=>a),t),s=[],n=t,r=e;do{let a=[];for(;a.push({face:n,vertex:r}),!!n.neighbours[r];){let l=n;n=n.neighbours[r],r=Xr(n.neighbours.indexOf(l),n)}r=Xr(r,n),s.push(a)}while(n!==t||r!==e);let o=new ul(s);for(;;){let a=Math.max(3,...o.array.map(d=>d.val.length)),l=o.array.filter(d=>d.val.length>=a);if(!l.length)break;let h=new Set;for(let d of l){if(h.has(d))continue;let p=d.val.map(g=>Of(g.face,g.vertex)),m=kf(...p);for(let[g,M]of m.entries()){let w=d.val[g],x=d.val[g+1],k=w.vertex,v=Yr(x.vertex,x.face);w.face.dihedral[k]=x.face.dihedral[v]=Math.max(M,w.face.dihedral[k]||0,x.face.dihedral[v]||0)}d.prev.val.push(...d.next.val),h.add(d.next),o.delete(d.next),o.delete(d)}}}function xh(i,t){return Math.max(...i.neighbours.map(e=>!e||e===t?0:xh(e,i)))+1}function Th(i,t){return i.visited?!0:(i.visited=!0,i.neighbours.filter(e=>e&&e!==t).some(e=>Th(e,i)))}function Sh(i,t,e,s){let n=i.neighbours.map((r,o)=>{if(!(!r||r===e))return Sh(r,t,i,i.dihedral[o])}).filter(r=>r);return{shape:Q(i.polygon.points.map(r=>r.subtract(t))),color:i.tile.colour,children:n.length?n:void 0,dihedral:s?+(s*nt).toFixed(2):void 0,parentEdge:e?e.neighbours.indexOf(i):void 0,myEdge:e?i.neighbours.indexOf(e):void 0}}function If(i){let t=i.map(e=>{let s=e.transformed.oriented,n=s.points.length;return{tile:e,polygon:s,size:n,neighbours:zt(void 0,n),dihedral:zt(void 0,n),edges:s.edges,center:s.centroid,radius:s.radius}});if(!t.some(e=>e.size<3)){for(let[e,s]of t.entries())for(let[n,r]of t.entries())if(!(e>=n)&&!(s.radius+r.radius<u.distance(s.center,r.center)-2)){for(let[o,a]of s.edges.entries())for(let[l,h]of r.edges.entries())if(a.equals(h,2)){if(s.neighbours[o]||r.neighbours[l])return;s.joined=r.joined=!0,s.neighbours[o]=r,r.neighbours[l]=s}}if(!t.some(e=>!e.joined)&&!Th(t[0]))return t}}function Mh(i){let t=If(i);if(!t)return;Lf(t);let e=Fe(t,n=>xh(n)),s=e.polygon.centroid;return[s,Sh(e,s)]}function Ph(i){var e;let t=((e=i.c||i.children)==null?void 0:e.map(s=>Ph(s)))||[];return{shape:Li(i.shape||i.s),color:i.color||i.a,children:t,dihedral:i.dihedral||i.d,parentEdge:i.parentEdge||i.p,myEdge:i.myEdge||i.m,rot:i.rot||i.r}}function Ch(i){var e;let t=(e=i.children)==null?void 0:e.map(s=>Ch(s));return(t==null?void 0:t.length)||(t=void 0),{s:Q(i.shape.points),a:i.color,children:t,d:i.dihedral,p:i.parentEdge,m:i.myEdge,r:i.rot}}function Rf(i){try{let{net:t,angle:e,rotation:s}=JSON.parse(i.replace(/([a-z]):/g,'"$1":')),n;return typeof t=="string"?(n=`"${t}"`,t=us[t].net||us.Cube.net):(t=Ph(t),n=JSON.stringify(Ch(t)).replace(/"([a-z])":/g,"$1:")),{net:t,serialized:n,angle:e,rotation:s}}catch(t){return{net:us.Cube.net,serialized:'"Cube"',angle:1}}}function Ii(i,t=1){var s;let e=(s=i.children)==null?void 0:s.map(n=>Ii(n,t));return Object.assign({},i,{children:e,shape:i.shape.scale(t)})}var us={Tetrahedron:{net:Ii($n,Pt(3)*50),scale:1.1},Cube:{net:Ii(xn,Pt(4)*50),scale:.8},Octahedron:{net:Ii(Tn,Pt(3)*50),scale:.95},Dodecahedron:{net:Ii(Sn,Pt(5)*50),scale:.42},Icosahedron:{net:Ii(Mn,Pt(3)*50),scale:.67},Pyramid:{net:yh(6,50,100),scale:.57},Prism:{net:wh(6,50,100),scale:.45}},ii={fov:400},Eh=[1.066,.243,-.088],si=class extends S{constructor(t,e,s){super(e,s);this.type="polyhedron";this.canRotate=!1;this.options=t,t in us&&(t=`{"net":"${t}","angle":1,"rotation":${JSON.stringify(Eh)}}`);let n=Rf(t);this.net=n.net,this.serialized=n.serialized;let r=hs(this.net,o=>new Gt(o.shape,{class:"polygon-tile"},o.color||cs(o.shape.points.length)));this.solid=r.group,this.foldTree=r.foldTree,this.$el.append(this.solid.$el),this.$outline=c("path",{class:"outline"},this.$el),this.$moveBar=c("path",{d:"M0 0h30",class:"handle"},this.$el),this.$moveHandle=c("path",{d:"M0 0h14v14h-14Z",class:"handle",style:"cursor: grab"},this.$el),this.solid.$el.css("cursor","move"),this.setRotation(n.rotation||[0,0,0]),this.hinge(n.angle||0),this.solid.render(ii),this.updateOutline(),e.events.listen(this.solid.$el,{start:()=>{e.selection.add(this,!0),this.$el.removeClass("active")},move:({posn:o,lastPosn:a})=>{this.solid.transform.dragToRotate(a.subtract(this.posn),o.subtract(this.posn),100),this.solid.render(ii)},end:()=>{this.rotation=this.solid.transform.toEulerAngles(),this.updateOutline(),this.updateOptions(),e.change({changed:[this]}),this.$el.addClass("active")},click:o=>e.tools.move.down(o),checkIfActive:()=>this.angle>0})}updateOutline(){let t=this.solid.getProjectedVertices(ii);this.path=P.convexHull(...t),this.$outline.draw(this.path),this.transform(),this.$moveBar.translate(this.path.points[0].x-30,this.path.points[0].y),this.$moveHandle.translate(this.path.points[0].x-45,this.path.points[0].y-7)}setRotation(t){this.rotation=t,this.solid.transform.clear().rotate(...t)}updateOptions(){let t=JSON.stringify(this.rotation.map(e=>+e.toFixed(4)));this.options=`{"net":${this.serialized},"angle":${this.angle},"rotation":${t}}`}animateHinges(t,e=!1,s=800){let n=e?this.rotation:[0,0,0],r=this.angle;return z(o=>{this.hinge(it(r,t,o)),e&&this.setRotation(n.map(a=>a*(1-o))),this.solid.render(ii)},s)}hinge(t){this.angle=T(t,0,1);let e=this.solid.transform.matrix;this.solid.transform.clear(),Kr(this.foldTree,this.solid.children[0],-this.angle),this.solid.transform.matrix=e}hingeStart(){this.startRotation=this.rotation,this.startAngle=this.angle,this.$el.removeClass("active")}hingeMove(t){if(!b(t,this.angle)){if(this.hinge(t),this.startRotation&&this.startAngle){let e=T(t/this.startAngle,0,1);this.setRotation(this.startRotation.map(s=>e*s))}this.solid.render(ii)}}hingeEnd(){this.updateOutline(),this.$el.addClass("active"),this.updateOptions()}setColour(t){super.setColour(t);for(let e of this.solid.getFaces())e.color=t;this.solid.render(ii)}static fold(t){let e=Mh(t);if(!e){yn("polyhedron-error");return}let s=JSON.stringify({net:e[1],angle:1}),n=new si(s,t[0].$parent);n.hinge(0);let r=n.solid.children[0].transform.matrix;n.setTransform(e[0].shift(-r[0][3],-r[1][3])),n.animateHinges(1).promise.then(()=>n.updateOutline());for(let a of t)a.delete();return n}unfold(){return O(this,null,function*(){this.$parent.selection.remove(this),this.angle>0&&(yield this.animateHinges(0,!0).promise);let t=Array.from(this.solid.getFaces()).map(e=>{let s=Array.from(e.getProjectedVertices()),n=new G(Q(s),this.$parent);return n.setColour(this.colour||e.color||cs(s.length)),n.setTransform(this.posn),n});return this.delete(),t})}static action(t,e){return O(this,null,function*(){if(t==="unfold"){let s=Bt(yield Promise.all(e.map(n=>n.unfold())));e[0].$parent.change({added:s,deleted:e})}})}static makeThumbnail(t,e){let s=c("svg",{width:70,height:70},e),n=c("g",{transform:"translate(35, 35)"},s),{net:r,scale:o}=us[t],a=hs(r,l=>new Gt(l.shape,{class:"polygon-tile"},cs(l.shape.points.length)),-1).group;a.transform.clear().rotate(...Eh).scale({x:o,y:o,z:o}),n.append(a.$el),a.render(ii)}};function Pt(i){let t=Math.cos(2*Math.PI/i);return 1/Math.sqrt(2-2*t)}var Jr=i=>ct(Math.round(i.angle*nt),180),Q=i=>i.map(t=>`${Ft(t.x,2)} ${Ft(t.y,2)}`).join(",");function Pn(i,t){let e=new u(-i/2,-t/2);return Q(new $(e,i,t).points)}var L=50,tt=Math.sqrt(3)/4*L,Qr=new pt(y,new u(0,1)),Ah={"equ-triangle":new P(new u(-L/2,tt),new u(L/2,tt),new u(0,-tt)),square:P.regular(4,L*Pt(4)),"reg-pentagon":P.regular(5,L*Pt(5)),"reg-hexagon":P.regular(6,L*Pt(6)),"reg-heptagon":P.regular(7,L*Pt(7)),"reg-octagon":P.regular(8,L*Pt(8)),"reg-decagon":P.regular(10,L*Pt(10)),"reg-dodecagon":P.regular(12,L*Pt(12)),rectangle:new $(new u(-L,-L/2),2*L,L).polygon,trapezium:new P(new u(-L,tt),new u(L,tt),new u(L/2,-tt),new u(-L/2,-tt)),rhombus:new P(new u(-L*3/4,tt),new u(L/4,tt),new u(L*3/4,-tt),new u(-L/4,-tt)),"right-triangle":new P(new u(-L/2,-L/2),new u(L/2,-L/2),new u(-L/2,L/2)),"rhombus-2":new P(new u(L/2-tt,L/4),new u(-tt-L/2,L/4),new u(tt-L/2,-L/4),new u(tt+L/2,-L/4)),chevron:new P(new u(-.75*L,2*tt),new u(.25*L,2*tt),new u(.75*L,0),new u(.25*L,-2*tt),new u(-.75*L,-2*tt),new u(-.25*L,0)),"right-triangle-2":new P(new u(-2*tt,-L/2),new u(-2*tt,L/2),new u(2*tt,-L/2)),kite:new P(new u(0,-L),new u(2*tt,-L/2),new u(0,L),new u(-2*tt,-L/2)),dart:new P(new u(2*tt,.75*L),new u(0,-.75*L),new u(-2*tt,.75*L),new u(0,.25*L))},to=["","","",f.yellow,f.blue,f.green,f.red,f.teal,f.purple,"",f.lime,"",f.orange],Vh={trapezium:f.red,"right-triangle":f.green,"rhombus-2":f.orange,chevron:f.orange,kite:f.purple,dart:f.teal},kh={"equ-triangle":f.green,square:f.yellow,"reg-pentagon":f.blue,"reg-hexagon":"#ffd615","reg-decagon":f.red,rectangle:f.yellow,trapezium:"#cc1030",rhombus:f.blue,"rhombus-2":"#e6e2c6",chevron:"#cc1030","right-triangle-2":"#ffd615",kite:"#134791",dart:f.purple};function cs(i){return to[i%to.length]||f.yellow}function Li(i){if(i in Ah)return Ah[i];if(i.match(/^[0-9.,\-\s]+$/)){let t=i.split(",").map(e=>new u(...e.split(" ").map(s=>+s)));return new P(...t)}throw new Error("Unknown polygon type.")}var Df=["trapezium","rhombus","rhombus-2","rectangle","right-triangle","right-triangle-2"],Nf=["equ-triangle","square","reg-pentagon","reg-hexagon","reg-heptagon","reg-octagon","reg-decagon","reg-dodecagon","rectangle","trapezium","kite","dart"],G=class extends S{constructor(t,e,s){super(e,s);this.type="polygon";this.options=t,this.path=Li(t),this.snapAngles=Rt(this.path.edges.map(Jr)),this.symmetric=Nf.includes(t);let n=e.options.altColors?kh:Vh;this.colour=n[t]||cs(this.path.points.length);let r=$.aroundPoints(this.path.points),o=new u(r.center.x,r.p.y);this.showSelectionOutline=u.distance(o,this.path.project(o))>5;let a={class:"polygon-tile",path:this.path,fill:this.colour};this.$path=c("path",a,this.$el),this.$outline=c("path",{class:"outline",path:this.path},this.$el)}static makeThumbnail(t,e,s,n){let r=Df.includes(t)?30:40,o=Li(t),a=Math.max(...o.points.map(d=>d.length));o=o.scale(36/a).shift(40,r);let l=c("svg",{width:80,height:2*r},e),h=c("path",{class:"polygon-tile",path:o},l);s.options.watch(d=>{let p=d.altColors?kh:Vh,m=n||p[t]||to[o.points.length];h.setAttr("fill",m)})}setColour(t){super.setColour(t),this.$path.setAttr("fill",A(this.colour))}flip(t){t&&(this.posn=new u(2*t.x-this.posn.x,this.posn.y)),this.rot=-this.rot,this.flipped=!this.flipped,this.symmetric||(this.path=this.path.reflect(Qr),this.$path.draw(this.path),this.$outline.draw(this.path)),this.transform()}static action(t,e,s){if(t==="flip"){for(let n of e)n.flip(s);e[0].$parent.selection.update(),e[0].$parent.change({changed:e})}else if(t==="join"){let n=e.map(l=>l.transformed),r=P.union(...n),o=e[0].colour,a=r.map(l=>new G(Q(l.points),e[0].$parent));for(let l of a)l.transform(),l.setColour(o);for(let l of e)l.delete();e[0].$parent.selection.select(a,!0),e[0].$parent.change({added:a,deleted:e})}else if(t==="fold"){let n=si.fold(e);n&&e[0].$parent.change({added:[n],deleted:e})}}};var Oh=i=>50*Math.log(i)/Math.log(2),eo=class extends G{constructor(t,e,s){super(Q(new $(new u(-25,-20),50,Oh(+t)).points),e,s);this.type="log-bar";this.fill=f.blue;this.options=t;let n=js(we(+t).map(r=>Oh(r)));n.pop();for(let r of n)c("line",{x1:-25,x2:25,y1:r-20,y2:r-20,class:"polygon-tile",opacity:.3},this.$el);this.$el.append(this.$outline),c("text",{text:t,class:"polygon-label",y:6},this.$el)}static makeThumbnail(t,e){e.setAttr("width",21),e.setAttr("fill",f.blue);let s=c("text",{class:"polygon-label",x:+e.attr("x")+10.5,y:+e.attr("y")+16},e.parent);e.onAttr("data-options",n=>{e.setAttr("height",Math.min(21*Math.log(+n)/Math.log(2),100)),s.text=n,s.css("font-size",+n<99?"":"11px")})}};var _f=[[0,0]],Lh=[[0,-39],[0,39]],Gf=[...Lh,[0,0]],Cn=[[-18,-39],[18,-39],[-18,39],[18,39]],Hf=[...Cn,[0,0]],Ih=[...Cn,[-18,0],[18,0]],qf=[...Ih,[0,-19]],io=[...Cn,[-18,-13],[18,-13],[-18,13],[18,13]],zf=[...io,[0,0]],Bf=[...io,[0,-26],[0,26]],Ff={C:"#333",S:"#333",H:f.orange,D:f.orange},Zf={A:_f,2:Lh,3:Gf,4:Cn,5:Hf,6:Ih,7:qf,8:io,9:zf,10:Bf},Uf="AH:2H:3H:4H:5H:6H:7H:8H:9H:0H:JH:QH:KH:AC:2C:3C:4C:5C:6C:7C:8C:9C:0C:JC:QC:KC:KD:QD:JD:0D:9D:8D:7D:6D:5D:4D:3D:2D:AD:KS:QS:JS:0S:9S:8S:7S:6S:5S:4S:3S:2S:AS".split(":").map(i=>i+"f").join(":"),jf={A:1,J:11,Q:12,K:13,0:10};function Rh(i,t){i.removeChildren();let[e,s,n]=t.split("");if(t==="deck"||n)return c("rect",{x:-39,y:-57,width:78,height:114,rx:2,fill:"url(#card-bg)"},i);e==="0"&&(e="10"),i.setAttr("fill",Ff[s]);let r=`#suit-${s.toLowerCase()}`;if(s==="J")c("image",{href:"/polypad/assets/cards/joker.svg",style:"transform: translate(-35px, -53px)",width:70},i),e="Joker";else if(["K","Q","J"].includes(e))c("use",{href:r,style:"transform: translate(-35px, -36px) scale(0.6)",width:24,height:24},i),c("use",{href:r,style:"transform: rotate(180deg) translate(-35px, -36px) scale(0.6)",width:24,height:24},i),c("image",{href:`/polypad/assets/cards/${t.toLowerCase()}.svg`,style:"transform: translate(-35px, -53px)",width:70},i);else{let a=e==="A"?" scale(1.7)":"";for(let l of Zf[e]||[]){let h=l[1]>0?" rotate(180deg)":"";c("use",{href:r,style:`transform: translate(${l[0]}px, ${l[1]}px)`+h+a,width:24,height:24},i)}}let o={text:e,x:-40,y:-45,style:"font-size: 16px; letter-spacing: -1px;"};c("text",o,i),c("text",ne(ne({},o),{style:"transform: rotate(180deg)"}),i)}var Ri=class extends S{constructor(t,e,s){super(e,s);this.type="card";this.count=0;this.$label=c("g",{class:"outline card-label"},this.$el),this.$labelRect=c("rect",{width:30,height:35,rx:5},this.$label),this.$labelText=c("text",{x:6,y:30},this.$label),this.$stack=c("rect",{class:"polygon-tile",fill:"url(#card-gradient)",rx:10},this.$el),this.$path=c("rect",{class:"polygon-tile",fill:"#eee",rx:10},this.$el),this.$body=c("g",{transform:"scale(1.4)"},this.$el),this.$outline=c("rect",{class:"outline",rx:10},this.$el),this.$path.setRect(new $(new u(-125/2,-175/2),125,175)),this.setOptions(t==="deck"?Uf:t)}setOptions(t){if(t===this.options)return;this.options=t;let e=t.split(":");this.count=e.length,this.value=N(e.map(r=>+(jf[r[0]]||r[0])));let s=Math.sqrt(this.count-1)*3;this.path=new $(new u(-125/2,-175/2),125,175+s);for(let r of[this.$stack,this.$outline])r.setRect(this.path);this.transform(),this.$label.setAttr("hidden",this.count<=1?!0:void 0),this.$label.setTransform({x:-125/2,y:175/2-15+s}),this.$labelRect.setAttr("width",46+this.count.toFixed().length*8),this.$labelText.text=`${this.count} cards`;let n=I(e);n!==this.top&&Rh(this.$body,n),this.top=n}setColour(t){super.setColour(t||f.blue)}addCards(t){this.setOptions(this.options+":"+t)}highlight(t=!0){this.$el.setClass("active",t)}move(t){super.move(t),!(this.$parent.selection.tiles.size>1)&&this.setCollision(this.findNearby("card",75))}collide(t){t.highlight(!1),t.addCards(this.options),this.delete();let e=this.lastSavedData?[this]:void 0;this.$parent.change({changed:[t],deleted:e})}doubleClick(){let t=this.draw();t&&this.$parent.change({added:[t],changed:[this]})}flip(){this.$parent.playSound("click");let t=this.options.split(":").reverse();this.setOptions(t.map(e=>e.length>2?e.slice(0,2):e+"f").join(":"))}draw(){if(this.count<=1)return;this.$parent.playSound("draw"),this.$parent.selection.clear();let t=this.options.split(":"),e=t.pop();this.setOptions(t.join(":"));let s=new Ri(e,this.$parent);return s.rot=this.rot,s.animateTo(this.posn.shift(150,0),this.posn),s}shuffle(){this.count<=1||(this.$parent.playSound("shuffle"),this.setOptions(Tt.shuffle(this.options.split(":")).join(":")))}static action(t,e){return O(this,null,function*(){if(t==="stack"){let s=Array.from(e),n=s.map(o=>o.options).join(":"),r=new Ri(n,s[0].$parent);r.setTransform(u.average(...s.map(o=>o.posn)));for(let o of e)o.delete();return s[0].$parent.selection.add(r),e[0].$parent.change({added:[r],deleted:e})}else if(t==="flip")for(let s of e)s.flip();else if(t==="draw"){let s=e.map(n=>n.draw()).filter(n=>n);return e[0].$parent.change({added:s,changed:e})}else if(t==="shuffle")for(let s of e)s.shuffle();e[0].$parent.change({changed:e})})}static makeThumbnail(t,e){let s=c("svg",{width:60,height:74},e);c("rect",{x:5,y:2,width:50,height:70,fill:"white",rx:4},s);let n=c("g",{style:"transform: translate(30px, 37px) scale(0.55)"},s);e.onAttr("data-options",r=>Rh(n,r))}};var Wf=[[0,-.2],[1.2,-1],[.6,1],[-.6,1],[-1.2,-.2]],Dh=Wf.map(i=>new u(i[0]*50,i[1]*50)),so=class extends G{constructor(t,e,s){super(t||Q(Dh),e,s);this.type="custom-polygon";this.$handles=[];this.showSelectionOutline=!0;for(let[r,o]of this.path.points.entries())this.makeVertex(o,r);this.updatePath();let n;this.$parent.events.listen(this.$outline,{down:({posn:r})=>{r=this.relativePosn(r);let o=this.path.edges.findIndex(a=>r.distanceFromLine(a)<5);n=this.makeVertex(r,(o+1)%this.$handles.length),this.updatePath()},move:({posn:r})=>{n&&this.moveVertex(n,r)},end:()=>{n&&this.$parent.change({changed:[this]})}}),this.$outline.css("cursor","crosshair")}makeVertex(t,e){if(this.$handles.length>=24)return;let s=this.makeHandle("c",(n,r)=>this.moveVertex(s,r),()=>this.deleteVertex(s));return s.setCenter(t),s.setAttr("r",8),s.css("cursor","move"),this.$handles.splice(e,0,s),s}deleteVertex(t){t.remove(),this.$handles.splice(this.$handles.indexOf(t),1),this.updatePath()}moveVertex(t,e){var n;let s=(n=this.$parent.snap([e]))==null?void 0:n.shift;t.setCenter(this.relativePosn(s?e.add(s):e)),this.updatePath()}updatePath(){let t=this.$handles.map(e=>e.center);this.path=new P(...t),this.$path.draw(this.path),this.$outline.draw(this.path),this.transform(),this.snapAngles=Rt(this.path.edges.map(Jr)),this.options=Q(t),this.$parent.selection.update()}flip(t){t&&(this.posn=new u(2*t.x-this.posn.x,this.posn.y)),this.rot=-this.rot,this.transform();for(let e of this.$handles)e.setCenter(e.center.reflect(Qr));this.updatePath()}lock(){let t=new G(this.options,this.$parent);return t.setColour(this.colour),t.setTransform(this.posn,this.rot),this.$parent.selection.add(t),this.delete(),t}static makeThumbnail(t,e){let s=new P(...Dh).scale(.5).shift(40),n=c("svg",{width:80,height:80},e);c("path",{class:"polygon-tile",path:s,fill:f.green},n);for(let r of s.points)c("circle",{cx:r.x,cy:r.y,r:3,fill:"white"},n)}static action(t,e){if(t==="lock"){let s=[];for(let n of Array.from(e))s.push(n.lock());e[0].$parent.change({added:s,deleted:e})}}};var no=25/2,Nh=[[[0,2],[0,-4],[-2,-4],[-2,4],[2,4],[2,2],[0,2]],[[0,0],[0,-4],[-2,-4],[-2,2],[0,2],[0,4],[2,4],[2,0],[0,0]],[[-5,-1],[5,-1],[5,1],[-5,1]],[[-3,-2],[-3,2],[1,2],[1,0],[3,0],[3,-2],[-3,-2]],[[3,-2],[3,0],[1,0],[1,-2],[-1,-2],[-1,2],[5,2],[5,-2],[3,-2]],[[-1,-3],[-1,-1],[-3,-1],[-3,3],[-1,3],[-1,1],[1,1],[1,-1],[3,-1],[3,-3],[-1,-3]],[[1,1],[1,-3],[-1,-3],[-1,1],[-3,1],[-3,3],[3,3],[3,1],[1,1]],[[1,-1],[1,-3],[-1,-3],[-1,-1],[-3,-1],[-3,1],[-1,1],[-1,3],[1,3],[1,1],[3,1],[3,-1],[1,-1]],[[-1,-3],[-1,-1],[-3,-1],[-3,1],[-1,1],[-1,3],[1,3],[1,-1],[3,-1],[3,-3],[-1,-3]],[[-4,-2],[-4,0],[-2,0],[-2,2],[0,2],[0,0],[4,0],[4,-2],[-4,-2]],[[-1,-3],[-1,1],[-3,1],[-3,3],[1,3],[1,-1],[3,-1],[3,-3],[-1,-3]],[[-1,-3],[-1,1],[-5,1],[-5,3],[1,3],[1,-3],[-1,-3]],[[-1,2],[1,2],[1,0],[3,0],[3,-2],[-3,-2],[-3,0],[-1,0]],[[-3,2],[-3,0],[-1,0],[-1,-2],[3,-2],[3,0],[1,0],[1,2]],[[-3,2],[-3,-2],[3,-2],[3,0],[-1,0],[-1,2]],[[-2,2],[2,2],[2,-2],[-2,-2]],[[-4,1],[4,1],[4,-1],[-4,-1]]].map(i=>i.map(t=>new u(t[0]*no,t[1]*no))),Kf=[[2,4],[4,4],[5,9],[7,2],[7,6],[11,3],[13,7],[15,3],[17,7],[20,2],[21,5],[23,7],[3,2],[7,2],[5,6],[10,4],[8,7]],_h=[...V.rainbow(12).map(i=>i.hex),f.red,f.blue,f.green,f.yellow,f.purple],ro=class extends G{constructor(t,e,s){super(Q(Nh[+t]),e,s);this.type="pentomino";this.options=t,this.setColour(_h[+t])}static makeThumbnail(t,e){let s=Kf[+t],n=new P(...Nh[+t]).scale(10/no);e.draw(n.shift(10*s[0],10*s[1]).shift(1,1)),e.setAttr("fill",_h[+t])}};var Gh=[[[-4,-2],[0,2],[4,-2]],[[-4,-2],[0,2],[4,-2]],[[-2,0],[0,-2],[2,0],[0,2]],[[-3,1],[1,1],[3,-1],[-1,-1]],[[0,-1],[2,1],[-2,1]],[[0,-1],[2,1],[-2,1]],[[-2,-2],[2,-2],[2,2]]],Hh=[f.red,f.blue,f.green,f.yellow,f.orange,f.teal,f.purple],Xf=[[2,4],[4,2],[6,4],[3,7],[7,2],[4,5],[6,6]],qh=[-90,0,0,0,-90,0,90],Yf=25,oo=class extends G{constructor(t,e,s){super(Q(Gh[+t].map(n=>new u(...n).scale(Yf))),e,s);this.type="tangram";this.snapAngles=[0,45,90,135];this.options=t,this.setColour(Hh[+t]),this.rot=qh[+t],this.transform()}static makeThumbnail(t,e,s,n){let r=Xf[+t],o=Gh[+t].map(l=>new u(...l).rotate(qh[+t]*F).shift(...r).scale(18).shift(2,2)),a=new P(...o);e.draw(a),e.setAttr("fill",n||Hh[+t])}getSnapLines(){return this.path.edges}};var zh=25,ds=(1+Math.sqrt(5))/2*zh,En=Math.sqrt((5+Math.sqrt(5))/2)*zh,ps=ds*(Math.sqrt(5)-1)/2,Bh=[`0 ${-ds},${En} ${-ps},0 ${ds},${-En} ${-ps}`,`0 ${2*ps-ds},${En} ${ps},0 ${-ds},${-En} ${ps}`],Fh=[["M29.4-30.9C25.3-18.2,13.4-9.5,0-9.5c-13.4,0-25.3-8.6-29.4-21.4","M29.4,0C20.8-6.2,10.6-9.5,0-9.5c-10.6,0-20.8,3.3-29.4,9.5"],["M18.2,15.5C20.1,9.6,19,3.3,15.5-1.7C11.9-6.6,6.1-9.5,0-9.5c-6.1,0-11.9,2.9-15.5,7.9c-3.6,4.9-4.6,11.3-2.7,17.1","M18.2-15.5C12.9-11.6,6.5-9.5,0-9.5c-6.5,0-12.9-2.1-18.2-5.9"]],Zh=[f.red,f.blue],ao=class extends G{constructor(t,e,s){super(Bh[+t],e,s);this.type="penrose";this.setColour(Zh[+t]),this.options=t;let n=c("g",{class:"penrose-circles"});this.$path.insertAfter(n);for(let r of Fh[+t])c("path",{d:r},n)}static makeThumbnail(t,e,s,n){let r=+t,o=c("svg",{width:80,height:80,viewBox:"-50 -50 100 100"},e),a=n||Zh[r];c("polygon",{points:Bh[r],class:"polygon-tile",fill:a},o);let l=c("g",{class:"penrose-circles"},o);for(let h of Fh[r])c("path",{d:h},l)}};var Uh=["M13.9-13.9,2.8-25H-2.8L-25-2.8V2.8L-2.8,25H2.8L13.9,13.9C21.6,6.6,21.6-6.6,13.9-13.9Zm-2.8,25L0,22.2-22.2,0,0-22.2,11.1-11.1A15.8,15.8,0,0,1,11.1,11.1Z","M25-2.8,13.9-13.9c-7.3-7.7-20.5-7.7-27.8,0L-25-2.8V2.8l11.1,11.1c7.3,7.7,20.5,7.7,27.8,0L25,2.8ZM11.1,11.1a15.8,15.8,0,0,1-22.2,0L-22.2,0l11.1-11.1a15.8,15.8,0,0,1,22.2,0L22.2,0Z","M-25-2.8V2.8l11.1,11.1c7.3,7.6,20.5,7.6,27.8,0s7.6-20.5,0-27.8L2.8-25H-2.8ZM15.7,0a15.9,15.9,0,0,1-4.6,11.1,15.8,15.8,0,0,1-22.2,0L-22.2,0,0-22.2,11.1-11.1A15.9,15.9,0,0,1,15.7,0Z","M-25-2.8V2.8L-2.8,25H2.8L25,2.8V-2.8L2.8-25H-2.8Zm25,25L-22.2,0,0-22.2,22.2,0Z","M0-19.7a19.5,19.5,0,0,0-13.9,5.8c-7.6,7.3-7.6,20.5,0,27.8s20.5,7.6,27.8,0C26.3,1.6,17.5-19.7,0-19.7ZM11.1,11.1c-5.8,6.1-16.3,6.1-22.2,0a15.8,15.8,0,0,1,0-22.2,15.8,15.8,0,0,1,22.2,0A15.8,15.8,0,0,1,11.1,11.1Z","M0-19.7a19.5,19.5,0,0,0-13.9,5.8L-25-2.8V2.8l11.1,11.1c7.3,7.6,20.5,7.6,27.8,0C26.3,1.6,17.5-19.7,0-19.7ZM11.1,11.1a15.8,15.8,0,0,1-22.2,0L-22.2,0l11.1-11.1c5.9-6.1,16.4-6.1,22.2,0A15.8,15.8,0,0,1,11.1,11.1Z"],lo=class extends G{constructor(t,e,s){super("square",e,s);this.type="kolam";this.setColour(f.orange),this.options=t,c("path",{d:Uh[+t],fill:"white"},this.$el),c("circle",{r:3,fill:"white"},this.$el),this.$el.append(this.$outline),this.$path.css("stroke-width",".5px")}static makeThumbnail(t,e){let s=c("svg",{width:60,height:60},e);c("rect",{class:"polygon-tile",fill:f.orange,x:5,y:5,width:50,height:50},s),c("path",{d:Uh[+t],fill:"white",transform:"translate(30 30)"},s),c("circle",{r:3,cx:30,cy:30,fill:"white"},s)}};var Di=["M-32.3,6.5,0,84.3H0L32.3,6.5A80.4,80.4,0,0,0,0,0,86.6,86.6,0,0,0-32.3,6.5Z","M-32.3,6.5,0,84.3H0L32.3,6.5A80.4,80.4,0,0,0,0,0,86.6,86.6,0,0,0-32.3,6.5Z","M-42.1,0A288.5,288.5,0,0,0-20.2,110.2a287.6,287.6,0,0,0,62.3,93.3V0Z","M-42.1,0V203.5a289.5,289.5,0,0,0,62.4-93.3A286.5,286.5,0,0,0,42.1,0Z","M0 0L-101.7 101.7L101.7 101.7Z","M0 0L-101.7 101.7L101.7 101.7Z","M0 0L-59.6 59.6L59.6 59.6Z","M42.1.1H-42.2l-59.5,59.6A143.4,143.4,0,0,0,0,101.8,143,143,0,0,0,101.7,59.7Z","M42.1.1H-42.2l-59.5,59.6A143.4,143.4,0,0,0,0,101.8,143,143,0,0,0,101.7,59.7Z"],jh=[[66,-17.5,-22.5],[82,-17.5,22.5],[23,-36.5,45],[125,-36.5,-45],[56,47.3,135],[92,47.3,-135],[74,101,180],[41,98,45],[107,98,-45]],Jf={0:1,1:1,2:3,3:2,7:8,8:7},Wh=[f.lime,f.teal,f.blue,f.red,f.yellow,f.green,f.grey,f.orange,f.purple],ho=class extends G{constructor(t,e,s){super(Q(Je(Di[+t])),e,s);this.type="egg";this.snapAngles=[0,45,90,135];this.options=t,this.$path.setAttr("d",Di[+t]),this.$outline.setAttr("d",Di[+t]),this.setColour(Wh[+t]),this.rot=jh[+t][2],this.transform(),+t<=1&&this.snapAngles.push(22.5,67.5,112.5,157.5)}flip(t){super.flip(t);let e=this.flipped?Jf[this.options]||this.options:this.options;this.$path.setAttr("d",Di[+e]),this.$outline.setAttr("d",Di[+e])}static makeThumbnail(t,e){e.setAttr("d",Di[+t]);let s=jh[+t];e.css("transform",`translate(${s[0]}px, ${s[1]}px) rotate(${s[2]}deg) scale(0.5)`),e.setAttr("fill",Wh[+t]),e.css("stroke-width","2px")}};var co=1/Math.sqrt(3),Qf=50/co,Kh=[f.blue,f.purple,f.red,f.orange,f.yellow],Ni=P.regular(6,Qf).rotate(Math.PI/6).points;Ni.splice(3,1);Ni.splice(2,0,new u(2*Ni[1].x,Ni[0].y));var uo=class extends G{constructor(t,e,s){super(Q(Ni.map(n=>n.scale(co**+t))),e,s);this.type="fractal";this.setColour(Kh[+t]),this.options=t}static makeThumbnail(t,e){let s=new P(...Ni).scale(.6*co**+t),n=$.aroundPoints(s.points),r=c("svg",{width:20+n.w,height:20+n.h},e);s=s.shift(10-n.center.x+n.w/2,10-n.center.y+n.h/2),c("path",{class:"polygon-tile",path:s,fill:Kh[+t]},r)}};var An=["M-25,34.4a81.3,81.3,0,0,1,50,0h0A81.1,81.1,0,0,0,40.4-13.1h.1A81.5,81.5,0,0,1,0-42.5H0A81.5,81.5,0,0,1-40.5-13.2h.1A81.1,81.1,0,0,0-25,34.4Z","M-15.4-21.3A80.5,80.5,0,0,1,0-68.8,80.5,80.5,0,0,1,15.4-21.3a80.6,80.6,0,0,1,50,0A80.3,80.3,0,0,1,25,8.1,80.4,80.4,0,0,1,40.4,55.7,80.2,80.2,0,0,1,0,26.3,80.2,80.2,0,0,1-40.4,55.7,80.4,80.4,0,0,1-25,8.1,80.3,80.3,0,0,1-65.4-21.3,80.6,80.6,0,0,1-15.4-21.3Z","M65.4-21.3A80.5,80.5,0,0,1,0,12.1,80.5,80.5,0,0,1-65.4-21.3a80.6,80.6,0,0,1,50,0A80.5,80.5,0,0,1,0-68.8,80.5,80.5,0,0,1,15.4-21.3,80.6,80.6,0,0,1,65.4-21.3Z","M80.9-47.5h0A81.5,81.5,0,0,1,40.4-76.9,80.4,80.4,0,0,0,0-47.5,80.2,80.2,0,0,0-40.5-76.9h0A80.8,80.8,0,0,1-80.9-47.6h0A80.3,80.3,0,0,1-65.5,0,80.3,80.3,0,0,1-80.9,47.5h0A80.8,80.8,0,0,1-40.5,76.9h0A80.2,80.2,0,0,0,0,47.5,80.4,80.4,0,0,0,40.4,76.9,81.5,81.5,0,0,1,80.9,47.6h0A80.3,80.3,0,0,1,65.5,0,80.3,80.3,0,0,1,80.9-47.5Z","M0-47.5A80.3,80.3,0,0,1,15.5,0,80.3,80.3,0,0,1,0,47.5,80.3,80.3,0,0,1-15.5,0,80.3,80.3,0,0,1,0-47.5Z","M130.9,153.8a80.5,80.5,0,0,1,15.4-47.5,80.2,80.2,0,0,1-40.4-29.4A80.1,80.1,0,0,1,90.5,29.4a80.6,80.6,0,0,1-50,0A80.6,80.6,0,0,1,0,0,80.3,80.3,0,0,1-40.4,29.4a80.9,80.9,0,0,1-50.1,0,80.8,80.8,0,0,1-15.4,47.5,80.9,80.9,0,0,1-40.5,29.4,79.9,79.9,0,0,1,15.5,47.5,81.3,81.3,0,0,1,50,0A80.9,80.9,0,0,1,0,72.9a80.9,80.9,0,0,1,80.9,80.9A81.3,81.3,0,0,1,130.9,153.8Z","M40.4-13.2A80.4,80.4,0,0,0,0-42.5,80.7,80.7,0,0,0-40.4-13.1,80.9,80.9,0,0,0-25,34.4a80.6,80.6,0,0,0,50,0A81.2,81.2,0,0,0,40.4-13.2Z","M40.4-13.1A82,82,0,0,1,0-42.5,81.1,81.1,0,0,1-40.5-13.2,81.3,81.3,0,0,1-25,34.4a81.3,81.3,0,0,1,50,0A81.6,81.6,0,0,1,40.4-13.1Z"],Xh=["M16.2-.3a5.5,5.5,0,0,1-4.4,6.4A5.3,5.3,0,0,1,5.5,1.8,5.4,5.4,0,0,1,9.8-4.6,5.5,5.5,0,0,1,16.2-.3Zm8-8A3.8,3.8,0,0,0,28-4.5a3.7,3.7,0,0,0,3.7-3.8A3.6,3.6,0,0,0,28-12,3.7,3.7,0,0,0,24.2-8.3ZM19,23.4a4.9,4.9,0,0,0,4.8-4.8A4.8,4.8,0,0,0,19,13.9a4.7,4.7,0,0,0-4.7,4.7A4.8,4.8,0,0,0,19,23.4ZM-11.7,6.1A5.3,5.3,0,0,0-5.4,1.8,5.4,5.4,0,0,0-9.7-4.6,5.5,5.5,0,0,0-16.1-.3,5.5,5.5,0,0,0-11.7,6.1ZM-27.9-4.5a3.8,3.8,0,0,0,3.8-3.8A3.7,3.7,0,0,0-27.9-12a3.6,3.6,0,0,0-3.7,3.7A3.7,3.7,0,0,0-27.9-4.5ZM20.9-22A139.9,139.9,0,0,1,3-19.5a1.1,1.1,0,0,1-.1.5L1-15.2V30H-1V-15.2L-2.9-19a1.1,1.1,0,0,1-.1-.5,127,127,0,0,1-17.8-2.6A80.8,80.8,0,0,0,0-41.7,83.3,83.3,0,0,0,20.9-22ZM-3.8-26.7A3.2,3.2,0,0,0-7-30a3.3,3.3,0,0,0-3.3,3.3A3.2,3.2,0,0,0-7-23.5,3.2,3.2,0,0,0-3.8-26.7ZM6.5-30a3.2,3.2,0,0,0-3.2,3.3,3.2,3.2,0,0,0,3.2,3.2,3.2,3.2,0,0,0,3.3-3.2A3.3,3.3,0,0,0,6.5-30ZM-23.7,18.6a4.9,4.9,0,0,0,4.8,4.8,4.8,4.8,0,0,0,4.7-4.8,4.7,4.7,0,0,0-4.7-4.7A4.8,4.8,0,0,0-23.7,18.6Z","M-16.9-4.7l-17.7-6.1a.8.8,0,0,1-.5-.9.8.8,0,0,1,.9-.5L-16.5-6a.7.7,0,0,1,.5.9.7.7,0,0,1-.7.4ZM-24.6-13l9.7,5.4h.3a.9.9,0,0,0,.7-.3.9.9,0,0,0-.3-1l-9.7-5.4a.8.8,0,0,0-1,.2A.8.8,0,0,0-24.6-13ZM-7.8-4.9l5.9,1.2h.5c.2-.1.3-.2.3-.4l.3-1.4a.6.6,0,0,0-.5-.8L-7.2-7.7h-.6l-.3.4-.3,1.4A.8.8,0,0,0-7.8-4.9ZM2.8-2.5a.9.9,0,0,0,.7.6h.2l1.6-.3a1,1,0,0,0,.5-.4.7.7,0,0,0,.1-.5l-1.4-6a.8.8,0,0,0-.9-.6L2-9.4l-.5.3a1.3,1.3,0,0,0-.1.6ZM10.9.4a.7.7,0,0,0-.1-.5L10-1.3a.8.8,0,0,0-1-.2L4,1.9c-.2.1-.3.2-.3.4a.7.7,0,0,0,.1.5L4.6,4a.6.6,0,0,0,.6.3h.4l5-3.4ZM-4.5-1l-1.4-.3a.4.4,0,0,0-.5.1c-.2.1-.3.2-.3.4L-8.2,5.1a.7.7,0,0,0,.5.8l1.4.4h.5a.5.5,0,0,0,.3-.5L-4-.1A.7.7,0,0,0-4.5-1Zm-12.1-.6a.7.7,0,0,0,.7-.6c.1-.4-.2-.7-.6-.8l-11-1.7a.8.8,0,0,0-.8.6c0,.4.2.8.6.8l11,1.7Zm16.1,6H-1c-.2,0-.3.1-.5.3l-.8,1.1a.8.8,0,0,0,.1,1l4.9,3.6.4.2h.1l.4-.3.9-1.1c.2-.4.2-.8-.1-1Zm-9.4,8.8a.7.7,0,0,0-1,.1L-22.2,28.2a.7.7,0,0,0,.1,1l.4.2a.9.9,0,0,0,.6-.3l11.3-15A.6.6,0,0,0-9.9,13.2Zm-11.2,5.6c.2.2.3.3.5.3l.5-.2,8.2-7.6a.7.7,0,0,0,0-1,.8.8,0,0,0-1,0L-21,17.8A.7.7,0,0,0-21.1,18.8Zm14-4.9a.8.8,0,0,0-1,.4L-13,24.2a.6.6,0,0,0,.3.9h.3a.6.6,0,0,0,.6-.4l5-9.9A.8.8,0,0,0-7.1,13.9Zm17.4-.7a.8.8,0,0,0-1-.2.8.8,0,0,0-.2,1L19.9,29.4a.5.5,0,0,0,.5.3h.4a.7.7,0,0,0,.2-1ZM7,14.4A.7.7,0,0,0,6,14a.7.7,0,0,0-.3.9L10.3,25a.8.8,0,0,0,.7.4h.3a.8.8,0,0,0,.3-1Zm4-2.8,7.8,7.8.5.2.5-.2a.7.7,0,0,0,0-1L12,10.6a.7.7,0,0,0-1,1ZM34.4-11.2a.7.7,0,0,0-.8-.5l-18,5.5a.7.7,0,0,0-.4.9.6.6,0,0,0,.6.5c.1,0,.2,0,.2-.1l18-5.4A.7.7,0,0,0,34.4-11.2ZM26.7-4l-11,1.3a.6.6,0,0,0-.6.8.7.7,0,0,0,.7.6h.1l11-1.3c.4,0,.6-.4.6-.8S27.1-4,26.7-4ZM14-7.3h.3l9.8-5.1a.7.7,0,0,0,.3-1,.7.7,0,0,0-.9-.3L13.6-8.6a.8.8,0,0,0-.3,1A.8.8,0,0,0,14-7.3ZM-.5-16.6h0a.7.7,0,0,0,.7-.6L.6-36a.7.7,0,0,0-.7-.7.7.7,0,0,0-.7.7l-.4,18.7A.7.7,0,0,0-.5-16.6Zm3.2,1.2h.2a.7.7,0,0,0,.7-.6L5.7-26.9a.7.7,0,0,0-.5-.8.8.8,0,0,0-.9.6L2.2-16.3A.7.7,0,0,0,2.7-15.4Zm-6.1-.1h.1c.4-.1.7-.5.6-.8l-1.8-11c0-.4-.4-.6-.8-.6a.8.8,0,0,0-.6.8l1.8,11A.9.9,0,0,0-3.4-15.5Z","M60.8-16.2l-3.6-2.5,1.4-3.9-.9-.3-1.3,3.5h0l-9.5,3,2.8-7.8h-1l-3,8.3-9.5,3.1,4.4-11.8H39.5L35-12.5,25.5-9.4l5-14.7H29.4L24.3-9.1l-9.1,3,6-16.3-1.2.3L14-5.7l-1.8.5a50.6,50.6,0,0,0,5.3-16.2l-1.9.6-.4.2L1-9.8v-10L14.4-30.3c0-.4-.1-.8-.1-1.2L1-21.1v-10l11.7-9.1-.3-1.1L1-32.4v-10l8.9-6.9a3,3,0,0,0-.4-1L1-43.7v-10l5.2-4a4.1,4.1,0,0,0-.5-.9l-5.2,4h-1l-5.2-4a4.1,4.1,0,0,0-.5.9l5.2,4v10l-8.5-6.6a3,3,0,0,0-.4,1L-1-42.4v10l-11.4-8.9-.3,1.1L-1-31.1v10L-14.3-31.5c0,.4-.1.8-.1,1.2L-1-19.8v10L-15.2-20.6l-.4-.2-1.9-.6A50.6,50.6,0,0,0-12.2-5.2L-14-5.7l-6-16.4-1.2-.3,6,16.3-9.1-3L-29.4-24h-1.1l5,14.7L-35-12.5l-4.5-12.2h-1.1l4.4,11.8L-45.7-16l-3-8.3h-1l2.8,7.8-9.5-3h0l-1.3-3.5-.9.3,1.4,3.9-3.6,2.5.7.7,3.1-2.2v.2l9.4,3-6.8,4.8.7.7,7.3-5.1,9.6,3.1L-47.3-3.8l.9.6,10.8-7.4,9.5,3.1-13,8.9,1,.5,13.2-9,9.6,3-14.4,10,1.2.4,14.3-9.9h.4l3,1C-9.8-1-8.9.5-7.9,1.9L-18.4,9.4l1.3.3,9.8-7a64.2,64.2,0,0,0,6.6,8H.7a64.2,64.2,0,0,0,6.6-8l9.8,7,1.3-.3L7.9,1.9C8.9.5,9.8-1,10.8-2.6l3-1h.4L28.5,6.3l1.2-.4L15.3-4.1l9.6-3,13.2,9,1-.5-13-8.9,9.5-3.1L46.4-3.2l.9-.6L36.8-11l9.6-3.1L53.7-9l.7-.7-6.8-4.8,9.4-3v-.2l3.1,2.2Zm-76-3.2L-1-8.5V.6l-9.7-7.4A45.9,45.9,0,0,1-15.2-19.4ZM0,8.5A66.6,66.6,0,0,1-9.6-4.7L-1,1.8V6.3a1,1,0,0,0,1,1,1,1,0,0,0,1-1V1.8L9.6-4.7A71,71,0,0,1,0,8.5ZM10.7-6.8,1,.6V-8.5L15.2-19.4A45.9,45.9,0,0,1,10.7-6.8Z","M65-1V1.1A81.6,81.6,0,0,1,40,5c-8.9,0-12.7-.4-20.6-2.9A1,1,0,0,1,18.8.8.9.9,0,0,1,20,.2C27.7,2.7,31.2,3,40,3A79.7,79.7,0,0,0,64.7-.9ZM-64.6,1.1A82.4,82.4,0,0,0-39.4,5c8.8,0,12.6-.4,20.5-2.9A1.2,1.2,0,0,0-18.2.8,1,1,0,0,0-19.5.2C-27.2,2.7-30.7,3-39.4,3A79.9,79.9,0,0,1-64.2-.9H-65V1ZM-45.8,36a6.7,6.7,0,0,1,6.7-6.7A6.7,6.7,0,0,1-32.4,36a6.7,6.7,0,0,1-6.7,6.7A6.7,6.7,0,0,1-45.8,36Zm2,0a4.7,4.7,0,0,0,4.7,4.7A4.7,4.7,0,0,0-34.4,36a4.7,4.7,0,0,0-4.7-4.7A4.7,4.7,0,0,0-43.8,36Zm10.4-71.4a5.7,5.7,0,0,0-5.7-5.7,5.6,5.6,0,0,0-5.7,5.7,5.7,5.7,0,0,0,5.7,5.7A5.8,5.8,0,0,0-33.4-35.4ZM4.9-37.1a2.2,2.2,0,0,0,2.2,2.2,2.2,2.2,0,0,0,2.2-2.2,2.2,2.2,0,0,0-2.2-2.2A2.2,2.2,0,0,0,4.9-37.1ZM38.7,42.7h0A6.8,6.8,0,0,1,32,36a6.7,6.7,0,1,1,6.7,6.7ZM43.4,36a4.7,4.7,0,1,0-4.7,4.7h0A4.7,4.7,0,0,0,43.4,36ZM0,42.9c4.1.7,8.7-9.6,11.4-17.9A78.6,78.6,0,0,0,15.3.3c0-6.7-1.3-13.7-3.2-21.6-.6-1.6-3.4-4.2-5.8-5.1,2.2-2,1.8-2.9,2.3-3.7s.1-3.3,0-3.8c-4.5,1.1-6.3-2.7-4.3-5.5C9-44,19.3-53.3,29-55.2a6.4,6.4,0,0,0,1,1.3,3.1,3.1,0,0,0,1.8.5,2.9,2.9,0,0,0,2.4-1.2h0a3,3,0,0,0-.6-4.2,2.9,2.9,0,0,0-4.2.7,2.6,2.6,0,0,0-.5.9C19-55.4,8.7-46.5,3.6-41.5A33.5,33.5,0,0,1-.2-42.6l-3.7,1.2c-5-4.9-15.3-13.9-25.4-15.8a2.7,2.7,0,0,0-.5-1.1,3,3,0,0,0-4.2-.6,3,3,0,0,0-.6,4.2h0a3,3,0,0,0,2.4,1.2,3.2,3.2,0,0,0,1.8-.6,3.1,3.1,0,0,0,.9-1.1c10.1,2,20.8,11.8,25.2,16.3,1.3,2.5-.4,5.8-4.2,5-.1.6-.5,3,0,4s.6,1.5,2.3,3.5c-2.4.7-6,4-6.3,5.3-1.6,7-3,15.5-3,21.4a78.8,78.8,0,0,0,4,24.7C-8.8,33.3-3.5,43.8,0,42.9Zm-5.2-80a2.2,2.2,0,0,0-2.2-2.2,2.2,2.2,0,0,0-2.2,2.2,2.2,2.2,0,0,0,2.2,2.2A2.2,2.2,0,0,0-5.2-37.1ZM33-35.4a5.8,5.8,0,0,0,5.7,5.7,5.7,5.7,0,0,0,5.7-5.7,5.6,5.6,0,0,0-5.7-5.7A5.7,5.7,0,0,0,33-35.4Z","M.9,33.4v-9l12.7-9.9.3-1.4L.9,23.2v-10l14-10.9V1L.9,12V2L14.5-8.6c0-.3-.1-.7-.1-1.1L.9.8v-10l11.9-9.3a3.6,3.6,0,0,1-.2-1L.9-10.4v-10l9.2-7.1a4.2,4.2,0,0,0-.4-1L.9-21.6v-9.9h0l5.6-4.3L6-36.8.4-32.4H-.4L-6-36.8l-.5.9L-1-31.6a.1.1,0,0,0-.1.1v9.8l-8.6-6.8a4.2,4.2,0,0,0-.4,1l9,7v10l-11.5-9a3.6,3.6,0,0,1-.2,1L-1.1-9.3V.7L-14.4-9.7c0,.4-.1.8-.1,1.1L-1.1,1.9v10L-14.9,1V2.3L-1.1,13.1v10l-12.8-10,.3,1.4,12.5,9.8v9l-9.6-7.5.6,1.8,9,7v4.1a1,1,0,0,0,1,1,.9.9,0,0,0,1-1v-4l9.2-7.1.6-1.7Z","M0,.8A76.2,76.2,0,0,0,7.8,9.9c-1.6,1.9-5.4,7.6-6.6,21.6h-2C-2,17.1-6,11.4-7.6,9.7A72.7,72.7,0,0,0,0,.8ZM124.3,117.2c-6.5,4.7-6.3,16,.5,25.4a30,30,0,0,0,5.8,6,81.7,81.7,0,0,1,8.3-31.1C133.6,114.7,128.1,114.4,124.3,117.2ZM-82.6,86.3A82.8,82.8,0,0,0-104,75l-1.2,1.7A81,81,0,0,1-83.8,87.9a79.9,79.9,0,0,1,17.6,17.7l.3.5,1.3-1.7A81.3,81.3,0,0,0-82.6,86.3Zm47.3-33.1a80,80,0,0,1-3.9-23.7l-1.1.4-.9.2a83.5,83.5,0,0,0,4,23.7A79.9,79.9,0,0,0-25.8,76.6l2-.6-.3-.4A78.4,78.4,0,0,1-35.3,53.2Zm-81,62.7.6-1.9c-11.9-5.1-16.5-10-18.1-12.4a81.4,81.4,0,0,1-11.8,4.9,85.1,85.1,0,0,1,5.8,9.4C-138.6,115.3-132.2,112.1-116.3,115.9ZM-90,30.1a81.7,81.7,0,0,1-.8,11.1c2,.4,8.7,2.3,18.5,13.8l1.7-1.2c-6.9-11.4-7.6-18.1-7.4-20.9A99.4,99.4,0,0,1-90,30.1ZM38,53.8a85.2,85.2,0,0,0,4.1-23.4l-1.8-.5h-.2a81.5,81.5,0,0,1-4,23.4A81.4,81.4,0,0,1,24.6,75.5l-.4.6,2,.7h0A83,83,0,0,0,38,53.8Zm68.4,24.7-.9-1.3-.3-.4a82,82,0,0,1-17.3,17,82,82,0,0,1-22.5,11.3h-.2l1.2,1.7A85.2,85.2,0,0,0,89.1,95.4,81.6,81.6,0,0,0,106.4,78.5ZM70.8,54.6l1.6,1.2c9.9-11.4,16.5-13.4,18.5-13.7a80.8,80.8,0,0,1-.9-12,97.8,97.8,0,0,1-11.9,2.8C78.4,35.1,78.4,42.1,70.8,54.6ZM126.3,152a28,28,0,0,0-3.9-7.7,26.3,26.3,0,0,0-11.9-9.5c-4.6-1.6-8.8-1.3-12,1s-5.5,8.3-4.3,14.4A82.6,82.6,0,0,1,126.3,152Z","M0,4L5,6.6L4,1.1L8.1,-2.9L2.5,-3.7L0,-8.8L-2.5,-3.7L-8.1,-2.9L-4,1.1L-5,6.6Z","M0,4L5,6.6L4,1.1L8.1,-2.9L2.5,-3.7L0,-8.8L-2.5,-3.7L-8.1,-2.9L-4,1.1L-5,6.6Z"],Yh=[f.red,f.blue,f.green,f.yellow,f.green,f.teal,f.orange,f.purple],tm=["-30 -35 60 60","-35 -42 70 70","-35 -60 70 70","-45 -45 90 90","-15 -30 30 60","-75 28 150 100","-30 -35 60 60","-30 -35 60 60"],Jh=[.7,.6,.3,.6,.3,.6,.7,.7],po=class extends G{constructor(t,e,s){super(Q(Je(An[+t])),e,s);this.type="garden";this.options=t;let n=+t;this.$path.setAttr("d",An[n]),this.$outline.setAttr("d",An[n]);let r=c("path",{d:Xh[n],fill:"black",opacity:Jh[n]});this.$path.insertAfter(r),this.symmetric=!0,this.setColour(Yh[n])}static makeThumbnail(t,e){let s=+t,r=c("svg",{width:s===4?40:s===5?120:80,height:80,viewBox:tm[s]},e),o=c("g",{transform:"scale(0.5)"},r);c("path",{d:An[s],fill:Yh[s],class:"polygon-tile"},o),c("path",{d:Xh[s],fill:"black",opacity:Jh[s]},o)}};var em=["M34,0a16,16,0,0,1,6.3-12.7l-9-15.7A34.1,34.1,0,0,0,16,0,34.1,34.1,0,0,0,31.3,28.4l9-15.7A16,16,0,0,1,34,0Z","M-25,9.3a33.7,33.7,0,0,0-15.2,3.6l9,15.7A14.4,14.4,0,0,1-25,27.3a16.1,16.1,0,0,1,15.9,14h18A34,34,0,0,0-25,9.3Z","M-25-9.3a33.7,33.7,0,0,1-15.2-3.6l9-15.7A14.4,14.4,0,0,0-25-27.3a16.1,16.1,0,0,0,15.9-14h18A34,34,0,0,1-25-9.3Z","M-8.9,41.3h18A16.1,16.1,0,0,1,25,27.3a14.4,14.4,0,0,1,6.2,1.3l9-15.7A33.9,33.9,0,0,0-8.9,41.3Z","M-31.3-28.4l-9,15.6A65.9,65.9,0,0,1-9.1,41.3h18A83.7,83.7,0,0,0-31.3-28.4Z","M-8.9,41.3h18A65.9,65.9,0,0,1,40.3-12.8l-9-15.6A83.7,83.7,0,0,0-8.9,41.3Z","M-40.3 12.9L-31.3 28.4L40.3 -12.9L31.3 -28.4Z","M-40.2,12.9l9,15.6A65.7,65.7,0,0,1,0,20.6a65.7,65.7,0,0,1,31.2,7.9l9-15.6A82.6,82.6,0,0,0,0,2.6,82.6,82.6,0,0,0-40.2,12.9Z","M31.3,28.4l9-15.6A65.9,65.9,0,0,1,9.1-41.3h-18A83.7,83.7,0,0,0,31.3,28.4Z"],im=[[6,3,2],[6,4,8],[7,2,5],[7,5,2],[2,6,3],[8,6,4],[5,7,2],[2,7,5],[3,2,6],[4,8,6],[2,5,7],[5,2,7],[0,1,2],[0,2,1]],fs="#242436",sm=[f.red,f.green,f.yellow];function Qh(i,t){let e=im[i].map((s,n)=>[s,n]).sort((s,n)=>n[0]-s[0]);for(let[s,n]of e)c("path",{d:em[s],class:"tantrix","stroke-width":2.8,stroke:fs,fill:sm[n]},t)}var fo=class extends G{constructor(t,e,s){super("reg-hexagon",e,s);this.type="tantrix";this.options=t,this.colour=fs,this.$path.setAttr("fill",fs);for(let n of this.$el.$$(".tantrix"))n.setAttr("stroke",fs);Qh(+t,this.$el)}setColour(){}static makeThumbnail(t,e){let s=c("svg",{width:60,height:60,viewBox:"-54 -54 108 108"},e);c("path",{class:"polygon-tile",path:Li("reg-hexagon"),fill:fs},s),Qh(+t,s)}};var tc=[[[-15.7728,63.1105],[-65.2725,56.0545],[-61.7426,-21.037],[-34.7275,-63.1105],[65.2725,-63.1105]],[[60.6056,14.8729],[-53.4909,57.394],[-80.668,-12.5086],[-20.582,-57.394],[80.668,-57.394]],[[0,-73.612],[50,12.9905],[15,73.612],[-50,12.9905],[-30,-73.612]],[[67.056,-58.248],[67.056,1.752],[-10.5597,58.248],[-67.056,-19.3675],[7.056,-58.248]],[[-74.4415,-47.6314],[35.5585,-47.6314],[74.4415,-8.733],[60.1965,44.3902],[-19.4415,47.6314]],[[47.6215,-81.108],[43.731,-26.2458],[-24.012,81.108],[-47.6215,-43.6179],[-7.3786,-81.108]],[[94.9659,43.7299],[-5.0343,43.7299],[-94.9659,0],[-5.0343,-43.7299],[42.1151,-41.1631]],[[-13.1927,57.1955],[76.8074,57.1955],[76.8257,-32.8045],[-9.8062,-57.1955],[-76.8257,-6.4506]],[[-3.2764,58.8874],[86.2804,29.1016],[26.2804,-43.7514],[-26.2804,-58.8874],[-86.2804,13.9666]],[[51.5265,-55],[58.4735,-14.7198],[9.6458,43.251],[-58.4735,55],[-58.4735,-55]],[[-95.733,-40.991],[53.87,-40.991],[95.733,-15.7718],[1.5099,40.991],[-95.733,-10.4271]],[[-85.642,-51.4515],[12.4961,-51.4515],[85.642,-13.2965],[-38.4855,51.4515],[-85.642,18.5485]],[[-69.99,67.0025],[84.488,2.9975],[84.488,-67.0025],[14.488,-67.0025],[-84.488,32.0117]],[[-15.6401,96.696],[46.9202,6.219],[8.0799,-96.696],[-46.9202,-96.696],[-46.9202,51.458]],[[-46.6683,85],[-46.6683,22.7758],[15.5561,-85],[46.6683,-31.1122],[15.5561,85]],[[0,-46.65],[-43.301,-21.65],[-43.301,46.65],[43.301,46.65],[43.301,-21.65]],[[-25,46.65],[25,46.65],[59.15,-12.5],[0,-46.65],[-59.15,-12.5]],[[0,-64.951],[-50,21.65],[-25,64.951],[25,64.951],[50,21.65]]],ec=[...V.rainbow(15).map(i=>i.hex),f.red,f.blue,f.yellow],mo=class extends G{constructor(t,e,s){super((tc[+t-1]||[]).map(n=>n.join(" ")).join(","),e,s);this.type="pentagon";this.options=t,this.setColour(ec[+t-1])}static makeThumbnail(t,e){let s=c("svg",{width:80,height:80},e),n=new P(...tc[+t-1].map(o=>new u(o[0],o[1])));n=n.scale(41/n.radius).shift(40);let r=ec[+t-1];c("path",{path:n,fill:r,class:"polygon-tile"},s)}};var wt=25,ic={100:f.yellow,10:f.blue};function Vn(i,t,e,s){let n=s.shift(i*e,0),r=n.shift(0,Math.floor(t/i)*e),o=s.shift(0,Math.ceil(t/i)*e),a=o.shift(t%i*e,0),l=a.shift(0,t%i?-e:0);return new P(s,n,r,l,a,o)}function sc(i,t,e){return c("rect",{class:"number-tile",width:i,height:i,fill:e},t)}function nc(i,t,e,s,n,r){i.setAttr("x",n+t%e*s),i.setAttr("y",r+Math.floor(t/e)*s)}var kn=class extends S{constructor(t,e,s){super(e,s);this.type="number-tile";this.options=t;let[n,r]=t.split(":").map(o=>+o);this.count=r,this.colour=ic[r]||f.red,this.$tiles=D(()=>sc(wt,this.$el,this.colour),r),this.$outline=c("path",{class:"outline"},this.$el),r>1&&(this.$handle=this.makeHandle("h",o=>this.setWidth(Math.round(o.x/wt)))),this.setWidth(n,!0)}setWidth(t,e=!1){var s;if(t=T(t,1,this.count),t!==this.width){this.value=this.count,this.width=t,this.options=`${t}:${this.count}`;for(let n=0;n<this.count;++n)nc(this.$tiles[n],n,t,wt,-wt/2,-wt/2);this.path=Vn(t,this.count,wt,new u(-wt/2,-wt/2)),this.$outline.draw(this.path),(s=this.$handle)==null||s.setTransform(new u((t-.5)*wt,-wt/2)),this.transform(),e||this.$parent.selection.update()}}setColour(t){this.colour=t;for(let e of this.$tiles)e.setAttr("fill",A(t))}static makeThumbnail(t,e){let[s,n]=t.split(":").map(h=>+h);s=Math.min(s,n);let r=c("svg",{width:n===1?40:80,height:80},e),o=(n===1?20:40)-s/2*7,a=40-Math.ceil(n/s)/2*7,l=ic[n]||f.red;for(let h=0;h<n;++h)nc(sc(7,r,l),h,s,7,o,a)}getSnapPoints(){let t=new u(-wt/2,-wt/2),e=[t];for(let n=1;n<=this.width;++n)e.push(t.shift(n*wt,0));let s=Math.ceil(this.count/this.width);for(let n=1;n<=s;++n)e.push(t.shift(0,n*wt));for(let n=0;n<this.count;++n)e.push(t.shift((n%this.width+1)*wt,Math.floor(n/this.width+1)*wt));return e}split(){if(this.count===1)return[];let t=D(e=>{let s=e%this.width*wt,n=Math.floor(e/this.width)*wt,r=this.posn.shift(s,n).rotate(this.rot*F,this.posn);return rc(1,1,this.$parent,r,this.rot,this.colour)},this.count);return this.$parent.selection.select(t),this.delete(),t}static action(t,e){if(t==="split"){let s=[];for(let n of e)s.push(...n.split());e[0].$parent.change({added:s,deleted:e})}else if(t==="merge"){let s=Array.from(e),n=N(s.map(p=>p.count)),r=I(Us(s,p=>p.count)),o=r.$parent,a=Math.min(...s.map(p=>p.posn.x)),l=Math.min(...s.map(p=>p.posn.y)),h=Math.max(...s.map(p=>Math.ceil((p.posn.x-a)/wt)+p.width)),d=rc(n,h,o,new u(a,l),r.rot,r.colour);for(let p of e)p.delete();o.selection.add(d),e[0].$parent.change({added:[d],deleted:e})}}};function rc(i,t,e,s,n,r){let o=new kn(`${t}:${i}`,e);return o.setColour(r),o.setTransform(s,n),o}var ms=[f.yellow,"#f15e19","#e1343b",f.red,"#8d2ca1","#4e53d0",f.blue,f.teal,f.green,f.lime],oc=["#e6e2c6","#cc1030",f.green,f.red,"#ffd615",f.teal,"#181824","#9a2e13",f.blue,f.yellow],ac=25,go=class extends G{constructor(t,e,s){super(Pn(+t*ac,ac),e,s);this.type="number-bar";this.options=t,this.value=+t,this.$text=c("text",{text:t,class:"polygon-label",y:6},this.$el),this.setColour((e.options.altColors?oc:ms)[+t-1])}customTransform(){this.$text.css("transform",`rotate(${-this.rot}deg)`)}static makeThumbnail(t,e,s){let n=+t,r=new $(new u(1,1),n*20,20),o=c("svg",{width:n*20+2,height:22},e),a=c("path",{class:"polygon-tile",path:r},o);c("text",{html:t,class:"polygon-label",x:n*10+1,y:16},o),s.options.watch(l=>a.setAttr("fill",(l.altColors?oc:ms)[n-1]))}};var lc=2*Math.PI;var _i=50,On={1:f.grey,2:f.yellow,3:f.green,5:f.blue,7:f.purple},nm="M0-xAx,x,0,0,0-x,0,x,x,0,0,0,0,x,x,x,0,0,0,x,0,x,x,0,0,0,0-xZM0,yAz,z,0,0,1-y,0,z,z,0,0,1,0-y,z,z,0,0,1,y,0,z,z,0,0,1,0,yZ";function hc(i,t,e=1){let s=i.y*t.x-i.x*t.y>0?e:1-e;return[i.x,i.y+"A"+i.length,i.length,0,s,e,t.x,t.y].join(",")}function cc(i,t,e=_i){if(t===1)return nm.replace(/x/g,""+e).replace(/y/g,""+.4*e).replace(/z/g,""+(.4*e+.1));let s=lc/t,n=-Math.PI/2-s/2,r=u.fromPolar(n+s*i,e),o=u.fromPolar(n+s*(i+1),e);return`M${hc(r,o)}L${hc(o.scale(.4),r.scale(.4),0)}Z`}function uc(i){return i===1?[1]:we(i).reverse()}var gs=class extends S{constructor(t,e,s){super(e,s);this.type="prime-disk";this.$segments=[];this.factors=[];this.path=new _(y,_i),c("circle",{class:"prime-background",r:_i},this.$el),this.$segmentWrap=c("g",{},this.$el),this.$label=c("text",{class:"prime-label",y:5},this.$el),this.$outline=c("path",{class:"outline",path:this.path},this.$el),this.setValue(+t)}setValue(t){t=this.value=T(Math.round(t),1,9999999),this.options=this.$label.text=""+t,this.factors=uc(t);let e=this.factors.length;for(let s=0;s<e;++s){let n=this.getSegment(s);n.setAttr("fill",On[this.factors[s]]||f.red),n.setAttr("d",cc(s,e)),n.show()}for(let s=e;s<this.$segments.length;++s)this.$segments[s].hide()}multiply(t){this.setValue(+this.options*t)}getSegment(t){if(this.$segments[t])return this.$segments[t];let e=c("path",{class:"polygon-tile"},this.$segmentWrap);return this.$parent.events.listen(e,{down:()=>{this.$parent.selection.add(this,!this.$parent.events.shiftKey)},start:()=>{!this.isActive||(this.$parent.selection.add(this,!0),e.addClass("prime-move"),this.$container.append(e))},move:s=>{!this.isActive||(e.setTransform(this.posn.add(s.posn).subtract(s.startPosn)),this.setCollision(this.findNearby("prime-disk",_i,s.posn)))},end:s=>{if(!this.isActive)return;e.removeClass("prime-move"),e.setTransform(),this.$segmentWrap.append(e);let n=s.lastPosn.subtract(s.startPosn);if(n.length>_i){let r=[],o=[this];if(this.collision)this.collision.multiply(this.factors[t]),this.$parent.selection.add(this.collision,!0),o.push(this.collision),this.setCollision();else{let a=new gs(`${this.factors[t]}`,this.$parent);a.setTransform(this.posn.add(n)),r.push(a),this.$parent.selection.add(a,!0)}this.setValue(+this.options/this.factors[t]),this.$parent.change({changed:o,added:r})}},checkIfActive:()=>this.factors.length>1}),this.$segments[t]=e,e}setColour(t){if(this.colour=t,t)for(let e of this.$segments)e.setAttr("fill",A(this.colour))}highlight(t=!0){this.$el.setClass("active",t)}move(t){super.move(t),!(this.$parent.selection.tiles.size>1)&&this.setCollision(this.findNearby("prime-disk",_i))}collide(t){t.highlight(!1),t.multiply(+this.options),this.delete();let e=this.lastSavedData?[this]:void 0;this.$parent.change({changed:[t],deleted:e})}static makeThumbnail(t,e){let s=c("svg",{width:54,height:54},e),n=c("g",{transform:"translate(27 27)"},s),r=o=>{n.removeChildren();let a=uc(o);for(let l=0;l<a.length;++l){let h=On[a[l]]||f.red,d=cc(l,a.length,25);c("path",{fill:h,d,class:"polygon-tile"},n),c("text",{text:o,y:4,fill:"white",style:"font-size: 11px; text-anchor: middle"},n)}};e.onAttr("data-options",o=>r(Math.round(+o)))}};var ft=25,wo=class extends S{constructor(t,e,s){super(e,s);this.type="decimal-grid";this.$handles=[];this.$tiles=c("g",{},this.$el),this.$outline=c("path",{class:"outline"},this.$el),this.$handles[0]=this.makeHandle("h",a=>this.setDimensions(a.x/ft,this.height,this.size)),this.$handles[1]=this.makeHandle("v",a=>this.setDimensions(this.width,a.y/ft,this.size)),this.$handles[2]=this.makeHandle("c",a=>this.setDimensions(this.width,this.height,(a.x+a.y)/2/ft)),this.$handles[1].css("cursor","ns-resize"),this.$handles[2].css("cursor","nwse-resize");let[n,r,o]=t.split(":");this.setDimensions(+n,+r,+o)}setDimensions(t,e,s){t=this.width=T(Math.round(t),1,100),e=this.height=T(Math.round(e),1,100),s=this.size=T(Math.round(s),2,Math.max(t,e));let n=[t,e,s].join(":");if(n===this.options)return;this.options=n,this.$tiles.removeChildren();let r=Math.floor(t/s)*s,o=Math.floor(e/s)*s,a=s*ft;for(let l=0;l<r;l+=s)for(let h=0;h<o;h+=s)this.drawRect(l*ft,h*ft,a,a,f.yellow);for(let l=r;l<t;++l)for(let h=0;h<o;h+=s)this.drawRect(l*ft,h*ft,ft,a,f.blue);for(let l=0;l<r;l+=s)for(let h=o;h<e;++h)this.drawRect(l*ft,h*ft,a,ft,f.blue);for(let l=r;l<t;++l)for(let h=o;h<e;++h)this.drawRect(l*ft,h*ft,ft,ft,f.red);this.$handles[0].setTransform({x:t*ft,y:0}),this.$handles[1].setTransform({x:0,y:e*ft}),this.$handles[2].setTransform({x:a,y:a}),this.path=new $(y,t*ft,e*ft),this.$outline.draw(this.path),this.$parent.selection.update(),this.transform()}drawRect(t,e,s,n,r){c("rect",{x:t,y:e,width:s,height:n,fill:this.colour||r,class:"polygon-tile"},this.$tiles)}setColour(t){this.colour=t;for(let e of this.$tiles.children)e.setAttr("fill",A(t))}static makeThumbnail(t,e){let s=c("svg",{width:140,height:80},e),n=(r,o,a,l,h)=>c("rect",{x:5+r,y:5+o,width:a,height:l,fill:h,class:"polygon-tile"},s);for(let r=0;r<2;++r)n(50*r,0,50,50,f.yellow);for(let r=0;r<3;++r)n(100+10*r,0,10,50,f.blue);for(let r=0;r<2;++r)for(let o=0;o<2;++o)n(50*r,50+o*10,50,10,f.blue);for(let r=0;r<3;++r)for(let o=0;o<2;++o)n(100+r*10,50+o*10,10,10,f.red)}};var dc='<h3>Dot Machine</h3><label class="row"><div class="label">Base:</div><input class="input-field" type="number" :bind="base" min="2" max="25"></label><label class="row"><div class="label">Boxes:</div><input class="input-field" type="number" :bind="boxes" min="1" max="10"></label>';var yo=class extends S{constructor(t,e,s){super(e,s);this.type="dot-machine";this.canRotate=!1;this.canDragToSelect=!1;this.cells=[];this.isAnimating=!1;let[n,r]=t.split(":").map(a=>+a),o={base:n,boxes:r};this.model=e.bindSettingsPanel(this,dc,o),this.$outline=c("rect",{class:"outline",rx:12},this.$el),this.model.watch(()=>this.draw(this.model)),this.setColour(f.purple),this.setOrder("back"),this.onMove=()=>{let a=Array.from(e.selection.tiles).filter(l=>l.type==="dot");for(let l of this.cells)l.hover(a.some(h=>l.contains(h.posn)))},this.onMoveEnd=()=>{for(let a of this.cells)a.hover(!1)},e.on("move-selection",this.onMove),e.on("move-end",this.onMoveEnd),this.onChange=()=>this.rearrangeDots(),setTimeout(()=>{this.rearrangeDots(),e.on("change",this.onChange)})}delete(){this.$parent.off("move-selection",this.onMove),this.$parent.off("move-end",this.onMoveEnd),this.$parent.off("change",this.onChange),super.delete()}select(){super.select();for(let t of this.cells)t.hover()}deselect(){super.deselect();for(let t of this.cells)t.hover(!1)}draw(t){let e=Math.round(t.base),s=Math.round(t.boxes);if(this.options=`${e}:${s}`,this.cells.length>s){for(let r=s;r<this.cells.length;++r)this.cells[r].delete();this.cells=this.cells.slice(0,s)}else if(this.cells.length<s)for(let r=this.cells.length;r<s;++r){let o=new pc(this,r,this.$parent);this.cells.push(o),o.setColour(this.colour)}for(let r of this.cells)r.setBase(e);let n=150*(s-1)+10;this.path=new $(new u(-n,-10),n+160,170),this.$outline.setRect(this.path),this.transform(),this.$parent.selection.update()}getSnapPoints(){return[]}setColour(t){super.setColour(t.slice(0,7));for(let e of this.cells)e.setColour(this.colour)}moveEnd(){super.moveEnd();for(let t of this.cells)for(let e of[...t.dots,...t.antiDots])e.cell=void 0}rearrangeDots(){if(!this.isAnimating){for(let t of this.cells)t.clear();for(let t of this.$parent.tiles.values())if(!(!t.is("dot")||t.deleted))for(let e of this.cells)(t.cell===e||!t.cell&&e.contains(t.posn))&&e.addDot(t);for(let t of this.cells)t.rearrange()}}static makeThumbnail(t,e){let s=c("svg",{width:160,height:60},e);for(let n of[105,55,5])c("rect",{x:n,y:5,width:50,height:50,class:"dot-cell",stroke:"#eee",style:"stroke-width: 6px"},s),c("circle",{cx:n+25,cy:5,r:2},s),c("circle",{cx:n+25,cy:55,r:2},s)}static action(t,e){return O(this,null,function*(){if(t==="explode")for(let s of e)s.isAnimating||s.cells[0].explode();else if(t==="annihilate")for(let s of e)s.isAnimating||s.cells[0].annihilate()})}},pc=class{constructor(t,e=0,s){this.machine=t;this.index=e;this.$doc=s;this.dots=[];this.antiDots=[];let n=-150*e;this.$el=c("rect",{class:"dot-cell",width:150,height:150,x:n}),this.$label=c("text",{class:"dot-label",x:75+n,y:154,"font-size":"12px"},t.$el),this.$value=c("text",{class:"dot-label",x:75+n,y:6,text:0,"font-size":"18px"},t.$el),this.bounds=new $(new u(n,0),150,150),t.$el.prepend(this.$el)}setBase(t){this.$label.text=rt(Math.pow(t,this.index))}delete(){this.$el.remove(),this.$label.remove(),this.$value.remove()}setColour(t){this.$el.setAttr("stroke",t),this.machine.isActive&&this.$el.css("fill",t)}hover(t=!0){this.machine.isActive&&!t||this.$el.css("fill",t?this.machine.colour:"none")}contains(t){return this.bounds.translate(this.machine.posn).contains(t)}clear(){this.dots=[],this.antiDots=[]}addDot(t){(t.options==="1"?this.dots:this.antiDots).push(t),t.cell=this}rearrange(){this.$value.text=rt(this.dots.length-this.antiDots.length);let t=[...this.dots,...this.antiDots];if(!t.length)return;let e=Math.ceil(Math.sqrt(t.length)),s=Math.ceil(t.length/e),n=t.length<=16?30:t.length<=25?25:20,r=this.bounds.center.add(this.machine.posn).shift(-n*(e-1)/2,-n*(s-1)/2),o=D(a=>r.shift(a%e*n,Math.floor(a/e)*n),t.length);return this.animatePoints(t,o)}animatePoints(t,e){let s=t.map(n=>n.posn);for(let[n,r]of t.entries())r.setTransform(e[n]);return z(n=>{var r;for(let[o,a]of t.entries()){let l=u.interpolate(s[o],e[o],Y("quad",n));a.$el.setTransform(l),a.transformed=(r=a.path)==null?void 0:r.translate(l)}this.machine.$parent.selection.update()},240).promise}getDotsToExplode(){let t=this.machine.model.base;if(this.dots.length>=t)return this.dots.splice(0,t);if(this.antiDots.length>=t)return this.antiDots.splice(0,t)}explode(){return O(this,null,function*(){let t=this.machine.cells[this.index+1];if(!t){this.machine.isAnimating=!1,this.machine.$parent.change({changed:this.dots});return}this.machine.isAnimating=!0;let e=this.getDotsToExplode();if(!e)return t.explode();this.$doc.playSound("rise"),t.addDot(e[0]);for(let s of e.slice(1))s.popOut();return t.rearrange(),yield Bs(400),this.rearrange(),yield Bs(400),this.explode()})}annihilate(){return O(this,null,function*(){this.machine.isAnimating=!0;let t=Math.min(this.dots.length,this.antiDots.length);if(t){let s=this.dots.splice(0,t),n=this.antiDots.splice(0,t);for(let r of[...s,...n])r.popOut();this.$doc.playSound("woosh"),this.rearrange(),yield Bs(600)}let e=this.machine.cells[this.index+1];if(e)return e.annihilate();this.machine.isAnimating=!1,this.machine.$parent.change({changed:this.dots})})}};var Ln=25/2,ws=class extends S{constructor(t,e,s){super(e,s);this.type="dot";this.deleted=!1;this.options=t,this.$path=c("circle",{r:Ln,class:"polygon-tile"},this.$el),this.$outline=c("circle",{r:Ln,class:"outline"},this.$el),this.path=new _(y,Ln),this.setColour(f.blue)}setColour(t){this.colour=t,this.$path.setAttr("fill",this.options==="-1"?f.red:this.colour)}getSnapPoints(){return[]}getCell(){for(let t of this.$parent.tiles.values())if(!(t.type!=="dot-machine"||t.isActive)){for(let e of t.cells)if(e.contains(this.posn))return e}}moveEnd(){let t=this.cell,e=this.cell=this.getCell();if(!t||!e||t===e||t.machine!==e.machine)return;let s=Math.abs(t.index-e.index),n=t.machine.model.base**s;if(t.index<e.index){let r=this.options==="1"?t.dots:t.antiDots;if(r.length<n)return this.cell=t;for(let o of r.filter(a=>!a.isActive).slice(0,n-1))o.popOut()}else for(let r=0;r<n-1;++r){let o=new ws(this.options,this.$parent);o.posn=this.posn,o.cell=e}}static makeThumbnail(t,e){let s=t==="1"?f.blue:f.red,n=c("svg",{width:40,height:40},e);c("circle",{class:"polygon-tile",cx:20,cy:20,r:Ln,fill:s},n)}negate(){this.options=this.options==="-1"?"1":"-1",this.setColour(f.blue)}popOut(){return O(this,null,function*(){this.deleted=!0,yield this.$path.exit("pop").promise,this.delete()})}};function fc(i){return i===0?f.grey:i>0?f.blue:f.red}function mc(i){return+i.replace("\u2013","-")}function gc(i,t,e=40,s=50){t=T(Math.round(t),-9999,9999);let r=(i.text=rt(t)).length;return i.css("font-size",(r>=6?.625:r>=4?.75:1)*e+"px"),i.setAttr("y",(r>=6?.9:r>=4?.94:1)*s),t}var vo=class extends S{constructor(t,e,s){super(e,s);this.type="number-card";this.path=new $(y,75),this.$path=c("rect",{class:"polygon-tile",rx:10,width:75,height:75},this.$el),this.$label=c("text",{x:75/2,fill:"white",style:"text-anchor: middle"},this.$el),this.$outline=c("rect",{class:"outline",rx:10,width:75,height:75},this.$el),this.setValue(mc(t))}setValue(t){this.value=gc(this.$label,t),this.options=""+this.value,this.setColour()}setColour(t){super.setColour(t||fc(this.value)),this.$path.setAttr("fill",A(this.colour))}highlight(t=!0){this.$el.setClass("active",t)}move(t){if(super.move(t),!this.$parent.options.mergeTiles||this.$parent.selection.tiles.size>1)return;let e=this.findNearby("number-card",40);this.setCollision(e&&W(e.value+this.value,-9999,9999)?e:void 0)}collide(t){t.highlight(!1),t.setValue(t.value+this.value),this.$parent.playSound("click"),this.delete();let e=this.lastSavedData?[this]:void 0;this.$parent.change({changed:[t],deleted:e})}negate(){this.setValue(-this.value)}static makeThumbnail(t,e){let s=c("svg",{width:60,height:60},e),n=c("rect",{x:5,y:5,width:50,height:50,class:"polygon-tile",rx:5},s),r=c("text",{fill:"white",x:30,style:"text-anchor: middle"},s);e.onAttr("data-options",o=>{let a=gc(r,mc(o),30,39);n.setAttr("fill",fc(a))})}};var ut=50,ni=14,rm=`M-${ut/2} -4.5h${ut*ni}v-33h9v75h-9v-33h-${ut*ni}v33h-9v-75h9Z`,bo=class extends S{constructor(t,e,s){super(e,s);this.type="abacus";this.options=t,this.path=new $(new u(-ut/2-9,-ut/2-12.5),ni*ut+18,ut+25),c("path",{path:this.path,fill:"transparent"},this.$el),c("path",{d:rm,class:"polygon-tile",fill:"#7e7c86"},this.$el),c("path",{path:this.path,class:"outline"},this.$el),this.positions=t.split(",").map(n=>+n),this.$beads=this.positions.map(n=>c("circle",{cx:n*ut,r:ut/2,class:"polygon-tile"},this.$el)),this.$gradients=this.positions.map(n=>c("circle",{cx:n*ut,r:ut/2,class:"bead-gradient"},this.$el)),this.count=this.$beads.length;for(let[n,r]of this.$beads.entries())this.setupBead(r,n);this.setColour(f.orange)}setupBead(t,e){let s=0;this.$parent.events.listen(t,{click:()=>{this.locked||this.$parent.selection.add(this,!this.$parent.events.shiftKey)},start:n=>{s=this.positions[e]-this.relativePosn(n.posn).x/ut},move:n=>{let r=this.positions[e]=T(s+this.relativePosn(n.posn).x/ut,e,ni-(this.count-e)),o=r;for(let l=e+1;l<this.count;++l)this.positions[l]<o+1&&(this.positions[l]=o+1),o=this.positions[l];let a=r;for(let l=e-1;l>=0;--l)this.positions[l]>a-1&&(this.positions[l]=a-1),a=this.positions[l];for(let[l,h]of this.$beads.entries())h.setAttr("cx",this.positions[l]*ut),this.$gradients[l].setAttr("cx",this.positions[l]*ut)},end:()=>{let n=this.options;this.options=this.positions.join(","),n!==this.options&&this.$parent.change({changed:[this]})}})}setColour(t){super.setColour(t.slice(0,7));let e=this.$beads.length/2,s=V.mix("#fff",this.colour,.8);for(let[n,r]of this.$beads.entries())r.setAttr("fill",n<e?this.colour:s)}getSnapPoints(){return[new u(-ut/2,-25),new u((ni-.5)*ut,-25),new u(-ut/2,25),new u((ni-.5)*ut,25),new u(-ut/2,50),new u((ni-.5)*ut,50)]}static makeThumbnail(t,e){let s=c("svg",{width:240,height:40},e);c("line",{x1:5,y1:18,x2:235,y2:20,stroke:"white","stroke-width":"3px"},s),c("line",{x1:4,y1:3,x2:4,y2:37,stroke:"white","stroke-width":"3px"},s),c("line",{x1:236,y1:3,x2:236,y2:37,stroke:"white","stroke-width":"3px"},s);for(let n=0;n<10;++n){let r=n<5?f.orange:V.mix("#fff",f.orange,.7),o={cx:16+20*n,cy:20,r:10,style:"stroke-width: 0.5px"};c("circle",ne(ne({},o),{class:"polygon-tile",fill:r}),s),c("circle",ne(ne({},o),{class:"bead-gradient"}),s)}}};var om={1:f.yellow,x:f.green,x2:f.blue,y:f.teal,y2:"#8d2ca1",xy:"#4e53d0"},ys=25,am=ys*5.4,lm=ys*4.7,hm="#ddd";function In(i){return i.replace("-","\u2013").replace("2","\xB2")}function $o(i){return i[0]==="-"?f.red:om[i]}function wc(i,t=ys,e=am,s=lm){return i.endsWith("x2")?[e,e]:i.endsWith("y2")?[s,s]:i.endsWith("xy")?[e,s]:i.endsWith("x")?[t,e]:i.endsWith("y")?[t,s]:[t,t]}var vs=class extends G{constructor(t,e,s){super(Pn(...wc(t.toLowerCase())),e,s);this.type="algebra-tile";this.options=t.toLowerCase(),this.$text=c("text",{text:In(this.options),class:"polygon-label",y:6},this.$el),this.setColour($o(this.options))}setColour(t=this.colour){super.setColour(t),this.$path.setAttr("fill",A(this.collision?hm:this.colour)),this.$text.text=this.collision?"0":In(this.options)}customTransform(){this.$text.css("transform",`rotate(${-this.rot}deg)`)}setCollision(t){this.collision=t,this.setColour()}move(t){if(super.move(t),this.collision){if(u.distance(this.posn,this.collision.posn)<.95*ys)return;this.collision.setCollision(),this.setCollision()}let e=this.options[0]==="-"?this.options.slice(1):"-"+this.options;for(let s of this.$parent.tiles.values())if(!(!s.is("algebra-tile")||s.collision||s===this)&&s.options===e&&!(u.distance(this.posn,s.posn)>=.95*ys)){this.setCollision(s),s.setCollision(this);return}}static makeThumbnail(t,e){let[s,n]=wc(t,20,78,64),r=t[0]==="-"?t.slice(1):t,o=r==="y2"?112:["x2","xy"].includes(r)?28:2,a=r==="1"?2:["x","x2"].includes(r)?28:112;e.hasAttr("data-rot")&&([o,a,s,n]=[a,o,n,s]),e.setRect(new $(new u(o,a),s,n)),e.setAttr("fill",$o(t)),e.insertAfter(c("text",{text:In(t),class:"polygon-label",x:o+s/2,y:a+n/2+5}))}negate(){this.options.startsWith("-")?this.options=this.options.slice(1):this.options="-"+this.options,this.setColour($o(this.options)),this.$text.text=In(this.options)}static action(t,e){if(t==="negate"){for(let s of e)s.negate();e[0].$parent.change({changed:e})}}};var yc="M-125,0l35,252c0,11,40.3,20,90,20s90-9,90-20L125,0Z",vc=D(i=>new u(i<5?-45:45,65+40*(i%5)),10),xo=class extends S{constructor(t,e,s){super(e,s);this.type="bucket";this.canRotate=!1;this.canDragToSelect=!1;this.isAnimating=!1;this.tiles=zt(void 0,20);c("path",{class:"polygon-tile bucket",d:yc,fill:"#ccc"},this.$el),c("ellipse",{class:"polygon-tile bucket",rx:125,ry:28,fill:"#888"},this.$el),this.$text=c("text",{text:0,class:"bucket-label",y:12},this.$el),this.setColour(f.grey),this.path=new P(new u(-125,0),new u(0,-28),new u(125,0),new u(90,252),new u(0,272),new u(-90,252)),this.setOrder("back"),this.onMoveEnd=()=>this.recompute(),e.on("change",this.onMoveEnd)}delete(){this.$parent.off("change",this.onMoveEnd),super.delete()}getSnapPoints(){return[]}recompute(){return O(this,null,function*(){var e;if(this.isAnimating)return;let t=[];for(let[s,n]of this.tiles.entries())n&&!Ve(this.$parent.tiles.values(),r=>r===n)&&(this.tiles[s]=void 0);for(let s of this.$parent.tiles.values()){if(!s.is("algebra-tile")||!s.options.endsWith("1"))continue;let n=s.options!=="1",r=(e=this.transformed)==null?void 0:e.contains(s.posn),o=this.tiles.indexOf(s);if(o>=0&&!r&&(this.tiles[o]=void 0),!r)continue;if((n?o>=0&&o<10:o>=10)&&(this.tiles[o]=void 0,o=-1),o<0&&(o=this.tiles.findIndex((l,h)=>!l&&(n?h>=10:h<10))),o<0)return;this.tiles[o]=s;let a=vc[o%10].shift(n?15:-15,0).add(this.posn);a.equals(s.posn)||t.push({tile:s,from:s.posn,to:a})}if(this.$text.text=rt(N(this.tiles.map((s,n)=>s?n<10?1:-1:0))),t.length){this.isAnimating=!0,yield z(s=>{var r;let n=Y("quad",s);for(let{tile:o,from:a,to:l}of t){let h=u.interpolate(a,l,n);o.posn=h,o.$el.setTransform(h,o.rot*F),o.transformed=(r=o.path)==null?void 0:r.translate(h)}this.$parent.selection.update()},240).promise;for(let s of t)s.tile.transform(),s.tile.move();this.isAnimating=!1}})}fill(){if(this.isAnimating)return[];let t=[];for(let[e,s]of this.tiles.entries()){if(s)continue;let n=new vs(e<10?"1":"-1",this.$parent);n.setTransform(vc[e%10].shift(e<10?-15:15,0).add(this.posn)),this.tiles[e]=n,t.push(n)}return this.$text.text="0",t}static makeThumbnail(t,e){let s=c("svg",{width:120,height:140,viewBox:"-140 -40 280 320"},e);c("path",{class:"polygon-tile bucket",d:yc,fill:"#ccc",style:"stroke-width: 2px"},s),c("ellipse",{class:"polygon-tile bucket",rx:125,ry:28,fill:"#888",style:"stroke-width: 2px"},s)}static action(t,e){return O(this,null,function*(){if(t==="fill"){let s=[];for(let n of e)s.push(...n.fill());s.length&&e[0].$parent.change({added:s})}})}};var Xt=50,bc=qt((i,t,e,s,n)=>i==="number"?1+s+n*t:i==="addition"?!s&&!n?"+":!s||!n?s||n:s+n:!s&&!n?"\xD7":!s||!n?s||n:s*n),cm=qt(i=>V.from(i).brightness<140),um=qt(i=>V.mix(i,"#000",.7).hex);function dm(i){return i?new Map(i.split(",").map(t=>t.split("-"))):new Map}function pm(i){return Array.from(i.entries()).map(t=>t.join("-")).join(",")}var To=class extends S{constructor(t,e,s){super(e,s);this.type="number-grid";this.cells=[];this.$handles=[];this.rows=3;this.cols=2;this.isFocussed=!1;this.selected=new Set;this.canRotate=!1;this.$cells=c("g",{},this.$el),this.$outline=c("path",{class:"outline"},this.$el),e.events.listen(this.$el,{down:l=>this.selectCell(l.posn),move:l=>this.selectCell(l.posn,!0),checkIfActive:()=>this.isFocussed}),this.$handles[0]=this.makeHandle("h",l=>this.resize(l.x/Xt,this.rows)),this.$handles[1]=this.makeHandle("v",l=>this.resize(this.cols,l.y/Xt)),this.$handles[1].css("cursor","ns-resize");let[n,r,o,a]=t.split(":");this.gridType=n,this.colour="#ccc",this.colorsStr=a||"",this.colors=dm(this.colorsStr),this.resize(+r,+o)}resize(t,e){this.cols=T(Math.round(t),2,20),this.rows=T(Math.round(e),2,20);let s=`${this.gridType}:${this.cols}:${this.rows}:${this.colorsStr}`;if(s===this.options)return;this.options=s;let n=this.cols*this.rows;for(let r=this.cells.length;r<n;++r)this.cells.push(this.makeCell());for(let r=n;r<this.cells.length;++r)this.cells[r][0].hide();this.updateCells(),this.path=new $(y,this.cols*Xt,this.rows*Xt),this.$outline.draw(this.path),this.$handles[0].setTransform({x:this.path.w,y:0}),this.$handles[1].setTransform({x:0,y:this.path.h}),this.transform(),this.$parent.selection.update()}makeCell(){let t=c("g",{class:"number-grid-cell"},this.$cells),e=c("circle",{r:23,cx:Xt/2,cy:Xt/2},t);return[t,e,c("text",{x:Xt/2,y:Xt/2+8},t)]}updateCells(){for(let t=0;t<this.cols;++t)for(let e=0;e<this.rows;++e){let[s,n,r]=this.cells[t+e*this.cols];s.show(),s.translate(t*Xt,this.flipped?(this.rows-1-e)*Xt:e*Xt),r.text=""+this.getCellValue(t,e)}this.updateColors()}updateColors(){let t=this.gridType==="number",e=A(this.colour),s=um(e);for(let n=0;n<this.cols;++n)for(let r=0;r<this.rows;++r){let o=n+r*this.cols,a=!t&&(!n||!r),l=this.colors.get(t?`${o}`:`${r}/${n}`)||(a?s:e);this.cells[o][1].setAttr("fill",l),this.cells[o][2].setAttr("fill",cm(l)?"#fff":"#000")}}setColour(t,e){if(this.isFocussed&&e==="picker"){let s=this.gridType==="number",n=A(t);for(let r of this.selected)this.colors.set(s?`${r}`:`${Math.floor(r/this.cols)}/${r%this.cols}`,n);return this.colorsStr=pm(this.colors),this.options=`${this.gridType}:${this.cols}:${this.rows}:${this.colorsStr}`,this.$parent.change({changed:[this]}),this.updateColors()}e==="picker"&&(this.colors.clear(),this.colorsStr="",this.options=`${this.gridType}:${this.cols}:${this.rows}`),super.setColour(t),this.updateColors()}doubleClick(t){this.$parent.selection.clear(),this.isFocussed=!0,this.$parent.options.focussed=this,this.selectCell(t.posn)}selectCell(t,e=!1){if(t=this.relativePosn(t).scale(1/Xt).floor(),t.x<0||t.x>=this.cols||t.y<0||t.y>=this.rows)return;let s=t.x+(this.flipped?this.rows-1-t.y:t.y)*this.cols;if(e)this.selected.has(s)||this.addToSelection(s);else if(this.$parent.events.shiftKey)this.selected.has(s)?this.removeFromSelection(s):this.addToSelection(s);else{for(let n of this.selected)this.removeFromSelection(n);this.addToSelection(s)}}addToSelection(t){this.cells[t][0].addClass("active"),this.selected.add(t)}removeFromSelection(t){this.cells[t][0].removeClass("active"),this.selected.delete(t)}getCellValue(t,e){return bc(this.gridType,this.cols,this.rows,t,e)}blur(){for(let t of this.selected)this.removeFromSelection(t);this.isFocussed=!1,this.$parent.options.focussed=void 0}flip(){super.flip(),this.updateCells()}selectMultiples(){let t=Array.from(this.selected).map(s=>+this.getCellValue(s%this.cols,Math.floor(s/this.cols))),e=t.length>1?Ue(...t):t[0];for(let s of this.selected)this.removeFromSelection(s);for(let s=0;s<this.cols;++s)for(let n=0;n<this.rows;++n)+this.getCellValue(s,n)%e==0&&this.addToSelection(s+n*this.cols)}static action(t,e){if(t==="reverse"){for(let s of e)s.flip();e[0].$parent.change({changed:e})}}static makeThumbnail(t,e){let s=t.split(":")[0],n=s==="number"?5:4,r=c("svg",{width:10+25*n,height:10+25*n,"text-anchor":"middle","font-size":"14"},e),o=(a,l,h,d)=>{c("circle",{cx:a+17.5,cy:l+17.5,r:12,fill:h},r),c("text",{x:a+17.5,y:l+22,text:d,fill:"white"},r)};for(let a=0;a<n;++a)for(let l=0;l<n;++l){let h=s==="number"||a&&l?"#ffffff44":"#ffffff88";o(25*a,25*l,h,bc(s,n,n,a,l))}}};var $c=25;function fm(i){let t=+i,e=Math.ceil(t/2);return Q(Vn(e,t,$c,y).points)}function xc(i,t,e,s=0,n=0){let r=Math.ceil(i/2);for(let o=0;o<i;++o){let a=(o%r+.5)*t+s,l=(.5+(o<r?0:1))*t+n;c("circle",{fill:"white",cx:a,cy:l,r:t*.25},e)}}var So=class extends G{constructor(t,e,s){super(fm(t),e,s);this.type="number-frame";this.options=t,this.value=+t,this.setColour(ms[this.value-1]),xc(this.value,$c,this.$el)}static makeThumbnail(t,e){let s=+t,n=Math.ceil(s/2),r=Vn(n,s,20,new u(5,5)),o=c("svg",{width:n*20+10,height:50},e);c("path",{path:r,fill:ms[s-1],class:"polygon-tile"},o),xc(s,20,o,5,5)}};var Tc=4,Sc=6,ri=6;function Mc(i){return i===1?[1]:we(i)}var mm=qt((i,t)=>{if(i===2)return 2*t+1.5*ri;let e=2*t+ri,s=2*t+ri;i===3&&(s/=Math.sqrt(3)),i===4&&(s/=Math.sqrt(2)),i>3&&i%2&&(i-=1);let r=Math.ceil((Math.sqrt(i*8/Sc+1)-1)/2);return s+(r-1)*e+t+ri});function Mo(i){return i.reduceRight((t,e)=>mm(e,t),Tc)}function gm(i,t){if(i===1)return[];if(i===2)return[y.shift(-t-ri/2,0),y.shift(t+ri/2,0)];let e=[],s=2*t+ri,n=s;i===3&&(n/=Math.sqrt(3)),i===4&&(n/=Math.sqrt(2)),i>3&&i%2&&(e.push(y),i-=1);let r=1;for(;i;){let o=Math.min(Sc*r,i);e.push(...P.regular(o,n).points),i-=o,n+=s,r+=1}return e}function Po(i,t,e,s=y){if(i.length<1)return[];let n=c("g",{class:"tile","data-n":i.join("-")},e),r=On[i[0]]||f.red;c("circle",{r:t,cx:s.x,cy:s.y,fill:r,class:"polygon-tile"},n);let o=i.slice(1),a=Mo(o),l=gm(i[0],a);if(o.length){let h=[n];for(let d of l)h.push(...Po(o,a,n,s.add(d)));return h}else{for(let h of l){let d=s.add(h);c("circle",{r:Tc,cx:d.x,cy:d.y,fill:"white"},n)}return[n]}}var bs=class extends S{constructor(t,e){super(e);this.type="number-dot";this.factors=[];this.$body=c("g",{},this.$el),this.$outline=c("path",{class:"outline"},this.$el),t.startsWith(">")?(this.options=t,this.factors=t.slice(1).split("-").map(s=>+s),this.value=this.factors.reduce((s,n)=>s*n,1),this.count=this.factors.length,this.buildTile()):this.setValue(+t)}setValue(t){t=this.value=T(Math.round(t),1,999),this.factors=Mc(t),this.count=this.factors.length,this.options=">"+this.factors.join("-"),this.buildTile()}add(t){this.setValue(this.value+t)}buildTile(){this.$body.removeChildren(),this.radius=Mo(this.factors);let t=Po(this.factors,this.radius,this.$body);if(this.factors.length>1)for(let e of t.slice(1))this.setupListeners(e);this.path=new _(y,this.radius),this.$outline.draw(this.path),this.transform()}setupListeners(t){let s=t.attr("data-n").split("-").reduce((o,a)=>o*+a,1),n=t.parent,r=t.children[0];this.$parent.events.listen(t,{down:()=>this.$parent.selection.add(this,!this.$parent.events.shiftKey),start:()=>{!this.isActive||(this.$parent.selection.add(this,!0),r.addClass("prime-move"),this.$container.append(t))},move:o=>{!this.isActive||(t.setTransform(this.posn.add(o.posn).subtract(o.startPosn)),this.setCollision(this.findCollision(o.posn)))},end:o=>{if(!!this.isActive)if(o.lastPosn.subtract(this.posn).length<=this.radius)t.setTransform(),r.removeClass("prime-move"),n.append(t);else if(this.collision)t.remove(),this.collision.add(s),this.add(-s),this.$parent.selection.add(this.collision,!0),this.$parent.change({changed:[this,this.collision]}),this.setCollision();else{t.remove();let a=new bs(`${s}`,this.$parent);a.setTransform(this.posn.add(o.lastPosn).subtract(o.startPosn)),this.add(-s),this.$parent.change({added:[a],changed:[this]})}}})}findCollision(t){for(let e of this.$parent.tiles.values())if(e!==this&&e.is("number-dot")&&u.distance(t,e.posn)<e.radius)return e}highlight(t=!0){this.$el.setClass("active",t)}move(t){super.move(t),!(this.$parent.selection.tiles.size>1)&&this.setCollision(this.findCollision(this.posn))}collide(t){t.highlight(!1),t.add(this.value);let e=this.lastSavedData?[this]:void 0;this.$parent.change({changed:[t],deleted:e}),this.delete()}reorder(){this.factors.push(this.factors.shift()),this.options=`>${this.factors.join("-")}`,this.buildTile()}shrink(){this.factors.length<=1||(this.factors.push(this.factors.pop()*this.factors.pop()),this.count=this.factors.length,this.options=`>${this.factors.join("-")}`,this.buildTile())}grow(){let t=this.factors.length-1-this.factors.slice(0).reverse().findIndex(n=>!xr(n));if(t<0||!this.factors[t])return;let e=we(this.factors[t])[0],s=Math.round(this.factors[t]/e);this.factors.splice(t,1,e,s),this.count=this.factors.length,this.options=`>${this.factors.join("-")}`,this.buildTile()}static action(t,e){return O(this,null,function*(){if(t!=="grow"&&(e=e.filter(s=>s.factors.length>1)),!!e.length){if(t==="reorder")for(let s of e)s.reorder();else if(t==="shrink")for(let s of e)s.shrink();else if(t==="grow")for(let s of e)s.grow();e[0].$parent.change({changed:e})}})}static makeThumbnail(t,e){let s=c("svg",{width:54,height:54},e),n=r=>{s.removeChildren();let o=Mc(r);for(let a=0;a<o.length;++a){let l=Mo(o);Po(o,l,s)[0].css("transform",`translate(27px, 27px) scale(${25/l})`)}};e.onAttr("data-options",r=>n(Math.round(+r)))}};var Z=class extends Error{constructor(i,t){super(t);this.name=i}static undefinedVariable(i){return new Z("EvalError",`Undefined variable \u201C${i}\u201D.`)}static undefinedFunction(i){return new Z("EvalError",`Undefined function \u201C${i}\u201D.`)}static evalLoop(i){return new Z("EvalError",`Loop in nested evaluation \u201C${i}\u201D.`)}static invalidCharacter(i){return new Z("SyntaxError",`Unknown symbol \u201C${i}\u201D.`)}static conflictingBrackets(i){return new Z("SyntaxError",`Conflicting brackets \u201C${i}\u201D.`)}static unclosedBracket(i){return new Z("SyntaxError",`Unclosed bracket \u201C${i}\u201D.`)}static startOperator(i){return new Z("SyntaxError",`A term cannot start with a \u201C${i}\u201D.`)}static endOperator(i){return new Z("SyntaxError",`A term cannot end with a \u201C${i}\u201D.`)}static consecutiveOperators(i,t){return new Z("SyntaxError",`A \u201C${i}\u201D cannot be followed by a \u201C${t}\u201D.`)}static invalidExpression(){return new Z("SyntaxError","This expression is invalid.")}},Co={pi:Math.PI,\u03C0:Math.PI,e:Math.E},Eo={"(":")","[":"]","{":"}"},Gi={"*":"\xB7","**":"\u2217","//":"//","+-":"\xB1","\u2013":"\u2212","-":"\u2212",xx:"\xD7",sum:"\u2211",prod:"\u220F",int:"\u222B",del:"\u2202",grad:"\u2207",aleph:"\u2135",not:"\xAC",AA:"\u2200",EE:"\u2203","'":"\u2019","!=":"\u2260","<=":"\u2264",">=":"\u2265",in:"\u2208","!in":"\u2209","==":"\u2261","~=":"\u2245","~~":"\u2248",sub:"\u2282",sube:"\u2286",prop:"\u221D",oo:"\u221E",cap:"\u2229",cup:"\u222A","<-":"\u2190","->":"\u2192","=>":"\u21D2","<=>":"\u21D4","|->":"\u21A6",uarr:"\u2191",darr:"\u2193",lArr:"\u21D0"},$s={Gamma:"\u0393",Delta:"\u0394",Theta:"\u0398",Lambda:"\u039B",Xi:"\u039E",Pi:"\u03A0",Sigma:"\u03A3",Phi:"\u03A6",Psi:"\u03A8",Omega:"\u03A9",alpha:"\u03B1",beta:"\u03B2",gamma:"\u03B3",delta:"\u03B4",epsilon:"\u025B",zeta:"\u03B6",eta:"\u03B7",theta:"\u03B8",iota:"\u03B9",kappa:"\u03BA",lambda:"\u03BB",mu:"\u03BC",nu:"\u03BD",xi:"\u03BE",pi:"\u03C0",rho:"\u03C1",sigma:"\u03C3",tau:"\u03C4",upsilon:"\u03C5",phi:"\u03C6",chi:"\u03C7",psi:"\u03C8",omega:"\u03C9",CC:"\u2102",NN:"\u2115",QQ:"\u211A",RR:"\u211D",ZZ:"\u2124"},Pc="abcdefghijklmnopqrstuvwxyz",wm=Pc.split(""),ym=Pc.toUpperCase().split(""),vm=Object.values($s),bm=[...wm,...ym,...vm,"$"],$m="|()[]{}\xF7,!<>=*/+-\u2013\u2212~^_\u2026\xB0\u2022\u2225\u22A5'\u2220:%\u223C\u25B3",xm=Object.values(Gi),Tm=[...$m,...xm],Sm={_:"sub","^":"sup","//":"/","\xF7":"/"},Cc={"<":"&lt;",">":"&gt;"};function Ec(i){return i in Cc?Cc[i]:i}var Mm=["abs","round","floor","ceil","max","min","mod","lcm","gcd","gcf","log","exp","ln","sqrt","root","sin","cos","tan","sec","csc","cot","cosec","cotan","arcsin","arccos","arctan","sinh","cosh","tanh","sech","csch","coth","cosech"];function xs(i){return Mm.includes(i)}var Hi={"+":"plus","\u2212":"minus","\xB7":"times","\xD7":"times","/":"over","//":"divided by","%":"percent","!":"factorial","\xB1":"plus-minus","=":"equals","\u2260":"does not equal","<":"is less than",">":"is greater than","\u2264":"is less than or equal to","\u2265":"is greater than or equal to",\u03C0:"pi","\u2245":"is congruent to","\u2225":"is parallel to","\u22A5":"is perpendicular to"};for(let i of Object.keys($s))Hi[$s[i]]=i;var Ac=i=>typeof i=="number"?i:i[0],Vc=i=>typeof i=="number"?[i,i]:i,Le=class{evaluate(i={},t){return NaN}interval(i={},t){return Vc(this.evaluate(i))}substitute(i={}){return this}recursiveSubstitute(i){let t=Object.keys(i);return this.unknowns.filter(e=>t.includes(e)).length?this.substitute(i).recursiveSubstitute(i):this}get simplified(){return this}get unknowns(){return this.variables.filter(i=>!Object.prototype.hasOwnProperty.call(Co,i))}get variables(){return[]}get functions(){return[]}collapse(){return this}toString(){return""}toVoice(i={}){return""}toMathML(i={}){return""}},Ao=new Set;function Vo(i,t,e=!1){var s;let n=(s=t[i])!=null?s:Co[i];if(n===void 0)throw Z.undefinedVariable(i);if(typeof n=="string"||n instanceof Le){if(e||Ao.clear(),Ao.has(i))throw Z.evalLoop(i);return Ao.add(i),typeof n=="string"&&(n=ce.parse(n)),n.evaluate(t,!0)}else return typeof n=="function"?n():n}var Ie=class extends Le{constructor(i){super();this.n=i}evaluate(){return this.n}toString(){return`${this.n}`}toVoice(){return`${this.n}`}toMathML(){return`<mn>${this.n}</mn>`}},qi=class extends Le{constructor(i){super();this.i=i}evaluate(i={},t){return Ac(Vo(this.i,i,t))}interval(i={},t){return Vc(Vo(this.i,i,t))}toMathML(){return`<mi${xs(this.i)?' mathvariant="normal"':""}>${this.i}</mi>`}substitute(i={}){return i[this.i]||this}get variables(){return[this.i]}toString(){return this.i}toVoice(){return this.i in Hi?Hi[this.i]:this.i.length===1?`_${this.i}_`:this.i}},Pm=class extends Le{constructor(i){super();this.s=i}evaluate(i={},t){return Ac(Vo(this.s,i,t))}toString(){return`"${this.s}"`}toVoice(){return this.s}toMathML(){return`<mtext>${this.s}</mtext>`}},kc=class extends Le{toString(){return" "}toMathML(){return"<mspace></mspace>"}},ve=class extends Le{constructor(i){super();this.o=i}toString(){return this.o.replace("//","/")}toVoice(){return Hi[this.o]||this.o}get functions(){return[this.o]}toMathML(){let i=Ec(this.toString());return`<mo value="${i}">${i}</mo>`}},Oc=[-Infinity,Infinity],zi=[NaN,NaN],oi=Math.PI/2,ko=Math.PI*2,et=(i,t)=>[i-Number.EPSILON,t+Number.EPSILON],ai=(...i)=>et(Math.min(...i),Math.max(...i)),Cm=i=>Math.abs(i[1]-i[0]),Bi=i=>isNaN(i[0])||isNaN(i[1]),Lc=i=>!isFinite(i[0])&&i[0]===i[1],Em=(i,t)=>W(t,i[0]-Number.EPSILON,i[1]+Number.EPSILON),Rn=i=>Em(i,0),be={add:(...i)=>i.reduce((t,e)=>t+e,0),sub:(...i)=>i.length>1?i[0]-i[1]:-i[0],mul:(...i)=>i.reduce((t,e)=>t*e,1),div:(i,t)=>i/t,abs:i=>Math.abs(i),round:i=>Math.round(i),floor:i=>Math.floor(i),ceil:i=>Math.ceil(i),max:(...i)=>Math.max(...i),min:(...i)=>Math.min(...i),mod:(i,t)=>i%t,lcm:(...i)=>Ue(...i),gcd:(...i)=>Ze(...i),gcf:(...i)=>Ze(...i),sup:(i,t)=>Math.pow(i,t),log:(i,t)=>Math.log(i)/(t===void 0?1:Math.log(t)),exp:i=>Math.exp(i),ln:i=>Math.log(i),sqrt:i=>Math.sqrt(i),root:(i,t)=>Math.pow(i,1/t),sin:i=>Math.sin(i),cos:i=>Math.cos(i),tan:i=>Math.tan(i),sec:i=>1/Math.cos(i),csc:i=>1/Math.sin(i),cot:i=>1/Math.tan(i),cosec:i=>be.csc(i),cotan:i=>be.cot(i),arcsin:i=>Math.asin(i),arccos:i=>Math.acos(i),arctan:i=>Math.atan(i),sinh:i=>Math.sinh(i),cosh:i=>Math.cosh(i),tanh:i=>Math.tanh(i),sech:i=>1/Math.cosh(i),csch:i=>1/Math.sinh(i),coth:i=>1/Math.tanh(i),cosech:i=>be.csch(i)};function Dn(i,t){if(i[0]>0)return t[0]>=0?et(i[0]**t[0],i[1]**t[1]):ai(i[0]**t[0],i[0]**t[1],i[1]**t[0],i[1]**t[1]);let e=t[0];return Number.isInteger(e)&&e===t[1]?e===0?[Rn(i)?0:1,1]:e%2?et(i[0]**e,i[1]**e):Rn(i)?[0,Math.max(i[0]**e,i[1]**e)]:ai(i[1]**e,i[0]**e):zi}function Ic(i,t=ko){let e=Math.floor(i[0]/t)*t;return[i[0]-e,i[1]-e]}var q={add:(...i)=>et(N(i.map(t=>t[0])),N(i.map(t=>t[1]))),sub:(i,t)=>t!==void 0?et(i[0]-t[1],i[1]-t[0]):et(-i[1],-i[0]),mul:(i,...t)=>(t.length>1&&(t=[q.mul(...t)]),ai(i[0]*t[0][0],i[0]*t[0][1],i[1]*t[0][0],i[1]*t[0][1])),div:(i,t)=>Rn(t)?Oc:ai(i[0]/t[0],i[0]/t[1],i[1]/t[0],i[1]/t[1]),abs:i=>Rn(i)?et(0,Math.max(-i[0],i[1])):ai(Math.abs(i[0]),Math.abs(i[1])),round:i=>et(Math.round(i[0]),Math.round(i[1])),floor:i=>et(Math.floor(i[0]),Math.floor(i[1])),ceil:i=>et(Math.ceil(i[0]),Math.ceil(i[1])),max:(...i)=>et(Math.max(...i.map(t=>t[0])),Math.max(...i.map(t=>t[1]))),min:(...i)=>et(Math.min(...i.map(t=>t[0])),Math.min(...i.map(t=>t[1]))),mod:(i,t)=>{if(Bi(i)||Bi(t))return zi;let e=i[0]/(i[0]<0?t[0]:t[1]);return e=e<0?Math.ceil(e):Math.floor(e),q.sub(i,q.mul(t,[e,e]))},lcm:(...i)=>ai(Ue(...i.map(t=>t[0]))),gcd:(...i)=>ai(Ze(...i.map(t=>t[0]))),gcf:(...i)=>q.gcd(...i),sup:(i,t)=>Dn(i,t),log:(i,t)=>(t!==void 0&&q.div(q.log(i),q.log(t)),et(i[0]<=0?-Infinity:Math.log(i[0]),Math.log(i[1]))),exp:i=>Dn([Math.E,Math.E],i),ln:i=>q.log(i),sqrt:i=>Dn(i,[.5,.5]),root:(i,t)=>Dn(i,q.div([1,1],t)),sin:i=>q.cos(q.sub(i,[oi,oi])),cos:i=>Bi(i)||Lc(i)?zi:Cm(i)>=ko-Number.EPSILON?[-1,1]:(i=Ic(i),i[0]>=Math.PI?q.sub(q.cos(q.sub(i,[Math.PI,Math.PI]))):i[1]<=Math.PI?et(Math.cos(i[1]),Math.cos(i[0])):i[1]<=ko?et(-1,Math.max(Math.cos(i[1]),Math.cos(i[0]))):et(-1,1)),tan:i=>Bi(i)||Lc(i)?zi:(i=Ic(i,Math.PI),i[0]>=oi&&(i=q.sub(i,[Math.PI,Math.PI])),i[0]<=-oi||i[1]>=oi?Oc:et(Math.tan(i[0]),Math.tan(i[1]))),sec:i=>q.div([1,1],q.cos(i)),csc:i=>q.div([1,1],q.sin(i)),cot:i=>q.div([1,1],q.tan(i)),cosec:i=>q.csc(i),cotan:i=>q.cot(i),arcsin:i=>Bi(i)||i[1]<-1||i[0]>1?zi:et(i[0]<=-1?-oi:Math.asin(i[0]),i[1]>=1?oi:Math.asin(i[1])),arccos:i=>Bi(i)||i[1]<-1||i[0]>1?zi:et(i[1]>=1?0:Math.acos(i[1]),i[0]<=-1?Math.PI:Math.acos(i[0])),arctan:i=>et(Math.atan(i[0]),Math.atan(i[1])),sinh:i=>et(Math.sinh(i[0]),Math.sinh(i[1])),cosh:i=>i[1]<0?et(Math.cosh(i[1]),Math.cosh(i[0])):i[0]>0?et(Math.cosh(i[0]),Math.cosh(i[1])):et(1,Math.cosh(Math.max(-i[0],i[1]))),tanh:i=>et(Math.tanh(i[0]),Math.tanh(i[1])),sech:i=>q.div([1,1],q.cosh(i)),csch:i=>q.div([1,1],q.sinh(i)),coth:i=>q.div([1,1],q.tanh(i)),cosech:i=>q.csch(i)},Nn=ht("+ \u2212 * \xD7 \xB7 / \xF7 // sup sub subsup"),Rc=ht("sub sup subsup"),Oo='<mo value="," lspace="0">,</mo>';function Dc(i,t){return Nn.includes(t)?i instanceof _n?!0:!(i instanceof Lt)||!Nn.includes(i.fn)?!1:Rc.includes(i.fn)&&Rc.includes(t)?!0:Nn.indexOf(t)>Nn.indexOf(i.fn):!1}function Am(i,t,e){return Dc(i,t)?`<mfenced>${e}</mfenced>`:e}function Re(i,t){return i instanceof _n||i instanceof Lt?`<mrow>${t}</mrow>`:t}function Nc(i){return i==="2"?"squared":i==="3"?"cubed":`to the power of ${i}`}var Lt=class extends Le{constructor(i,t=[]){super();this.fn=i,this.args=t}evaluate(i={}){let t=this.args.map(e=>e.evaluate(i));if(this.fn in i)return i[this.fn](...t);if(this.fn==="+")return be.add(...t);if(this.fn==="\u2212")return be.sub(...t);if(["*","\xB7","\xD7"].includes(this.fn))return be.mul(...t);if(this.fn==="/")return be.div(...t);if(this.fn==="sup")return be.sup(...t);if(xs(this.fn))return be[this.fn](...t);if(this.fn==="(")return t[0];throw Z.undefinedFunction(this.fn)}interval(i={}){if(this.fn in i)return zt(this.evaluate(i),2);let t=this.args.map(e=>e.interval(i));if(this.fn==="+")return q.add(...t);if(this.fn==="\u2212")return q.sub(...t);if(["*","\xB7","\xD7"].includes(this.fn))return q.mul(...t);if(this.fn==="/")return q.div(...t);if(this.fn==="sup")return q.sup(...t);if(xs(this.fn))return q[this.fn](...t);if(this.fn==="(")return t[0];throw Z.undefinedFunction(this.fn)}substitute(i={}){return new Lt(this.fn,this.args.map(t=>t.substitute(i)))}collapse(){return this.fn==="("?this.args[0].collapse():new Lt(this.fn,this.args.map(i=>i.collapse()))}get simplified(){return this}get variables(){return Rt(Bt(this.args.map(i=>i.variables)))}get functions(){return Rt([this.fn,...Bt(this.args.map(i=>i.functions))])}toString(){let i=this.args.map(t=>Dc(t,this.fn)?`(${t.toString()})`:t.toString());return this.fn==="\u2212"?i.length>1?i.join(" \u2212 "):`\u2212${i[0]}`:this.fn==="sup"?i.join("^"):this.fn==="sub"?i.join("_"):this.fn==="subsup"?`${i[0]}_${i[1]}^${i[2]}`:ht("+ * \xD7 \xB7 / = < > \u2264 \u2265 \u2248").includes(this.fn)?i.join(` ${this.fn} `):J(this.fn,"(","[","{")?this.fn+this.args.join(", ")+Eo[this.fn]:J(this.fn,"!","%")?i[0]+this.fn:`${this.fn}(${i.join(", ")})`}toMathML(i={}){let t=this.args.map(n=>n.toMathML(i)),e=this.args.map((n,r)=>Am(n,this.fn,t[r]));if(this.fn in i){let n=t.map((r,o)=>({toString:()=>r,val:this.args[o]}));return i[this.fn](...n)}if(this.fn==="\u2212")return e.length>1?e.join('<mo value="\u2212">\u2212</mo>'):`<mo rspace="0" value="\u2212">\u2212</mo>${e[0]}`;if(J(this.fn,"+","=","<",">","\u2264","\u2265","\u2248")){let n=Ec(this.fn);return e.join(`<mo value="${n}">${n}</mo>`)}if(J(this.fn,"*","\xD7","\xB7")){let n=e[0];for(let r=1;r<e.length-1;++r)n+=(this.args[0]instanceof Ie&&this.args[1]instanceof Ie?'<mo value="\xD7">\xD7</mo>':"")+e[1];return n}if(this.fn==="//")return e.join('<mo value="/">/</mo>');if(this.fn==="sqrt")return`<msqrt>${e[0]}</msqrt>`;if(J(this.fn,"/","root")){let n=this.fn==="/"?"mfrac":"mroot",r=this.args.map((o,a)=>Re(o,t[a]));return`<${n}>${r.join("")}</${n}>`}if(J(this.fn,"sup","sub")){let n=[Re(this.args[0],e[0]),Re(this.args[1],t[1])];return`<m${this.fn}>${n.join("")}</m${this.fn}>`}return this.fn==="subsup"?`<msubsup>${[Re(this.args[0],e[0]),Re(this.args[1],t[1]),Re(this.args[2],t[2])].join("")}</msubsup>`:J(this.fn,"(","[","{")?`<mfenced open="${this.fn}" close="${Eo[this.fn]}">${e.join(Oo)}</mfenced>`:J(this.fn,"!","%")?`${e[0]}<mo value="${this.fn}" lspace="0">${this.fn}</mo>`:this.fn==="abs"?`<mfenced open="|" close="|">${e.join(Oo)}</mfenced>`:this.fn==="bar"?`<mover>${Re(this.args[0],e[0])}<mo value="\u203E">\u203E</mo></mover>`:this.fn==="vec"?`<mover>${Re(this.args[0],e[0])}<mo value="\u2192">\u2192</mo></mover>`:`<mi${xs(this.fn)?' mathvariant="normal"':""}>${this.fn}</mi><mfenced>${e.join(Oo)}</mfenced>`}toVoice(i={}){let t=this.args.map(s=>s.toVoice(i)),e=t.join(" ");if(this.fn in i){let s=t.map((n,r)=>({toString:()=>n,val:this.args[r]}));return i[this.fn](...s)}return J(this.fn,"(","[","{")?e:this.fn==="sqrt"?`square root of ${e}`:this.fn==="%"?`${e} percent`:this.fn==="!"?`${e} factorial`:this.fn==="/"?`${t[0]} over ${t[1]}`:this.fn==="//"?`${t[0]} divided by ${t[1]}`:this.fn==="sub"?e:this.fn==="subsup"?`${t[0]} ${t[1]} ${Nc(t[2])}`:this.fn==="sup"?`${t[0]} ${Nc(t[1])}`:Hi[this.fn]?t.join(` ${Hi[this.fn]} `):xs(this.fn)?`${this.fn} ${e}`:`${this.fn} of ${e}`}},_n=class extends Le{constructor(i){super();this.items=i}evaluate(i={}){return this.collapse().evaluate(i)}interval(i={}){return this.collapse().interval(i)}substitute(i={}){return this.collapse().substitute(i)}get simplified(){return this.collapse().simplified}get variables(){return Rt(Ws(...this.items.map(i=>i.variables)))}get functions(){return this.collapse().functions}toString(){return this.items.map(i=>i.toString()).join(" ")}toMathML(i={}){return this.items.map(t=>t.toMathML(i)).join("")}toVoice(i={}){return this.items.map(t=>t.toVoice(i)).join(" ")}collapse(){return Lo(this.items).collapse()}};function Io(i,t){if(t===2)return new Pm(i);if(!(!i||!t)){if(t===1&&i.length>1)return new kc;if(t===3){if(isNaN(+i))throw Z.invalidExpression();return new Ie(+i)}if(t===4)return i in $s?new qi($s[i]):i in Gi?new ve(Gi[i]):new qi(i);if(t===5)return i in Gi?new ve(Gi[i]):new ve(i)}}function Vm(i){let t=[],e="",s=0;for(let r of i){if(r==='"'){let a=s===2?0:2,l=Io(e,s);l&&t.push(l),e="",s=a;continue}else if(s===2){e+=r;continue}let o=r.match(/[0-9.]/)?3:bm.includes(r)?4:Tm.includes(r)?5:r.match(/\s/)?1:0;if(!o)throw Z.invalidCharacter(r);if(!s||s===3&&o!==3||s===4&&o!==4&&o!==3||s===5&&!(e+r in Gi)||s===1&&o!==1){let a=Io(e,s);a&&t.push(a),e="",s=o}e+=r}let n=Io(e,s);return n&&t.push(n),t}function km(i){return i.length>1?new _n(i):i[0]instanceof ve?new _n(i):i[0]}function Om(i,t){let e=[[]];for(let s of i)t(s)?e.push([]):I(e).push(s);return e}function Ct(i,t){return i instanceof ve&&ht(t).includes(i.o)}function Ts(i){return i instanceof Lt&&i.fn==="("?i.args[0]:i}function Gn(i,t){if(Ct(i[0],t))throw Z.startOperator(i[0]);if(Ct(I(i),t))throw Z.endOperator(I(i));for(let e=1;e<i.length-1;++e){if(!Ct(i[e],t))continue;let s=i[e],n=i[e-1],r=i[e+1];if(n instanceof ve)throw Z.consecutiveOperators(n.o,s.o);if(r instanceof ve)throw Z.consecutiveOperators(s.o,r.o);let o=i[e+2];if(t==="^ _"&&Ct(s,"_ ^")&&Ct(o,"_ ^")&&s.o!==o.o){let a=i[e+3];if(a instanceof ve)throw Z.consecutiveOperators(o.o,a.o);let l=[Ts(n),Ts(r),Ts(a)];s.o==="^"&&([l[1],l[2]]=[l[2],l[1]]),i.splice(e-1,5,new Lt("subsup",l)),e-=4}else{let a=Sm[s.o]||s.o,l=[Ts(n),Ts(r)];i.splice(e-1,3,new Lt(a,l)),e-=2}}}function _c(i){return Gn(i,"^ _"),Gn(i,"/"),km(i)}function Lm(i,t){let e=[[]],s=["\u03C0",...(t==null?void 0:t.variables)||[]];for(let n of i){let r=I(e).length?I(e)[0].o:void 0;if(Ct(n,") ] }")){if(!Ct(n,Eo[r]))throw Z.conflictingBrackets(n.o);let o=e.pop(),a=I(e),l=I(a),d=Ct(n,")")&&l instanceof qi&&!s.includes(l.i)?a.pop().i:o[0].o,p=Om(o.slice(1),m=>Ct(m,","));a.push(new Lt(d,p.map(_c)))}else Ct(n,"( [ {")?e.push([n]):I(e).push(n)}if(e.length>1)throw Z.unclosedBracket(I(e)[0].o);return _c(e[0])}function Gc(i,t,e=!1){let s=[],n=[],r=!1;function o(){if(r)throw Z.invalidExpression();!n.length||(s.push(n.length>1?new Lt(t[0],n):n[0]),n=[])}for(let a of i)if(Ct(a,t)){if(r||!n.length)throw Z.invalidExpression();r=!0}else if(a instanceof ve)o(),s.push(a),r=!1;else{let l=!e||a instanceof Ie;if(n.length&&!r&&l)throw Z.invalidExpression();n.push(a),r=!1}return o(),s}function Lo(i){if(i=i.filter(e=>!(e instanceof kc)),!i.length)throw Z.invalidExpression();let t=i.findIndex(e=>Ct(e,"= < > \u2264 \u2265"));if(t===0)throw Z.startOperator(i[0]);if(t===i.length-1)throw Z.endOperator(i[0]);if(t>0){let e=Lo(i.slice(0,t)),s=Lo(i.slice(t+1));return new Lt(i[t].o,[e,s])}if(Ct(i[0],"%!"))throw Z.startOperator(i[0]);for(let e=0;e<i.length;++e)!Ct(i[e],"%!")||(i.splice(e-1,2,new Lt(i[e].o,[i[e-1]])),e-=1);if(Gn(i,"// \xF7"),i=Gc(i,"\xD7 * \xB7",!0),Ct(i[0],"\u2212 \xB1")&&i.splice(0,2,new Lt(i[0].o,[i[1]])),Gn(i,"\u2212 \xB1"),Ct(i[0],"+")&&(i=i.slice(1)),i=Gc(i,"+"),i.length>1)throw Z.invalidExpression();return i[0]}function Im(i,t=!1,e){let s=Lm(Vm(i),e);return t?s.collapse():s}function Rm(i,t){try{let e=Rt([...i.variables,...t.variables]),s=i.collapse(),n=t.collapse(),r=0;for(let o=0;o<5;++o){let a={};for(let d of e)a[d]=Co[d]||Math.random()*5;let l=s.evaluate(a),h=n.evaluate(a);if(!(isNaN(l)||isNaN(h))){if(!b(l,h))return!1;r+=1}}return!!r}catch(e){return!1}}var ce={numEquals:Rm,parse:qt(Im)};var Dm={"*":"\xB7","**":"\u2217","//":"//","+-":"\xB1","\u2013":"\u2212","-":"\u2212",xx:"\xD7",sum:"\u2211",prod:"\u220F",int:"\u222B",del:"\u2202",grad:"\u2207",aleph:"\u2135",not:"\xAC",AA:"\u2200",EE:"\u2203","'":"\u2019","!=":"\u2260","<=":"\u2264",">=":"\u2265",in:"\u2208","!in":"\u2209","==":"\u2261","~=":"\u2245","~~":"\u2248",sub:"\u2282",sube:"\u2286",prop:"\u221D",oo:"\u221E",cap:"\u2229",cup:"\u222A","<-":"\u2190","->":"\u2192","=>":"\u21D2","<=>":"\u21D4","|->":"\u21A6",uarr:"\u2191",darr:"\u2193",lArr:"\u21D0"},Fi={Gamma:"\u0393",Delta:"\u0394",Theta:"\u0398",Lambda:"\u039B",Xi:"\u039E",Pi:"\u03A0",Sigma:"\u03A3",Phi:"\u03A6",Psi:"\u03A8",Omega:"\u03A9",alpha:"\u03B1",beta:"\u03B2",gamma:"\u03B3",delta:"\u03B4",epsilon:"\u025B",zeta:"\u03B6",eta:"\u03B7",theta:"\u03B8",iota:"\u03B9",kappa:"\u03BA",lambda:"\u03BB",mu:"\u03BC",nu:"\u03BD",xi:"\u03BE",pi:"\u03C0",rho:"\u03C1",sigma:"\u03C3",tau:"\u03C4",upsilon:"\u03C5",phi:"\u03C6",chi:"\u03C7",psi:"\u03C8",omega:"\u03C9",CC:"\u2102",NN:"\u2115",QQ:"\u211A",RR:"\u211D",ZZ:"\u2124"},Hc="abcdefghijklmnopqrstuvwxyz",Nm=Hc.split(""),_m=Hc.toUpperCase().split(""),Gm=Object.values(Fi),M$=[...Nm,..._m,...Gm,"$"],Hm="|()[]{}\xF7,!<>=*/+-\u2013\u2212~^_\u2026\xB0\u2022\u2225\u22A5'\u2220:%\u223C\u25B3",qm=Object.values(Dm),P$=[...Hm,...qm];var zm=["abs","round","floor","ceil","max","min","mod","lcm","gcd","gcf","log","exp","ln","sqrt","root","sin","cos","tan","sec","csc","cot","cosec","cotan","arcsin","arccos","arctan","sinh","cosh","tanh","sech","csch","coth","cosech"];function qc(i){return zm.includes(i)}var Bm={"+":"plus","\u2212":"minus","\xB7":"times","\xD7":"times","/":"over","//":"divided by","%":"percent","!":"factorial","\xB1":"plus-minus","=":"equals","\u2260":"does not equal","<":"is less than",">":"is greater than","\u2264":"is less than or equal to","\u2265":"is greater than or equal to",\u03C0:"pi","\u2245":"is congruent to","\u2225":"is parallel to","\u22A5":"is perpendicular to"};for(let i of Object.keys(Fi))Bm[Fi[i]]=i;var Ro=class{constructor(){this.callbacks=[]}add(t){this.callbacks.push(t)}start(t=1e3){return z(s=>{for(let n of this.callbacks)n(s)},t).promise}};function zc(i,t){return i.every((e,s)=>b(e,t[s]))}function Bc(i,t){i.scale*=t.scale,i.x=i.x*t.scale+t.x,i.y=i.y*t.scale+t.y}function Fc(i,t){return b(i.x,t.x)&&b(i.y,t.y)&&b(i.scale,t.scale)}function Hn(i,t,e){if(e==="adding"){let s=i.strokeLength,n=t<.5?0:Y("cubic-in",t*2-1);i.css({"stroke-dasharray":s+"px","stroke-dashoffset":s*(1-n)+"px"})}else if(e==="deleting"){let s=i.strokeLength,n=t<.5?Y("cubic-in",2*t):1;i.css({"stroke-dasharray":s+"px","stroke-dashoffset":s*(2-n)+"px"})}}function Zc(i,t){let e=[i],s=i.expr;for(;t.startsWith(s);){if(t===s)return e;let n=I(e).next;if(!n)return;e.push(n),s+=n.expr}}function Uc(i,t,e=1){let s=e*Math.abs(t.x-i.x)/3,n=u.average(i,t).shift(0,s);return function(r){let o=(1-r)**2*i.x+2*r*(1-r)*n.x+r*r*t.x,a=(1-r)**2*i.y+2*r*(1-r)*n.y+r*r*t.y;return{x:o,y:a}}}function Do(i,t){return Math.max(t*i,.4)/i}function xe(i){return i instanceof $e&&i.children.length>1||i instanceof Zi?`(${i.expr})`:i.expr}function ue(i,t){return t.length===1&&t[0].type==="mrow"?t[0]:new $e(t,i)}var bt=class{constructor(t,e,s,n){this.type=t;this.equation=s;this.$element=n;this.children=[];this.status="";this.value="";this.customColor="";this.roundedMotion=!1;this.width=0;this.height=0;this.baseline=0;this.transform={x:0,y:0,scale:1};this.currentDimensions=[0,0,0];this.currentWorldTransform={x:0,y:0,scale:1};this.addChildren(e),n&&s.$row.append(n)}get expr(){return""}get log(){let t=this.children.map(e=>e.log);return`<${this.type}>${t.join("")}</${this.type}>`}get color(){return this.customColor||(this.parent?this.parent.color:"")}static create(t,e){let s=t.nodeName.toLowerCase();if(J(s,"mn","mi","mo","mtext")){if(t.textContent==="placeholder")return new zn(e);let r=t.getAttribute("mathvariant")||void 0;return new li(s,t.textContent||"",e,r)}if(!J(s,"mrow","mfrac","mfenced","msqrt","mroot","msub","msup","msubsup","munder","mover","munderover","mspace"))return new Kc(t,e);if(s==="mfenced"&&t.getAttribute("open")==="["){let r=t.children.length,o=Bt(Array.from(t.children,l=>Array.from(l.children,h=>bt.create(h,e)))),a=new Wc(o,e,r);return new Ss([a],e)}let n=Array.from(t.children,r=>bt.create(r,e));switch(s){case"mrow":return new $e(n,e);case"mfrac":return n=n.map(r=>ue(e,[r])),new Bn(n,e);case"mfenced":return n=[ue(e,n)],new Ss(n,e);case"msqrt":return n=[ue(e,n)],new Ui(s,n,e);case"mroot":return n=n.map(r=>ue(e,[r])),new Ui(s,n,e);case"msub":case"msup":case"msubsup":return n=n.map(r=>ue(e,[r])),new Zi(s,n,e);case"munder":case"mover":case"munderover":return n=n.map(r=>ue(e,[r])),new jc(s,n,e);case"mspace":return new qn(e)}throw new Error(`Unknown element type tag ${t.nodeName}`)}get marginLeft(){return .1}get marginRight(){return .1}setTransform(t=0,e=0,s=1){this.transform.x=t,this.transform.y=e,this.transform.scale=s}get worldTransform(){let t=this,e=Object.assign({},this.transform);for(;t=t.parent;)Bc(e,t.transform);return e}get index(){return this.parent?this.parent.children.indexOf(this):-1}get next(){if(!this.parent)return;let t=this.parent.children.indexOf(this);return this.parent.children[t+1]}get prev(){if(!this.parent)return;let t=this.parent.children.indexOf(this);return this.parent.children[t-1]}addChildren(t,e=this.children.length){for(let s of this.children)s.type==="placeholder"&&s.deleteFromDom();for(let s of t)s.detach(),s.parent=this;this.children.splice(e,0,...t)}insertAfter(t){let e=this.parent.children.indexOf(this);this.parent.addChildren(t,e+1)}insertBefore(t){let e=this.parent.children.indexOf(this);this.parent.addChildren(t,e)}detach(){if(this.parent){let t=this.parent.children.indexOf(this);t>=0&&this.parent.children.splice(t,1),this.parent=void 0}}deleteFromDom(){this.parent&&this.detach(),this.$element&&this.$element.remove(),this.$element=void 0;for(let t of this.children.slice(0))t.deleteFromDom()}*parents(t=!1){let e=t?this:this.parent;for(;e;)yield e,e=e.parent}hasParent(t,e=!1){return Ve(this.parents(e),t)}hitTest(t){let{x:e,scale:s}=this.worldTransform,n=this.marginLeft*s*this.equation.fontSize,r=this.marginRight*s*this.equation.fontSize;if(W(t.x,e-n,e+this.width*s+n+r))return this.hitTestChildren(t)||this}hitTestChildren(t){for(let e of this.children){let s=e.hitTest(t);if(s)return s}}measure(t=1){for(let e of this.children)e.measure(t)}clean(){for(let t of this.children)t.clean()}setStatus(t){this.status=t;for(let e of this.children)e.setStatus(t)}render(t){for(let l of this.children)l.render(t);if(!this.$element)return;let e=this.currentWorldTransform,s=this.currentWorldTransform=this.worldTransform,n=this.currentDimensions,r=this.currentDimensions=[this.width,this.height,this.baseline];if(Fc(e,s)&&zc(n,r)&&!this.status)return;if(!t){this.positionElement(s),this.drawElement(1,r[0],r[1],r[2],s.scale);return}this.status==="adding"&&this.positionElement(s);let o=s.y+this.baseline<this.equation.root.baseline?-1:1,a=this.roundedMotion?Uc(e,s,o):void 0;this.roundedMotion=!1,t.add(l=>{if(!this.$element)return;let h=Y("cubic",l),d=J(this.status,"adding","deleting"),p=d?r[0]:it(n[0],r[0],h),m=d?r[1]:it(n[1],r[1],h),g=d?r[2]:it(n[2],r[2],h),M=d?s.scale:it(e.scale,s.scale,h);if(this.drawElement(l,p,m,g,M),!this.status){let w=a?a(h):u.interpolate(e,s,h);this.positionElement({x:w.x,y:w.y,scale:M})}})}positionElement(t){this.$element.setTransform(t,0,t.scale)}drawElement(t,e,s,n,r){}},Fm="acegmnopqrsuvwxyz",hi=1.1,ji=.2,No=["=","\u2248","<",">","\u2264","\u2265"],Zm=document.createElement("canvas"),Xc=Zm.getContext("2d"),Um=qt((i,t)=>(Xc.font=`${t}px "Source Sans Pro", sans-serif`,Xc.measureText(i).width)),li=class extends bt{constructor(t,e,s,n){super(t,[],s,c("text",{}));this.variant=n;this.setValue(e)}setValue(t){this.$element.text=this.value=t;let e=this.value.split("").every(n=>Fm.includes(n));this.width=Um(t,this.equation.fontSize),this.height=(hi-(e?.1:0))*this.equation.fontSize,this.baseline=this.height-ji*this.equation.fontSize;let s=this.type==="mtext"||this.variant==="normal";this.$element.setClass("font-normal",s||qc(this.value))}get expr(){return this.value==="xx"?'"xx"':this.type==="mtext"?`"${this.value}"`:this.value}get log(){return`<${this.type}>${this.value}</${this.type}>`}get marginLeft(){if(this.type==="mo")return No.includes(this.value)?this.equation.isDisplay?.5:.35:J(this.value,"\u2221","\u25B3","!","%","\u2019")||J(this.value,"\u2026","\xB0")&&this.prev&&this.prev.type==="mn"?0:.25;if(this.type==="mi"){if(this.prev&&this.prev.type==="mn")return .1;if(this.prev&&this.prev.type==="mi")return .05;if(this.prev&&this.prev.type==="mfrac")return .15}return 0}get marginRight(){return this.type==="mo"?this.equation.isDisplay&&No.includes(this.value)?.5:J(this.value,"\u2221","\u25B3")?0:this.value==="\u2212"&&(!this.prev||No.includes(this.prev.value))?.1:.25:0}positionElement(t){if(!this.$element)return;let e=(this.equation.fontSize-this.baseline)*t.scale;this.$element.setTransform({x:t.x,y:t.y-e},0,t.scale)}drawElement(t,e,s,n,r){this.status==="adding"?this.$element.setAttr("opacity",t<.5?0:Y("cubic-in",t*2-1)):this.status==="deleting"&&this.$element.setAttr("opacity",t<.5?1-Y("cubic-in",2*t):0),this.$element.css("stroke-width",(1-r)*1.5+"px"),this.$element.css("color",this.color||"currentColor")}},qn=class extends bt{constructor(t){super("mspace",[],t);this.height=(hi-.1)*t.fontSize,this.baseline=this.height-ji*this.equation.fontSize,this.width=t.fontSize*.2}get expr(){return" "}},$e=class extends bt{constructor(t,e,s,n=0){super("mrow",t,e);this.align=s;this.dx=n}addChildren(t,e=this.children.length){let s=[];for(let n of t)n.type==="mrow"?(s.push(...n.children),n.detach()):s.push(n);super.addChildren(s,e)}get expr(){return this.children.map(t=>t.expr).join(" ").replace(/− /,"\u2212")||"placeholder"}measure(t=1){if(super.measure(t),!this.children.length){this.height=this.width=this.baseline=0;return}this.baseline=Math.max(...this.children.map(s=>s.baseline)),this.height=this.baseline+Math.max(...this.children.map(s=>s.height-s.baseline));let e=0;for(let[s,n]of this.children.entries())n.setTransform(e,this.baseline-n.baseline),e+=n.width,s<this.children.length-1&&(e+=Math.max(n.marginRight,this.children[s+1].marginLeft)*this.equation.fontSize);if(this.align){let s=this.children.find(n=>n.expr===this.align);s&&(this.transform.x=this.dx-s.transform.x-s.width/2)}this.width=e}},zn=class extends bt{constructor(t){let e=t.fontSize,s=`M${.1*e} ${.3*e}h${e/2}v${e/2}h-${e/2}Z`,n=c("path",{class:"placeholder",d:s});super("placeholder",[],t,n);this.width=.7*e,this.height=hi*e,this.baseline=this.height-ji*e}get expr(){return"placeholder"}get marginLeft(){return 0}get marginRight(){return 0}},Bn=class extends bt{constructor(t,e){super("mfrac",t,e,c("line"))}get expr(){return this.children.map(t=>xe(t)).join("/")}measure(t){let e=this.hasParent(a=>a.type==="mfrac"||a.type==="matrix"),s=Do(t,!this.equation.isDisplay||e?.66:1),n=.1*this.equation.fontSize,[r,o]=this.children;super.measure(t*s),this.width=(Math.max(r.width,o.width)+2*n)*s,this.height=(r.height+o.height)*s,this.baseline=r.height*s+this.equation.fontSize*(hi/2-ji),r.setTransform((this.width-r.width*s)/2,0,s),o.setTransform((this.width-o.width*s)/2,r.height*s,s)}drawElement(t,e,s,n){let r=n-this.equation.fontSize*(hi/2-ji);this.$element.setLine({x:0,y:r},{x:e,y:r}),this.$element.setAttr("stroke",this.color||"currentColor"),Hn(this.$element,t,this.status)}hitTestChildren(t){let{scale:e,y:s}=this.worldTransform,n=this.baseline-this.equation.fontSize*(hi/2-ji),r=t.y<=s+n*e,o=this.children[r?0:1];return o.hitTestChildren(t)||o}},Zi=class extends bt{get expr(){let t=xe(this.children[0]);return this.type!=="msup"&&(t+="_"+xe(this.children[1])),this.type==="msup"&&(t+="^"+xe(this.children[1])),this.type==="msubsup"&&(t+="^"+xe(this.children[2])),t}measure(t){let[e,s,n]=this.children,r=this.type==="msup"?void 0:s,o=this.type==="msubsup"?n:this.type==="msup"?s:void 0,a=.05*this.equation.fontSize,l=Do(t,.65);e.measure(t),r&&r.measure(t*l),o&&o.measure(t*l);let h=o?o.height*l-.4*this.equation.fontSize:0,d=r?r.height*l-.5*this.equation.fontSize:0,p=o?o.width:0,m=r?r.width:0;this.width=e.width+a+Math.max(p,m)*l,this.height=e.height+h+d,this.baseline=e.baseline+h,e.setTransform(0,this.baseline-e.baseline),o&&o.setTransform(e.width+a,0,l),r&&r.setTransform(e.width+a,this.height-r.height*l,l)}clean(){if(super.clean(),this.children=this.children.filter(t=>t.type!=="mrow"||t.children.length),this.children.length===0)return this.detach();this.children.length===1&&(this.insertAfter(this.children),this.detach())}},jc=class extends bt{get expr(){let t=this.children[0].expr;return this.type!=="munder"&&(t+="_"+xe(this.children[1])),this.type==="mover"&&(t+="^"+xe(this.children[1])),this.type==="munderover"&&(t+="^"+xe(this.children[2])),t}measure(t){super.measure(t)}},Ss=class extends bt{constructor(t,e){super("mfenced",t,e,c("path"))}get expr(){return`(${this.children.map(t=>t.expr).join()})`}get marginLeft(){return .2}get marginRight(){return .2}measure(t){super.measure(t);let e=this.children[0];this.height=e.height+2,this.baseline=e.baseline+1;let s=1+this.height/this.equation.fontSize,n=.1*this.equation.fontSize;this.width=e.width+2*(s+n),e.setTransform(s+n,1)}drawElement(t,e,s){let n=Math.min(2+s/this.equation.fontSize,5),r=s-4,o=e-n,a=`M${n},2c${-2*n/3},${.15*r},${-n},${.32*r},${-n},${r/2}s${n/3},${.35*r},${n},${r/2}M${o},2c${2*n/3},${.15*r},${n},${.32*r},${n},${r/2}s${-n/3},${.35*r},${-n},${r/2}`;this.$element.setAttr("d",a),this.$element.css("stroke",this.color||"currentColor"),Hn(this.$element,t,this.status)}clean(){super.clean(),this.children.length||this.detach()}},Ui=class extends bt{constructor(t,e,s){super(t,e,s,c("path"))}get expr(){return`sqrt(${this.children.map(t=>t.expr).join(", ")})`}get marginLeft(){return .2}get marginRight(){return .2}measure(t){super.measure(t);let e=this.children[0];this.height=e.height+2,this.baseline=e.baseline+2;let s=Math.min(16,3+5*this.height/this.equation.fontSize),n=.05*this.equation.fontSize;this.width=e.width+s+2*n,e.setTransform(s+n,2)}drawElement(t,e,s){let n=Math.min(16,3+5*s/this.equation.fontSize),r=s-2,o=`M0,${.55*r}L${.18*n},${.51*r}L${.45*n},${r}L${n},2L${e},2`;this.$element.setAttr("d",o),this.$element.css("stroke",this.color||"currentColor"),Hn(this.$element,t,this.status)}clean(){super.clean(),this.children.length||this.detach()}},Wc=class extends bt{constructor(t,e,s){super("matrix",t,e,c("g"));this.rows=s;this.cols=Math.floor(t.length/s)}get expr(){return`${this.children.map(t=>t.expr).join(", ")}`}measure(t){super.measure(t);let e=.6*this.equation.fontSize,s=D(o=>Math.max(...D(a=>this.children[o*this.cols+a].height,this.cols)),this.rows),n=D(o=>Math.max(...D(a=>this.children[a*this.cols+o].width,this.rows)),this.cols);this.height=N(s)+(this.rows-1)*e/2,this.width=N(n)+this.cols*e,this.baseline=(this.height+hi*this.equation.fontSize)/2;let r=0;for(let o=0;o<this.rows;++o){let a=e/2;for(let l=0;l<this.cols;++l){let h=this.children[o*this.cols+l],d=a+(n[l]-h.width)/2,p=r+(s[o]-h.height)/2;h.setTransform(d,p),a+=n[l]+e}r+=s[o]+e/2}}},Kc=class extends bt{constructor(t,e){super("foreign",[],e,c("g"));var s;this.$body=c("div",{},e.$overlay),this.$body._el.appendChild(t),this.$measure=c("span",{text:".",style:"font-size: 0"},this.$body),this.checkForResize(),this.$body.on("resize",()=>{this.checkForResize()&&this.equation.resize()}),(s=this.$body.$("x-blank, x-blank-mc"))==null||s.on("solve",n=>{ts(()=>this.replace(n.solution,"#0f82f2"),n.restore?0:200)})}deleteFromDom(){var t;super.deleteFromDom(),(t=this.$body)==null||t.remove(),this.$body=void 0,this.$measure=void 0}replace(t,e){var r;let s=isNaN(+t)?"mtext":"mn",n=new li(s,t,this.equation);n.customColor=e,this.insertAfter([n]),(r=this.$body)==null||r.off("resize"),this.deleteFromDom(),this.equation.resize()}checkForResize(){var n,r;let t=this.height,e=this.width,s=this.baseline;return this.height=((n=this.$body)==null?void 0:n.height)||0,this.width=((r=this.$body)==null?void 0:r.width)||0,this.baseline=this.$measure.bounds.top-this.$body.bounds.top,!(b(t,this.height)&&b(e,this.width)&&b(s,this.baseline))}positionElement(t){var e,s;(e=this.$body)==null||e.css({left:t.x+"px",top:t.y+"px"}),b(t.scale,1)||(s=this.$body)==null||s.css("transform",`scale(${t.scale})`)}get expr(){var t;return`"${(t=this.$body)==null?void 0:t.text}"`}get log(){return`<foreign>${this.expr}</foreign>`}};var ci=class extends xi{constructor(t,e,s=0,n="=",r=18,o=!0){super();this.$row=t;this.$overlay=e;this.fontSize=r;this.isDisplay=o;this.isReady=!0;this.deletedNodes=new Set;this.root=new $e([],this,n,s)}setValue(t){let e=Array.isArray(t)?t.map(s=>bt.create(s,this)):this.parse(t);for(let s of this.root.children)s.deleteFromDom();this.root.addChildren(e),this.updateDescription(),this.resize()}updateDescription(){let t=ce.parse(this.root.expr).toVoice();this.$row.setAttr("aria-label",t)}resize(){this.root.measure(),this.root.render()}parse(t){var o;let e=new DOMParser,s=ce.parse(t).toMathML(),n=e.parseFromString(`<math>${s}</math>`,"text/xml");if(((o=n.firstChild)==null?void 0:o.nodeName)==="parsererror")throw new Error(n.firstChild.textContent);let r=n.firstChild.childNodes;return Array.from(r,a=>bt.create(a,this))}find(t){let[e,s]=t.split("`");e=e.replace(/[–-]/g,"\u2212");let n=+s||1,r=this.root.children.slice(0),o=0;for(;r.length;){let a=r.shift(),l=a instanceof $e?void 0:Zc(a,e);if(l&&(o+=1,o===n))return l;r.unshift(...a.children)}throw new Error(`Can't find element ${e}.`)}animate(t=1200){return O(this,null,function*(){this.isReady=!1,this.root.clean(),this.root.measure();let e=new Ro;this.root.render(e),this.trigger("resize",{height:this.root.height});for(let s of this.deletedNodes)s.render(e);yield e.start(t);for(let s of this.deletedNodes)s.deleteFromDom();this.root.setStatus(""),this.deletedNodes.clear(),this.isReady=!0})}addTermAfter(t,e){let s=I(e?this.find(e):this.root.children),n=this.parse(t);s.insertAfter(n);for(let r of n)r.setStatus("adding");this.updateDescription()}addTermBefore(t,e){let s=e?this.find(e)[0]:this.root.children[0],n=this.parse(t);s.insertBefore(n);for(let r of n)r.setStatus("adding");this.updateDescription()}deleteTerm(t){for(let e of this.find(t))e.setStatus("deleting"),e.detach(),this.deletedNodes.add(e);this.updateDescription()}replaceTerm(t,e){let s=this.find(t),n=this.parse(e);s[0].insertBefore(n);for(let r of n)r.setStatus("adding");for(let r of s)r.setStatus("deleting"),r.detach(),this.deletedNodes.add(r);this.updateDescription()}moveTermAfter(t,e){let s=this.find(t);for(let r of s)r.roundedMotion=!0;I(e?this.find(e):this.root.children).insertAfter(s),this.updateDescription()}moveTermBefore(t,e){let s=this.find(t);for(let r of s)r.roundedMotion=!0;(e?this.find(e)[0]:this.root.children[0]).insertBefore(s),this.updateDescription()}moveTermToStart(t){let e=this.find(t);for(let s of e)s.roundedMotion=!0;this.root.children[0].insertBefore(e),this.updateDescription()}wrapTerms(t,...e){let s=e.map(r=>this.find(r));for(let r of s)for(let o of r)o.roundedMotion=!0;let n=this.parse(t);for(let r of n)r.setStatus("adding");s[0][0].insertBefore(n);for(let[r,o]of s.entries()){let a=this.find("$"+(r+1))[0];a.insertAfter(o),a.deleteFromDom()}this.updateDescription()}unwrapTerm(t,e=1){let s=this.find(t),n=s[0],r=1;for(;r<=e;)n=n.parent,n instanceof $e&&(n=n.parent),r+=1;n.insertAfter(s),n.setStatus("deleting"),n.detach(),this.deletedNodes.add(n),this.updateDescription()}get leftSide(){let t=this.root.children.findIndex(e=>e.expr==="=");return this.root.children.slice(0,t-1)}get rightSide(){let t=this.root.children.findIndex(e=>e.expr==="=");return this.root.children.slice(t+1)}};var $t=50,De=[f.yellow,"#f15e19","#e1343b",f.red,"#8d2ca1","#4e53d0",f.blue,"#0595bf","#0ba27b",f.green,"#7dc410","#ebc000"];function ui(...i){if(!!E.isSafari){for(let t of i)t==null||t.css("transform-box","view-box");setTimeout(()=>{for(let t of i)t==null||t.css("transform-box","fill-box")})}}function jm(i,t){return i==="fraction"?`"1"/"${t}"`:i==="decimal"?`"${Ft(1/t,2)}"`:`"${Ft(1/t*100,1)}%"`}function Fn(i,t,e,s,n,r=1){let o=c("g",{class:"fraction"},n);if(i!=="fraction"&&t>12)return o;let a=t>20?12:t>16?14:18,l=c("g",{style:`font-size: ${a}px`,class:"equation"},o),h=new ci(l,void 0,0,"",a,!0);h.setValue(jm(i,t));let d=h.root.width*r/2,p=h.root.height*r/2;return l.css("transform",`translate(${e-d}px, ${s-p}px)`+(r!==1?` scale(${r})`:"")),o}function Yc(i,t,e,s,n,r,o,a,l,h=1){let d=c("rect",{x:i,y:t,width:e,height:s,fill:o,class:"polygon-tile"},r);return a?[d,Fn(l,n,i+e/2,t+s/2,r,h)]:[d]}var Wi=class extends S{constructor(t,e,s){super(e,s);this.type="fraction-bar";this.count=0;this.$parts=[];this.options=t;let[n,r,o]=t.split(":").map(a=>+a);this.denominator=n,this.tileWidth=10*$t/n,this.$fraction=c("g",{},this.$el),this.$outline=c("path",{class:"outline"},this.$el),this.$handle=this.makeHandle("h",a=>this.setCount(Math.round((a.x+$t/2)/this.tileWidth))),this.$dark=this.makeHandle("h",a=>this.setCount(this.count,Math.round((a.x+$t/2)/this.tileWidth))),this.setCount(r,o!=null?o:r),this.setColour(De[(n-1)%De.length]),this.watchPolypadOptions(a=>this.draw(!a.noLabels,a.labelType))}setCount(t,e){t=T(t,1,40),e=T(e!=null?e:this.dark===this.count?t:this.dark,0,t),!(t===this.count&&e===this.dark)&&(this.count=t,this.dark=e,this.value=e/this.denominator,this.options=`${this.denominator}:${t}:${e}`,this.draw(!this.$parent.options.noLabels,this.$parent.options.labelType),this.path=new $(new u(-$t/2,-$t/2),t*this.tileWidth,$t),this.$outline.draw(this.path),this.$handle.setTransform(new u(t*this.tileWidth-$t/2,-$t/2)),this.$dark.setTransform(new u(this.dark*this.tileWidth-$t/2,$t/2)),this.$dark.setAttr("d",`M0 0V20L${this.dark?-20:20} 0Z`),this.transform(),this.$parent.selection.update())}select(){super.select(),ui(...this.$parts.map(t=>t[1]))}deselect(){super.deselect(),ui(...this.$parts.map(t=>t[1]))}setColour(t){super.setColour(t);let e=A(t),s=V.mix("#fff",e,.8).hex;for(let[n,r]of this.$parts.entries())r[0].setAttr("fill",n<this.dark?e:s);this.$fraction.css("color",V.from(e).brightness<220?"#fff":"#000")}draw(t,e){this.$fraction.removeChildren(),this.$parts=[];let s=V.mix("#fff",this.colour,.8).hex;for(let n=0;n<this.count;n+=1){let r=n<this.dark?this.colour:s;this.$parts.push(Yc(n*this.tileWidth-$t/2,-$t/2,this.tileWidth,$t,this.denominator,this.$fraction,r,t,e))}this.customTransform(),ui(...this.$parts.map(n=>n[1]))}customTransform(){var t;for(let e of this.$parts)(t=e[1])==null||t.css("transform",`rotate(${-this.rot}deg)`)}static makeThumbnail(t,e,s){let[n,r]=t.split(":").map(h=>+h),o=c("svg",{width:222,height:24},e),a=De[n-1],l=220/n;s.options.watch(h=>{o.removeChildren();let d=!h.noLabels,p=h.labelType,m=p!=="fraction"&&n>10?.44:.5;for(let g=0;g<r;++g)Yc(1+g*l,1,l,22,n,o,a,d,p,m)})}changeDenominator(t){for(let e=this.denominator+t;t>0?e<=24:e>=1;e+=t){let s=Math.round(this.count/this.denominator*e);if(!b(s,this.count/this.denominator*e))continue;let n=Math.round(this.dark/this.denominator*e);if(!!b(n,this.dark/this.denominator*e)){this.denominator=e,this.tileWidth=10*$t/e,this.setCount(s,n),this.setColour(De[(e-1)%De.length]);return}}}getSnapPoints(){let t=[];for(let e=0;e<=this.count;e+=1)t.push(new u(e*this.tileWidth-$t/2,-$t/2)),t.push(new u(e*this.tileWidth-$t/2,$t/2));return t}split(){if(this.count===1)return[];let t=D(e=>{let s=this.posn.shift(e*this.tileWidth,0).rotate(this.rot*F,this.posn),n=new Wi(`${this.denominator}:${1}`,this.$parent);return n.setTransform(s,this.rot),n.setColour(this.colour),n},this.count);return this.$parent.selection.select(t),this.delete(),t}static action(t,e){if(t==="split"){let s=[];for(let r of e)s.push(...r.split());let n=e.filter(r=>r.count>1);e[0].$parent.change({added:s,deleted:n})}else if(t==="expand"){for(let s of e)s.changeDenominator(1);e[0].$parent.change({changed:e})}else if(t==="reduce"){for(let s of e)s.changeDenominator(-1);e[0].$parent.change({changed:e})}else if(t==="merge"){let s=Array.from(e),n=Math.min(...s.map(h=>h.posn.x)),r=Math.min(...s.map(h=>h.posn.y)),o=s.map(h=>h.count),a=N(o),l=new Wi(`${s[0].denominator}:${a}`,s[0].$parent);l.setColour(V.mixMany(s.map(h=>V.from(h.colour)),o).hex),l.setTransform(new u(n,r),s[0].rot);for(let h of e)h.delete();s[0].$parent.selection.add(l),e[0].$parent.change({added:[l],deleted:e})}}};var _o=100,Go=class extends S{constructor(t,e,s){super(e,s);this.type="fraction-circle";this.rotateAroundOrigin=!0;this.options=t;let n={class:"polygon-tile",path:this.path,fill:this.colour};this.$path=c("path",n,this.$el),this.$outline=c("path",{class:"outline",path:this.path},this.$el);let r=this.denominator=+t;if(this.value=1/r,r>1){let o=new u(0,-_o).rotate(-Math.PI/r),a=this.path=new Ke(y,o,2*Math.PI/r);this.snapAngles=[0,je(o)*nt,je(a.end)*nt]}else this.path=new _(y,_o);this.$path.draw(this.path),this.$outline.draw(this.path),this.watchPolypadOptions(o=>this.draw(!o.noLabels,o.labelType)),r===1&&this.setOrder("back"),this.setColour(De[r-1]),this.$path.setAttr("fill",this.colour)}draw(t,e){var n;if((n=this.$label)==null||n.remove(),this.denominator===1||!t)return;let s=2-_o/2-(this.denominator-2)*3;this.$label=Fn(e,this.denominator,0,s,this.$el),this.customTransform(),ui(this.$label)}customTransform(){var t;(t=this.$label)==null||t.css("transform",`rotate(${-this.rot}deg)`)}select(){super.select(),ui(this.$label)}deselect(){super.deselect(),ui(this.$label)}setColour(t){super.setColour(t),this.$path.setAttr("fill",A(t)),this.$el.css("color",V.from(A(t)).brightness<220?"#fff":"#000")}static makeThumbnail(t,e,s){let n=+t,r=c("svg",{width:80,height:44},e),o=c("path",{class:"polygon-tile"},r),a=new u(40,2).rotate(-Math.PI/n,new u(40,42)),l=n>1?new Ke(new u(40,42),a,2*Math.PI/n):new _(new u(40,22),20);if(o.draw(l),o.setAttr("fill",De[n-1]),n===1)return;let h;s.options.watch(d=>{h==null||h.remove();let p=!d.noLabels,m=d.labelType,g=26-(m==="fraction"?1.2:1.4)*n;p&&(h=Fn(m,n,40,g,r,.6-n/80))})}};var Te=25;function Ho(i,t,e,s,n){return new P(new u(-n,-n),new u(-n,i),new u(n,i),new u(n,-n),new u(t,-n),new u(t,n),new u(n,n),new u(n,e),new u(-n,e),new u(-n,n),new u(s,n),new u(s,-n))}var qo=class extends S{constructor(t,e,s){super(e,s);this.type="grid";this.showSelectionOutline=!0;this.canDragToSelect=!1;this.options=t,this.dimensions=new u,this.$axes=D(()=>c("line",{class:"grid-axis",stroke:"#777"},this.$el),2),this.$fill=c("path",{fill:"transparent"},this.$el),this.$handles=[0,1].map(r=>this.makeHandle("c",o=>{let a=r?this.dimensions.x:Math.round(o.x/Te-1),l=r?Math.round(o.y/Te-1):this.dimensions.y;this.setDimensions(a,l)})),this.$handles[1].css("cursor","ns-resize");let n=t.split(":");this.setDimensions(+n[0],+n[1])}setDimensions(t,e){t=T(t,1,100),e=T(e,1,100),!(t===this.dimensions.x&&e===this.dimensions.y)&&(this.dimensions=new u(t,e),this.options=`${t}:${e}`,this.path=Ho(-1.5,t+1,e+1,-1.5,.5).scale(Te),this.$axes[0].setLine({x:-1.5*Te,y:0},{x:(t+1)*Te,y:0}),this.$axes[1].setLine({x:0,y:-1.5*Te},{x:0,y:(e+1)*Te}),this.$handles[0].setCenter({x:(t+1)*Te,y:0}),this.$handles[1].setCenter({x:0,y:(e+1)*Te}),this.$fill.draw(this.path),this.transform(),this.$parent.selection.update())}setColour(t){this.colour=t;for(let e of this.$axes)e.setAttr("stroke",A(t))}static makeThumbnail(t,e){let s=c("svg",{width:80,height:80},e);c("line",{x1:20,y1:0,x2:20,y2:80,stroke:"white","stroke-width":2},s),c("line",{x1:0,y1:20,x2:80,y2:20,stroke:"white","stroke-width":2},s)}};var Ne=new Map,Ms="";function zo(i){var s,n,r;if(i.value!==void 0)return["",i.value,0,i.value,0];if(i.is("algebra-tile")){let o=i.options.startsWith("-")?-1:1,a=o<0?i.options.slice(1):i.options,l=(s=Ne.get("x"))!=null?s:5,h=(n=Ne.get("y"))!=null?n:4;switch(a){case"1":return["",o,0,o,0];case"x":return["x",o,0,o*l,l];case"x2":return["x",0,o,o*l*l,l];case"y":return["y",o,0,o*h,h];case"y2":return["y",0,o,o*h*h,h];case"xy":return["x",o*h,0,o*h*l,l]}}let t=btoa(i.type+i.options+i.colour).replace(/=/g,""),e=(r=Ne.get(t))!=null?r:1;return[t,1,0,e,e]}function Wm(i,t){let e={},s=0,n=(p,m=1)=>{let[g,M,w,x,k]=zo(p);s+=m*x,!!g&&(e[g]||(e[g]=[0,0,0]),e[g][0]+=m*M,e[g][1]+=m*w,e[g][2]=k)};for(let p of i)n(p,1);for(let p of t)n(p,-1);if(b(s,0))return;let r=Object.keys(e).filter(p=>e[p][0]||e[p][1]),o=r.filter(p=>!Ne.has(p))[0]||I(r);if(!o)return!0;let[a,l,h]=e[o],d=b(l,0)?h-s/a:Math.max(...$r(l,a,s-a*h-l*h*h));Ne.set(o,d),Ms=Array.from(Ne.entries()).map(p=>p.join("=")).join(",")}function Km(i){if(i!==Ms){Ms=i,Ne.clear();for(let t of i.split(",")){let[e,s]=t.split("=");e&&Ne.set(e,+s||0)}}}var Zn="M120,0C120,16,66.3,20,0,20S-120,16-120,0Z",Jc="M0,26A18.1,18.1,0,0,0-18,44V72H18V44A18.1,18.1,0,0,0,0,26Z",Qc=["text","grid","number-line","spinner","decimal-grid","axes","custom-spinner","ruler","protractor","compass","geo","dot-machine","abacus"],Un=new $(new u(0,-180),240,180),di=15;function tu(i,t){var s;let e=i.posn.shift(0,t);i.$el.setTransform(e,i.rot*F),i.transformed=(s=i.path)==null?void 0:s.rotate(i.rot).translate(e)}var Bo=class extends S{constructor(t,e,s){super(e,s);this.type="balance";this.canRotate=!1;this.canDragToSelect=!1;this.level=0;this.left=[];this.right=[];this.isAnimating=!1;let[n,r]=t.split(":");this.level=+n||0,this.options=`${this.level}:${Ms}`,t&&Km(r||""),this.$beam=c("path",{class:"balance-beam"},this.$el),this.$left=c("path",{d:Zn,class:"balance"},this.$el),this.$right=c("path",{d:Zn,class:"balance"},this.$el),this.$base=c("path",{d:Jc,class:"balance"},this.$el),this.setColour("#bbb"),this.customTransform(),this.draw();let o=c("path",{path:Un,class:"balance-target"},this.$el),a=c("path",{path:Un,class:"balance-target"},this.$el);this.onMoveStart=()=>{if(!ml(e.selection.tiles,l=>Qc.includes(l.type))){o.setTransform({x:-280,y:this.level*di}),a.setTransform({x:40,y:-this.level*di});for(let l of[o,a])l.show()}},this.onMoveEnd=()=>{for(let l of[o,a])l.hide()},this.onChange=l=>{l.action==="change"&&(this.checkTileOverlaps(),this.rebalance(400,l))},e.on("move-start",this.onMoveStart),e.on("move-end",this.onMoveEnd),setTimeout(()=>{this.checkTileOverlaps(),e.on("change",this.onChange)})}delete(){this.$parent.off("move-start",this.onMoveStart),this.$parent.off("move-end",this.onMoveEnd),this.$parent.off("change",this.onChange),super.delete()}checkTileOverlaps(){let t=Un.translate(this.posn).shift(-280,this.level*di),e=Un.translate(this.posn).shift(40,-this.level*di);this.left=[],this.right=[];for(let s of this.$parent.tiles.values())!s.transformed||s.type==="balance"||Qc.includes(s.type)||(rs(t,s.transformed)?this.left.push(s):rs(e,s.transformed)&&this.right.push(s))}draw(t=this.level){let e=new u(-160,t*15),s=new u(160,-t*15);this.$beam.draw(new Ye(e.shift(0,10),e.shift(0,44),s.shift(0,44),s.shift(0,10))),this.$left.setTransform(e),this.$right.setTransform(s)}rebalance(t=400,e){return O(this,null,function*(){let s=N(this.left.map(l=>zo(l)[3])),n=N(this.right.map(l=>zo(l)[3])),r=b(s,n)?0:s<n?-1:1;if(r===this.level||this.isAnimating)return;let o=this.level,a=(r-o)*di;this.level=r;for(let l of this.left)l.setTransform(l.posn.shift(0,a));for(let l of this.right)l.setTransform(l.posn.shift(0,-a));if(e==null?void 0:e.data){let l=e.data.changed=e.data.changed||[],h=[...e.data.added||[],...e.data.deleted||[]];for(let d of[this,...this.left,...this.right])!l.includes(d)&&!h.includes(d)&&l.push(d)}this.options=`${r}:${Ms}`,this.isAnimating=!0,yield z(l=>{this.draw(it(o,r,l));for(let h of this.left)tu(h,(l-1)*a);for(let h of this.right)tu(h,(1-l)*a);this.$parent.selection.update()},t).promise,this.isAnimating=!1,this.transform(),this.$parent.selection.update()})}customTransform(){let t=this.level*di;this.path=new P(new u(-280,t),new u(-40,t),new u(-40,25),new u(40,25),new u(40,-t),new u(280,-t),new u(280,-t+48),new u(40,-t+48),new u(40,72),new u(-40,72),new u(-40,t+48),new u(-280,t+48))}getSnapPoints(){return[]}getSnapLines(){let t=this.level*di;return[new j(new u(-280,t),new u(-40,t)),new j(new u(40,-t),new u(280,-t))]}setColour(t){this.colour=t,this.$beam.css("stroke",t);for(let e of[this.$base,this.$left,this.$right])e.css("fill",A(t))}static makeThumbnail(t,e){let s=c("svg",{width:250,height:50,viewBox:"-290 -10 580 82",class:"scale"},e);c("path",{d:"M-160 10v34h320v-34",fill:"transparent",stroke:"#bbb","stroke-width":10},s),c("path",{d:Zn,transform:"translate(-160 0)",fill:"#bbb"},s),c("path",{d:Zn,transform:"translate(160 0)",fill:"#bbb"},s),c("path",{d:Jc,fill:"#bbb"},s)}static action(t,e){return O(this,null,function*(){let s=e[0];if(t!=="balance"||e.length!==1||!s.level)return;if(Wm(s.left,s.right))return yn("balance-error");let r=new Set;for(let o of s.$parent.tiles.values())if(!!o.is("balance")){o.rebalance();for(let a of[o,...o.left,...o.right])r.add(a)}e[0].$parent.change({changed:Array.from(r)})})}};var Fo={circle:"M -25 0a25,25 0 1 0 50 0a25 25 0 1 0 -50 0",square:"M0 -25L25 0L0 25L-25 0Z",cross:"M25 -9L9 -9L9 -25L-9 -25L-9 -9L-25 -9L-25 9L-9 9L-9 25L9 25L9 9L25 9L25 -9Z",weight:"M24.3,22.1,17.7-6.1A4,4,0,0,0,14-9H8a10.3,10.3,0,0,0,2-6A10,10,0,0,0,0-25,10,10,0,0,0-10-15,10.3,10.3,0,0,0-8-9h-6a4,4,0,0,0-3.7,2.9l-6.6,28.2A2.2,2.2,0,0,0-22,25H22A2.2,2.2,0,0,0,24.3,22.1ZM0-11a4,4,0,0,1-4-4,4,4,0,0,1,4-4,4,4,0,0,1,4,4A4,4,0,0,1,0-11Z",star:"M0 15.7L15.5 23.8L12.5 6.6L25 -5.6L7.7 -8.1L0 -23.8L-7.7 -8.1L-25 -5.6L-12.5 6.6L-15.5 23.8L0 15.7Z",heart:"M3.4,20.8a4.9,4.9,0,0,1-6.7-.1l-.3-.2C-16.7,8.6-25.3.8-25-8.9a13.7,13.7,0,0,1,5.9-10.7A14.4,14.4,0,0,1,0-16.8a14.4,14.4,0,0,1,19.1-2.8A13.7,13.7,0,0,1,25-8.9C25.3.8,16.7,8.6,3.6,20.5Z"},Xm={weight:"M24.3,22.1,17.7-6.1A4,4,0,0,0,14-9H8a10.3,10.3,0,0,0,2-6A10,10,0,0,0,0-25,10,10,0,0,0-10-15,10.3,10.3,0,0,0-8-9h-6a4,4,0,0,0-3.7,2.9l-6.6,28.2A2.2,2.2,0,0,0-22,25H22A2.2,2.2,0,0,0,24.3,22.1Z"},eu={circle:f.orange,square:f.purple,cross:f.green,weight:f.blue,star:f.yellow,heart:f.red},Zo=class extends G{constructor(t,e,s){super("square",e,s);this.type="token";this.options=t,this.$path.setAttr("d",Fo[t]),this.$outline.setAttr("d",Xm[t]||Fo[t]),this.setColour(eu[t])}static makeThumbnail(t,e){let s=c("svg",{width:36,height:36},e),n=c("path",{d:Fo[t],class:"polygon-tile"},s);n.setTransform({x:18,y:18},0,.6),n.setAttr("fill",eu[t])}};var Ht=19,Ps=[[],[[0,0]],[[-.9,-.9],[.9,.9]],[[-1,-1],[0,0],[1,1]],[[-.9,-.9],[.9,-.9],[.9,.9],[-.9,.9]],[[-1,-1],[1,-1],[1,1],[-1,1],[0,0]],[[-.9,-1.1],[-.9,0],[-.9,1.1],[.9,-1.1],[.9,0],[.9,1.1]],[[0,-1.2],[0,0],[0,1.2],[1,-.6],[1,.6],[-1,-.6],[-1,.6]],[[0,-1.1],[0,1.1],[-1.1,-1.1],[-1.1,0],[-1.1,1.1],[1.1,-1.1],[1.1,0],[1.1,1.1]],[[0,-1.1],[0,0],[0,1.1],[-1.1,-1.1],[-1.1,0],[-1.1,1.1],[1.1,-1.1],[1.1,0],[1.1,1.1]]],Ym=new $(new u(-Ht,-Ht),2*Ht,2*Ht),jn=[[0,0],[0,Math.PI/2],[Math.PI/2,0],[-Math.PI/2,0],[0,-Math.PI/2],[Math.PI,0]],Uo=["#656073",f.teal,f.blue,f.purple,f.red,f.orange,f.yellow,f.lime,f.green,f.teal],te=class extends S{constructor(t,e,s){super(e,s);this.type="dice";this.isAnimating=!1;this.options=t;let[n,r]=t.split(":");this.faces=r||"1,2,3,4,5,6";let o=this.faces.split(",").map(a=>{let l=new Gt(Ym,{class:"dice-face",fill:Uo[+a],stroke:Uo[+a]}),h=Ps[+a].map(d=>new Gt(new _(new u(d[0]*Ht/2,d[1]*Ht/2),4),{class:"dice-dot"}));for(let d of h)d.transform.translate(0,0,2);return new Wt([l,...h])});o[0].transform.translate(0,0,Ht),o[1].transform.translate(-Ht,0,0).rotate(0,-Math.PI/2),o[2].transform.translate(0,Ht,0).rotate(-Math.PI/2,0),o[3].transform.translate(0,-Ht,0).rotate(Math.PI/2,0),o[4].transform.translate(Ht,0,0).rotate(0,Math.PI/2),o[5].transform.translate(0,0,-Ht).rotate(0,Math.PI),this.die=new Wt(o,{},this.$el),this.die.sorting=!0,this.setValue(+n||Tt.integer(1,6)),this.path=new $(new u(-25,-25),50,50),this.$outline=c("path",{class:"outline",path:this.path},this.$el)}setColour(t){this.colour=t==="#000"||t==="#000000"?"":t.slice(0,7);for(let e of this.die.children)e.children[0].color=A(this.colour);this.die.render()}setValue(t){this.value!==t&&(this.value=t,this.options=`${t}:${this.faces}`,this.die.transform.clear().rotate(...jn[t-1]),this.die.render())}roll(t=2e3){return O(this,null,function*(){if(this.isAnimating)return;this.isAnimating=!0,this.$parent.playSound("roll");let e=Tt.integer(1,6),s=jn[this.value-1],n=4*Math.PI+jn[e-1][0]-s[0],r=4*Math.PI+jn[e-1][1]-s[1];yield z(o=>{let a=Y("sine",o);this.die.transform.clear().translate(0,0,4*a*(1-a)*Ht/2).rotate(s[0]+a*n,s[1]+a*r),this.die.render()},t).promise,this.setValue(e),this.isAnimating=!1})}static makeThumbnail(t,e){if(e.data.thumb==="net"){let s=c("svg",{width:58,height:76},e),n=t.split(":")[1].split(",").map(a=>+a),r=e.data.colour,o=[new u(20,2),new u(20,20),new u(20,38),new u(20,56),new u(2,20),new u(38,20)];for(let[a,l]of o.entries()){let h=r||Uo[+n[a]];c("path",{path:new $(l,18,18),class:"polygon-tile",fill:h},s);for(let d of Ps[n[a]])c("circle",{cx:l.x+9+d[0]*4.5,cy:l.y+9+d[1]*4.5,r:1.8,class:"dice-dot"},s)}}else{let s=c("svg",{width:60,height:60},e);c("rect",{x:6,y:6,width:48,height:48,rx:3,class:"polygon-tile",fill:f.orange},s);for(let n of Ps[5])c("circle",{cx:30+n[0]*12,cy:30+n[1]*12,r:5,class:"dice-dot"},s)}}doubleClick(){te.action("roll",[this])}static action(t,e){return O(this,null,function*(){t==="roll"&&(e[0].$parent.selection.clear(),yield Promise.all(e.map(s=>s.roll())),e[0].$parent.selection.tiles.size||e[0].$parent.selection.select(e),e[0].$parent.change({changed:e}))})}};var Jm={1:"M-1.92 3.18V2.24H-0.5V-1.94H-1.67V-2.66C-1.15-2.74-0.65-2.92-0.2-3.18H0.66V2.24H1.91V3.18Z",2:"M-2.13 3.24V2.57C-1.04 1.37 0.53 0.37 0.75-1.23 0.78-2.65-0.89-2.56-1.53-1.62L-2.18-2.26C-1.23-3.5 1.07-3.69 1.72-2.09 2.36-0.32 0.62 1.1-0.44 2.33 0.43 2.26 1.3 2.24 2.18 2.26V3.24Z",3:"M-0.04 3.3C-0.86 3.34-1.65 3.01-2.2 2.4L-1.65 1.66C0.56 3.88 2.73 0.26-0.84 0.32V-0.52C2.13-0.44 0.64-3.74-1.4-1.79L-1.99-2.5C-1-3.49 1.1-3.71 1.83-2.34 2.03-1.92 2.04-1.45 1.85-1.03 1.67-0.61 1.31-0.29 0.87-0.16V-0.12C3.22 0.57 2.17 3.46-0.04 3.3Z",4:"M0.46 3.18V1.54H-2.34V0.76L0.18-3.18H1.55V0.65H2.35V1.54H1.55V3.18ZM-1.21 0.65H0.46C0.47-0.13 0.45-1.34 0.51-2.11H0.47C0.31-1.77 0.14-1.46-0.05-1.12Z",5:"M-0.03 3.24C-0.84 3.26-1.63 2.94-2.2 2.36L-1.67 1.62C-0.91 2.53 1.08 2.63 1.05 1.08 1.11-0.14-0.33-0.42-1.14 0.25L-1.69-0.1-1.5-3.24H1.9V-2.27H-0.5L-0.63-0.73C2.69-2.07 3.34 3.22-0.03 3.24Z",6:"M-0.78 3.3C-3.49 3.25-3.6-0.85-2.32-2.48-1.9-2.98-1.28-3.28-0.63-3.3 0.03-3.32 0.66-3.06 1.11-2.58L0.49-1.88C-0.96-3.24-2.1-1.59-2.02-0.01-1.71-0.43-1.23-0.7-0.72-0.75-0.2-0.8 0.32-0.63 0.71-0.28 1.85 0.94 1.02 3.38-0.78 3.3ZM-0.8 2.42C0.17 2.46 0.41 0.95-0.11 0.36-0.41 0.13-0.79 0.04-1.16 0.13-1.52 0.22-1.83 0.47-1.99 0.81-1.88 1.7-1.63 2.37-0.8 2.42ZM2.38 3.3C1.97 3.27 1.64 2.93 1.64 2.52 1.64 2.1 1.97 1.76 2.38 1.74 3.35 1.7 3.35 3.33 2.38 3.3Z",7:"M-0.89 3.18C-0.9 1.24-0.28-0.65 0.87-2.21H-2.13V-3.18H2.13V-2.48C0.84-0.89 0.17 1.13 0.28 3.18Z",8:"M0.01 3.3C-2.15 3.38-3.04 0.92-1.01-0.08V-0.12C-1.71-0.52-2.04-1.36-1.79-2.14-1.54-2.91-0.77-3.4 0.03-3.3 0.83-3.37 1.57-2.88 1.82-2.12 2.06-1.36 1.75-0.53 1.05-0.12V-0.08C3.03 0.9 2.12 3.43 0.01 3.3ZM0.03 2.48C0.38 2.52 0.72 2.36 0.91 2.06 1.11 1.77 1.13 1.39 0.96 1.08 0.57 0.68 0.08 0.38-0.46 0.24-1.49 0.87-1.34 2.51 0.02 2.48ZM0.43-0.41C1.17-1 1.18-2.49 0.02-2.48-0.3-2.49-0.59-2.33-0.75-2.06-0.9-1.79-0.91-1.46-0.75-1.19-0.46-0.81-0.04-0.54 0.42-0.41Z",9:"M-1.33 3.3C-1.97 3.31-2.59 3.05-3.03 2.58L-2.41 1.88C-0.96 3.23 0.2 1.59 0.11 0.01-0.27 0.53-0.9 0.81-1.55 0.74-2.19 0.66-2.74 0.25-2.99-0.35-3.27-0.99-3.21-1.72-2.84-2.31-2.46-2.9-1.83-3.27-1.13-3.3 2.17-3.26 1.88 3.36-1.33 3.3ZM-1.06-0.08C-0.58-0.12-0.15-0.39 0.08-0.82 0.07-1.94-0.89-2.96-1.79-2.11-2.32-1.48-2.12 0.01-1.06-0.08ZM2.41 3.3C2 3.28 1.67 2.94 1.67 2.52 1.67 2.11 2 1.76 2.41 1.74 3.38 1.71 3.38 3.33 2.41 3.3Z",10:"M-4.48 3.18V2.24H-3.06V-1.94H-4.23V-2.66C-3.71-2.74-3.21-2.92-2.76-3.18H-1.9V2.24H-0.65V3.18ZM2.27 3.3C-0.66 3.38-0.69-3.4 2.27-3.3 5.23-3.39 5.2 3.38 2.27 3.3ZM2.27 2.4C3.71 2.54 3.74-2.56 2.27-2.4 0.8-2.56 0.83 2.53 2.27 2.4Z",11:"M-4.38 3.18V2.24H-2.96V-1.94H-4.13V-2.66C-3.61-2.74-3.11-2.92-2.66-3.18H-1.8V2.24H-0.55V3.18ZM0.55 3.18V2.24H1.97V-1.94H0.8V-2.66C1.32-2.74 1.82-2.92 2.27-3.18H3.13V2.24H4.38V3.18Z",12:"M-4.43 3.24V2.3H-3.01V-1.88H-4.18V-2.6C-3.67-2.68-3.17-2.86-2.71-3.12H-1.85V2.3H-0.6V3.24ZM0.13 3.24V2.57C1.22 1.37 2.79 0.37 3.01-1.23 3.04-2.65 1.37-2.56 0.73-1.62L0.09-2.26C1.03-3.5 3.33-3.69 3.98-2.09 4.62-0.32 2.88 1.1 1.82 2.33 2.69 2.26 3.56 2.24 4.43 2.26V3.24Z",13:"M-4.41 3.18V2.24H-2.99V-1.94H-4.16V-2.66C-3.65-2.74-3.15-2.92-2.69-3.18H-1.83V2.24H-0.58V3.18ZM2.18 3.3C1.36 3.34 0.57 3.01 0.02 2.4L0.57 1.66C2.78 3.88 4.94 0.26 1.38 0.32V-0.52C4.34-0.44 2.86-3.74 0.82-1.79L0.23-2.5C1.21-3.49 3.31-3.71 4.04-2.34 4.24-1.92 4.25-1.45 4.07-1.03 3.88-0.61 3.53-0.29 3.09-0.16V-0.12C5.43 0.57 4.38 3.46 2.18 3.3Z",14:"M-4.53 3.18V2.24H-3.11V-1.94H-4.28V-2.66C-3.76-2.74-3.26-2.92-2.81-3.18H-1.95V2.24H-0.7V3.18ZM2.65 3.18V1.54H-0.16V0.76L2.36-3.18H3.73V0.65H4.53V1.54H3.73V3.18ZM0.98 0.65H2.65C2.65-0.13 2.64-1.34 2.7-2.11H2.66C2.5-1.77 2.32-1.46 2.14-1.12Z",15:"M-4.41 3.12V2.18H-2.99V-2H-4.16V-2.72C-3.65-2.8-3.15-2.98-2.69-3.24H-1.83V2.18H-0.58V3.12ZM2.19 3.24C1.37 3.26 0.59 2.94 0.02 2.36L0.55 1.62C1.3 2.53 3.29 2.63 3.27 1.08 3.33-0.14 1.88-0.42 1.07 0.25L0.52-0.1 0.71-3.24H4.11V-2.27H1.72L1.59-0.73C4.9-2.06 5.56 3.22 2.18 3.24Z",16:"M-4.47 3.18V2.24H-3.05V-1.94H-4.22V-2.66C-3.71-2.74-3.21-2.92-2.75-3.18H-1.89V2.24H-0.64V3.18ZM2.46 3.3C-0.24 3.25-0.35-0.85 0.92-2.48 1.34-2.98 1.96-3.28 2.61-3.3 3.27-3.32 3.9-3.06 4.35-2.58L3.73-1.88C2.29-3.24 1.14-1.59 1.22-0.01 1.54-0.43 2.01-0.7 2.53-0.75 3.05-0.8 3.56-0.63 3.95-0.28 5.09 0.94 4.26 3.39 2.46 3.3ZM2.44 2.42C3.41 2.46 3.65 0.95 3.13 0.36 2.84 0.13 2.45 0.04 2.09 0.13 1.72 0.22 1.41 0.47 1.25 0.81 1.36 1.7 1.61 2.37 2.45 2.42Z",17:"M-4.45 3.18V2.24H-3.03V-1.94H-4.2V-2.66C-3.68-2.74-3.18-2.92-2.73-3.18H-1.87V2.24H-0.62V3.18ZM1.42 3.18C1.42 1.24 2.04-0.65 3.19-2.21H0.18V-3.18H4.45V-2.48C3.15-0.89 2.49 1.13 2.59 3.18Z",18:"M-4.45 3.18V2.24H-3.03V-1.94H-4.2V-2.66C-3.68-2.74-3.18-2.92-2.73-3.18H-1.87V2.24H-0.62V3.18ZM2.31 3.3C0.16 3.38-0.74 0.92 1.3-0.08V-0.12C0.59-0.52 0.26-1.36 0.51-2.14 0.77-2.91 1.53-3.4 2.34-3.3 3.14-3.37 3.88-2.88 4.12-2.12 4.37-1.36 4.05-0.53 3.36-0.12V-0.08C5.33 0.9 4.42 3.43 2.31 3.3ZM2.33 2.48C2.68 2.52 3.02 2.36 3.22 2.06 3.41 1.77 3.43 1.39 3.26 1.08 2.88 0.68 2.39 0.38 1.85 0.24 0.82 0.87 0.96 2.51 2.33 2.48ZM2.73-0.41C3.47-1 3.48-2.49 2.32-2.48 2.01-2.49 1.72-2.33 1.56-2.06 1.4-1.79 1.39-1.46 1.55-1.19 1.85-0.81 2.26-0.54 2.73-0.41Z",19:"M-4.45 3.18V2.24H-3.03V-1.94H-4.2V-2.66C-3.68-2.74-3.18-2.92-2.73-3.18H-1.87V2.24H-0.62V3.18ZM1.91 3.3C1.27 3.31 0.65 3.05 0.21 2.58L0.83 1.88C2.28 3.23 3.44 1.59 3.35 0.01 2.97 0.53 2.33 0.81 1.69 0.74 1.05 0.66 0.5 0.25 0.24-0.35-0.03-0.99 0.03-1.73 0.4-2.31 0.77-2.9 1.41-3.27 2.11-3.3 5.4-3.26 5.12 3.36 1.91 3.3ZM2.18-0.08C2.66-0.12 3.09-0.39 3.32-0.82 3.3-1.94 2.35-2.96 1.45-2.11 0.91-1.48 1.12 0.01 2.18-0.08Z",20:"M-4.63 3.18V2.51C-3.54 1.31-1.98 0.31-1.75-1.29-1.73-2.71-3.4-2.62-4.04-1.68L-4.68-2.32C-3.74-3.56-1.44-3.75-0.79-2.15-0.15-0.38-1.88 1.04-2.95 2.27-2.08 2.2-1.21 2.18-0.33 2.2V3.18ZM2.48 3.3C-0.45 3.38-0.48-3.4 2.48-3.3 5.43-3.39 5.4 3.38 2.48 3.3ZM2.48 2.4C3.92 2.54 3.95-2.56 2.48-2.4 1.01-2.56 1.03 2.53 2.48 2.4Z"},jo=40,Wo={4:{net:$n,meshScale:.9,numberScale:.08,colour:f.red,thumbnailY:8,renderOptions:{fov:180,hideBackface:!0}},6:{net:xn,meshScale:.744,numberScale:.1,colour:f.yellow,renderOptions:{fov:120,hideBackface:!0}},8:{net:Tn,meshScale:.85,numberScale:.07,colour:f.green,thumbnailY:3,renderOptions:{fov:180,hideBackface:!0}},12:{net:Sn,meshScale:.6,numberScale:.1,colour:f.blue,renderOptions:{fov:!1,hideBackface:!0}},20:{net:Mn,meshScale:.6,numberScale:.06,colour:f.purple,renderOptions:{fov:!1,hideBackface:!0}}};function iu(i,t){let e=Wo[i],s=[],n=hs(e.net,o=>{let a=new Gt(o.shape,{class:"polygon-tile",style:"stroke-width: 0.5"});a.color=A(e.colour),s.push(a);let l=new Gt(Jm[s.length],{class:"dice-dot"});return l.transform.scale(H.all(e.numberScale)),new Wt([a,l])}).group,r=n.children[0].children.map(o=>{let a=o.getTransformed(H.zero).fixFloat(),l=0;(a.x!==0||a.z!==0)&&(l=Math.atan2(a.z,a.x)-Math.PI/2);let h=a.transform(U.rotateY(l)),d=0;(h.y!==0||h.z!==0)&&(d=Math.atan2(h.y,h.z));let p=ot.product(U.rotateX(d),U.rotateY(l)),m=o.getTransformed(new H(1,0,0)).transform(p).fixFloat().xy,g=Math.atan2(-m.y,m.x);return new H(d,l,g)});return t.append(n.$el),{die:n,faces:s,rotationOptions:r}}var Ko=class extends S{constructor(t,e,s){super(e,s);this.type="polyhedral-dice";this.isAnimating=!1;this.options=t;let[n,r]=t.split(":").map(l=>+l);n=n||0,n>=r&&(n=0),this.faceCount=r,this.definition=Wo[r];let o=iu(r,this.$el);this.faces=o.faces,this.die=o.die,this.rotationOptions=o.rotationOptions,this.setValue(+n||Tt.integer(1,r));let a=this.die.getProjectedVertices(this.definition.renderOptions);this.path=P.convexHull(...a),this.$outline=c("path",{class:"outline",path:this.path},this.$el)}setColour(t){super.setColour(t);for(let e of this.faces)e.color=A(this.colour);this.die.render(this.definition.renderOptions)}setValue(t){if(this.value===t)return;this.value=t,this.options=`${t}:${this.faceCount}`;let e=this.rotationOptions[this.value-1];this.die.transform.matrix=ot.product(U.rotateZ(e.z),U.rotateX(e.x),U.rotateY(e.y),U.scaleAll(this.definition.meshScale*jo)),this.die.render(this.definition.renderOptions)}roll(t=2e3){return O(this,null,function*(){if(this.isAnimating)return;this.isAnimating=!0,this.$parent.playSound("roll");let e=Math.floor(Math.random()*this.faceCount),s=this.rotationOptions[this.value-1],n=this.rotationOptions[e];yield z(r=>{r=Y("sine",r),this.die.transform.matrix=ot.product(U.translate(new H(0,0,4*r*(1-r)*jo/2)),U.rotateZ(s.z+(n.z-s.z)*r),U.rotateX(s.x+(n.x-s.x+4*Math.PI)*r),U.rotateY(s.y+(n.y-s.y+4*Math.PI)*r),U.scaleAll(this.definition.meshScale*jo)),this.die.render(this.definition.renderOptions)},t).promise,this.setValue(e+1),this.isAnimating=!1})}doubleClick(){te.action("roll",[this])}static makeThumbnail(t,e){let s=+t.split(":")[1],n=Wo[s],r=c("svg",{width:70,height:70},e),o=c("g",{transform:`translate(35, ${35+(n.thumbnailY||0)})`},r),a=iu(s,o),l=a.rotationOptions[a.rotationOptions.length-1];a.die.transform.matrix=ot.product(U.rotateZ(l.z),U.rotateX(l.x),U.rotateY(l.y),U.scaleAll(n.meshScale*32)),a.die.render()}};var Qm="M0 7.4L8.6 12L7 2.4L13.9 -4.4L4.3 -5.8L0 -14.5L-4.3 -5.8L-13.9 -4.4L-7 2.4L-8.6 12L0 7.4",su="M12.9,9.7C13.9,3,4,5.3,4,1.2H4C9.4-3.7,7.6-14,.1-14.3S-9.3-3.9-4,1.3c-.1,3.8-9.8,1.9-8.9,8.4h0C-5.5,13.2,5.2,13.2,12.9,9.7Z",nu=23,t0=[f.red,f.blue],e0=[Qm,su],Xo=class extends S{constructor(t,e,s){super(e,s);this.type="coin";this.isAnimating=!1;let n=new _(y,nu),r=t0.map((o,a)=>{let l=new Gt(n,{class:"dice-face",fill:o,stroke:o}),h=new Gt(e0[a],{class:"dice-dot"});return h.transform.translate(0,0,1),new Wt([l,h])});r[0].transform.translate(0,0,.5),r[1].transform.rotate(Math.PI,0,0).translate(0,0,-.5),this.coin=new Wt(r,{},this.$el),this.coin.sorting=!0,this.setValue(t?+t:Tt.integer(0,1)),this.path=new _(y,25),this.$outline=c("path",{class:"outline",path:this.path},this.$el)}setValue(t){this.value!==t&&(this.value=t,this.options=""+t,this.coin.transform.clear().rotate(t?Math.PI:0,0,0),this.coin.render())}setColour(t){this.colour=t.slice(0,7)}roll(t=2e3){return O(this,null,function*(){if(this.isAnimating)return;this.isAnimating=!0,this.$parent.playSound("coinToss");let e=Tt.integer(0,1),s=this.value?Math.PI:0,n=6*Math.PI+(e?Math.PI:0)-s;yield z(r=>{let o=Y("sine",r);this.coin.transform.clear().translate(0,0,4*o*(1-o)*nu).rotate(s+o*n,.4*Math.sin(o*8*Math.PI),0),this.coin.render()},t).promise,this.setValue(e),this.isAnimating=!1})}doubleClick(){te.action("roll",[this])}static makeThumbnail(t,e){let s=c("svg",{width:60,height:60},e);c("circle",{cx:30,cy:30,r:28,class:"polygon-tile",fill:f.blue},s),c("path",{d:su,class:"dice-dot"},s).setTransform({x:30,y:30},0,1.2)}};var Yo=75,Cs=2*Math.PI,Es=Math.PI/2,Wn="M9.8-39.1,0-63-9.8-39.1-3-43V60a2.9,2.9,0,0,0,3,3,2.9,2.9,0,0,0,3-3V-43Z";function As(i,t,e,s=Yo,n=y){let r=e?V.shades(e,t.length):V.rainbow(t.length);i.removeChildren();for(let[o,a]of t.entries()){let l=t[o+1]?t[o+1]-a:Cs-a+t[0],h=new Ke(n,u.fromPolar(a-Es,s).add(n),l),d=r[o];c("path",{path:h,class:"polygon-tile",fill:d},i)}}var Vs=class extends S{constructor(t,e,s){super(e,s);this.type="spinner";this.angle=0;this.isAnimating=!1;this.path=new _(y,Yo),this.$sectors=c("g",{},this.$el),this.$arrow=c("path",{d:Wn,class:"spinner"},this.$el),this.$outline=c("path",{class:"outline",path:this.path},this.$el),this.setupHandles(),c("circle",{r:4,class:"spinner"},this.$el),e.events.listen(this.$arrow,{move:({posn:o})=>{let a=this.relativePosn(o).angle()+Es;this.$arrow.setTransform(void 0,a)},end:({lastPosn:o})=>{let a=this.relativePosn(o).angle()+Es;this.setValue(a*nt)},click:()=>this.roll()}),this.$arrow.css("cursor","pointer");let[n,r]=t.split(":");this.drawSectors(+r),this.setValue(+n||0)}setupHandles(){this.$handle=this.makeHandle("c",t=>{let e=(t.angle()+Es)%Cs;this.drawSectors(Cs/e)}),this.$handle.css("cursor","move")}drawSectors(t){let e=T(Math.round(t),2,16);if(e===this.sectors)return;this.sectors=e,this.options=`${this.angle}:${e}`;let s=Cs/e;As(this.$sectors,D(n=>s*n,e),this.colour),this.$handle.setCenter(u.fromPolar(s-Es,Yo))}setColour(t){this.colour=t;let e=this.$sectors.children,s=V.shades(t,e.length);for(let[n,r]of e.entries())r.setAttr("fill",s[n])}setValue(t){t=ct(Math.round(t),360),this.angle!==t&&(this.angle=t,this.options=`${t}:${this.sectors}`,this.$arrow.setTransform(void 0,this.angle*F))}roll(t=2e3){return O(this,null,function*(){if(this.isAnimating)return;this.isAnimating=!0,this.$parent.playSound("spin");let e=this.angle,s=(4+Math.random())*360;yield z(n=>{let r=it(e,s,Y("sine",n));this.$arrow.setTransform(void 0,r*F)},t).promise,this.setValue(s),this.isAnimating=!1})}doubleClick(){te.action("roll",[this])}static makeThumbnail(t,e){let s=c("svg",{width:80,height:80},e),n=new u(40,40);As(s,D(o=>Cs/5*o,5),"",36,n),c("path",{d:Wn,class:"spinner"},s).setTransform(n,-.8,.5)}};var i0=2*Math.PI,Jo=Math.PI/2,Qo=75,ta=class extends Vs{constructor(t,e,s){super(`${t.split(":")[0]}:1`,e,s);this.type="custom-spinner";this.$handles=[];for(let n of t.split(":")[1].split(","))this.makeVertex(u.fromPolar(+n*F-Jo,Qo))}setupHandles(){let t;this.$parent.events.listen(this.$outline,{down:({posn:e})=>t=this.makeVertex(this.relativePosn(e)),move:({posn:e})=>this.moveVertex(this.relativePosn(e),t),end:()=>this.$parent.change({changed:[this]})}),this.$outline.css("cursor","crosshair")}drawSectors(){if(!this.$handles||this.$handles.length<2)return;let t=this.$handles.map(s=>(s.center.angle()+Jo)%i0).sort();this.sectors=t.map(s=>Math.round(s*nt)).join(",");let e=`${this.angle}:${this.sectors}`;e!==this.options&&(this.options=e,As(this.$sectors,t,this.colour))}makeVertex(t){if(this.$handles.length>=24)return;let e=this.makeHandle("c",s=>{!e||(s.length>2*Qo?(this.deleteVertex(e),e=void 0):this.moveVertex(s,e))},()=>{e&&this.deleteVertex(e)});return e.setAttr("r",8),e.css("cursor","move"),this.$handles.push(e),this.moveVertex(t,e),e}deleteVertex(t){this.$handles.length<=2||(t.remove(),this.$handles.splice(this.$handles.indexOf(t),1),this.drawSectors())}moveVertex(t,e){if(!e)return;let s=K(t.angle()*nt,10)*F;e.setCenter(u.fromPolar(s,Qo)),this.drawSectors()}static makeThumbnail(t,e){let s=c("svg",{width:80,height:80},e),n=new u(40,40),r=t.split(":")[1].split(",").map(a=>+a*F);As(s,r,"",36,n),c("path",{d:Wn,class:"spinner"},s).setTransform(n,.4,.5);for(let a of r){let l=u.fromPolar(a-Jo,36).add(n);c("circle",{cx:l.x,cy:l.y,r:3,fill:"white"},s)}}};var ee=50;function Kn(i,t,e,s=0,n=0){for(let r of Ps[t]){let o=r[0]*.23*e+e/2+s,a=r[1]*.23*e+e/2+n;c("circle",{cx:o,cy:a,r:e/10,class:"dice-dot"},i)}}var ea=class extends S{constructor(t,e,s){super(e,s);this.type="domino";this.options=t,this.path=new $(y,ee,ee*2),this.$mainShape=c("rect",{class:"polygon-tile",rx:5},this.$el),c("line",{x1:0,y1:ee,x2:ee,y2:ee,class:"polygon-tile"},this.$el);let[n,r]=t.split(":").map(o=>+o);Kn(this.$el,n,ee,0,0),Kn(this.$el,r,ee,0,ee),this.value=n+r,this.$outline=c("rect",{class:"outline",rx:5},this.$el),this.$mainShape.setRect(this.path),this.$outline.setRect(this.path),this.transform(),this.setColour(f.teal)}getSnapPoints(){return[...super.getSnapPoints(),new u(0,ee),new u(ee,ee)]}setColour(t){super.setColour(t),this.$mainShape.setAttr("fill",A(t))}static makeThumbnail(t,e){let s=30,n=c("svg",{width:s+4,height:s*2+4},e);c("rect",{x:2,y:2,width:s,height:s*2,rx:2,class:"polygon-tile",fill:f.teal},n),c("line",{x1:2,y1:s+2,x2:s+2,y2:s+2,class:"polygon-tile"},n);let[r,o]=t.split(":").map(a=>+a);Kn(n,r,s,2,2),Kn(n,o,s,2,2+s)}};var ru=[f.red,f.blue,f.green,f.yellow,f.purple,f.orange,f.lime],pi=class extends S{constructor(t,e,s){super(e,s);this.focussedSeries=-1;this.default=!0;this.chartOptions=ke({}),t&&Object.assign(this.chartOptions,Be(t)),this.chartColors=this.chartOptions.colours||[],this.chartOptions.watchAll(()=>this.options=JSON.stringify(this.chartOptions)),this.$series=c("g",{},this.$el),this.$outline=c("path",{class:"outline"},this.$el),e.events.listen(this.$el,{click:n=>this.focusOnSeries(n),checkIfActive:()=>this.focussedSeries>=0})}setColour(t,e){let s=this.focussedSeries;if(s>=0&&e==="picker"){if(this.chartColors[s]===t)return;this.chartColors[s]=t,this.colorSeries(A(t),s),this.chartOptions.colours=this.chartColors.slice(0),this.$parent.change({changed:[this]})}else e==="theme"||super.setColour(t)}getSeriesColor(t){if(this.default)return f.grey;let e=this.chartColors[t]||ru[t%ru.length];return A(e)}doubleClick(t){this.focussedSeries>=0||(this.focusOnSeries(t),!(this.focussedSeries<0)&&(this.$parent.options.focussed=this,this.$el.addClass("chart-focussed"),this.$parent.selection.clear()))}focusOnSeries(t){let e=t.event.target.getAttribute("series-idx")||this.findClosestElement(t);!e||(this.focussedSeries=+e,this.focusSeries(+e))}findClosestElement(t){return""}blur(){this.focussedSeries<0||(this.focussedSeries=-1,this.$el.removeClass("chart-focussed"),this.$parent.options.focussed=void 0)}};function ks(i){i=i.filter((e,s)=>!s||e.some(n=>n));let t=i[0].map((e,s)=>i.some((n,r)=>r>0&&n[s]));return i.map(e=>e.filter((s,n)=>t[n]))}function ou(i){if(i=ks(i),!i.length||!i[0].length)return[[],[]];i[0].length===1&&(i=i.map((n,r)=>[`${r}`,n[0]]));let t=i.slice(1),e=t.map(n=>n[0]),s=i[0].slice(1).map((n,r)=>({label:n,data:t.map(o=>+o[r+1]||0)}));return[e,s]}function au(i,t,e=!0){let s=i[0].data.length,n=[];for(let r=0;r<s;++r){let o=[];if(t==="grouped")for(let a of i)o.push([0,a.data[r]]);else if(e){let a=0,l=0,h=i.map(p=>p.data[r]),d=t==="percentage"?99.99/N(h):1;for(let p of h)p<0?(o.push([a,a+p*d]),a+=p*d):(o.push([l,l+p*d]),l+=p*d)}else{let a=0,l=i.map(d=>d.data[r]),h=t==="percentage"?99.99/N(l):1;for(let d of l)o.push([a,a+d*h]),a+=d*h}n.push(o)}return n}var de=class{constructor(t){this.makeNew=t;this.stack=[]}get(t){return this.stack[t]||(this.stack[t]=this.makeNew()),this.stack[t]}};var s0=["A","B","C"],n0=[[10,20,30],[30,10,40],[20,25,10]].map(i=>({label:"",data:i})),ia=class extends pi{constructor(t,e,s){super(t,e,s);this.type="chart";this.colour=f.darkGrey;this.tables=[];this.categories=[];this.series=[];this.$rects=new de(()=>c("rect",{class:"polygon-tile"}));this.$areas=new de(()=>c("polygon",{opacity:.5}));this.$lines=new de(()=>c("polyline",{class:"chart-line"}));this.$points=new de(()=>c("circle",{r:5}));this.$background=c("path",{fill:"transparent"},this.$el),this.$el.prepend(this.$background),this.$axes=c("path",{class:"grid-axis",stroke:f.darkGrey},this.$el),this.$labels=c("g",{class:"axis-labels"},this.$el),this.$foreground=c("g",{},this.$el),this.$handle=this.makeHandle("c",n=>{this.chartOptions.height=Math.max(K(-n.y,25),100),this.chartOptions.width=Math.max(K(n.x,25),100)}),this.$handle.css("cursor","nesw-resize"),this.chartOptions.watch(({type:n,layout:r,width:o,height:a})=>{this.updateOutline(o,a),this.drawChart(n,r)}),this.makeInPort("main",{tileTypes:["table"],message:(n,r)=>{if(n.type!=="table")return;let[o,a]=ou(n.table),l=this.tables.find(h=>h.cable===r);l?Object.assign(l,{categories:o,series:a}):this.tables.push({cable:r,categories:o,series:a}),this.reconcileSeries(),this.drawChart(this.chartOptions.type,this.chartOptions.layout)},disconnect:n=>{this.tables=this.tables.filter(r=>r.cable!==n),this.reconcileSeries(),this.drawChart(this.chartOptions.type,this.chartOptions.layout)}})}reconcileSeries(){var t,e;this.categories=((t=this.tables[0])==null?void 0:t.categories.slice(0))||[],this.series=((e=this.tables[0])==null?void 0:e.series.map(s=>({label:s.label,data:s.data.slice(0)})))||[];for(let s of this.tables.slice(1)){let n=this.categories.length,r=this.series.length;for(let o of s.series)this.series.push({label:o.label,data:zt(0,n)});for(let[o,a]of s.categories.entries()){let l=this.categories.indexOf(a);if(l<0){this.categories.push(a);for(let h of this.series)h.data.push(0);l=this.categories.length-1}for(let[h,d]of s.series.entries())this.series[r+h].data[l]=d.data[o]}}}updateOutline(t=400,e=250){this.path=new $(y.shift(0,-e),t,e),this.$background.draw(this.path),this.$outline.draw(this.path),this.$handle.setCenter({x:t,y:-e}),this.transform(),this.$parent.selection.update()}getX(t){return(t-this.bounds.xMin)/this.bounds.dx*this.path.w}getY(t){return(t-this.bounds.yMin)/this.bounds.dy*this.path.h}drawChart(t="column",e="grouped"){this.$series.removeChildren(),this.$foreground.removeChildren();let s=["line","area"].includes(t);this.default=!this.series.length;let n=this.default?n0:this.series,r=this.default?s0:this.categories,o=au(n,e,!s),a=Math.min(0,...o.map(M=>Math.min(...M.map(w=>w[1])))),l=Math.max(0,...o.map(M=>Math.max(...M.map(w=>w[1])))),h=t==="row"?this.path.w:this.path.h,d=as("",h,[a,l],0),p=[0,r.length-1,1],m=s&&!r.some(M=>isNaN(+M)),g=m?r.map(M=>+M):void 0;if(m){let M=Math.min(...g),w=Math.max(...g);p=as("",this.path.w,[M,w],0)}t==="row"&&([d,p]=[p,d]),this.bounds=new Vt(p[0],p[1],d[0],d[1]),t==="column"?this.drawColumnChart(o,e):t==="row"?this.drawRowChart(o,e):(t==="area"&&this.drawAreas(o,g),this.drawLines(o,g),t==="line"&&this.drawPoints(o,g)),this.drawAxes(t,this.path.w,this.path.h,p[2],d[2],m?void 0:r)}drawAxes(t,e,s,n,r,o){var l;this.$labels.removeChildren();let a=`M0 0v${-s}M0 0h${e}`;if(W(0,this.bounds.yMin,this.bounds.yMax)&&(a+=`M0 ${-this.getY(0)}h${e}`),W(0,this.bounds.xMin,this.bounds.xMax)&&(a+=`M${this.getX(0)} 0 v${-s}`),t==="column"&&o){let h=o.length?e/o.length:0;for(let d=0;d<=o.length;++d){let p=d*h;a+=`M${p} 0L${p} 5`,c("text",{text:o[d],x:p+h/2,y:21,"text-anchor":"middle"},this.$labels)}}else for(let h=this.bounds.xMin;h<=this.bounds.xMax;h+=n){let d=this.getX(h);a+=`M${d},0v5`;let p=t==="row"?rt(h,4):(l=o==null?void 0:o[h])!=null?l:rt(h,4);c("text",{text:p,x:d,y:21,"text-anchor":"middle"},this.$labels)}if(t==="row"&&o){let h=o.length?s/o.length:0;for(let d=0;d<=o.length;++d){let p=-d*h;a+=`M0 ${p}h-5`,c("text",{text:o[d],x:-12,y:p-h/2+5,"text-anchor":"end"},this.$labels)}}else for(let h=this.bounds.yMin;h<=this.bounds.yMax;h+=r){let d=this.getY(h);a+=`M0 ${-d}h-5`;let p=rt(h,4);c("text",{text:p,x:-10,y:-d+5,"text-anchor":"end"},this.$labels)}this.$axes.setAttr("d",a)}drawColumnChart(t,e){let s=t.length,n=t[0].length,r=this.path.w/s,o=r/4,a=r-o,l=e==="grouped";l&&(a/=n);for(let h=0;h<n;++h)for(let d=0;d<s;++d){let p=t[d][h],m=d*r+o/2+(l?h*a:0),g=[-this.getY(p[0]),-this.getY(p[1])],M=Math.abs(g[1]-g[0]);this.drawRect(h*s+d,h,m,Math.min(...g),a,M)}}drawRowChart(t,e){let s=t.length,n=t[0].length,r=this.path.h/s,o=r/4,a=r-o,l=e==="grouped";l&&(a/=n);for(let h=0;h<n;++h)for(let d=0;d<s;++d){let p=t[d][h],m=d*r+o/2+(l?h*a:0),g=[this.getX(p[0]),this.getX(p[1])],M=Math.abs(g[1]-g[0]);this.drawRect(h*s+d,h,Math.min(...g),-(m+a),M,a)}}drawRect(t,e,s,n,r,o){let a=this.$rects.get(t);this.$series.append(a),a.setAttr("fill",this.getSeriesColor(e)),a.setAttr("x",s),a.setAttr("y",n),a.setAttr("width",r),a.setAttr("height",o),a.setAttr("series-idx",e)}drawLines(t,e){let s=t[0].length;for(let n=0;n<s;++n){let r=t.map((a,l)=>{var h;return`${this.getX((h=e==null?void 0:e[l])!=null?h:l)} ${-this.getY(a[n][1])}`}).join(" "),o=this.$lines.get(n);o.setAttr("stroke",this.getSeriesColor(n)),o.setAttr("points",r),o.setAttr("series-idx",n),this.$series.append(o)}}drawPoints(t,e){var r;let s=t[0].length,n=t.length;for(let o=0;o<s;++o)for(let a=0;a<n;++a){let l=this.$points.get(o*n+a);l.setCenter({x:this.getX((r=e==null?void 0:e[a])!=null?r:a),y:-this.getY(t[a][o][1])}),l.setAttr("fill",this.getSeriesColor(o)),l.setAttr("series-idx",o),this.$foreground.append(l)}}drawAreas(t,e){let s=t[0].length;for(let n=0;n<s;++n){let r=t.map((l,h)=>{var d;return`${this.getX((d=e==null?void 0:e[h])!=null?d:h)} ${-this.getY(l[n][1])}`}).join(" "),o=t.map((l,h)=>{var d;return`${this.getX((d=e==null?void 0:e[h])!=null?d:h)} ${-this.getY(l[n][0])}`}).reverse().join(" "),a=this.$areas.get(n);a.setAttr("fill",this.getSeriesColor(n)),a.setAttr("points",r+" "+o),a.setAttr("series-idx",n),this.$series.append(a)}}setColour(t,e){super.setColour(t,e),this.focussedSeries<0&&(this.$labels.setAttr("fill",A(t)),this.$axes.setAttr("stroke",A(t)))}colorSeries(t,e){var s,n,r,o;if(!!this.series.length){(s=this.$lines.stack[e])==null||s.setAttr("stroke",t),(n=this.$areas.stack[e])==null||n.setAttr("stroke",t),(r=this.$areas.stack[e])==null||r.setAttr("fill",t),e===this.focussedSeries&&((o=this.$focussedLine)==null||o.setAttr("stroke",t));for(let a of this.$series.$$(`rect[series-idx="${e}"]`))a.setAttr("fill",t);for(let a of this.$foreground.$$(`circle[series-idx="${e}"]`))a.setAttr("fill",t)}}focusSeries(t){if(this.chartOptions.type==="line"){this.$focussedLine||(this.$focussedLine=c("polyline",{class:"chart-shadow"}),this.$background.insertAfter(this.$focussedLine)),this.$focussedLine.setAttr("points",this.$lines.get(t).attr("points")),this.$focussedLine.setAttr("stroke",this.getSeriesColor(t)),this.$focussedLine.show();return}if(this.$focussedOutline||(this.$focussedOutline=c("path",{class:"chart-outline"},this.$el)),this.chartOptions.type==="area"){let e=$i(this.$areas.get(t).attr("points").split(" "),2),s="M"+e.map(n=>n.join(" ")).join("L")+"Z";this.$focussedOutline.setAttr("d",s)}else{let e=this.$rects.stack.filter(n=>+n.attr("series-idx")===t&&n.css("display")),s="";for(let n of e){let r=+n.attr("height");if(b(0,r))continue;let o=n.attr("width");s+=`M${n.attr("x")} ${n.attr("y")}h${o}v${r}h${-o}Z`}this.$focussedOutline.setAttr("d",s)}this.$focussedOutline.show()}blur(){var t,e;super.blur(),(t=this.$focussedOutline)==null||t.hide(),(e=this.$focussedLine)==null||e.hide()}findClosestElement(t){var n;if(this.chartOptions.type!=="line"&&this.chartOptions.type!=="area")return"";let e=this.relativePosn(t.posn),s=this.$lines.stack.slice(0,this.series.length);return((n=Fe(s,r=>{let o=$i(r.attr("points").split(" "),2).map(([l,h])=>new u(+l,+h)),a=new Ye(...o);return u.distance(e,a.project(e))}))==null?void 0:n.attr("series-idx"))||""}static action(t,e){return O(this,null,function*(){if(["line","area","column","row"].includes(t)){let s=e.filter(n=>n.chartOptions.type!==t);for(let n of s)n.chartOptions.type=t;s.length&&s[0].$parent.change({changed:s})}else if(["grouped","stacked","percentage"].includes(t)){let s=e.filter(n=>n.chartOptions.layout!==t);for(let n of s)n.chartOptions.layout=t;s.length&&s[0].$parent.change({changed:s})}})}};var r0=[2,4,5],sa=class extends pi{constructor(t,e,s){super(t,e,s);this.type="pie-chart";this.series=[];this.$sectors=new de(()=>c("path",{class:"polygon-tile"}));this.$focussedOutline=c("path",{class:"chart-outline"},this.$el),this.$handle=this.makeHandle("c",n=>{this.chartOptions.width=T(K(n.length,25),50,300)}),this.$handle.css("cursor","ew-resize"),this.chartOptions.watch(({type:n,width:r})=>{this.updateOutline(r),this.drawChart(n||"pie",r)}),this.makeInPort("main",{tileTypes:["table"],max:1,message:n=>{if(n.type!=="table")return;let r=ks(n.table).slice(1);if(r.length===0)this.series=[];else{let o=r[0].length>1?1:0;this.series=r.map(a=>Math.abs(+a[o]||0))}this.drawChart(this.chartOptions.type,this.chartOptions.width)},disconnect:()=>{this.series=[],this.drawChart(this.chartOptions.type,this.chartOptions.width)}})}updateOutline(t=100){this.path=new _(y,t),this.$outline.draw(this.path),this.$handle.setTransform({x:t,y:0}),this.transform(),this.$parent.selection.update()}drawChart(t,e=100){var a,l;this.default=!this.series.length||this.series.every(h=>h===0);let s=this.default?r0:this.series,n=N(s),r=s.map(h=>h/n*2*Math.PI);this.$series.removeChildren();let o=-Math.PI/2;for(let[h,d]of r.entries()){if(d===0)continue;b(d,Math.PI*2)&&(d=Math.PI*2-.001);let p=this.$sectors.get(h);this.$series.append(p),p.setAttr("fill",this.getSeriesColor(h)),p.setAttr("series-idx",h),p.draw(new Ke(y,u.fromPolar(o,e),d)),o+=d}t==="donut"&&!this.$donutHole&&(this.$donutHole=c("circle",{fill:"white",class:"donut-hole"},this.$el)),(a=this.$donutHole)==null||a.setAttr("r",e/2),(l=this.$donutHole)==null||l.toggle(t==="donut")}colorSeries(t,e){!this.series.length||this.$sectors.get(e).setAttr("fill",t)}focusSeries(t){this.$focussedOutline.setAttr("d",this.$sectors.get(t).attr("d")),this.$focussedOutline.show()}blur(){super.blur(),this.$focussedOutline.hide()}static action(t,e){return O(this,null,function*(){if(["pie","donut"].includes(t)){let s=e.filter(n=>n.chartOptions.type!==t);for(let n of s)n.chartOptions.type=t;s.length&&s[0].$parent.change({changed:s})}})}};var o0=[[1,2,3,4,5]].map(i=>({label:"",data:i}));function a0(i,t=!1){let e=Mi(i,.25),s=Mi(i,.75),n=1.5*(s-e),r=t?i.filter(h=>W(h,e-n,s+n)):i,o=Math.min(...r);e=Mi(r,.25);let a=Mi(r,.5);s=Mi(r,.75);let l=Math.max(...r);return[o,e,a,s,l]}var na=class extends pi{constructor(t,e,s){super(t,e,s);this.type="box-whisker";this.colour=f.darkGrey;this.$boxPlots=new de(()=>c("path",{class:"chart-line"}));this.range=[0,5];this.series=[];this.tables=new Map;this.$background=c("path",{fill:"transparent"}),this.$el.prepend(this.$background),this.$axis=c("path",{class:"grid-axis",stroke:f.darkGrey},this.$el),this.$labels=c("g",{class:"axis-labels"},this.$el),this.$focussedOutline=c("path",{class:"chart-shadow"},this.$el),this.$handle=this.makeHandle("h",n=>{this.chartOptions.width=Math.max(K(n.x,25),100)}),this.chartOptions.watch(({width:n})=>{this.updateOutline(n),this.drawChart()}),this.makeInPort("main",{tileTypes:["table"],message:(n,r)=>{n.type==="table"&&(this.tables.set(r,n.table),this.redraw())},disconnect:n=>{this.tables.delete(n),this.redraw()}})}drawChart(){this.default=!this.series.length;let t=this.default?o0:this.series;this.$series.removeChildren(),this.range[0]=Math.min(...t.map(e=>Math.min(...e.data))),this.range[1]=Math.max(...t.map(e=>Math.max(...e.data))),t.forEach((e,s)=>this.drawBoxWhiskerPlot(e.data,s,-25-50*(t.length-1-s))),this.drawAxes(t)}drawBoxWhiskerPlot(t,e,s){let n=this.$boxPlots.get(e),r=this.chartOptions.layout==="outliers",[o,a,l,h,d]=a0(t,r).map(M=>this.getX(M)),p=16,m=10,g=`M${o} ${s+m}V${s-m}M${o} ${s}H${a}V${s+p}H${h}V${s-p}H${a}V${s}M${l} ${s+p}V${s-p}M${h} ${s}H${d}M${d} ${s+m}V${s-m}`;if(r){let M=t.map(w=>this.getX(w)).filter(w=>w<o||w>d);for(let w of M)g+=oe(new _(new u(w,s),4))}n.setAttr("d",g),n.setAttr("series-idx",e),n.setAttr("stroke",this.getSeriesColor(e)),this.$series.append(n)}drawAxes(t){this.$labels.removeChildren();let e=as("",this.path.w,this.range,0),s=`M 0 0 h ${this.path.w}`;for(let n=this.range[0];n<=this.range[1]+.001;n+=e[2]){let r=this.getX(n);s+=`M${r},0v5`,c("text",{text:rt(n,4),x:r,y:21,"text-anchor":"middle"},this.$labels)}this.$axis.setAttr("d",s),t.forEach((n,r)=>{let o=-25-50*(t.length-1-r),a=n.label;c("text",{text:a,x:-14,y:o,"text-anchor":"end"},this.$labels)})}updateOutline(t=this.chartOptions.width||300){let e=(this.series.length||1)*50;this.path=new $(y.shift(0,-e),t,e),this.$outline.draw(this.path),this.$background.draw(this.path),this.$handle.translate(t,-e),this.transform(),this.$parent.selection.update()}colorSeries(t,e){this.$boxPlots.get(e).setAttr("stroke",t),this.$focussedOutline.setAttr("stroke",t)}getX(t){return(t-this.range[0])/(this.range[1]-this.range[0])*this.path.w}setColour(t,e){super.setColour(t,e),this.focussedSeries<0&&(this.$labels.setAttr("fill",A(t)),this.$axis.setAttr("stroke",A(t)))}redraw(){this.buildSeries(),this.drawChart(),this.updateOutline()}buildSeries(){this.series=[];for(let t of this.tables.values()){let e=ks(t).slice(1);if(!!e.length)for(let s=0;s<e[0].length;s++){let n=e.map(r=>parseInt(r[s])).filter(r=>!Number.isNaN(r));n.length&&this.series.push({label:t[0][s],data:n})}}}focusSeries(t){this.$focussedOutline.setAttr("d",this.$boxPlots.get(t).attr("d")),this.$focussedOutline.setAttr("stroke",this.getSeriesColor(t)),this.$focussedOutline.show()}blur(){super.blur(),this.$focussedOutline.hide()}findClosestElement(t){let e=Math.round((this.relativePosn(t.posn).y+25)/50);return""+T(-e,0,this.series.length-1)}static action(t,e){return O(this,null,function*(){if(t==="outliers")for(let s of e)s.chartOptions.layout=s.chartOptions.layout===t?void 0:t})}static makeThumbnail(t,e){let[s,n]=[180,45],[r,o,a,l,h]=[0,1,2,3,4].map(x=>5+x/4*170),[d,p,m]=[n/2,14,8],g=c("svg",{width:s,height:n},e),M=c("path",{class:"chart-line",stroke:"white",style:"stroke-width: 2px"},g),w=`M${r} ${d-m} V ${d+m}M${r} ${d} H ${o}V${d-p}H${l} V ${d+p}H${o} V ${d}M${a} ${d-p} V ${d+p}M${l} ${d}H${h}M${h} ${d-m}V${d+m}`;M.setAttr("d",w)}};var lu=`<h3>Coordinate System</h3><div class="row"><div class="label">X Axis:</div><button class="increment" @click="step('xStep', -1)">\u2013</button><input class="input-field" type="number" :bind="xStep" min="0" style="width: 45px"><button class="increment" @click="step('xStep', 1)">+</button></div><div class="row"><div class="label">Y Axis:</div><button class="increment" @click="step('yStep', -1)">\u2013</button><input class="input-field" type="number" :bind="yStep" min="0" style="width: 45px"><button class="increment" @click="step('yStep', 1)">+</button></div>`;var l0=["x","y","\u03B8","r"];function Ki(i){if(i instanceof Lt&&i.fn==="="){let[t,e]=i.args;if(t instanceof qi&&!l0.includes(t.i))return[t.i,e]}return[void 0,i]}var ra=class{constructor(){this.assignments=new Map;this.callbackDeps=new Map;this.updatedNames=new Set}findFirstAssigner(t){var e;return(e=this.assignments.get(t))==null?void 0:e.keys().next().value}findDependants(t,e=[]){let s=[];for(let[r,o]of this.assignments.entries())o.size===1&&r!==t&&!e.includes(r)&&Ks(o.values()).unknowns.filter(l=>!e.includes(l)).includes(t)&&s.push(r);let n=[...Ti(s,r=>this.findDependants(r,s))];return s.concat(n)}validate(t){let e=new Set,s=(n,r=[])=>{if(!this.assignments.has(n)){e.add(n);return}if(r.includes(n))return{message:`The variable <em>${n}</em> is defined recursively.`,locations:r.splice(r.indexOf(n)).map(a=>this.findFirstAssigner(a))};let o=this.assignments.get(n);if(o.size===1){let a=Ks(o.values());for(let l of a.unknowns){let h=s(l,[...r,n]);if(h)return h}}else return{message:`You have defined <em>${n}</em> in multiple places.`,locations:Array.from(o.keys())}};for(let n of t.unknowns){let r=s(n);if(r)return{error:r,dependsOn:[],unknowns:[]}}return{dependsOn:[],unknowns:Array.from(e)}}evaluate(t){let{error:e,unknowns:s}=this.validate(t);if(e||s.length)return{error:e,value:NaN};try{return{value:t.evaluate(this.evalContext)}}catch(n){return{value:NaN}}}get evalContext(){let t={};for(let[e,s]of this.assignments.entries())s.size===1&&(t[e]=Ks(s.values()));return t}get serializedEvalContext(){let t={};for(let[e,s]of Object.entries(this.evalContext))t[e]=s.toString();return t}substituteAssignments(t){let[e,s]=Ki(t);return e?new Lt("=",[new qi(e),s.recursiveSubstitute(this.evalContext)]):t.recursiveSubstitute(this.evalContext)}markUpdated(t){this.updatedNames.add(t);for(let e of this.findDependants(t))this.updatedNames.add(e)}flushChanges(){for(let[e,s]of this.callbackDeps.entries())s.some(n=>this.updatedNames.has(n))&&e();let t=Array.from(this.updatedNames);return this.updatedNames.clear(),t}updateSource(t,e,s,n=!0){this.removeSource(t,!1),this.assignments.has(e)||this.assignments.set(e,new Map),this.assignments.get(e).set(t,s),this.markUpdated(e),n&&this.flushChanges()}attemptUpdateSource(t,e,s=!0){if(typeof e=="string")try{e=ce.parse(e).collapse()}catch(o){return}let[n,r]=Ki(e);return n?this.updateSource(t,n,r,s):this.removeSource(t),r}removeSource(t,e=!0){for(let[s,n]of this.assignments.entries())n.has(t)&&this.markUpdated(s),n.delete(t),n.size===0&&this.assignments.delete(s);e&&this.flushChanges()}watch(t,e,s=!1){this.callbackDeps.set(e,t),s&&e()}unwatch(t){t&&this.callbackDeps.delete(t)}};var mt=50,hu=class{constructor(t){this.promises=new Map;this.latestPromises=new Map;this.worker=new Worker(t),this.worker.onmessage=e=>{if(!e.data)return;let s=e.data[0],n=this.promises.get(e.data[0]);this.promises.delete(s),!(!n||this.latestPromises.get(n[0])!==s)&&n[1](e.data[1])}}draw(t,e,s,{xMin:n,xMax:r,yMin:o,yMax:a,xStep:l,yStep:h}){let d=Ae();return this.latestPromises.set(t,d),this.worker.postMessage(["plot",e,s,d,n,r,l,o,a,h,mt]),new Promise(p=>this.promises.set(d,[t,p]))}},oa,aa=class extends S{constructor(t,e,s){super(e,s);this.type="axes";this.showSelectionOutline=!0;this.canDragToSelect=!1;this.functions=new Map;this.watchers=new Map;this.$fill=c("path",{fill:"transparent"},this.$el),this.$grid=c("path",{class:"axis-gridlines"},this.$el),this.$content=c("g",{},this.$el),this.$axes=c("path",{class:"grid-axis"},this.$el),this.$labels=c("g",{class:"axis-labels"},this.$el),this.$outline=c("rect",{class:"outline active",hidden:!0},this.$el),this.setColour(f.darkGrey),this.watchPolypadOptions(g=>this.$grid.toggle(g.grid==="none"));let[n,r,o,a,l,h]=t.split(":").map(g=>+g),p={xMin:n,xMax:o,xStep:r,yMin:a,yMax:h,yStep:l,step:(g,M)=>this.step(g,M)},m=this.model=e.bindSettingsPanel(this,lu,p);this.$handles=[this.makeHandle("c",g=>m.xMin=T(Math.round(g.x/mt),-20,0)),this.makeHandle("c",g=>m.xMax=T(Math.round(g.x/mt),0,20)),this.makeHandle("c",g=>m.yMin=T(Math.round(-g.y/mt),-20,0)),this.makeHandle("c",g=>m.yMax=T(Math.round(-g.y/mt),0,20))];for(let g of[2,3])this.$handles[g].css("cursor","ns-resize");this.makeInPort("main",{connect:g=>{this.functions.has(g)||this.functions.set(g,c("path",{class:"geo-path"},this.$content))},message:(g,M)=>{let w=this.functions.get(M);w.css("color",A(M.from.tile.colour)),this.draw(M.from.tile,w)},disconnect:g=>{var M;(M=this.functions.get(g))==null||M.remove(),this.functions.delete(g),this.$parent.mathContext.unwatch(this.watchers.get(g.from.tile))},tileTypes:["table","equation"]}),m.watch((g,M)=>this.setSizes(m,M))}highlight(t=!0){var e;(e=this.$outline)==null||e.toggle(t)}setSizes({xMin:t,xMax:e,yMin:s,yMax:n,xStep:r,yStep:o},a=!1){var m;let l=`${t}:${r}:${e}:${s}:${o}:${n}`;if(l===this.options)return;this.options=l;let h=mt;this.$handles[0].setCenter({x:t*h,y:0}),this.$handles[1].setCenter({x:e*h,y:0}),this.$handles[2].setCenter({x:0,y:-s*h}),this.$handles[3].setCenter({x:0,y:-n*h}),this.$labels.removeChildren();let d="",p=`M${t*h} 0L${e*h} 0M0 ${-s*h}L0 ${-n*h}`;p+=`M0 ${-n*h-3}l5 8h-10ZM${e*h+3} 0l-8 5v-10Z`;for(let g=t+1;g<e;++g)!g||(p+=`M${g*h} 0L${g*h} 5`,d+=`M${g*h} ${-s*h}L${g*h} ${-n*h}`,c("text",{text:rt(g*r,4),x:g*h,y:21,"text-anchor":"middle"},this.$labels));for(let g=s+1;g<n;++g)!g||(p+=`M0 ${-g*h}L-5 ${-g*h}`,d+=`M${t*h} ${-g*h}L${e*h} ${-g*h}`,c("text",{text:rt(g*o,4),x:-10,y:-g*h+5,"text-anchor":"end"},this.$labels));this.$axes.setAttr("d",p),this.$grid.setAttr("d",d),this.$fill.draw(Ho(-n*mt,e*mt,-s*mt,t*mt,15)),this.path=new $(new u(t*mt,-n*mt),(e-t)*mt,(n-s)*mt),(m=this.$outline)==null||m.setRect(this.path);for(let[g,M]of this.functions.entries())this.draw(g.from.tile,M);this.transform(),this.$parent.selection.update(),a||this.$parent.change({changed:[this]})}step(t,e){let s=this.model[t],n=Math.pow(10,Math.floor(Math.log10(s))),r=[.5*n,n,2*n,5*n,10*n],o=r.find((a,l)=>e>0?a>s:r[l+1]>=s);this.model[t]=T(o,1e-6,1e12)}draw(t,e){let s=ce.parse(t.options).collapse(),n=this.$parent.mathContext;n.unwatch(this.watchers.get(t));let r=()=>O(this,null,function*(){let[o,a]=Ki(s),{error:l,unknowns:h}=n.validate(a);if(this.showErrorIcon(l),l)e.setAttr("d","");else if(h.length>2)this.showErrorIcon({message:"An equation has too many degrees of freedom.",locations:[t]}),e.setAttr("d","");else{oa||(oa=new hu(this.$parent.attr("worker")));let d=yield oa.draw(t,s.toString(),n.serializedEvalContext,this.model);e.setAttr("d",d.startsWith("[Error]")?"":d)}});this.watchers.set(t,r),n.watch(s.unknowns,r,!0)}getSnapPoints(){let{xMin:t,xMax:e,yMin:s,yMax:n}=this.model,r=[];for(let o=t;o<=e;++o)for(let a=s;a<=n;++a)r.push(new u(o*mt,-a*mt));return r}getSnapLines(){let{xMin:t,xMax:e,yMin:s,yMax:n}=this.model;return[new j(new u(t*mt,0),new u(e*mt,0)),new j(new u(0,-s*mt),new u(0,-n*mt))]}setColour(t){super.setColour(t.slice(0,7));for(let e of[this.$axes,this.$labels])e.setAttr("fill",A(this.colour));for(let e of[this.$axes,this.$grid])e.setAttr("stroke",A(this.colour))}static makeThumbnail(t,e){let s=c("svg",{width:180,height:180},e);c("path",{d:"M30 10v160M60 10v160M120 10v160M150 10v160M10 30h160M10 60h160M10 120h160M10 150h160",class:"axis-gridlines",stroke:"white"},s),c("path",{d:"M10 90h160M90 10v160M90 8l4 6h-8ZM172 90l-6 4v-8Z",class:"grid-axis",fill:"white"},s)}};var h0=Math.PI/2,xt=Math.PI*2,cu=["hours","minutes","seconds"],c0={hours:"M-3,0-4-29l4-5,4,5L3,0Z",minutes:"M-2,0-3-47l3-5,3,5L2,0",seconds:"M-1,-52L1,-52L1,0L-1,0Z"};function uu(i,t=75){let e=t-5,s="";for(let a=0;a<60;++a){let l=u.fromPolar(a/30*Math.PI),h=e-(a%5?3:8);s+=`M${l.x*h} ${l.y*h}L${l.x*e} ${l.y*e}`}let n=c("circle",{r:t,class:"polygon-tile"},i);c("circle",{r:e,class:"clock-face"},i);let r=c("path",{d:s,class:"clock-ticks"},i);for(let a=1;a<=12;++a){let l=u.fromPolar((a-3)/6*Math.PI).scale(53).shift(0,5);c("text",{text:a,x:l.x,y:l.y,class:"clock-label"},i)}let o=cu.map(a=>c("path",{class:"clock-handle",d:c0[a],opacity:a==="hours"?.8:void 0},i));return c("circle",{r:4,class:"spinner"},i),[n,r,...o]}var la=class extends S{constructor(t,e,s){super(e,s);this.type="clock";this.showSeconds=!0;this.prevAngle=0;this.currentAngle=0;this.seconds=0;this.time=[0,0,0];this.options=t;let n=75;this.path=new _(y,n),[this.$border,this.$ticks,...this.$hands]=uu(this.$el,n),this.$outline=c("circle",{class:"outline",r:n},this.$el);let r=this.options;for(let[h,d]of this.$hands.entries())e.events.listen(d,{start:({posn:p})=>{r=this.options,this.prevAngle=this.getPointerAngle(p)%xt},move:({posn:p})=>this.handleMoveHand(cu[h],p),end:()=>{this.updateOptions(),this.options!==r&&e.change({changed:[this]})}});let[o,a,...l]=this.options.split(":");if(+a||this.$hands[2].hide(),o==="l"){this.clockType="live";let h=new Date().getTimezoneOffset()*60,d=-1;this.animation=z(()=>{let p=Math.round(Date.now()/1e3-h);p!==d&&(d=p,this.setTime(p))});for(let p of this.$hands)p.css("pointer-events","none")}else o==="g"?(this.clockType="geared",this.setTime(+l[0]||0)):(this.clockType="free",this.setHands(+l[0]||0,+l[1]||0,+l[2]||0))}setTime(t){this.seconds=t;let e=t%60,s=t/60%60,n=t/3600%12;this.setHands(n,s,e)}setHands(t,e,s){this.time=[t%12,e%60,s%60],this.$hands[2].setTransform(void 0,Math.round(s)/60*xt),this.$hands[1].setTransform(void 0,e/60*xt),this.$hands[0].setTransform(void 0,t/12*xt),this.value=ct(t,12)+ct(e,60)/60+ct(s,60)/3600}updateOptions(){let t=this.showSeconds?"1":"0";this.clockType==="live"?this.options=`l:${t}`:this.clockType==="geared"?this.options=`g:${t}:${this.seconds}`:this.options=`f:${t}:${this.time[0]}:${this.time[1]}:${this.time[2]}`}delete(){var t;(t=this.animation)==null||t.cancel,super.delete()}getPointerAngle(t){return this.relativePosn(t).angle()+h0}handleMoveHand(t,e){this.currentAngle=this.getPointerAngle(e)%xt,this.prevAngle/xt>.75?this.currentAngle/xt<.25&&(this.currentAngle+=xt):this.prevAngle/xt<.25&&this.currentAngle/xt>.75&&(this.currentAngle-=xt);let s=(this.currentAngle-this.prevAngle)/xt;if(this.clockType==="geared"){let n=s*(t==="hours"?43200:t==="minutes"?3600:60);this.setTime(this.seconds+n)}else if(this.clockType==="free"){let[n,r,o]=this.time;t==="hours"?n+=s*12:t==="minutes"?r+=s*60:o+=s*60,this.setHands(n,r,o)}this.currentAngle>=xt?this.currentAngle-=xt:this.currentAngle<0&&(this.currentAngle+=xt),this.prevAngle=this.currentAngle}setColour(t){super.setColour(t),this.$border.setAttr("fill",A(t)),this.$ticks.setAttr("stroke",A(t)),this.$hands[2].css("fill",A(t))}toggleSecondsVisible(){this.$hands[2].toggle(!this.showSeconds),this.showSeconds=!this.showSeconds,this.updateOptions()}static action(t,e){if(t==="toggleSeconds"){for(let s of e)s.toggleSecondsVisible();e[0].$parent.change({changed:e})}}static makeThumbnail(t,e){let s=c("svg",{width:80,height:80,viewBox:"-80 -80 160 160"},e),n=e.data.colour,[r,o,...a]=uu(s,75);r.removeClass("polygon-tile"),r.setAttr("fill",n),o.setAttr("stroke",n),a[2].css("fill",n),a[2].setTransform(void 0,57/60*xt),a[1].setTransform(void 0,37/60*xt),a[0].setTransform(void 0,2.62/12*xt)}};var du='<h3>Number Line</h3><label class="row"><div class="label">Start:</div><input class="input-field" type="number" :bind="start"></label><label class="row"><div class="label">Step Size:</div><input class="input-field" type="number" :bind="step" min="0"></label><label class="row"><div class="label">Width:</div><input class="input-field" type="number" :bind="size" min="1" max="25"></label><label class="row"><div class="label">Divisions:</div><input class="input-field" type="number" :bind="minor" min="1" max="25"></label>';var Os=25,ha=class extends S{constructor(t,e,s){super(e,s);this.type="number-line";this.$el.addClass("number-line"),this.$fill=c("path",{fill:"transparent"},this.$el),this.$lines=c("path",{class:"number-line-ticks"},this.$el),this.$labels=c("g",{},this.$el),this.setColour(f.darkGrey);let[n,r,o,a,l]=t.split(":").map(p=>+p),h={start:n,step:r,width:o,size:a,minor:l},d=e.bindSettingsPanel(this,du,h);this.$start=this.makeHandle("h",p=>{let m=T(Math.round(p.x/Os/d.size),d.width-100,d.width-1);!m||(this.setTransform(this.posn.rotate(-Tr(this.rot)).shift(m*Os*d.size,0).rotate(Tr(this.rot))),d.width-=m,d.start=Ft(d.start+m*d.step,5))}),this.$start.setTransform({x:-Os,y:-2.5},Math.PI),E.isSafari&&this.$start.hide(),this.$end=this.makeHandle("h",p=>{let m=p.x/Os/d.size;d.width=T(Math.round(m),1,100)}),d.watch((p,m)=>{d.start=Ft(d.start,4),d.step=Ft(d.step,4),d.size=Math.round(d.size),d.minor=Math.round(d.minor),this.setDimensions(d,m)})}setDimensions({start:t,step:e,width:s,size:n,minor:r},o=!1){let a=`${t}:${e}:${s}:${n}:${r}`;if(a===this.options)return;this.options=a,this.$labels.removeChildren(),n*=Os;let l=`M0 10L${s*n} 10`;for(let h=0;h<=s*r;h+=1){let d=h*n/r,p=!(h%r),m=rt(t+h*e/r,4);l+=`M${d} ${p?0:5}L${d} ${p?20:15}`,p&&c("text",{text:m,x:d,y:40},this.$labels)}this.$lines.setAttr("d",l),this.$end.setTransform({x:s*n,y:-2.5}),this.linePoints=D(h=>new u(h*n/r,10),s*r+1),this.line=new j(new u(0,10),new u(s*n,10)),this.path=new $(new u(0,-2.5),s*n,25),this.$fill.draw(this.path),this.transform(),this.$parent.selection.update(),o||this.$parent.change({changed:[this]})}getSnapPoints(){return this.linePoints}getSnapLines(){return[this.line]}customTransform(){if(!E.isSafari)for(let t of this.$labels.children)t.css("transform",`rotate(${-this.rot}deg)`)}setColour(t){super.setColour(t.slice(0,7)),this.$lines.setAttr("stroke",A(this.colour)),this.$labels.setAttr("fill",A(this.colour))}static makeThumbnail(t,e){let s=c("svg",{width:240,height:40,class:"number-line"},e),n="M20 10L220 10";for(let r=0;r<=10;r+=1){let o=20+r*20;n+=`M${o} 5L${o} 15`,c("text",{text:r,x:o,y:30},s)}c("path",{d:n,class:"number-line-ticks"},s)}};var u0=3,d0=.15;function pu(i,t,e,s=!1){let n=t||i,r=e||i,o=Math.atan2(r.y-n.y,r.x-n.x)+(s?Math.PI:0),a=u.distance(n,r)*d0;return i.shift(Math.cos(o)*a,Math.sin(o)*a)}function p0(i){return i.length<=2?oe(new Ye(...i)):i.map((t,e)=>{if(e===0)return`M${t.x.toFixed(2)} ${t.y.toFixed(2)}`;if(u.distance(i[e-1],t)<4)return`L${t.x.toFixed(2)},${t.y.toFixed(2)}`;let s=pu(i[e-1],i[e-2],t),n=pu(t,i[e-1],i[e+1],!0);return`C${s.x.toFixed(2)},${s.y.toFixed(2)} ${n.x.toFixed(2)},${n.y.toFixed(2)} ${t.x.toFixed(2)},${t.y.toFixed(2)}`}).join("")}var pe=class{constructor(t,e,s,n,r){this.$parent=t;this.brush=n;this.path="";this.$el=c("path",{class:`stroke ${n}`},t.$strokes),this.setColor(s),this.id=r||Ae(10),t.strokes.set(this.id,this),e.length===1&&e.push(e[0].shift(.01)),this.draw(e)}setColor(t){this.color=t,this.$el.setAttr("stroke",A(t))}addPoint(t){this.segments.push(new j(I(this.segments).p2,t)),this.path+=`L${t.x},${t.y}`,this.$el.setAttr("d",this.path)}setLine(t){this.segments=[t],this.path=oe(t),this.$el.setAttr("d",this.path)}makeSnapPoints(){this.snapPoints=Ws(...this.segments.map(t=>[t.p1,t.p2])),this.snapLines=this.segments}simplify(){let t=this.segments.map(n=>n.p1);t.push(I(this.segments).p2);let e=[t[0]],s=0;for(let n=2;n<t.length;++n){let r=new j(I(e),t[n]);t.slice(s+1,n).every(a=>r.contains(a,u0))||(e.push(t[n-1]),s=n-1)}e.push(I(t)),this.draw(e)}draw(t){this.path=p0(t),this.segments=new Ye(...t).edges,this.$el.setAttr("d",this.path)}hitTest(t,e){let s=e**2;return this.segments.some(n=>n.distanceSquared(t)<s)}delete(){this.$parent.strokes.delete(this.id),this.$el.remove()}serialize(t=Infinity){return{points:this.path.slice(0,t),colour:this.color,brush:this.brush,id:this.id}}get lastSavedData(){return this.serialize()}static unSerialize(t,e){let s=Je(t==null?void 0:t.points);if(!s.length)return;let n=new pe(e,s,t.colour||"#000",t.brush||"",t.id);return s.length===2&&n.makeSnapPoints(),n}};var fu='<g class="leg-pin" style="transform-origin:bottom right"><polygon points="0,-21 -7,-21 0,0" fill="#3a3645"></polygon><path d="M-23.9-375H0v354h-7l-17-19v-335H-23.9z" fill="#d6d4db"></path></g><g class="pencil"><rect class="leg-pencil" x="0" y="-375" width="24" height="307" style="transform-box:fill-box;transform-origin:bottom center" fill="#d6d4db"></rect><g><path d="M72-48c-0.5,0-3,5-3,5H39c0,0-2.5-5-3-5v-106h36C72-154,72-48,72-48z"></path><rect x="47" y="-154" width="14" height="111" fill="#000" opacity="0.3"></rect><path d="M37.4-47.3l2.2,2.6c0.4,0.5,1,0.8,1.6,0.8c0.5,0,1-0.2,1.4-0.6l2.8-3.9c0.9-0.8,2.3-0.9,3.3-0.2l3.6,3.2c1,0.8,2.4,0.8,3.4,0l3.6-3.2c1-0.7,2.4-0.6,3.3,0.2l2.8,3.9c0.4,0.4,0.9,0.6,1.4,0.6c0.6,0,1.2-0.3,1.6-0.8l2.2-2.6c0.3-0.4,0.8-0.7,1.4-0.7L61.4-19.6c-4.8-1.9-10-1.9-14.8,0L36-48C36.6-48,37.1-47.7,37.4-47.3z" fill="#f7eecb"></path><path d="M46.6-19.6c4.8-1.9,10-1.9,14.8,0L54,0L46.6-19.6z"></path></g><path d="M81-56H15c-1.7,0-3-1.3-3-3v-18c0-1.7,1.3-3,3-3h66c1.7,0,3,1.3,3,3v18C84-57.3,82.7-56,81-56z" fill="#d6d4db"></path><circle cx="12" cy="-68" r="16" fill="#d6d4db"></circle><circle cx="12" cy="-68" r="9" fill="#3a3645"></circle></g><g class="top"><path d="M19-422H9v-25c0-2.8-2.2-5-5-5h-8c-2.8,0-5,2.2-5,5v25h-10c-2.8,0-5,2.2-5,5l0.1,42l9.2,19.2c0.4,1,1.4,4,4,4h21.7c2.7,0,3.7-3,4.1-4L24-375v-42C24-419.8,21.8-422,19-422z" fill="#3a3645"></path><circle cy="-386" r="9" fill="#d6d4db"></circle></g>';var at=50,mu=75,Ls=class extends S{constructor(t,e,s){super(e,s);this.canRotate=!1;this.canDragToSelect=!1;this.$el.addClass("utensil"),this.width=+t,this.absoluteEnd=new u(this.width,0),this.setup(),this.$handles=[0,1].map(n=>this.makeHandle("c",(r,o)=>{var h;let a=n?this.posn:this.absoluteEnd,l=(h=this.$parent.snap([o]))==null?void 0:h.shift;o=l?o.add(l):o.snap(a,10),u.distance(o,a)<mu&&(o=new _(a,mu).project(o)),n?this.absoluteEnd=o:this.posn=o,this.rot=this.absoluteEnd.angle(this.posn)*nt,this.width=this.absoluteEnd.subtract(this.posn).length,this.update(),this.transform()})),this.update(),this.setOrder("front")}flip(){super.flip(),this.update(),this.transform()}moveEnd(){this.absoluteEnd=new u(this.width,0).rotate(this.rot/nt).add(this.posn)}update(){this.options=""+this.width,this.$handles[1].setCenter({x:this.width,y:0})}},f0=["ruler","protractor","set-triangle","compass"];function gu(i){return f0.includes(i.type)}var ca=class extends Ls{constructor(){super(...arguments);this.type="ruler"}setup(){this.$glass=c("rect",{x:-20,height:60,class:"glass",rx:5},this.$el),this.$ticks=c("path",{class:"ticks"},this.$el),this.$labels=D(t=>c("text",{text:t,y:31},this.$el),31)}update(){this.path=new j(y,new u(this.width,0)),this.flipped&&(this.path=new j(this.path.p2,y));let t=this.path.length+.1;this.$glass.setAttr("width",t+40);let e="";for(let s=0;s<=t;s+=at/10){let n=s%at?s%(at/2)?0:1:2;e+=`M${this.flipped?this.width-s:s} 0V${[10,15,20][n]}`}this.$ticks.setAttr("d",e);for(let[s,n]of this.$labels.entries())n.toggle(s<=t/at),n.setAttr("x",this.flipped?this.width-at*s:at*s);super.update()}getSnapPoints(){let t=this.path.length;return D(e=>this.path.at(e*at/t),t/at)}getSnapLines(){return[this.path]}static action(t,e){if(t==="flip")for(let s of e)s.flip();e[0].$parent.change({changed:e})}};function m0(i){return`M0-${i}A${i},${i},0,0,0-${i},0V3a5,5,0,0,0,5,5H${i-5}a5,5,0,0,0,5-5V0A${i},${i},0,0,0,0-${i}Z`}var ua=class extends Ls{constructor(){super(...arguments);this.type="protractor"}setup(){this.$glass=c("path",{d:"",class:"glass"},this.$el),this.$ticks=c("path",{class:"ticks"},this.$el),this.$labels=D(t=>c("text",{text:t*10},this.$el),19)}update(){let t=this.width;this.path=new We(y,new u(-this.width,0),Math.PI),this.$glass.setAttr("d",m0(t));let e="",s=this.width<100?5:1;for(let n=0;n<=180;n+=s){let r=!(n%10),o=u.fromPolar(-n*F),a=t-(r?30:20);e+=`M${o.x*t} ${o.y*t}L${o.x*a} ${o.y*a}`,r&&(e+=`M${o.x*8} ${o.y*8}L${o.x*(t-50)} ${o.y*(t-50)}`)}this.$ticks.setAttr("d",e);for(let[n,r]of this.$labels.entries()){let o=t>160||!(n%3);r.toggle(o),!!o&&(r.setAttr("y",44-t),r.setAttr("transform",`rotate(${(this.flipped?-1:1)*(90-10*n)})`))}super.update()}getSnapPoints(){return[y,this.path.start,this.path.at(.5),this.path.end]}getSnapLines(){return[]}},da=234,Xn=150;function g0(i){let t=i<Xn?i/(Xn/(da/6)):i<da?da/6:i/6,e=t+t*Math.SQRT2;return`M0,0 H${i} L0,${-i} V0 M${t},${-t} H${i-e} L${t},${-i+e} V${t},${-t}`}var pa=class extends Ls{constructor(){super(...arguments);this.type="set-triangle"}setup(){this.$glass=c("path",{d:"","fill-rule":"evenodd",class:"glass"},this.$el),this.$ticks=c("path",{class:"ticks"},this.$el),this.$hLabels=D(t=>c("text",{text:t,y:-23},this.$el),31),this.$hLabels[0].hide(),this.$vLabels=D(t=>c("text",{text:t,x:25,"dominant-baseline":"central"},this.$el),31),this.$vLabels[0].hide()}update(){this.path=new P(y,new u(this.width,0),new u(0,-this.width)),this.$glass.setAttr("d",g0(this.width));let t=this.width-50,e="",s=2,n=1;for(let r=0;r<=t;r+=at/10){let o=r%at?r%(at/2)?0:n:s,a=r<10?-10*(r/10):[-10,-15,-20][o];e+=`M${r} 0V${a}`}for(let r=0;r<=t;r+=at/10){let o=r%at?r%(at/2)?0:n:s,a=r<10?10*(r/10):[10,15,20][o];e+=`M0,${-r} H${a}`}this.$ticks.setAttr("d",e);for(let[r,o]of this.$hLabels.entries())r>0&&o.toggle(this.width>=Xn&&r<t/at),o.setAttr("x",at*r);for(let[r,o]of this.$vLabels.entries())r>0&&o.toggle(this.width>=Xn&&r<t/at),o.setAttr("y",at*-r);super.update()}getSnapPoints(){let t=this.width,e=new j(y,new u(this.width,0)),s=new j(y,new u(0,-this.width)),n=D(o=>e.at(o*at/t),t/at),r=D(o=>s.at(o*at/t),t/at);return n.concat(r)}getSnapLines(){return[this.path]}},Yn=375,Jn=new u(54,68),fa=class extends Ls{constructor(){super(...arguments);this.type="compass"}setup(){this.$el.html=fu,this.$pencil=this.$el.$(".pencil"),this.$top=this.$el.$(".top"),this.$legPin=this.$el.$(".leg-pin"),this.$legPencil=this.$el.$(".leg-pencil"),this.setColour(f.red);let t,e=0;this.$parent.events.listen(this.$pencil.$("g"),{start:s=>{let n=new u(this.width,0).rotate(this.rot/nt).add(this.posn);t=new pe(this.$parent,[n],this.colour,"pen"),e=s.posn.angle(this.posn)*nt-this.rot;for(let r of this.$handles)r.setAttr("hidden",!0)},move:s=>{this.rot=s.posn.angle(this.posn)*nt-e,this.transform();let n=u.fromPolar(this.rot/nt,this.width).add(this.posn);t.addPoint(n)},end:()=>{this.$parent.change({added:[t],changed:[this]}),t=void 0;for(let s of this.$handles)s.removeAttr("hidden")}})}setColour(t){super.setColour(t),this.$pencil.css("fill",this.colour)}update(){this.width>730&&(this.width=730);let t=this.width-Jn.x,e=Yn-Jn.y,s=new _(y,Yn),n=new _(new u(t,-Jn.y),e),r=It(s,n)[0],o=Math.acos(r.x/Yn),a=Math.acos((t-r.x)/e);this.$legPin.setTransform(void 0,-o+Math.PI/2),this.$legPencil.setTransform(void 0,a-Math.PI/2),this.$pencil.setTransform({x:this.width-Jn.x,y:0}),this.$top.setTransform({x:r.x,y:Yn+r.y}),this.path=new _(y,this.width),super.update()}getSnapPoints(){return[y,new u(this.width,0)]}};var fe=50,w0=["chart","pie-chart","box-whisker"],ma=class extends S{constructor(t,e,s){super(e,s);this.type="table";this.size=0;this.$handles=[];this.$cells=[];this.focussed=!1;this.timeout=0;this.rows=3;this.cols=2;this.data=[["x","y"],["",""],[""],[""]];this.columnWidths=[];this.selection={startRow:0,startCol:0,endRow:0,endCol:0};this.options=t,t&&this.initializeData(),this.$foreignObject=c("foreignObject",{x:this.posn.x,y:this.posn.y,width:1,height:1,overflow:"visible"},this.$el),this.$table=c("div",{xmlns:"http://www.w3.org/1999/xhtml",class:"table-tile"},this.$foreignObject),this.$outline=c("path",{class:"outline"},this.$el),this.$selectionOutline=c("rect",{class:"table-selection",hidden:!0,rx:2},this.$el),e.events.listen(this.$el,{down:n=>{this.findSelection(this.relativePosn(n.posn)),this.$hidden.focus()},move:n=>{let r=this.relativePosn(n.startPosn),o=this.relativePosn(n.posn);this.findSelection(r,o)},click:n=>this.focusCell(this.findCellAt(this.relativePosn(n.posn))),blurInput:!1,checkIfActive:()=>this.focussed}),this.$hidden=c("textarea",{class:"table-hidden"},this.$parent),this.$hidden.on("blur",n=>{var r;((r=R(n.relatedTarget))==null?void 0:r.hasClass("table-cell"))||this.blur()}),this.$hidden.on("paste",n=>{var r;n.preventDefault(),this.paste(((r=n.clipboardData)==null?void 0:r.getData("text").trim())||"")}),this.$hidden.on("cut copy",n=>{var o;let r=this.getSelectionContents();r&&((o=window.navigator.clipboard)==null||o.writeText(r)),n.type==="cut"&&this.removeSelectionContents()}),this.$hidden.onKeyDown("escape",n=>{n.stopPropagation(),this.$hidden.blur(),this.$parent.selection.add(this)}),this.$hidden.onKeyDown("enter",n=>{n.preventDefault(),this.moveDown(!0)}),this.$hidden.onKeyDown("tab",n=>{n.preventDefault(),this.moveRight()}),this.$hidden.onKeyDown("backspace",n=>{n.stopPropagation(),this.removeSelectionContents()}),this.$handles[0]=this.makeHandle("h",n=>this.updateCols(n.x)),this.$handles[1]=this.makeHandle("v",n=>this.updateRows(n.y)),this.$handles[1].css("cursor","ns-resize"),this.setColour("#bbb"),this.buildTable()}setColour(t){this.colour=t,this.$table.css("border-color",t);for(let s of this.$cells)s.css("border-color",t);let e=V.mix(t,"#fff",.6);this.$table.css("background",e.rgb),this.$table.setClass("contrast",e.brightness<128)}updateOutline(){let t=I(this.columnWidths),e=this.rows*fe;this.$foreignObject.setAttr("width",t||1),this.$foreignObject.setAttr("height",e||1);let s=new $(y,t,e);this.$outline.draw(s),this.path=s.shift(.5),this.$handles[0].setTransform({x:t,y:0}),this.$handles[1].setTransform({x:0,y:e})}initializeData(){this.data=Be(this.options,[[""],[""]]),this.rows=this.data.length,this.cols=this.data[0].length}updateCols(t){let e=I(this.columnWidths),s=this.columnWidths[this.columnWidths.length-2]||0;t>e+fe?(this.cols+=1,this.buildTable()):this.cols>1&&t<s+fe&&(this.cols-=1,this.buildTable())}updateRows(t){let e=T(Math.round(t/fe),1,100);e!==this.rows&&(this.rows=e,this.buildTable())}resizeColumns(){this.columnWidths=js(D(t=>this.$cells[t].width,this.cols)),this.drawSelection()}makeCell(){let t=this.$cells.length,e=c("div",{class:"table-cell",contenteditable:!0,"cell-index":t},this.$table);e.css("border-color",this.colour),this.$cells.push(e);let s=!1;e.on("focus",()=>s=!0),e.on("pointerdown",r=>{s&&r.stopPropagation()}),e.on("blur",r=>{s=!1,this.data[this.cellPosn(e)[0]][this.cellPosn(e)[1]]=e.text,this.updateData();let o=R(r.relatedTarget);!(o==null?void 0:o.hasClass("table-cell"))&&!(o==null?void 0:o.hasClass("table-hidden"))&&this.blur()});let n=e.width;e.on("change keyup input",()=>{let r=n;n=e.width,r!==n&&this.resizeColumns()}),e.on("paste",r=>{var a;let o=((a=r.clipboardData)==null?void 0:a.getData("text").trim())||"";(o.includes(`
`)||o.includes("	"))&&(r.preventDefault(),this.paste(o))}),e.onKeyDown("escape",r=>{r.stopPropagation(),e.blur(),this.$parent.selection.add(this)}),e.onKeyDown("enter",r=>{r.preventDefault(),this.$parent.events.shiftKey?this.moveUp():this.moveDown(!0)}),e.onKeyDown("tab",r=>{r.preventDefault(),this.$parent.events.shiftKey?this.moveLeft():this.moveRight()})}cellPosn(t){let e=parseInt(t.attr("cell-index"));return[Math.floor(e/this.cols),e%this.cols]}buildTable(){this.$table.css("grid-template-columns",`repeat(${this.cols}, max-content)`);let t=this.cols*this.rows;for(let e=this.$cells.length;e<t;++e)this.makeCell();for(let e=t;e<this.$cells.length;++e)this.$cells[e].hide();for(let e=0;e<this.rows;++e)for(let s=0;s<this.cols;++s){this.data[e]||(this.data[e]=[]),this.data[e][s]||(this.data[e][s]="");let n=this.$cells[e*this.cols+s];n.show(),n.text=this.data[e][s],n.setClass("header",!e)}this.resizeColumns(),this.updateOutline(),this.$parent.selection.update(),this.makeOutPort("main",{tileTypes:w0,location:new u(I(this.columnWidths),this.rows*fe/2),connect:e=>e.enqueueMessage({type:"table",table:this.rawData})}),this.transform(),this.updateData()}paste(t){let[e,s]=[this.selection.startRow,this.selection.startCol],n=t.trim().split(`
`).map(r=>r.split("	"));this.rows=Math.max(this.rows,e+n.length),this.cols=Math.max(this.cols,s+Math.max(...n.map(r=>r.length)));for(let r=0;r<n.length;++r)for(let o=0;o<n[r].length;++o)this.data[e+r]||(this.data[e+r]=[]),this.data[e+r][s+o]=n[r][o];this.updateSelection(s,e,s+n[0].length-1,e+n.length-1),this.buildTable()}moveLeft(){let[t,e]=[this.selection.startRow,this.selection.startCol];this.focusCell(this.$cells[t*this.cols+e-1]||this.$cells[this.$cells.length-1])}moveRight(){let[t,e]=[this.selection.startRow,this.selection.startCol];this.focusCell(this.$cells[t*this.cols+e+1]||this.$cells[0])}moveUp(){let[t,e]=[this.selection.startRow,this.selection.startCol],s=t===0?this.rows:t;this.focusCell(this.$cells[(s-1)*this.cols+e])}moveDown(t=!0){let[e,s]=[this.selection.startRow,this.selection.startCol];t&&this.rows<=e+1&&(this.data[e][s]=this.$cells[e*this.cols+s].text,this.rows+=1,this.buildTable()),this.focusCell(this.$cells[(e+1)*this.cols+s])}click(t){let e=Date.now();e-this.timeout<500&&(this.focus(),this.focusCell(this.findCellAt(this.relativePosn(t.posn)))),this.timeout=e}focus(){this.focussed||(this.focussed=!0,this.initialOptions=this.options,this.$parent.options.focussed=this,this.$table.addClass("active"),this.$parent.selection.clear(),this.$selectionOutline.show())}findCellAt(t){let e=this.columnWidths.findIndex(n=>n>t.x),s=Math.floor(t.y/fe);return this.$cells[this.cols*s+e]}focusCell(t){var r,o;let[e,s]=this.cellPosn(t);this.updateSelection(s,e),t.focus();let n=document.createRange();n.selectNodeContents(t._el),(r=document.getSelection())==null||r.removeAllRanges(),(o=document.getSelection())==null||o.addRange(n)}blur(){!this.focussed||(this.focussed=!1,this.$parent.options.focussed=void 0,this.$table.removeClass("active"),this.$selectionOutline.hide(),this.updateData(),this.updateOutline(),this.transform(),this.$parent.selection.add(this),this.initialOptions!==this.options&&this.$parent.change({changed:[this]}))}get rawData(){return this.data.slice(0,this.rows).map(t=>t.slice(0,this.cols))}updateData(){let t=this.rawData;this.options=JSON.stringify(t),this.initialOptions!==this.options&&this.emitMessage("main",{type:"table",table:t})}findSelection(t,e=t){let s=Math.floor(Math.min(t.y,e.y)/fe),n=Math.ceil(Math.max(t.y,e.y)/fe)-1,r=this.columnWidths.findIndex(a=>a>Math.min(t.x,e.x)),o=this.columnWidths.findIndex(a=>a>Math.max(t.x,e.x));o<0&&(o=this.cols),this.updateSelection(r,s,o,n)}updateSelection(t,e,s=t,n=e){var r,o,a,l;t=T(t,0,this.cols-1),s=T(s,t,this.cols-1),e=T(e,0,this.rows-1),n=T(n,e,this.rows-1),!(((r=this.selection)==null?void 0:r.startRow)===e&&((o=this.selection)==null?void 0:o.endRow)===n&&((a=this.selection)==null?void 0:a.startCol)===t&&((l=this.selection)==null?void 0:l.endCol)===s)&&(this.selection={startCol:t,startRow:e,endCol:s,endRow:n},this.drawSelection())}drawSelection(){if(!this.selection)return;let t=this.columnWidths[this.selection.startCol-1]||0,e=new u(t,this.selection.startRow*fe),s=this.columnWidths[this.selection.endCol]-t||0,n=(this.selection.endRow+1-this.selection.startRow)*fe;this.$selectionOutline.setRect(new $(e,s+1,n+1))}getSelectionContents(){let t="",e=this.selection;if(!e)return t;for(let s=e.startRow;s<=e.endRow;++s){for(let n=e.startCol;n<=e.endCol;++n)n>e.startCol&&(t+="	"),t+=this.data[s][n];t+=`
`}return t}removeSelectionContents(){let t=this.selection;if(!!t)for(let e=t.startRow;e<=t.endRow;++e)for(let s=t.startCol;s<=t.endCol;++s)this.data[e][s]="",this.$cells[e*this.cols+s].text=""}static action(t,e){return O(this,null,function*(){if(t==="transpose"){for(let s of e){for(let n=0;n<s.data.length;n++)for(let r=0;r<n;r++)[s.data[n][r],s.data[r][n]]=[s.data[r][n],s.data[n][r]];[s.rows,s.cols]=[s.cols,s.rows],s.updateData(),s.buildTable()}e[0].$parent.change({changed:e})}})}static makeThumbnail(t,e){let s=c("svg",{width:110,height:85},e),n=(r,o,a,l,h,d="")=>{c("rect",{x:5+r,y:5+o,width:a,height:l,fill:h,class:"polygon-tile"},s),d&&c("text",{x:25+5/2+r,y:25-5/2+o,text:d,fill:"white"},s)};for(let r=0;r<2;++r)for(let o=0;o<3;++o)n(50*r,25*o,50,25,o?"#ffffff33":"#ffffff66",o?"":r?"y":"x")}};var y0="M7,4,2.3-.3,6.6-5a1.2,1.2,0,0,0,0-1.5l-.4-.3a1,1,0,0,0-1.4,0L0-2.5-4.8-6.8a1,1,0,0,0-1.4,0l-.4.3A1.2,1.2,0,0,0-6.6-5L-2.3-.3-7,4a1.1,1.1,0,0,0-.1,1.4l1.5,1.4a.9.9,0,0,0,1.3,0L0,2.1,4.3,6.8a.9.9,0,0,0,1.3,0L7.1,5.4A1.1,1.1,0,0,0,7,4Z",wu="M7.7-5.7l-.2-.4-.3-.2c-.1-.1-.3,0-.4,0A36.6,36.6,0,0,0-3,2.1,36.1,36.1,0,0,0-7.8-.8h-.5l-1,.9a.4.4,0,0,0-.1.3c0,.2,0,.3.1.4a72.1,72.1,0,0,1,6.6,7h.4l.4-.2C1.9,1,3.8-1.8,7.5-5.2,7.7-5.3,7.7-5.5,7.7-5.7Z",yu={fill:"none",style:"touch-action: none",stroke:f.green},vu=class{constructor(t){this.$el=c("g",{});this.$ring=c("circle",ne({opacity:.6},yu),this.$el);this.$burst=c("path",yu,this.$el);this.$mark=c("g",{class:"problem-marker"},this.$el);this.$circle=c("circle",{r:13},this.$mark);this.$cross=c("path",{d:y0,fill:"white"},this.$mark);this.$check=c("path",{d:wu,fill:"white"},this.$mark);this.isAnimating=!1;t.append(this.$el)}show(t=!1,e=!0){this.$cross.toggle(!t),this.$check.toggle(t),this.$circle.setAttr("fill",t?f.green:f.red),this.$mark.addClass("show"),e&&t&&this.burst()}hide(){this.$mark.removeClass("show")}burst(t=1e3,e=60,s=20){return O(this,null,function*(){this.isAnimating||(this.isAnimating=!0,yield z(n=>{let r=Y("sine-out",n);this.$ring.setAttr("r",.6*r*e),this.$ring.setAttr("stroke-width",.25*(1-r)*e);let o=Y("exp-out",n),a=(.4+.6*o)*e,l=(.1+.9*o)*e,h="";for(let d=0;d<s;++d){let p=Math.cos(Math.PI*2*d/s),m=Math.sin(Math.PI*2*d/s);h+=`M${p*l} ${m*l}L${p*a} ${m*a}`}this.$burst.setAttr("d",h)},t).promise,this.isAnimating=!1)})}},Is=class extends S{constructor(t,e,s){super(e,s);this.type="question-blank";this.size=100;this.canRotate=!1;this.solution="";this.submitted="";this.attempts=0;this.correct=!1;this.focussed=!1;this.options=t||"Pw::0";let[n,r,o]=this.options.split(":");this.solution=atob(n),this.submitted=r,this.attempts=+o||0,this.$box=c("rect",{class:"problem-box",rx:6},this.$el),this.$text=c("text",{class:"problem-text",text:this.text,y:36},this.$el),this.mark=new vu(this.$el),this.$input=c("input",{class:"problem-text"},e.$html),this.$input.onKeyDown("enter",()=>this.$input.blur()),this.$input.on("blur",()=>this.blur()),this.$parent.options.canEditQuestions?(this.$handle=this.makeHandle("c",a=>this.setSize(a.x)),this.$handle.css("cursor","ew-resize")):(this.$input.setInputPattern(this.solution),this.checkAnswer(!1),this.canMove=!1),this.setSize(100),this.setOrder("front")}setSize(t){var e;super.setSize(K(T(t,50,400),25)),this.path=new $(y,this.size,50),this.$input.css({width:this.size+"px",height:"50px"}),this.$box.setRect(this.path),this.$text.setAttr("x",this.size/2),this.mark.$el.setTransform({x:this.size,y:0}),(e=this.$handle)==null||e.setCenter({x:this.size,y:50}),this.transform()}delete(){super.delete(),this.$input.remove()}get text(){return(this.$parent.options.canEditQuestions?this.solution:this.submitted)||"?"}click(){this.focussed||this.$parent.events.shiftKey||this.correct&&!this.$parent.options.canEditQuestions||(this.focussed=!0,this.$parent.selection.add(this,!0),setTimeout(()=>{this.$el.removeClass("correct incorrect"),this.mark.hide()}),this.$input.css({top:this.posn.y+"px",left:this.posn.x+"px"}),this.$input.value=this.text,this.$text.hide(),this.$input.show(),this.$input.focus(),document.execCommand("selectAll",!1))}blur(){if(!this.focussed)return;this.focussed=!1,this.$input.hide(),this.$text.show();let t=this.text,e=this.$input.value.trim();this.$parent.options.canEditQuestions?(this.solution=e,this.options=`${btoa(e)}::0`):(e&&e!==this.submitted&&(this.attempts+=1),this.submitted=e==="?"?"":e,this.options=`${btoa(this.solution)}:${e}:${this.attempts}`,setTimeout(()=>{this.checkAnswer(),Is.gradeWorksheet(this.$parent)})),this.$text.text=this.text,this.text!==t&&this.$parent.change({changed:[this]})}isCorrect(){if(!this.submitted||!this.solution)return!1;if(this.submitted.toLowerCase()===this.solution.toLowerCase())return!0;let t=yr(this.solution),e=yr(this.submitted);return b(e,t)||br(t)===this.submitted||this.solution===br(e)}checkAnswer(t=!0){this.correct=this.isCorrect(),this.submitted&&this.mark.show(this.correct,t),this.$el.setClass("correct",this.correct),this.$el.setClass("incorrect",!!this.submitted&&!this.correct)}static gradeWorksheet(t){let e=[0,0,0,0];for(let s of t.tiles.values())!s.is("question-blank")||(e[0]+=1,!!s.submitted&&(e[s.correct?s.attempts<=1?1:2:3]+=1));e[0]===e[1]+e[2]&&fn()}static makeThumbnail(t,e){let s=c("svg",{width:130,height:70},e);c("rect",{x:15,y:15,width:100,height:50,class:"problem-box",rx:6},s),c("text",{x:65,y:50,text:"?",class:"problem-text"},s),c("circle",{cx:115,cy:15,r:13,fill:f.blue},s),c("path",{d:wu,fill:"white",transform:"translate(115 15)"},s)}};var bu=qt(nn),ga=class extends S{constructor(t,e,s){super(e,s);this.type="image";this.path=new $(y,0,0);this.aspectRatio=1;this.options=t,this.$image=c("image",{href:t,crossorigin:"anonymous"},this.$el),this.$outline=c("path",{class:"outline"},this.$el),bu(t).then(n=>{this.aspectRatio=n.height/n.width,this.setSize(this.size||n.width)}),this.$handle=this.makeHandle("c",n=>this.setSize(n.x)),this.$handle.css("cursor","nwse-resize")}setHref(t){this.options=t,this.$image.setAttr("href",t),bu(t)}setSize(t){let e=Math.max(50,50*this.aspectRatio),s=Math.min(1e3,1e3/this.aspectRatio);this.size=T(t,e,s),this.$image.setAttr("width",this.size),this.$image.setAttr("height",this.aspectRatio*this.size),this.path=new $(y,this.size,this.aspectRatio*this.size),this.$outline.draw(this.path),this.$handle.setCenter({x:this.size,y:this.aspectRatio*this.size}),this.transform(),this.$parent.selection.update()}};var v0={bold:"font-weight",italic:"font-style",underline:"text-decoration",colour:"color"};function $u(i,t){return i.style.getPropertyValue(t)||""}function xu(i,t,e){i.style.setProperty(t,e)}function b0(i,t){t==="font-weight"||t==="font-style"?i.style.setProperty(t,"normal"):t==="text-decoration"?i.style.setProperty(t,"none"):i.style.removeProperty(t)}var wa=class extends S{constructor(t,e,s){super(e,s);this.type="text";this.size=0;this.focussed=!1;this.creating=!1;this.$box=c("rect",{fill:"transparent"},this.$el),this.$foreignObject=c("foreignObject",{x:this.posn.x,y:this.posn.y,width:1,height:1,overflow:"visible"},this.$el),this.$text=c("div",{class:"text-edit",style:"pointer-events: none",xmlns:"http://www.w3.org/1999/xhtml"},this.$foreignObject),this.$outline=c("path",{class:"outline"},this.$el),this.options=this.$text.html=t||"Text",this.setColour(e.penColour),this.setOrder("front"),this.updateOutline(),this.$text.on("pointerdown",n=>n.handled=!0),this.$text.onKeyDown("escape",n=>this.blur()),this.$text.on("blur",()=>this.blur())}setSize(t){super.setSize(T(t,-5,10)),this.$text.css("font-size",20*1.2**this.size+"px"),this.updateOutline()}setColour(t){if(this.focussed)return this.formatFont("color",t);this.colour=t,this.$text.css("color",A(this.colour))}getSnapPoints(){return[]}updateOutline(){let t=this.$text.width,e=this.$text.height;this.$foreignObject.setAttr("width",t||1),this.$foreignObject.setAttr("height",e||1),this.path=new $(y,t,e),this.$box.setRect(this.path),this.$outline.draw(this.path),this.transform()}selectAll(){let t=this.selection,e=document.createRange();e.selectNodeContents(this.$text._el),t==null||t.removeAllRanges(),t==null||t.addRange(e)}static action(t,e){return O(this,null,function*(){for(let s of Array.from(e))t==="smaller"||t==="larger"?s.setSize(t==="larger"?s.size+1:s.size-1):s.format(t);e[0].$parent.change({changed:Array.from(e)})})}format(t){this.formatFont(v0[t]||"",t),this.cleanupElements(this.$text._el.children),this.updateOutline(),this.options=this.$text.html}get selection(){var e,s;return(((s=(e=this.$el._el).getRootNode)==null?void 0:s.call(e))||document).getSelection()}formatFont(t,e){if(!this.focussed){let r=new Range,o=this.$text._el.childNodes;return r.setStartBefore(o[0]),r.setEndAfter(o[o.length-1]),this.formatRange(r,t,e)}let s=this.selection;if(!s)return;let n=[];for(let r=0;r<s.rangeCount;++r){let o=s.getRangeAt(r);this.formatRange(o,t,e),n.push(s.getRangeAt(r))}s.removeAllRanges();for(let r=0;r<n.length;++r)s.addRange(n[r])}formatRange(t,e,s){let n=t==null?void 0:t.extractContents().childNodes;if(!n)return;let r=t.commonAncestorContainer;(r==null?void 0:r.nodeName)==="#text"&&r.parentNode&&(r=r.parentNode),this.removeEmptyTextNodes(n),this.wrapChildrenInSpans(r,n,e),this.updateRangeChildren(n,e,s);for(let o=n.length-1;o>=0;--o)t.insertNode(n[o])}removeEmptyTextNodes(t){for(let e=0;e<t.length;e++){let s=t[e];s.nodeName==="#text"&&!s.nodeValue&&s.remove()}}wrapChildrenInSpans(t,e,s){for(let n=0;n<e.length;++n){let r=e[n];if(r.nodeName==="#text"){let o=document.createElement("span");t.nodeName==="SPAN"&&xu(o,s,$u(t,s)),o.appendChild(document.createTextNode(r.nodeValue||"")),r.replaceWith(o)}}}updateRangeChildren(t,e,s){if(s==="smaller"||s==="larger"){let n=t[0],r=parseFloat(n.style.fontSize)||100,o=(s==="smaller"?1/1.2:1.2)*r;this.setChildrenStyles(t,"font-size",o+"%")}else this.allChildrenHaveStyle(t,e,s)?this.unsetChildrenStyles(t,e):this.setChildrenStyles(t,e,s)}allChildrenHaveStyle(t,e,s){for(let n=0;n<t.length;++n){let r=t[n];if($u(r,e)!==s||!this.allChildrenHaveStyle(r.children,e,s))return!1}return!0}unsetChildrenStyles(t,e){for(let s=0;s<t.length;++s){let n=t[s];b0(n,e),this.unsetChildrenStyles(n.children,e)}}setChildrenStyles(t,e,s){for(let n=0;n<t.length;++n){let r=t[n];xu(r,e,s),this.clearChildrenStyles(r.children,e)}}clearChildrenStyles(t,e){for(let s=0;s<t.length;++s){let n=t[s];n.style.removeProperty(e),this.clearChildrenStyles(n.children,e)}}cleanupElements(t){for(let e=0;e<t.length;++e)this.cleanupElements(t[e].children);for(let e=0;e<t.length;++e)t[e].textContent||t[e].remove();for(let e=0;e<t.length;++e)t[e].getAttribute("style")||t[e].replaceWith(...Array.from(t[e].childNodes))}doubleClick(){this.focus()}focus(t=!1){this.focussed||(this.creating=t,this.focussed=!0,this.$parent.options.focussed=this,this.$parent.selection.clear(),this.$text.css("pointer-events","all"),this.$text.setAttr("contenteditable",!0),this.$text.focus(),this.selectAll())}blur(){var s;if(!this.focussed)return;this.focussed=!1,this.$parent.options.focussed=void 0,this.$text.css("pointer-events","none"),this.$text.removeAttr("contenteditable");let t=this.$text.html,e=this.options!==t;if(t){this.$text.show(),this.options=t,this.updateOutline();let n=this.creating?"added":"changed";(this.creating||e)&&this.$parent.change({[n]:[this]})}else this.delete(),this.creating||this.$parent.change({deleted:[this]});(s=this.selection)==null||s.removeAllRanges()}};var Tu={point:(i,t)=>i!==void 0&&t!==void 0?new u(i,t):void 0,line:(i,t)=>i&&t&&!i.equals(t)?new pt(i,t):void 0,segment:(i,t)=>i&&t&&!i.equals(t)?new j(i,t):void 0,circle:(i,t)=>i&&t?new _(i,t):void 0,polygon:(...i)=>i.every(t=>t)?new P(...i):void 0,triangle:(i,t,e)=>i&&t&&e?new kr(i,t,e):void 0,rectangle:(i,t,e)=>i?new $(i,t,e):void 0,distance:u.distance,intersections:It},ie=ke({});ie.assign(Tu);var _e=new Map,Rs=new Map,$0=/^_x[0-9]+\.at\([0-9-.e]+\)$/,x0=/^intersections\(|\.midpoint$|\.centroid$/,lt=class extends S{constructor(t,e,s){super(e,s,c("path",{class:"geo-path"},e.$geoPaths));this.$parent=e;this.type="geo";this.hideSelectionOutline=!0;this.isProjection=!1;this.parentKeys=[];this.deleted=!1;this.onDraw=()=>this.draw();this.$shadow=c("path",{class:"geo-shadow"},e.$geoShadows),this.options=t;let[n,r]=t.split("=");r||(r=n,n=ie.getKey()),this.key=n,_e.set(n,this),this.snapPoints=this.snapLines=this.snapAngles=[],this.setExpr(r),ie.watch(this.onDraw),this.setColour(e.penColour)}setExpr(t,e=!1){let s=Jt(t);ie.setComputed(this.key,s),!e&&(this.options=`${this.key}=${t}`,this.expr=t,this.setParentKeys(t.match(/_x[0-9]+/g)||[]),this.isProjection=$0.test(t),this.computed=x0.test(t),this.$el.setClass("intersection",this.computed))}draw(){let t=ie[this.key];if(t===this.path)return;this.path=t,this.$el.toggle(t&&!this.hidden),this.isActive&&!t&&this.$shadow.hide();let e=t==null?void 0:t.type;e!==this.geoType&&(this.$el.setClass("geo-point",e==="point"),this.$el.setClass("geo-path",e!=="point"),(e==="point"?this.$parent.$geoPoints:this.$parent.$geoPaths).append(this.$el),this.geoType=e),!!t&&(e==="point"&&(t=new _(t,this.computed?3.5:6)),this.$el.draw(t,{box:this.$parent.canvasBounds.rect}),this.$shadow.setAttr("d",this.$el.attr("d")),this.transform())}setParentKeys(t){var e;for(let s of this.parentKeys)(e=Rs.get(s))==null||e.delete(this.key);this.parentKeys=t;for(let s of t)Rs.has(s)||Rs.set(s,new Set),Rs.get(s).add(this.key)}get parents(){return this.parentKeys.map(t=>_e.get(t)).filter(t=>t)}get children(){let t=Rs.get(this.key);return t?Array.from(t).map(e=>_e.get(e)).filter(e=>e):[]}get ariaDescription(){var t;return`${(t=this.path)==null?void 0:t.type} ${this.key}: ${this.expr}`}setOrder(){}select(){var t;this.isActive=!0,this.path&&this.$shadow.show(),(t=this.$el.parent)==null||t.append(this.$el)}deselect(){this.isActive=!1,this.$shadow.hide()}hover(t=!0){this.isActive||!this.path||(t?this.$shadow.show():this.$shadow.hide())}transform(){this.transformed=this.path,this.pending||(this.snapPoints=this.path&&gt(this.path)?[this.path]:[],this.snapLines=!this.path||gt(this.path)?[]:[this.path])}setTransform(){this.transform()}setColour(t){var e,s;this.colour=t,(e=this.$el)==null||e.css("color",A(t)),(s=this.$shadow)==null||s.css("color",A(t))}copy(t={}){if(!this.path)return;if(t[this.key])return t[this.key];let e=this.expr;if(gt(this.path))e=`point(${this.path.x+25},${this.path.y+25})`;else for(let s of this.parents){let n=t[s.key]||s.copy(t);e=e.replace(s.key,n.key)}return t[this.key]=new lt(e,this.$parent)}delete(){this.deleted=!0,super.delete(),ie.unwatch(this.onDraw),ie[this.key]=void 0,_e.delete(this.key),this.$shadow.remove();for(let t of this.parents)t.geoType==="point"&&!t.deleted&&!t.parentKeys.length&&!t.children.length&&t.delete();for(let t of this.children)t.delete()}setPending(t=!0){this.pending=t,t||this.transform();for(let e of this.children)e.setPending(t)}moveStart(){if(!(this.computed||!this.path)){if(this.isProjection){if(this.$parent.selection.size>1)return;this.setParentKeys([])}this.setPending(!0);for(let t of this.parents)t.moveStart();this.moveStartValue=this.transformed}}move(t,e){if(!(!t||!this.path||!this.moveStartValue))if(gt(this.path))this.snapTarget=e,this.$el.setClass("intersection",this.computed||!!(e==null?void 0:e.intersection)),ie[this.key]=this.moveStartValue.translate(t);else for(let s of this.parents)s.move(t)}moveEnd(){var t,e,s,n;if(!!this.moveStartValue){for(let r of this.parents)r.moveEnd();if(this.setPending(!1),(t=this.snapTarget)==null?void 0:t.intersection)this.setExpr(this.snapTarget.intersection.expr);else if(((s=(e=this.snapTarget)==null?void 0:e.tile)==null?void 0:s.type)==="geo"){let r=(n=this.snapTarget)==null?void 0:n.tile;if(r.path&&gt(r.path)){for(let o of this.children)o.setExpr(o.expr.replace(this.key,r.key));return this.$parent.selection.add(r),this.delete()}else if(r.path){let o=wn(r.path,ie[this.key]);this.setExpr(`${r.key}.at(${o})`)}}else this.path&&gt(this.path)&&(this.expr=`point(${this.path.x},${this.path.y})`,this.options=`${this.key}=${this.expr}`,this.isActive||this.$parent.selection.implicitChanges.add(this))}}applyChange(t){let[e,s]=t.options.split("=");s!==this.expr&&this.setExpr(s),t.colour!==this.colour&&this.setColour(t.colour),!t.locked!=!this.locked&&this.lock(t.locked),this.lastSavedData=t}static get tiles(){return _e.values()}static computeIntersections(t){t.intersections.clear();let e=Array.from(_e.values()).filter(n=>n.path&&!gt(n.path)),s=e.length;for(let n=0;n<s;++n)for(let r=n+1;r<s;++r){let o=It(e[n].path,e[r].path);for(let[a,l]of o.entries())t.intersections.add({value:l,expr:`intersections(${e[n].key},${e[r].key})[${a}]`})}}static getInferredShape(t){let e=t.filter(l=>l.type==="geo"&&l.path);if(!e.length)return;if(e.length===1)return{type:e[0].path.type,expr:e[0].key,value:e[0].path};let s=e.filter(l=>gt(l.path)),n=e.filter(l=>At(l.path)||st(l.path));if(n.length===1&&s.length===e.length-1){let l=n[0].path;if(s.every(h=>l.contains(h.path)))return{type:l.type,expr:n[0].key,value:l}}let r=n.filter(l=>At(l.path));if(s.length+r.length!==e.length)return;for(let l of r)if(Ci(l.path)){let h=l.parentKeys.map(d=>_e.get(d));for(let d of h)s.includes(d)||s.push(d)}else if(s.filter(h=>l.path.contains(h.path)).length<2)return;let o=s.map(l=>l.key).join(","),a=s.map(l=>l.path);if(s.length===2){let l=new j(a[0],a[1]);return{type:"segment",expr:`segment(${o})`,value:l}}return s.length===3?{type:"triangle",expr:`triangle(${o})`,value:new kr(...a)}:{type:"polygon",expr:`polygon(${o})`,value:new P(...a)}}static construct(t,e,s){if(t=t.replace(/\$0/g,e||""),t.includes("$1"))s.tools.geoPending.enable(t);else{let n=new lt(t,s);s.selection.add(n,!0);let r=gt(n.path)?"pop":"draw";n.$el.enter(r,400),n.$shadow.enter(r,400),lt.computeIntersections(s),s.change({added:[n]})}}static redrawLines(t){for(let e of _e.values())e.path&&Vr(e.path)&&(e.$el.draw(e.path,{box:t}),e.$shadow.setAttr("d",e.$el.attr("d")))}static clearModel(){ie.clear(),ie.assign(Tu)}};function Et(i){return!!i.setValue}function Su(i,t){let e=i;for(let s of i.parents()){if(s.type in t&&s.children.indexOf(e)===t[s.type])return s;e=s}}function T0(i,t){for(let e of i.parents(!0))for(let s of t.parents(!0))if(e===s)return s}function Mu(i,t,e=!1){let s=e?i.children.slice(0).reverse():i.children,n=t.parent;return s.findIndex((r,o)=>n.hasParent(a=>a===r)||Et(n)&&n===r||i===n&&(e?s.length-o:o)===t.offset)}var ya=class{constructor(t){this.equation=t;this.offset=0;this.$el=c("line",{class:"cursor",hidden:!0},t.$row),this.$range=c("rect",{class:"range",hidden:!0}),t.$row.prepend(this.$range),this.parent=t.root}redraw(){let t=this.getRangeRect();if(this.$el.toggle(!t),this.$range.toggle(!!t),t)this.$range.setRect(t);else{this.selected=void 0;let e=this.getCursorLine();e&&this.$el.setLine(...e),this.$el.restartAnimation()}}hide(){this.$el.hide(),this.$range.hide(),this.clearRange()}startRange(){this.start={parent:this.parent,offset:this.offset}}clearRange(){this.selected=void 0,this.start=void 0}moveToPoint(t){let e=this.equation.root.hitTest(t)||this.equation.root,s=e.worldTransform,n=(t.x-s.x)/(e.width*s.scale);Et(e)?this.moveInto(e,Math.round(n*e.value.length)):n<.5?this.moveBefore(e):this.moveAfter(e)}getRangeRect(){if(!this.start||this.start.parent===this.parent&&this.start.offset===this.offset)return;let t=T0(this.parent,this.start.parent),e=[t];if(t.children.length){let s=Mu(t,this.start),n=Mu(t,this);n<s&&([s,n]=[n,s]),(s>0||n<t.children.length-1)&&(e=t.children.slice(s,n+1)),e.length||(e=[t]),(s<0||n<0)&&t.type==="mrow"&&t.parent&&(e=[t.parent]),e.length===1&&e[0].type==="mrow"&&(e=e[0].children.slice(0))}return this.selected=e,$.aroundPoints(Ti(e,s=>{let n=s.worldTransform;return[n,{x:n.x+s.width*n.scale,y:n.y+s.height*n.scale}]}))}getCursorLine(){let t=Et(this.parent)?this.parent:this.prev||this.next;if(!t)return;let e=t.worldTransform,s=t.height*e.scale,n=-1;return Et(this.parent)?n=t.width*e.scale*this.offset/t.value.length:this.prev&&(n=this.prev.width*e.scale+1),[{x:e.x+n,y:e.y+2},{x:e.x+n,y:e.y+s-2}]}moveAfter(t){if(t.type==="mrow")return this.moveAfter(I(t.children));if(!t.parent)throw new Error("Move cursor to unattached node");this.parent=t.parent,this.offset=this.parent.children.indexOf(t)+1}moveBefore(t){if(t.type==="mrow")return this.moveBefore(t.children[0]);if(!t.parent)throw new Error("Move cursor to unattached node");this.parent=t.parent,this.offset=this.parent.children.indexOf(t)}moveInto(t,e){if(Et(t)){if(e<=0)return this.moveBefore(t);if(e>=t.value.length)return this.moveAfter(t)}this.parent=t,this.offset=e}get prev(){return this.parent.children[this.offset-1]}get next(){return this.parent.children[this.offset]}handleShift(t,e=!1){if(t&&!this.selected)this.startRange();else if(!t&&this.selected)return e?this.moveBefore(this.selected[0]):this.moveAfter(I(this.selected)),this.clearRange(),!0;this.selected&&this.parent!==this.selected[0].parent&&this.moveAfter(I(this.selected))}left(t){if(this.handleShift(t,!0))return;if(this.selected)return this.offset-=1;if(Et(this.parent))return this.moveInto(this.parent,this.offset-1);let e=this.prev;if(e)return Et(e)?this.moveInto(e,e.value.length-1):e.children.length?this.moveAfter(I(e.children)):this.moveBefore(e);let s=this.parent,n=(s==null?void 0:s.type)==="mrow";if(n&&(s==null?void 0:s.prev))return this.moveAfter(s.prev);let r=n?s.parent:s;r&&this.moveBefore(r)}right(t){if(this.handleShift(t))return;if(this.selected)return this.offset+=1;if(Et(this.parent))return this.moveInto(this.parent,this.offset+1);let e=this.next;if(e)return Et(e)?this.moveInto(e,1):e.children.length?this.moveBefore(e.children[0]):this.moveAfter(e);let s=this.parent,n=(s==null?void 0:s.type)==="mrow";if(n&&(s==null?void 0:s.next))return this.moveBefore(s.next);let r=n?s.parent:s;r&&this.moveAfter(r)}up(t){this.selected&&this.clearRange();let e=Su(this.parent,{mfrac:1,msub:1,msup:0});(e==null?void 0:e.type)==="mfrac"&&this.moveAfter(I(e.children[0].children)),(e==null?void 0:e.type)==="msub"&&this.moveAfter(I(e.children[0].children)),(e==null?void 0:e.type)==="msup"&&this.moveBefore(e.children[1].children[0])}down(t){this.selected&&this.clearRange();let e=Su(this.parent,{mfrac:0,msub:0,msup:1});(e==null?void 0:e.type)==="mfrac"&&this.moveBefore(e.children[1].children[0]),(e==null?void 0:e.type)==="msub"&&this.moveBefore(e.children[1].children[0]),(e==null?void 0:e.type)==="msup"&&this.moveAfter(I(e.children[0].children))}backspace(){var r;if(this.selected){this.moveBefore(this.selected[0]);for(let o of this.selected)o.deleteFromDom();this.clearRange(),this.parent.children.length||this.parent.addChildren([this.placeholder]);return}if(Et(this.parent)){let o=this.parent.value;return this.setText(o.slice(0,this.offset-1)+o.slice(this.offset)),this.moveInto(this.parent,this.offset-1)}let t=this.prev;if(t)return Et(t)&&t.value.length>1?t.setValue(t.value.slice(0,t.value.length-1)):t.type==="placeholder"||t.children.length?this.left():(t.deleteFromDom(),this.parent.children.length||this.parent.addChildren([this.placeholder]),this.moveInto(this.parent,this.offset-1));let e=this.parent,s=e.children,n=0;e.type==="mrow"&&parent.parent&&(n=((r=e.prev)==null?void 0:r.children.filter(o=>o.type!=="placeholder").length)||0,e=e.parent,s=Bt((e==null?void 0:e.children.map(o=>o.children))||[])),!!(e==null?void 0:e.parent)&&(this.moveInto(e.parent,e.index+n),e.insertAfter(s.filter(o=>o.type!=="placeholder")),e.deleteFromDom(),this.parent.children.length||this.parent.addChildren([this.placeholder]))}get placeholder(){return new zn(this.equation)}setText(t,e){if(!e&&Et(this.parent)&&(e=this.parent),!!e){if(t in Fi&&(t=Fi[t]),t==="sqrt"){let s=this.createNode("msqrt");return e.insertAfter([s]),e.deleteFromDom(),this.moveBefore(s.children[0].children[0])}e.setValue(t)}}createNode(t,e){let s=ue(this.equation,e||[this.placeholder]);if(t==="mfenced")return new Ss([s],this.equation);if(t==="msqrt")return new Ui(t,[s],this.equation);let n=ue(this.equation,[this.placeholder]);if(t==="mfrac")return new Bn([s,n],this.equation);if(t==="mroot")return new Ui(t,[s,n],this.equation);if(t==="msub"||t==="msup")return new Zi(t,[s,n],this.equation)}splitTextNode(){let t=this.parent,e=t.value.slice(this.offset);t.setValue(t.value.slice(0,this.offset)),t.insertAfter([new li(t.type,e,this.equation)]),this.moveAfter(t)}insert(t,e){var n,r,o,a,l;let s=((n=this.prev)==null?void 0:n.type)==="placeholder";if(Et(this.parent)&&!this.start&&!this.selected){let h=this.parent.value;((r=this.parent)==null?void 0:r.type)===t?(this.setText(h.slice(0,this.offset)+e+h.slice(this.offset)),this.moveInto(this.parent,this.offset+1)):(this.splitTextNode(),this.insert(t,e))}else if(t==="mi"||t==="mn"||t==="mtext")this.selected&&this.backspace(),((o=this.prev)==null?void 0:o.type)===t?this.setText(this.prev.value+e,this.prev):((a=this.next)==null?void 0:a.type)===t?(this.setText(e+this.next.value,this.next),this.moveInto(this.next,1)):(this.parent.addChildren([new li(t,e,this.equation)],this.offset),s||(this.offset+=1));else if(t==="mo"||t==="mspace"){this.selected&&this.backspace();let h=t==="mo"?new li("mo",e,this.equation):new qn(this.equation);this.parent.addChildren([h],this.offset),s||(this.offset+=1)}else{let h=t==="msub"||t==="msup"||t==="mfrac"&&((l=this.prev)==null?void 0:l.type)!=="mo",d=this.selected||(h&&this.prev?[this.prev]:void 0);d&&this.moveBefore(d[0]),this.selected&&this.clearRange();let p=this.createNode(t,d);this.parent.addChildren([p],this.offset),this.moveBefore(p.children[d&&p.children.length>1?1:0].children[0])}}toSubSup(t){let e=this.placeholder,s=t.type==="msub"?2:1;t.addChildren([ue(this.equation,[e])],s),t.type="msubsup",this.moveBefore(e)}type(t){var e,s,n,r,o,a;if(t=t.replace("*","\xD7").replace("-","\u2212"),t.match(/^[A-Za-zπ]$/))this.insert("mi",t);else if("0123456789.".includes(t))this.insert("mn",t);else if("+\u2212\xB1\xD7\xF7<>\u2264\u2265=%!".includes(t))this.insert("mo",t);else if(t===" "){let l=(e=this.prev)==null?void 0:e.type,h=(s=this.next)==null?void 0:s.type;if(l==="placeholder"||l==="mspace"||h==="placeholder"||h==="mspace"||!Et(this.parent)&&l!=="mi"&&h!=="mi")return;this.insert("mspace")}else if(t==="frac"||t==="/")this.insert("mfrac",t);else if(t==="sqrt")this.insert("msqrt",t);else if(t==="^"||t==="sup"){if(((n=this.prev)==null?void 0:n.type)==="msub")return this.toSubSup(this.prev);this.insert("msup",t)}else if(t==="_"||t==="sub"){if(((r=this.prev)==null?void 0:r.type)==="msup")return this.toSubSup(this.prev);this.insert("msub",t)}else if(t==="brackets"||"([{|".includes(t))this.insert("mfenced",t);else if(")]}".includes(t))if(((a=(o=this.parent)==null?void 0:o.parent)==null?void 0:a.type)==="mfenced")this.moveAfter(this.parent.parent);else{let l=this.prev;this.parent.addChildren([this.createNode("mfenced",l?[l]:void 0)],this.offset),l||(this.offset+=1)}}copy(){return this.selected?this.selected.map(t=>t.expr).join(""):""}paste(t){try{let e=this.equation.parse(t);if(this.selected&&this.backspace(),e.length===1&&Et(e[0]))return this.insert(e[0].type,e[0].value),e[0].deleteFromDom();Et(this.parent)&&this.splitTextNode(),this.parent.addChildren(e,this.offset),this.moveAfter(I(e))}catch(e){}}};var Pu=class{constructor(t,e,s=!0){this.$el=c("g",{class:"equation","font-size":"20px"},t),this.equation=new ci(this.$el,void 0,0,"",20,s);try{this.equation.setValue(e)}catch(n){console.warn("Parsing error",e,n.message)}}get expr(){return ce.parse(this.equation.root.expr).collapse()}get width(){return this.equation.root.width}get height(){return this.equation.root.height}},Cu=class extends Pu{constructor(t,e,s,n=!0){super(e,s,n);this.tile=t;this.cursor=new ya(this.equation),this.$textarea=c("textarea",{class:"hidden-input",tabindex:-1},t.$parent),this.$textarea.on("key",r=>this.handleKey(r)),this.$textarea.on("blur",()=>t.blur()),this.$textarea.on("cut copy",r=>{var o;(o=window.navigator.clipboard)==null||o.writeText(this.cursor.copy()),r.type==="cut"&&(this.cursor.backspace(),this.redraw())}),this.$textarea.on("paste",()=>O(this,null,function*(){var o;let r=yield(o=window.navigator.clipboard)==null?void 0:o.readText();!r||(this.cursor.paste(r),this.redraw())}))}redraw(){this.equation.resize(),this.tile.transform(),this.cursor.redraw()}bindSlideEvents(t,e){this.tile.$parent.events.listen(this.tile.$el,{down:s=>{s.event.preventDefault(),this.cursor.clearRange(),this.moveCursor(t(s))},start:()=>this.cursor.startRange(),move:s=>this.moveCursor(t(s)),blurInput:!1,checkIfActive:e})}handleKey(t){var e;if(!((e=this.excludedChars)==null?void 0:e.includes(t.char))){if(t.code===_t.enter||t.code===_t.escape)return this.$textarea.blur(),this.tile.$parent.selection.add(this.tile,!0);if(t.code===_t.left)this.cursor.left(t.shift);else if(t.code===_t.right)this.cursor.right(t.shift);else if(t.code===_t.up)this.cursor.up(t.shift);else if(t.code===_t.down)this.cursor.down(t.shift);else return t.code===_t.backspace||t.code===_t.delete?(this.cursor.backspace(),this.redraw()):(this.cursor.type(t.char),this.redraw());this.cursor.redraw()}}moveCursor(t){this.cursor.moveToPoint(t||y),this.cursor.redraw()}focus(){this.$textarea.show(),this.$textarea.focus()}blur(){return this.cursor.hide(),this.$textarea.hide(),this.equation.updateDescription(),this.equation.root.expr}delete(){this.$el.remove(),this.$textarea.remove()}},va=class extends S{constructor(t,e,s){super(e,s);this.type="equation";this.focussed=!1;this.size=0;this.linkTypes=["axes"];this.creating=!1;this.options=t||"placeholder",this.$box=c("rect",{fill:"transparent"},this.$el),this.$outline=c("rect",{class:"outline"},this.$el),this.$resultText=c("text",{opacity:.5,style:"font-size: 13px"},this.$el),this.watchPolypadOptions(n=>{var r;this.$resultText.toggle(n.evalEquations),(r=this.watcher)==null||r.call(this)}),this.equationArea=new Cu(this,this.$el,this.options),this.equationArea.bindSlideEvents(n=>this.getCursorOffset(n),()=>this.focussed),this.setOrder("front"),this.makeOutPort("main",{tileTypes:["axes"],connect:n=>n.enqueueMessage({type:"equation",text:this.options})}),this.transform(),this.setColour(e.penColour),this.updateMath()}setSize(t){super.setSize(T(t,-5,10)),this.equationArea.$el.css("transform",this.size?`scale(${this.scale})`:""),this.$resultText.css("font-size",13*this.scale+"px"),this.transform()}get scale(){return 1.2**this.size}doubleClick(t){this.focus(!1,t)}customTransform(){let t=this.equationArea.width*this.scale+16,e=this.equationArea.height*this.scale+12;this.path=new $(y.shift(-8,-6),t,e);for(let s of[this.$box,this.$outline])s.setRect(this.path);this.$resultText.setTransform({x:0,y:e+10*this.scale-6})}setColour(t){super.setColour(t),this.equationArea.$el.css("color",A(this.colour)),this.$resultText.setAttr("fill",A(this.colour)),this.emitMessage("main",{type:"equation",text:this.options})}delete(){super.delete(),this.equationArea.delete()}getSnapPoints(){return[]}focus(t=!1,e){this.focussed||(this.focussed=!0,this.$parent.options.focussed=this,this.creating=t,this.showErrorIcon(void 0),this.$el.css("cursor","text"),this.$parent.selection.clear(),this.equationArea.focus(),this.equationArea.moveCursor(this.getCursorOffset(e)))}blur(){if(!this.focussed)return;this.focussed=!1,this.$parent.options.focussed=void 0,this.$el.css("cursor","grab");let t=this.options;if(this.options=this.equationArea.blur(),this.updateMath(),this.creating||t!==this.options){let e=this.creating?"added":"changed";this.$parent.change({[e]:[this]}),this.emitMessage("main",{type:"equation",text:this.options})}}updateMath(){let t=this.$parent.mathContext;this.watcher&&t.unwatch(this.watcher);let e=t.attemptUpdateSource(this,this.options);if(!e){this.watcher=void 0,this.value=0;return}let s=Ki(e)[1]instanceof Ie,n=()=>{let{error:r,value:o}=t.evaluate(e);if(this.showErrorIcon(this.$parent.options.evalEquations?r:void 0),this.value=o||0,s||isNaN(o))return this.$resultText.textStr="";this.$resultText.textStr=`= ${rt(o,8)}`};this.watcher=n,t.watch(e.unknowns,n,!0)}getCursorOffset(t){return t?this.relativePosn(t.posn).scale(1/this.scale):y}format(t){this.equationArea.handleKey({char:t})}};var Eu='<h3>Variable Slider</h3><label class="row"><div class="label">Variable:</div><input class="input-field wide" type="text" :bind="name" style="font-style:italic"></label><label class="row"><div class="label">Range:</div><input class="input-field input-pair" type="number" :bind="min"><input class="input-field input-pair" type="number" :bind="max"></label><label class="row"><div class="label">Increment:</div><input class="input-field wide" type="number" :bind="step"></label><label class="row"><div class="label">Duration:</div><input class="input-field wide" type="number" :bind="duration" min="0.1" max="10"></label><label class="row"><div class="label">Motion:</div><select class="input-field wide" :bind="type"><option value="bounce">Bounce</option><option value="loop">Loop</option><option value="once">Once</option></select></label>';var Qn=200,tr=75,me=20,S0='<tspan style="font-style:italic"></tspan> &nbsp;=&nbsp; <tspan></tspan>',Au="M8,6.8V17.2a.9.9,0,0,0,1.5.8l8.2-5.2a1,1,0,0,0,0-1.7L9.5,6A1,1,0,0,0,8,6.8Z",M0="M8 19a2 2 0 0 0 2-2v-10a2 2 0 0 0 -2-2 2 2 0 0 0 -2 2v10a2 2 0 0 0 2 2zm6-12v10a2 2 0 0 0 2 2 2 2 0 0 0 2-2v-10a2 2 0 0 0 -2-2 2 2 0 0 0 -2 2z";function P0(i,t,e){let s=(Date.now()-i)/1e3;if(e==="once")return s/t;if(e==="loop")return s/t%1;let n=s/(t*2)%1;return n<.5?n*2:1-(n-.5)*2}var ba=class extends S{constructor(t,e,s){super(e,s);this.type="slider";this.path=new $(y,Qn,tr);this.options=t,this.$body=c("rect",{class:"polygon-tile",rx:10},this.$el),this.$outline=c("rect",{class:"outline",rx:10},this.$el),this.$body.setRect(this.path),this.$outline.setRect(this.path),this.$expr=c("text",{x:me,y:30,html:S0},this.$el),[this.$exprName,this.$exprValue]=this.$expr.$$("tspan"),this.$bar=c("line",{x1:me,x2:Qn-me,y1:tr-me,y2:tr-me,opacity:.5,style:"stroke-width: 4; stroke-linecap: round;"},this.$el);let n=c("g",{transform:"translate(162 12)",style:"cursor: pointer"},this.$el);c("rect",{x:-4,y:-4,width:32,height:32,fill:"transparent"},n),this.$playIcon=c("path",{d:Au},n),e.events.listen(n,{click:()=>this.play()}),this.$handle=this.makeHandle("c",m=>{let g=it(this.model.min,this.model.max,(m.x-me)/(Qn-2*me));this.setValue(g),this.updateOptions()}),this.$handle.addClass("persistent");let[r,o,a,l,h,d,p]=this.options.split(":");this.variable=r,this.model=e.bindSettingsPanel(this,Eu,{name:r,min:a===void 0?-5:+a,max:l===void 0?5:+l,step:+h||.1,type:d||"bounce",duration:+p||2}),this.model.watchAll((m,g)=>{this.animation&&this.stopAnimating(),this.setValue(g?+o||0:this.value)})}play(){if(this.animation)return this.stopAnimating();this.$playIcon.setAttr("d",M0);let{min:t,max:e,type:s,duration:n}=this.model,r=Date.now(),o=r+n*1e3;this.animation=z(()=>{let a=P0(r,n,s);this.setValue(it(t,e,a)),s==="once"&&Date.now()>=o&&this.stopAnimating()})}stopAnimating(){var t;(t=this.animation)==null||t.cancel(),this.animation=void 0,this.$playIcon.setAttr("d",Au),this.updateOptions(),this.$parent.change({changed:[this]})}delete(){this.animation&&this.stopAnimating(),super.delete()}setValue(t){if(t=T(K(t,this.model.step),this.model.min,this.model.max),this.model.name!==this.variable)this.model.name=this.model.name.replace(/[^A-Za-z]/g,""),this.$parent.mathContext.removeSource(this),this.variable=this.model.name;else if(this.value!==void 0&&b(t,this.value))return;this.value=t;let e=it(me,Qn-me,(t-this.model.min)/(this.model.max-this.model.min));this.$handle.setTransform(new u(e,tr-me)),this.$exprName.text=this.variable,this.$exprValue.text=rt(t,5),this.$parent.mathContext.updateSource(this,this.variable,new Ie(t))}setColour(t){super.setColour(t);let e=A(t),s=V.from(e).brightness<180?"#fff":"#000";this.$body.setAttr("fill",e);for(let n of[this.$expr,this.$playIcon])n.setAttr("fill",s);this.$handle.css("fill",s),this.$bar.setAttr("stroke",s)}updateOptions(){this.options=[this.variable,this.value,this.model.min,this.model.max,this.model.step,this.model.type,this.model.duration].join(":")}static makeThumbnail(t,e){let n=t.split(":")[0],r=c("svg",{width:104,height:54},e);c("rect",{x:2,y:2,width:100,height:50,fill:e.data.colour,rx:5},r),c("rect",{x:10,y:40,width:84,height:3,fill:"white",rx:2,opacity:.5},r),c("circle",{cx:32,cy:41.5,r:6,fill:"white"},r),c("text",{x:52,y:28,fill:"white",style:"font-size:24;font-style:italic;text-anchor:middle",text:n},r)}};var Vu={"number-bar":go,"number-tile":kn,polygon:G,pentomino:ro,tangram:oo,"fraction-bar":Wi,"fraction-circle":Go,text:wa,"algebra-tile":vs,"log-bar":eo,grid:qo,"custom-polygon":so,image:ga,dice:te,"polyhedral-dice":Ko,coin:Xo,"number-line":ha,penrose:ao,kolam:lo,"prime-disk":gs,balance:Bo,"decimal-grid":wo,spinner:Vs,"custom-spinner":ta,token:Zo,egg:ho,geo:lt,fractal:uo,ruler:ca,protractor:ua,compass:fa,"set-triangle":pa,"dot-machine":yo,dot:ws,garden:po,tantrix:fo,axes:aa,"question-blank":Is,equation:va,"number-card":vo,card:Ri,abacus:bo,bucket:xo,table:ma,pentagon:mo,domino:ea,slider:ba,"number-grid":To,"number-frame":So,"number-dot":bs,polyhedron:si,chart:ia,"pie-chart":sa,clock:la,"box-whisker":na};function fi(i){if(!(i in Vu))throw new Error(`Unknown tile type: ${i}`);return Vu[i]}var $a=class{constructor(t,e){this.$canvas=t;this.defaultCallbacks=e;this.callbacks=new WeakMap;this.isMoving=!1;this.shiftKey=!1;this.altKey=!1;this.cancelled=!1;setTimeout(()=>{document.addEventListener("keydown",s=>{this.shiftKey=s.shiftKey,this.altKey=s.altKey}),document.addEventListener("keyup",s=>{this.shiftKey=s.shiftKey,this.altKey=s.altKey}),document.addEventListener("visibilitychange",()=>{this.shiftKey=this.altKey=!1})},2e3),t.css("touch-action","none"),t.on("pointerdown",s=>this.startEvent(s)),E.onKey("escape",()=>this.cancel()),e.hover&&t.on("pointermove",s=>{this.isMoving||e.hover({posn:Qt(s,t),event:s})})}listen(t,e){this.callbacks.set(t._el,e),t.hasParent(this.$canvas)||(t.css("touch-action","none"),t.on("pointerdown",s=>this.startEvent(s)))}startEvent(t){var h;if(t.handled||t.button)return;this.isMoving=!0,this.cancelled=!1,t.preventDefault();let e=t.pointerId,s=this.getCallbacks(t.target);"shiftKey"in t&&(this.shiftKey=t.shiftKey),s.blurInput!==!1&&((h=E.getActiveInput())==null||h.blur());let n=Qt(t,this.$canvas),r=n,o=!1,a=d=>{if(d.pointerId&&d.pointerId!==e)return;if(d.preventDefault(),this.cancelled)return l(d);let p=Qt(d,this.$canvas);u.distance(p,r)<.5||(!o&&s.start&&s.start({posn:n,event:d}),s.move&&s.move({posn:p,startPosn:n,lastPosn:r,event:d}),!o&&s.cursor!==!1&&Mt.addClass("grabbing"),r=p,o=!0)},l=d=>{var p,m,g;d.pointerId&&d.pointerId!==e||(d.preventDefault(),X.off("pointermove",a),X.off("pointerstop",l),(p=s.up)==null||p.call(s,{posn:n,event:d}),o?(m=s.end)==null||m.call(s,{posn:r,lastPosn:r,startPosn:n,event:d,cancelled:this.cancelled}):this.cancelled||(g=s.click)==null||g.call(s,{posn:n,event:d}),Mt.removeClass("grabbing"),this.isMoving=this.cancelled=!1)};s.down&&s.down({posn:n,event:t}),X.on("pointermove",a),X.on("pointerstop",l)}getCallbacks(t){for(;t;){let e=this.callbacks.get(t);if(e&&(!e.checkIfActive||e.checkIfActive()))return e;t=t.parentNode||void 0}return this.defaultCallbacks}cancel(){this.cancelled=!0}};var Ds=Math.PI/180,ku,Ou,er=new Set,xa=new Set;function C0(i,t,e){let s=ct(i-t,e);return s>e/2?s-e:s}var Ta=class{constructor(t){this.$parent=t;this.angle=0;this.startAngle=0;this.hasChanged=!1;this.showTools=!1;this.isMoving=!1;this.tiles=new Set;this.implicitChanges=new Set;this.$tools=t.$(".transform-tools"),this.$shadow=t.$(".group-shadow"),this.$rect=this.$tools.$(".group-outline"),this.$rotateBar=this.$tools.$(".rotate-bar"),this.$rotateCircle=this.$tools.$(".rotate-circle"),t.events.listen(this.$rotateCircle,{start:()=>{this.startAngle=this.angle,this.rotateStart()},move:({startPosn:e,posn:s})=>{this.rotate(this.startAngle-new St(s,this.center,e).deg)},end:()=>this.rotateEnd()}),E.onKey("up down left right r R",(e,s)=>{if(!this.tiles.size)return;if(s==="r"||s==="R"){if(Array.from(this.tiles).some(h=>h.fixed||!h.canRotate))return;this.rotateStart(),this.rotate(this.angle+(s==="R"?-15:15)),this.rotateEnd();return}let n=y,r=this.$parent.events.shiftKey?5:25,o=s==="left"?-r:s==="right"?r:0,a=s==="up"?-r:s==="down"?r:0,l=n.shift(o,a);this.moveStart(),this.move({posn:l,startPosn:n}),this.moveEnd()}),E.onKey("escape",()=>this.clear())}get size(){return this.tiles.size}add(t,e=!1,s=!1){e&&this.clear(),!t.isActive&&this.$parent.tiles.has(t.id)&&this.select([t],s)}select(t,e=!1){for(let s of t)s.isActive||!this.$parent.tiles.has(s.id)||(this.tiles.add(s),s.select(),this.hasChanged=!0);e||this.update(!0)}remove(t,e=!1){!t.isActive||(t.deselect(),this.hasChanged=!0,this.tiles.delete(t),e||this.update(!0))}clear(){if(!this.isMoving){for(let t of this.tiles)t.deselect();this.tiles.size&&(this.hasChanged=!0),this.tiles.clear(),this.update(!0)}}getTileProperty(t){if(!this.size)return;let e=Array.from(this.tiles),s=t(e[0]);return e.slice(1).some(r=>t(r)!==s)?void 0:s}update(t=!1){if(t&&!this.hasChanged)return;if(this.hasChanged=!1,this.implicitChanges.clear(),!this.size){for(let l of[this.$shadow,this.$tools])l.hide();this.$parent.trigger("change-selection",{tiles:[],color:void 0});return}let e=Array.from(this.tiles);this.angle=this.getTileProperty(l=>l.rot)||0;let s=Oe(...e.map(l=>l.transformed.rotate(-this.angle*Ds))),n=s.p.shift(s.w/2,s.h/2).rotate(this.angle*Ds).shift(-s.w/2,-s.h/2);this.rect=new $(n,s.w,s.h),this.center=this.rect.center;let r=!!this.$parent.options.canRotate&&e.every(l=>l.canRotate&&!l.fixed);if(e.length===1&&st(e[0].transformed)&&(r=!1),r&&this.getTileProperty(l=>l.rotateAroundOrigin)){let l=e[0].posn;e.slice(1).every(h=>h.posn.equals(l))&&(this.center=l,this.angle&&e.length===1&&(this.rect=Oe(e[0].transformed.rotate(-this.angle*Ds,l))))}this.$rotateBar.toggle(r),this.$rotateCircle.toggle(r);let o=this.size>1||e[0].showSelectionOutline;this.$rect.toggle(o),this.showTools=!this.getTileProperty(l=>l.hideSelectionOutline),this.$tools.toggle(this.showTools),this.$shadow.toggle(o&&this.showTools),(this.size===1?e[0].$container:this.$parent.$svg).append(this.$tools),this.$parent.$svg.append(this.$parent.$cables),this.positionTools();let a=this.getTileProperty(l=>l.colour);this.$parent.trigger("change-selection",{tiles:e,color:a})}positionTools(){if(!this.showTools)return;let t=this.rect.rotate(this.angle*Ds,this.center);for(let n of[this.$shadow,this.$rect])n.draw(t);let e=new u(this.center.x,this.rect.p.y),s=new j(e,e.shift(0,-28)).rotate(this.angle*Ds,this.center);this.$rotateBar.setLine(s.p1,s.p2),this.$rotateCircle.setCenter(s.p2)}moveStart(){for(let t of this.tiles)if(t.fixed||!t.canMove)return;this.isMoving=!0;for(let t of this.tiles)t.moveStart();this.startSnapPoints=[];for(let t of this.tiles)for(let e of t.snapPoints)this.startSnapPoints.some(s=>e.equals(s))||this.startSnapPoints.push(e);Ou=this.rect,ku=this.center,this.$parent.newTileShift=0,this.$parent.trigger("move-start")}move({posn:t,startPosn:e}){if(!this.isMoving)return;let s=t.subtract(e),n=this.startSnapPoints.map(a=>a.add(s)),r=this.$parent.snap(n);r&&(s=s.add(r.shift));let o=this.tiles.size===1?r==null?void 0:r.target:void 0;for(let a of this.tiles)a.move(s,o);this.rect=Ou.translate(s),this.center=ku.add(s),this.positionTools(),this.$parent.trigger("move-selection")}moveEnd(t=!1){if(!this.isMoving)return;for(let s of this.tiles)s.transform(),s.moveEnd();if(lt.computeIntersections(this.$parent),this.$parent.trigger("move-end"),this.isMoving=!1,!this.tiles.size)return;let e=[...Array.from(this.tiles),...Array.from(this.implicitChanges)];this.$parent.change({[t?"added":"changed"]:e}),this.implicitChanges.clear()}rotateStart(){xa.clear();for(let t of this.tiles)for(let e of t.snapAngles)xa.add(ct(e+t.rot,180));er.clear(),er.add(0);for(let t of this.$parent.tiles.values())if(!t.isActive&&!!Ve(this.tiles,e=>u.distance(e.posn,t.posn)<140))for(let e of t.snapAngles)er.add(ct(e+t.rot,180));this.$parent.newTileShift=0}rotate(t){if(t=K(t,3),t===this.angle)return;let e=Infinity;for(let n of xa)for(let r of er){let o=C0(r,n+t-this.startAngle,180);Math.abs(o)<Math.abs(e)&&(e=o)}if(Math.abs(e)<8&&(t+=e),t===this.angle)return;let s=t-this.angle;this.angle=t;for(let n of this.tiles)n.posn=n.posn.rotate(s*Math.PI/180,this.center),n.rot=ct(n.rot+s,360),n.transform(!0);this.positionTools(),this.$parent.trigger("rotate-selection")}rotateEnd(){for(let t of this.tiles)t.transform();this.$parent.change({changed:Array.from(this.tiles)})}copy(t=!1,e=25){if(this.isMoving||!this.$parent.options.canCopy||!this.tiles.size||Ot.isMoving)return;let s={},n=Array.from(this.tiles).map(r=>r.copy(s,e));this.clear();for(let r of n)this.add(r);t||this.$parent.change({added:n})}delete(){var s;if(this.isMoving||!this.$parent.options.canDelete||Ot.isMoving)return;let t=Array.from(this.tiles).filter(n=>!n.fixed);if(!t.length)return;let e=new Set;for(let n of t){for(let r of Ti(((s=n.inPorts)==null?void 0:s.values())||[],o=>o.cables))e.add(r.from.tile);n.delete()}lt.computeIntersections(this.$parent),this.$parent.change({deleted:t,changed:Array.from(e).filter(n=>!t.includes(n))}),this.$parent.newTileShift=0}action(t,e){if(e==="copy")return this.copy();if(e==="delete")return this.delete();fi(t.split(" ")[0]).action(e,Array.from(this.tiles),this.center),this.update()}setOrder(t){for(let e of this.tiles)e.setOrder(t);this.$parent.change({changed:Array.from(this.tiles)})}lock(){let t=Array.from(this.tiles);for(let e of this.tiles)e.lock();this.$parent.change({changed:t})}setFixed(t=!0){let e=Array.from(this.tiles).filter(s=>!s.fixed!=!t);for(let s of e)s.fixed=t;e.length&&this.$parent.change({changed:e})}hide(){let t=Array.from(this.tiles);for(let e of t)e.hide();this.$parent.change({changed:t})}};var E0=5,mi=class{constructor(t){this.$parent=t}getTileAt(t,e=!0){var o;let s=this.$parent.snap([t.posn],e,!0,!0,"geo"),n=(o=s==null?void 0:s.target)==null?void 0:o.tile;if(!(n==null?void 0:n.locked)&&!(n==null?void 0:n.hidden)&&(n==null?void 0:n.type)==="geo")return n;let r=t.event.target;for(;r;){let a=vn.get(r);if(a&&!a.locked&&!a.hidden&&a.type!=="geo")return a;if(r=r.parentNode||void 0,r===this.$parent._el)return}}hoverGeoTile(t){var e;this.hoveringTile!==t&&((e=this.hoveringTile)==null||e.hover(!1)),t==null||t.hover(),this.hoveringTile=t}down(t){}start(t){}move(t){}end(t){}click(t){}hover(t){}cancel(){}},Sa=class extends mi{constructor(){super(...arguments);this.clickTimeout=0;this.name="move"}down(t){var s;let e=this.activeTile=this.getTileAt(t,!1);this.previousSelection=void 0,(s=this.$parent.options.focussed)==null||s.blur(),this.$parent.warningBanner.hide(),e?(e.isActive&&this.$parent.events.shiftKey?this.$parent.selection.remove(e):(this.$parent.events.shiftKey||!e.isActive)&&this.$parent.selection.add(e,!this.$parent.events.shiftKey),Mt.addClass("grabbing")):this.$parent.events.shiftKey?this.previousSelection=new Set(this.$parent.selection.tiles):this.$parent.selection.clear()}start(){this.activeTile?(this.$parent.events.altKey&&this.$parent.selection.copy(!0,0),this.$parent.selection.moveStart()):this.$parent.$selection.show()}move(t){var s;if(this.activeTile){this.$parent.selection.move(t);return}let e=$.aroundPoints([t.startPosn,t.posn]);this.$parent.$selection.setRect(e);for(let n of this.$parent.tiles.values()){if(n.locked||n.hidden||!n.canDragToSelect||!n.transformed)continue;let r=rs(e,n.transformed,n.type);(this.$parent.events.shiftKey&&((s=this.previousSelection)==null?void 0:s.has(n))?!r:r)?this.$parent.selection.add(n,!1,!0):this.$parent.selection.remove(n,!0)}this.$parent.selection.update(!0)}end(){this.activeTile?this.$parent.selection.moveEnd():this.$parent.$selection.hide(),Mt.removeClass("grabbing")}click(t){if(this.activeTile){this.activeTile.click(t);let e=Date.now();e-this.clickTimeout<500&&this.activeTile.doubleClick(t),this.clickTimeout=e}}hover(t){let e=this.getTileAt(t,!1);this.hoverGeoTile((e==null?void 0:e.type)==="geo"?e:void 0),this.$parent.$svg.css("cursor",e?"grab":"")}},Ma=class extends mi{constructor(){super(...arguments);this.erased=[];this.name="eraser"}down({posn:t}){this.erase(t)}move({posn:t,lastPosn:e}){let s=u.distance(t,e)/4;for(let n=0;n<s;++n)this.erase(u.interpolate(t,e,n/s))}shouldErase(t,e,s){return gt(e)?u.distance(e,t)<10:At(e)?e.distanceSquared(t)<100:en(e)?e.edges.some(n=>n.distanceSquared(t)<100):st(e)&&s==="geo"?Math.abs(u.distance(t,e.c)-e.r)<10:e.contains(t)}erase(t){for(let e of this.$parent.tiles.values())if(!(!e.transformed||!e.canDragToSelect||e.locked||e.hidden)&&this.shouldErase(t,e.transformed,e.type)){e.delete(),this.erased.push(e);return}for(let e of this.$parent.strokes.values())if(e.hitTest(t,10)){e.delete(),this.erased.push(e);return}}end(){this.erased.length&&this.$parent.change({deleted:this.erased}),this.erased=[]}click(){this.end()}},Pa=class extends mi{constructor(){super(...arguments);this.name="text";this.options="text"}down({posn:t}){let e=this.$parent.newTile(this.options,"");e.setTransform(t.shift(-10,-15)),this.$parent.trigger("add-tile",{tile:e}),e.focus(!0)}},Ca=class extends mi{constructor(){super(...arguments);this.name="pan"}enable(){this.previousTool=this.$parent.activeTool.name,this.$parent.setActiveTool("pan")}down(t){this.initialOrigin=this.$parent.origin,this.startPosn=le(t.event)}move(t){let e=le(t.event).subtract(this.startPosn),s=this.initialOrigin.subtract(e.scale(1/this.$parent.zoom));this.$parent.setViewport(s,this.$parent.zoom)}end(){this.$parent.setActiveTool(this.previousTool)}click(){this.end()}},ir=class extends mi{constructor(){super(...arguments);this.name="pen";this.options="pen"}getUtensil(t){for(let e of this.$parent.tiles.values()){if(!e.transformed||!gu(e))continue;let s=e.transformed.project(t);if(u.distance(t,s)<30)return e.transformed}}getPoint(t){if(this.options==="ruler"){let e=this.$parent.snap([t]);return e?t.add(e.shift):this.startPoint?t.snap(this.startPoint,E0):t}else return this.utensil?this.utensil.project(t):t}down({posn:t}){this.utensil=this.getUtensil(t),this.startPoint=this.getPoint(t),this.stroke=new pe(this.$parent,[this.startPoint],this.$parent.penColour,this.options)}move({posn:t}){var s,n;let e=this.getPoint(t);this.options==="ruler"?(s=this.stroke)==null||s.setLine(new j(this.startPoint,e)):(n=this.stroke)==null||n.addPoint(this.getPoint(e))}click(){this.$parent.change({added:[this.stroke]}),this.stroke=this.startPoint=this.utensil=void 0}end(t){var e,s;this.options==="ruler"?(e=this.stroke)==null||e.makeSnapPoints():this.utensil||(s=this.stroke)==null||s.simplify(),this.utensil=void 0,this.click()}},sr=class extends mi{constructor(){super(...arguments);this.name="geo";this.options="line"}expr(t,e){switch(this.options){case"line":return`segment(${t},${e})`;case"circle":return`circle(${t},distance(${t},${e}))`;case"rect":return`rectangle(${t},${e}.x-${t}.x,${e}.y-${t}.y)`}}snapPoint(t){var r,o,a,l;let e=this.$parent.snap([t]);e&&(t=t.add(e.shift));let s="",n=((o=(r=e==null?void 0:e.target)==null?void 0:r.tile)==null?void 0:o.type)==="geo"?(a=e==null?void 0:e.target)==null?void 0:a.tile:void 0;return(n==null?void 0:n.path)&&gt(n.path)&&(s=n.key),((l=e==null?void 0:e.target)==null?void 0:l.intersection)&&(s=e.target.intersection.expr),{point:t,tile:n,expr:s||`point(${t.x},${t.y})`}}getOrMakePointTile(t){var s,n;if(((s=t==null?void 0:t.tile)==null?void 0:s.path)&&gt(t.tile.path))return t.tile;if((n=t==null?void 0:t.tile)==null?void 0:n.path){let r=wn(t.tile.path,t.point),o=new lt(`${t.tile.key}.at(${r})`,this.$parent);return this.$parent.trigger("add-tile",{tile:o}),o}let e=new lt(t.expr,this.$parent);return this.$parent.trigger("add-tile",{tile:e}),e}drawPendingPoint(t){var n,r;let e=((r=(n=t.tile)==null?void 0:n.path)==null?void 0:r.type)==="point",s=t.expr.startsWith("intersection");this.$parent.$pendingPoint.toggle(!e),e||(this.$parent.$pendingPoint.setCenter(t.point),this.$parent.$pendingPoint.setClass("intersection",s),this.$parent.$pendingPoint.setAttr("r",s?3.5:6))}down({posn:t}){let e=this.snapPoint(t);this.startPoint=this.getOrMakePointTile(e),this.createdNewStart=!e.tile}start(){var t;this.path=new lt("",this.$parent),this.startPoint.pending=this.path.pending=!0,(t=this.$parent.$pendingPoint)==null||t.show(),this.hoverGeoTile(void 0)}move({posn:t}){var e;this.endSnap=this.snapPoint(t),this.path.setExpr(this.expr(this.startPoint.key,this.endSnap.expr),!0),this.drawPendingPoint(this.endSnap),this.hoverGeoTile((e=this.endSnap)==null?void 0:e.tile)}end(){var s;let t=u.distance(this.startPoint.path,this.endSnap.point)<8,e;if(t?this.path.delete():(e=this.getOrMakePointTile(this.endSnap),this.path.setExpr(this.expr(this.startPoint.key,e.key)),this.path.setPending(!1),this.$parent.trigger("add-tile",{tile:this.path})),this.startPoint.setPending(!1),(s=this.$parent.$pendingPoint)==null||s.hide(),this.hoverGeoTile(void 0),lt.computeIntersections(this.$parent),this.createdNewStart||!t){let n=[];this.createdNewStart&&n.push(this.startPoint),this.path&&n.push(this.path),e&&n.push(e),this.$parent.change({added:n})}this.startPoint=this.path=this.endSnap=void 0}click(){this.createdNewStart&&this.$parent.change({added:[this.startPoint]})}hover(t){var s;let e=this.snapPoint(t.posn);this.drawPendingPoint(e),this.hoverGeoTile(((s=e==null?void 0:e.tile)==null?void 0:s.type)==="geo"?e.tile:void 0)}cancel(){this.$parent.$pendingPoint.hide(),this.path&&this.path.delete(),this.startPoint=this.path=this.endSnap=void 0}},Ea=class extends sr{constructor(){super(...arguments);this.name="geoPending";this.startId="";this.expression=""}enable(t){var e;this.expression=t,this.$parent.selection.clear(),this.$parent.setActiveTool("geoPending"),((e=window.event)==null?void 0:e.clientX)&&this.hover({posn:Qt(window.event,this.$parent.$svg)})}makePath(){return this.path=new lt("",this.$parent),this.path.$el.css("opacity",.5),this.path.pending=!0,this.path}down(t){if(!this.expression)return;super.down(t);let e=this.path||this.makePath();e.$el.css("opacity",1),e.setExpr(this.expression.replace(/\$1/g,this.startPoint.key)),e.pending=!1,this.path=void 0,this.$parent.selection.add(e,!0);let s=this.createdNewStart?[this.startPoint]:[];this.$parent.change({added:[...s,e]}),lt.computeIntersections(this.$parent),this.$parent.trigger("add-tile",{tile:e}),this.$parent.setActiveTool("move")}hover({posn:t}){var s;if(!this.expression)return;let e=this.snapPoint(t);this.drawPendingPoint(e),this.hoverGeoTile(((s=e==null?void 0:e.tile)==null?void 0:s.type)==="geo"?e.tile:void 0),this.path||this.makePath(),this.path.setExpr(this.expression.replace(/\$1/g,e.expr))}cancel(){super.cancel(),this.expression=""}},Aa=class extends ir{constructor(){super(...arguments);this.name="cutPolygon";this.options="ruler"}enable(){if(this.tiles=Array.from(this.$parent.selection.tiles).filter(t=>!t.fixed),!this.tiles.length)return this.cancel();this.$parent.selection.clear(),this.$parent.setActiveTool("cutPolygon");for(let t of this.tiles)t.$el.addClass("active")}down(){}start({posn:t}){!this.tiles||(this.utensil=this.getUtensil(t),this.startPoint=this.getPoint(t),this.$stroke=c("line",{class:"stroke cut"},this.$parent.$strokes))}move({posn:t}){var e;this.lastPoint=this.getPoint(t),(e=this.$stroke)==null||e.setLine(this.startPoint,this.lastPoint)}end(t){var o;if(t.cancelled)return this.cancel();let e=new pt(this.startPoint,this.lastPoint),s=!1,n=[],r=[];for(let a of this.tiles||[]){let h=a.transformed.cut(e);if(h.length>1){for(let d of h){let p=new G(Q(d.points),this.$parent);p.setColour(a.colour),p.transform(),n.push(p)}a.delete(),r.push(a),s=!0}else a.$el.removeClass("active")}s&&this.$parent.change({added:n,deleted:r}),(o=this.$stroke)==null||o.remove(),this.$stroke=this.tiles=this.startPoint=this.lastPoint=void 0,this.$parent.setActiveTool("move")}click(){this.cancel()}cancel(){var t;for(let e of this.tiles||[])e.$el.removeClass("active");(t=this.$stroke)==null||t.remove(),this.$stroke=this.tiles=this.startPoint=this.lastPoint=void 0,setTimeout(()=>this.$parent.setActiveTool("move"))}};var Lu='<svg class="canvas" tabindex="0"><defs><pattern class="grid-pattern" id="square2-grid" x="0" y="0" width="50" height="50" patternUnits="userSpaceOnUse"><rect x="0" y="0" width="50" height="50" opacity="0.2"></rect></pattern><pattern class="grid-pattern" id="square-dots" x="-4" y="-4" width="25" height="25" patternUnits="userSpaceOnUse"><circle cx="4" cy="4" r="2" opacity="0.3"></circle></pattern><pattern class="grid-pattern" id="square-grid" x="0" y="0" width="125" height="125" patternUnits="userSpaceOnUse"><g opacity="0.2"><line x1="25" y1="0" x2="25" y2="125"></line><line x1="0" y1="25" x2="125" y2="25"></line><line x1="50" y1="0" x2="50" y2="125"></line><line x1="0" y1="50" x2="125" y2="50"></line><line x1="75" y1="0" x2="75" y2="125"></line><line x1="0" y1="75" x2="125" y2="75"></line><line x1="100" y1="0" x2="100" y2="125"></line><line x1="0" y1="100" x2="125" y2="100"></line></g><rect x="0" y="0" width="125" height="125" opacity="0.5"></rect></pattern><pattern class="grid-pattern" id="tri-dots" x="0" y="-4" width="25" height="43.30127018922193" patternUnits="userSpaceOnUse"><circle cx="0" cy="4" r="2" opacity="0.3"></circle><circle cx="25" cy="4" r="2" opacity="0.3"></circle><circle cx="12.5" cy="25.650635094610966" r="2" opacity="0.3"></circle></pattern><pattern class="grid-pattern" id="tri-grid" x="0" y="0" width="25" height="43.30127018922193" patternUnits="userSpaceOnUse"><g opacity="0.2"><line x1="0" y1="0" x2="25" y2="0"></line><line x1="0" y1="21.650635094610966" x2="25" y2="21.650635094610966"></line><line x1="0" y1="43.30127018922193" x2="25" y2="43.30127018922193"></line><line x1="0" y1="0" x2="25" y2="43.30127018922193"></line><line x1="25" y1="0" x2="0" y2="43.30127018922193"></line></g></pattern><pattern class="grid-pattern" id="tri2-dots" x="-4" y="0" width="43.30127018922193" height="25" patternUnits="userSpaceOnUse"><circle cx="4" cy="0" r="2" opacity="0.3"></circle><circle cx="4" cy="25" r="2" opacity="0.3"></circle><circle cx="25.650635094610966" cy="12.5" r="2" opacity="0.3"></circle></pattern><pattern class="grid-pattern" id="tri2-grid" x="0" y="0" width="43.30127018922193" height="25" patternUnits="userSpaceOnUse"><g opacity="0.2"><line x1="0" y1="0" x2="0" y2="25"></line><line x1="21.650635094610966" y1="0" x2="21.650635094610966" y2="25"></line><line x1="43.30127018922193" y1="0" x2="43.30127018922193" y2="25"></line><line x1="0" y1="0" x2="43.30127018922193" y2="25"></line><line x1="0" y1="25" x2="43.30127018922193" y2="0"></line></g></pattern><pattern class="grid-pattern" id="square-checked" x="0" y="0" width="50" height="50" patternUnits="userSpaceOnUse"><rect class="filled" x="0" y="0" width="25" height="25" opacity="0.2"></rect><rect class="filled" x="25" y="25" width="25" height="25" opacity="0.2"></rect></pattern><pattern class="grid-pattern" id="rainbow-grid" x="0" y="0" width="100" height="100" patternUnits="userSpaceOnUse"><g opacity="0.2"><line x1="10" y1="-10" x2="-110" y2="110" style="stroke:#cd0e66" stroke-width="17.677669529663685"></line><line x1="35" y1="-10" x2="-85" y2="110" style="stroke:#fd8c00" stroke-width="17.677669529663685"></line><line x1="60" y1="-10" x2="-60" y2="110" style="stroke:#22ab24" stroke-width="17.677669529663685"></line><line x1="85" y1="-10" x2="-35" y2="110" style="stroke:#0f82f2" stroke-width="17.677669529663685"></line><line x1="110" y1="-10" x2="-10" y2="110" style="stroke:#cd0e66" stroke-width="17.677669529663685"></line><line x1="135" y1="-10" x2="15" y2="110" style="stroke:#fd8c00" stroke-width="17.677669529663685"></line><line x1="160" y1="-10" x2="40" y2="110" style="stroke:#22ab24" stroke-width="17.677669529663685"></line><line x1="185" y1="-10" x2="65" y2="110" style="stroke:#0f82f2" stroke-width="17.677669529663685"></line><line x1="210" y1="-10" x2="90" y2="110" style="stroke:#cd0e66" stroke-width="17.677669529663685"></line></g></pattern><marker id="axis-arrow" refX="3" refY="3" markerWidth="6" markerHeight="6" orient="auto"><path d="M 0 0 L 6 3 L 0 6 z"></path></marker><radialGradient id="sphere-gradient" cx="65%" cy="35%" r="65%"><stop offset="0" stop-color="white" stop-opacity="0.3"></stop><stop offset="0.32" stop-color="white" stop-opacity="0"></stop><stop offset="0.33" stop-opacity="0"></stop><stop offset="1" stop-opacity="0.2"></stop></radialGradient><linearGradient id="card-gradient"><stop offset="0" stop-color="#999"></stop><stop offset="0.08" stop-color="#bbb"></stop><stop offset="0.92" stop-color="#bbb"></stop><stop offset="1" stop-color="#999"></stop></linearGradient><filter id="handdrawn" x="-20%" y="-20%" width="140%" height="140%"><feTurbulence type="fractalNoise" basefrequency="0.004 0.004" numoctaves="26" stitchtiles="stitch" result="turbulence"></feTurbulence><feDisplacementMap in="SourceGraphic" in2="turbulence" scale="20" xchannelselector="R" ychannelselector="G" result="displacementMap"></feDisplacementMap></filter><filter id="pencil" x="-10%" y="-10%" width="110%" height="110%" filterUnits="objectBoundingBox"><feTurbulence type="fractalNoise" baseFrequency="1.2" numOctaves="3" result="noise"></feTurbulence><feDisplacementMap xChannelSelector="R" yChannelSelector="G" scale="2" in="SourceGraphic" result="newSource"></feDisplacementMap></filter><symbol id="suit-c" viewBox="-12 -12 24 24" width="24" height="24" x="-12" y="-12"><path d="m0-10c2.3.1 4.2 1.9 4.3 4.2 0 1.6-.9 3-2.3 3.8.8-.3 1.6-.5 2.5-.5 2.4-.1 4.4 1.7 4.5 4.1v.2c0 2.3-1.9 4.2-4.2 4.2-.1 0-.2 0-.3 0-1.2-.1-2.4-.4-3.5-1 0 0-.3 2 2 5h-6c2.3-3 2-5 2-5-1.1.6-2.3.9-3.5 1-2.3.2-4.3-1.6-4.5-3.9 0-.1 0-.2 0-.3 0-2.4 1.9-4.3 4.3-4.3h.2c.9 0 1.7.2 2.5.5-1.4-.8-2.3-2.2-2.3-3.8.1-2.3 2-4.1 4.3-4.2z"></path></symbol><symbol id="suit-s" viewBox="-12 -12 24 24" width="24" height="24" x="-12" y="-12"><path d="m0-10c-3 5-8 7-8 12 .1 2.1 1.9 3.9 4 4 1.1.1 2.2-.2 3-1 0 0 .3 2-2 5h6c-2-3-2-5-2-5 .8.8 1.9 1.1 3 1 2.1-.1 3.9-1.9 4-4 0-5-5-7-8-12z"></path></symbol><symbol id="suit-h" viewBox="-12 -12 24 24" width="24" height="24" x="-12" y="-12"><path d="m0 8.5-1.3-1.3c-4.6-4.1-7.7-6.9-7.7-10.3-.1-2.7 2.1-4.9 4.8-5h.2c1.5 0 3.1.7 4 1.9 1-1.2 2.5-1.9 4-1.9 2.8-.1 4.9 2.1 5 4.8v.2c0 3.4-3.1 6.2-7.7 10.3z"></path></symbol><symbol id="suit-d" viewBox="-12 -12 24 24" width="24" height="24" x="-12" y="-12"><path d="m7 0-7 10-7-10 7-10"></path></symbol><pattern id="card-bg" width="6" height="8" patternUnits="userSpaceOnUse"><rect width="6" height="8" fill="#0f82f2"></rect><line x2="6" y2="8" stroke="#eee" stroke-width="1"></line><line x1="6" y2="8" stroke="#eee" stroke-width="1"></line></pattern></defs><rect class="grid"></rect><path class="group-shadow"></path><g class="tiles"></g><g class="tiles"></g><g class="tiles"></g><g class="tiles"></g><g class="strokes"></g><g class="geo-shadows"></g><g class="geo-paths"></g><g class="geo-points"></g><g class="tiles"></g><g class="tiles"></g><rect class="selection"></rect><g class="transform-tools" hidden><path class="group-outline"></path><line class="rotate-bar"></line><circle class="rotate-circle" r="10"></circle></g><g class="cables"></g></svg><div class="html-overlay"></div><div class="panels"></div><slot></slot>';var Se="https://static.mathigon.org/polypad/audio",Iu={roll:new ae(`${Se}/roll.mp3`,.6),spin:new ae(`${Se}/spin.mp3`,.5),coinToss:new ae(`${Se}/coin-toss.mp3`,.3),shuffle:new ae(`${Se}/shuffle.mp3`,.3),draw:new ae(`${Se}/card-draw.mp3`,.2),click:new ae(`${Se}/click.mp3`,.3),woosh:new ae(`${Se}/woosh.mp3`,.2),rise:new ae(`${Se}/rise.mp3`,.3),fall:new ae(`${Se}/fall.mp3`,.3)};var Va=3,A0=new Vt(-2e3,4e3,-2e3,4e3),Me=25,ka=Me*Math.sqrt(3)/2,nr=i=>`${i.xMin} ${i.yMin} ${i.dx} ${i.dy}`,Oa=i=>!!i.name,La=class extends yt{constructor(){super(...arguments);this.tiles=new Map;this.strokes=new Map;this.mathContext=new ra;this.penColour="#242436";this.initial={};this.intersections=new Set;this.margins=[20,20,20,20];this.tools={move:new Sa(this),pen:new ir(this),geo:new sr(this),geoPending:new Ea(this),eraser:new Ma(this),text:new Pa(this),pan:new Ca(this),cutPolygon:new Aa(this)};this.activeTool=this.tools.move;this.origin=y;this.zoom=1;this.newTileShift=0;this.options=ke({grid:"none",changeCount:0,labelType:"fraction"});this.canPinchPan=!1;this.setup=!1;this.undoStack=[];this.redoStack=[]}ready(){this.$svg=this.$("svg.canvas"),this.$tiles=this.$svg.$$(".tiles"),this.$cables=this.$svg.$(".cables"),this.$selection=this.$svg.$(".selection"),this.$strokes=this.$svg.$(".strokes"),this.$grid=this.$svg.$(".grid"),this.$html=this.$(".html-overlay"),this.$panels=this.$(".panels"),this.$geoShadows=this.$svg.$(".geo-shadows"),this.$geoPaths=this.$svg.$(".geo-paths"),this.$geoPoints=this.$svg.$(".geo-points"),this.$pendingPoint=c("circle",{class:"geo-point pending",hidden:!0},this.$geoPoints),this.setAttr("data-tool","move"),this.events=new $a(this.$svg,{down:s=>this.activeTool.down(s),start:s=>this.activeTool.start(s),move:s=>this.activeTool.move(s),end:s=>this.activeTool.end(s),click:s=>this.activeTool.click(s),hover:s=>this.activeTool.hover(s),cursor:!1});let t=this.options;this.$svg.copy=function(s=!0,n=!0,r){let o=cn.prototype.copy.call(this,s,n,r);if(t.canEditQuestions)for(let a of o.$$(".problem-text"))a.text="?";return o},this.selection=new Ta(this),this.warningBanner=new Hr(this),this.isTeacher=this.attr("user-type")==="teacher",this.options.canEditQuestions=this.isTeacher,this.options.canRotate=os(this,"rotate",!0),this.options.canDelete=os(this,"delete",!0),this.options.canCopy=os(this,"copy",!0),this.options.grid=this.attr("grid")||"none",this.setViewport(y,1),this.options.watch(s=>{this.$grid.setAttr("fill",s.grid!=="none"?`url(#${s.grid})`:"none"),this.$grid.setRect(this.canvasBounds.rect)}),os(this,"pan",!1)&&this.enablePinchPan(),this.$svg.on("contextmenu",s=>{this.options.focussed||s.preventDefault()});let e=!1;this.$svg.on("focusin",()=>{if(!e)return;let s=Array.from(this.tiles.values());this.focusTile(this.events.shiftKey?I(s):s[0])}),this.$svg.on("focusout",()=>this.focussed=void 0),X.on("keydown",s=>{if(e=!0,s.keyCode!==9||!this.focussed)return;let n=Array.from(this.tiles.values());this.focusTile(n[n.indexOf(this.focussed)+(s.shiftKey?-1:1)]),this.focussed&&s.preventDefault()}),X.on("pointerdown",()=>e=!1),E.onThemeChange(()=>{for(let s of this.tiles.values())s.colour&&s.setColour(s.colour,"theme");for(let s of this.strokes.values())s.setColor(s.color)})}playSound(t){this.options.playAudio&&Iu[t].play()}focusTile(t){this.options.focussed||(this.focussed=t,this.$svg.setAttr("aria-description",t?t.ariaDescription:"Empty Canvas"),t&&this.selection.add(t,!0))}*snapPoints(t,e,s){if(!s){for(let n of lt.tiles)if(!(t&&n.isActive||e&&n.locked||n.pending))for(let r of n.snapPoints)yield[r,{tile:n}]}for(let n of this.tiles.values())if(!(t&&n.isActive||e&&n.locked||n.pending||s&&n.type!==s))for(let r of n.snapPoints)yield[r,{tile:n}];for(let n of this.strokes.values())if(!!n.snapPoints)for(let r of n.snapPoints)yield[r,{stroke:n}];for(let n of this.intersections)yield[n.value,{intersection:n}]}*gridPoints(t){if(this.options.grid==="none")return;let e=this.options.grid.split("-")[0],s=$.aroundPoints(t),n=new Vt(s.p.x-Me,s.p.x+s.w+2*Me,s.p.y-Me,s.p.y+s.h+2*Me);if(e.startsWith("square")){let r=(e==="square2"?2:1)*Me,o=K(n.xMin,r);for(let a=K(n.yMin,r);a<n.yMax;a+=r)for(let l=o;l<n.xMax;l+=r)yield[new u(l,a),{}]}else if(e.startsWith("tri")){let r=e==="tri2";r&&(n=n.flip);let o=K(n.xMin,Me);for(let a=Math.floor(n.yMin/ka);a*ka<n.yMax;++a)for(let l=o+(a%2?Me/2:0);l<n.xMax;l+=Me){let h=new u(l,a*ka);yield[r?h.flip:h,{}]}}}*snapLines(t,e,s){for(let n of this.tiles.values())if(!(t&&n.isActive||e&&n.locked||n.pending||s&&n.type!==s))for(let r of n.snapLines)yield[r,{tile:n}];for(let n of this.strokes.values())if(!!n.snapLines)for(let r of n.snapLines)yield[r,{stroke:n}]}snap(t,e=!0,s=!1,n=!1,r){return mn(8,t,this.snapPoints(e,n,r))||!s&&mn(18,t,this.gridPoints(t))||mn(6,t,this.snapLines(e,n,r),(o,a)=>o.project(a))}getTileAt(t,e){var s;for(let n of this.tiles.values())if(!(e&&!e.includes(n.type))&&!!n.transformed&&!(!re(n.transformed)&&!st(n.transformed)&&!ye(n.transformed))&&((s=n.transformed)==null?void 0:s.contains(t)))return n}getInputAt(t,e){var s;return(s=this.getTileAt(t))==null?void 0:s.getPortAt(t,e)}enablePinchPan(){this.canPinchPan=!0,this.on("wheel",s=>{if(s.preventDefault(),s.ctrlKey){let n=this.zoom*(1-s.deltaY/100);this.setViewport(this.origin,n,Qt(s,this.$svg))}else{let n=this.origin.shift(s.deltaX/this.zoom,s.deltaY/this.zoom);this.setViewport(n,this.zoom)}});let t=0,e=this.origin;this.on("gesturestart",s=>{s.preventDefault(),e=new u(s.pageX,s.pageY).subtract(this.origin),t=this.zoom,this.events.cancel()}),this.on("gesturechange",s=>{s.preventDefault();let n=t*s.scale,r=new u(s.pageX,s.pageY).subtract(e);this.setViewport(r,n,Qt(s,this.$svg))}),this.on("gestureend",s=>s.preventDefault())}enableImageDrop(t,e){let s=c("div",{class:"image-drop"},this);this.imageUploadCallback=t,this.on("dragenter dragover dragleave drop",r=>r.preventDefault()),this.on("dragenter dragover",()=>s.show()),this.on("dragleave drop",()=>s.hide());let n=(r,o)=>O(this,null,function*(){let l=Array.from((r==null?void 0:r.files)||[]).slice(0,10).map((d,p)=>this.newImage(d,o.shift(p*25),t)),h=yield Promise.all(l);this.change({added:h}),this.trigger("paste")});this.on("drop",r=>n(r.dataTransfer,Qt(r,this.$svg))),e==null||e.on("change",()=>O(this,null,function*(){yield n(e._el,this.canvasBounds.center),e.value=""}))}bindSettingsPanel(t,e,s){let n=c("div",{class:"polypad-settings",html:e},this.$panels);this.on("change-selection",({tiles:o})=>{n.toggle(o.length===1&&o[0]===t)});let r=ke(s);return n.bindModel(r),r}enableHotkeys(){E.onKey("backspace",()=>this.selection.delete()),E.onKey("z",t=>{(t.ctrlKey||t.metaKey)&&(t.preventDefault(),t.shiftKey?this.redo():this.undo())}),E.onKey("y",t=>{(t.ctrlKey||t.metaKey)&&(t.preventDefault(),this.redo())}),E.onKey("c",t=>{var e;t.ctrlKey||t.metaKey||((e=E.getActiveInput())==null?void 0:e.is("input, textarea, [contenteditable]"))||this.selection.copy()}),X.on("cut copy",t=>{var s,n;if(!this.selection.tiles.size||((s=E.getActiveInput())==null?void 0:s.is("input, textarea, [contenteditable]")))return;let e=Array.from(this.selection.tiles).map(r=>r.serialize());(n=window.navigator.clipboard)==null||n.writeText(JSON.stringify(e)),t.type==="cut"&&this.selection.delete()}),X.on("paste",t=>O(this,null,function*(){var n,r;if((n=E.getActiveInput())==null?void 0:n.is("input, textarea, [contenteditable]"))return;let e=dh(t.clipboardData);if(e&&this.imageUploadCallback){let o=yield this.newImage(e,this.center.shift(-50),this.imageUploadCallback);return this.trigger("paste"),this.change({added:[o]})}let s=yield(r=window.navigator.clipboard)==null?void 0:r.readText();if(!!s){try{let o=JSON.parse(s);if(!o.length)return;let a=new Map,l=o.map(p=>{let m=S.unSerialize(p,this,!0);return m&&a.set(p.id,m.id),m}).filter(p=>p);for(let p of o)for(let m of p.cables||[])Ot.unSerialize(a.get(p.id),{fromPort:m.fromPort,toPort:m.toPort,toTileId:a.get(m.toTileId)},this);this.selection.clear();let h=Oe(...l.map(p=>p.transformed)).center,d=this.center.subtract(h).shift(this.newTileShift*25);for(let p of l)p.setTransform(p.posn.add(d)),this.selection.add(p);this.change({added:l}),this.newTileShift+=1}catch(a){let o=this.newTile("text",s);o.setTransform(this.canvasBounds.center.subtract(o.center)),this.selection.add(o,!0),this.change({added:[o]})}this.trigger("paste")}}))}newImage(t,e,s){return O(this,null,function*(){let n=new FileReader;n.readAsDataURL(t),yield new Promise(o=>n.onloadend=o);let r=this.newTile("image",(n.result||"").toString());return r.setTransform(e),this.selection.add(r,!0),yield s==null?void 0:s(t,r),r})}newTile(t,e,s){return new(fi(t))(e,this,s)}setViewport(t,e=1,s){if(e=T(e,1/Va,Va),s){let a=this.zoom/e;t=s.subtract(s.subtract(this.origin).scale(a))}let n=this.width/e,r=this.height/e;this.zoom=e,this.origin=t.clamp(A0.resize(-n,-r)),this.canvasBounds=new Vt(this.origin.x,this.origin.x+n,this.origin.y,this.origin.y+r),this.$svg.setAttr("viewBox",this.attr("viewBox")||nr(this.canvasBounds)),this.$html.setTransform(this.origin.inverse.scale(this.zoom),0,this.zoom);let o=this.canvasBounds.rect;this.options.grid!=="none"&&this.$grid.setRect(o),lt.redrawLines(o),this.newTileShift=0}resetViewport(){if(!this.tiles.size&&!this.strokes.size)return this.setViewport(y,1);let t=gn(this.tiles,this.strokes,0),[e,s,n,r]=this.margins,o=(this.width-r-s)/t.dx,a=(this.height-e-n)/t.dy,l=T(Math.min(o,a),1/Va,1),h=new u(this.width+r-s,this.height+e-n),d=t.center.subtract(h.scale(1/2/l));this.setViewport(d,l)}bindSource(t,e,s,n,r){fi(e).makeThumbnail(s,t,this,r);let o,a=n==null?void 0:n.$(".tiles"),l=+t.attr("data-rot")||0;this.events.listen(t,{down:()=>this.trigger("add-tile-start"),start:({posn:h})=>{o=this.newTile(e,t.data.options||s),r&&o.setColour(r),o.setTransform(h,l),this.selection.add(o,!0),this.selection.moveStart(),n&&n.setAttr("viewBox",nr(this.canvasBounds)),(a||o.$container).append(o.$el),this.trigger("add-tile",{tile:o})},move:h=>this.selection.move(h),end:()=>{o.$container.append(o.$el),this.selection.moveEnd(!0)},click:()=>{let h=this.newTile(e,t.data.options||s);h.setTransform(this.center.subtract(h.center).shift(this.newTileShift*25)),r&&h.setColour(r),this.selection.add(h,!0),h.moveEnd(),this.trigger("add-tile",{tile:h}),this.change({added:[h]}),this.newTileShift+=1}})}get center(){let[t,e,s,n]=this.margins;return this.canvasBounds.center.shift((n-e)/this.zoom/2,(t-s)/this.zoom/2)}setActiveTool(t,e){this.activeTool.cancel(),this.activeTool=this.tools[t],e&&(this.activeTool.options=e),this.setAttr("data-tool",t),this.warningBanner.hide(),this.selection.clear()}clear(t=!0){this.selection.clear();let e=[...Array.from(this.tiles.values()),...Array.from(this.strokes.values())];for(let s of e)s.delete();t&&this.setViewport(y,1),e.length&&this.change({deleted:e})}thumbnail(t,e){let s=gn(this.tiles,this.strokes,50);return this.$svg.pngImage(t,e,nr(s))}downloadImage(t){var n;this.selection.clear();let e=t||((n=this.options.title)==null?void 0:n.replace(/\s/g,"-").replace(/[^\w-]/g,"").toLowerCase())||"polypad",s=gn(this.tiles,this.strokes,50);this.$svg.downloadImage(`${e}.png`,"png",s.dx,s.dy,nr(s))}unlockAll(){let t=[];for(let e of this.tiles.values())!e.locked&&!e.hidden||(e.lock(!1),e.hide(!1),t.push(e));this.change({changed:t})}check(t){let e=!1;return new Promise(s=>{this.on("change",()=>{!e&&t(Array.from(this.tiles.values()))&&(e=!0,s())})})}change(t){var e,s,n;this.setup||(this.trigger("change",{action:"change",data:t}),this.undoStack.push({added:(e=t.added)==null?void 0:e.map(r=>r.serialize()),changed:(s=t.changed)==null?void 0:s.map(r=>[r.lastSavedData,r.serialize()]),deleted:(n=t.deleted)==null?void 0:n.map(r=>r.lastSavedData)}),this.undoStack.length>50&&this.undoStack.shift(),this.redoStack=[],this.options.canUndo=!0,this.options.canRedo=!1,this.options.changeCount+=1)}undo(){!this.undoStack.length||(this.applyChange(I(this.undoStack),!0),this.redoStack.push(this.undoStack.pop()),this.options.canUndo=!!this.undoStack.length,this.options.canRedo=!0,this.options.changeCount-=1,this.selection.update(),this.trigger("change",{action:"undo"}))}redo(){!this.redoStack.length||(this.applyChange(I(this.redoStack)),this.undoStack.push(this.redoStack.pop()),this.options.canUndo=!0,this.options.canRedo=!!this.redoStack.length,this.options.changeCount+=1,this.selection.update(),this.trigger("change",{action:"redo"}))}applyChange(t,e=!1){var s,n;for(let r of(e?t.deleted:t.added)||[])(Oa(r)?S:pe).unSerialize(r,this);for(let r of(e?t.added:t.deleted)||[])(s=(Oa(r)?this.tiles:this.strokes).get(r.id))==null||s.delete();for(let[r,o]of t.changed||[])(n=this.tiles.get(r.id))==null||n.applyChange(e?r:o);for(let r of(e?t.deleted:t.added)||[])if(Oa(r)&&r.cables)for(let o of r.cables)Ot.unSerialize(r.id,o,this)}serialize(t=2e3,e=1e3,s=16e3){var n;return{title:(n=this.options.title)==null?void 0:n.slice(0,30),grid:this.options.grid||"none",noLabels:this.options.noLabels,altColors:this.options.altColors,mergeTiles:this.options.mergeTiles,evalEquations:this.options.evalEquations,labelType:this.options.labelType,tiles:Array.from(this.tiles.values()).slice(0,t).map(r=>r.serialize()),strokes:Array.from(this.strokes.values()).slice(0,e).map(r=>r.serialize(s))}}unSerialize(t){if(!!t){this.setup=!0,this.clear(!1),lt.clearModel();for(let e of t.tiles||[])S.unSerialize(e,this);for(let e of t.strokes||[])pe.unSerialize(e,this);for(let e of t.tiles||[])for(let s of e.cables||[])Ot.unSerialize(e.id,s,this);lt.computeIntersections(this);for(let e of this.tiles.values())e.move();this.setup=!1}}load(t){var e,s,n,r,o;this.initial=t,this.options.canEditQuestions=this.isTeacher&&((e=t.canEdit)!=null?e:!0),this.unSerialize(t),this.undoStack=this.redoStack=[],this.options.assign({title:t.title,grid:t.grid||"none",canUndo:!1,changeCount:0,noLabels:(s=t.noLabels)!=null?s:this.options.noLabels,altColors:(n=t.altColors)!=null?n:this.options.altColors,mergeTiles:(r=t.mergeTiles)!=null?r:this.options.mergeTiles,evalEquations:(o=t.evalEquations)!=null?o:this.options.evalEquations,labelType:t.labelType||this.options.labelType}),this.resetViewport()}};La=Ee([vt("x-polypad",{template:Lu})],La);var Ru='<x-select><button class="switch" data-value="palette" title="Colour Swatches"><x-icon name="tiles" size="32"></x-icon></button><button class="switch" data-value="sliders" title="RGB Sliders"><x-icon name="controls" size="32"></x-icon></button></x-select><div class="color-content"><div class="palette"></div><div class="sliders"><div class="slider-row"><label>R</label><div class="slider"><div class="handle"></div></div><input class="input-field" type="number" name="Red"></div><div class="slider-row"><label>G</label><div class="slider"><div class="handle"></div></div><input class="input-field" type="number" name="Green"></div><div class="slider-row"><label>B</label><div class="slider"><div class="handle"></div></div><input class="input-field" type="number" name="Blue"></div><div class="slider-row"><label>A</label><div class="slider"><div class="handle"></div></div><input class="input-field" type="number" name="Alpha"></div></div></div>';var Ia=["#fd8c00","#eb4726","#cd0e66","#6d3bbf","#0f82f2","#009ea6","#22ab24","#bfc212"],gi=[];for(let i of Ia)gi.push(V.mix(i,"#fff",.5));gi.push(V.fromHex("#eee"));for(let i of Ia)gi.push(V.fromHex(i));gi.push(V.fromHex("#777"));for(let i of Ia)gi.push(V.mix(i,"#000",.7));gi.push(V.fromHex("#111"));function Ra(i,t,e,s,n,r){return`linear-gradient(90deg, rgb(${i},${t},${e}), rgb(${s},${n},${r}))`}function V0(i,t,e){t==="r"&&(i.r=e),t==="g"&&(i.g=e),t==="b"&&(i.b=e),t==="a"&&(i.a=e/255)}function k0(i,t){return t==="r"?i.r:t==="g"?i.g:t==="b"?i.b:i.a*255}var Da=class extends yt{constructor(){super(...arguments);this.sliders=[];this.swatches=[]}ready(){this.$("x-select").on("change",s=>{s.data.value==="palette"?this.removeClass("custom"):this.addClass("custom")});let e=this.$(".palette");this.swatches=gi.map(s=>{let n=c("button",{style:`background: ${s.hex}`},e);return n.on("click",()=>{this.setColor(s),this.trigger("click-swatch"),this.commit()}),{$el:n,color:s}}),this.$inputs=this.$$("input");for(let s of this.$inputs)s.change(()=>this.setColor(this.inputColor)),s.on("change",n=>n.stopPropagation()),s.on("blur",()=>this.commit()),s.onKeyDown("enter",()=>s.blur());this.sliders=this.$$(".slider").map((s,n)=>{let r=["r","g","b","a"][n],o=s.$(".handle"),a=new oh(o,{moveY:!1,bounds:new Vt(0,180,0,0)});return a.on("start",()=>{for(let l of this.$inputs)l.blur();o.addClass("active")}),a.on("drag",({posn:l})=>{let h=this.color.copy();V0(h,r,l.x*255/180),this.setColor(h,!0)}),a.on("end",()=>{o.removeClass("active"),this.commit()}),{$el:s,c:r,drag:a}}),this.setColor(new V(0,0,0))}commit(){this.lastCommittedColor!==this.color&&(this.trigger("commit-color"),this.lastCommittedColor=this.color)}get inputColor(){let[t,e,s]=this.$inputs.map(r=>T(+r.value||0,0,255)),n=T(+this.$inputs[3].value,0,100)/100;return new V(t,e,s,n)}setColor(t,e=!1,s=!1){if(typeof t=="string"&&(t=V.fromHex(t)),!(this.color&&this.color.hex===t.hex)){if(this.color=t,s&&(this.lastCommittedColor=t),this.$activeSwatch&&(this.$activeSwatch.removeClass("active"),this.$activeSwatch=void 0),!e){for(let n of this.swatches)if(n.color.hex===t.hex){n.$el.addClass("active"),this.$activeSwatch=n.$el;break}for(let n of this.sliders)n.drag.setPosition(k0(t,n.c)/255*180,0)}this.$inputs[0].value=""+Math.round(t.r),this.$inputs[1].value=""+Math.round(t.g),this.$inputs[2].value=""+Math.round(t.b),this.$inputs[3].value=""+Math.round(t.a*100),this.sliders[0].$el.css("background",Ra(0,t.g,t.b,255,t.g,t.b)),this.sliders[1].$el.css("background",Ra(t.r,0,t.b,t.r,255,t.b)),this.sliders[2].$el.css("background",Ra(t.r,t.g,0,t.r,t.g,255)),this.sliders[3].$el.css("background",`linear-gradient(90deg, black, rgb(${t.r},${t.g},${t.b}))`),s||this.trigger("change",t)}}};Da=Ee([vt("x-color-picker",{template:Ru})],Da);var O0=Object.defineProperty,L0=Object.getOwnPropertyDescriptor,Ns=(i,t,e,s)=>{for(var n=s>1?void 0:s?L0(t,e):t,r=i.length-1,o;r>=0;r--)(o=i[r])&&(n=(s?o(t,e,n):o(n))||n);return s&&n&&O0(t,e,n),n},Du=(i,t,e)=>new Promise((s,n)=>{var r=l=>{try{a(e.next(l))}catch(h){n(h)}},o=l=>{try{a(e.throw(l))}catch(h){n(h)}},a=l=>l.done?s(l.value):Promise.resolve(l.value).then(r,o);a((e=e.apply(i,t)).next())}),Xi,I0=c("div",{class:"snackbar"},X),Nu=class extends yt{ready(){var i;I0.append(this),(i=this.$("button"))==null||i.on("click",()=>this.close())}open(i=2e3){return Du(this,null,function*(){Xi!==this&&(Xi&&(yield Xi.close()),Xi=this,yield this.enter("pop",300).promise,this.setAttr("role","alert"),i&&setTimeout(()=>this.close(),i))})}close(){return Du(this,null,function*(){Xi===this&&(Xi=void 0,this.removeAttr("role"),yield this.exit("pop",300).promise)})}};Nu=Ns([vt("x-alert")],Nu);var _u=class extends yt{ready(){if(this.children.length)return;let i=+this.attr("size")||24;this.css({width:`${i}px`,height:`${i}px`});let t=c("svg",{viewBox:"0 0 24 24"},this);t.css({width:`${i}px`,height:`${i}px`});let e=c("use",{},t);this.onAttr("name",s=>e.setAttr("href",`/icons.f1c0c95c.svg#${s}`))}};_u=Ns([vt("x-icon")],_u);var wi=c("div",{class:"modal-background"},X),Na,Pe=void 0,_a=void 0;function Ga(){Pe&&Pe.canClose&&Pe.close()}wi.on("click",Ga);E.onKey("escape",Ga);ns.on("change",Ga);wi.on("scrollwheel touchmove",i=>{i.preventDefault(),i.stopPropagation()});E.onKey("space up down pagedown pageup",i=>{Pe&&(i.preventDefault(),i.stopPropagation())});var Gu=class extends yt{constructor(){super(...arguments);this.isOpen=!1,this.canClose=!0}ready(){this.canClose=!this.hasAttr("no-close"),this.$iframe=this.$("iframe[data-src]"),this.$video=this.$("video");let i=he(`[data-modal=${this.id}]`);for(let e of i)e.on("click",()=>this.open());ns.on("afterChange",({$viewport:e})=>{let s=e.$$(`[data-modal=${this.id}]`);for(let n of s)n.on("click",()=>this.open())}),this.hasClass("open")&&!Pe&&this.open(!0),this.$("input")&&this.addClass("interactive");let t=this.$(".close");t&&t.on("click",()=>this.close());for(let e of this.$$(".btn"))e.on("click",()=>this.trigger("btn-click",e))}open(i=!1){if(this.isOpen)return;wi.setClass("light",this.hasClass("light")),Pe?Pe.close(!0):i?wi.show():wi.css("display")==="block"?Na==null||Na.cancel():wi.enter("fade",250),this.isOpen=!0,Pe=this,this.$iframe&&this.$iframe.setAttr("src",this.$iframe.data.src),this.$video&&this.$video.play(),i?this.show():this.enter("pop",250).promise.then(()=>this.css("transform","")),this.setAttr("role","dialog"),this.trigger("open"),_a=document.activeElement;let t=this.$('input, a, button, textarea, [tabindex="0"]');t&&t.focus()}close(i=!1,t=!1){!this.isOpen||(this.isOpen=!1,this.removeAttr("role"),Pe=void 0,this.$iframe&&this.$iframe.setAttr("src",""),this.$video&&this.$video.pause(),i||(Na=wi.exit("fade",250)),this.exit("pop",250).promise.then(()=>this.css("transform","")),t||this.trigger("close"),_a&&_a.focus())}};Gu=Ns([vt("x-modal")],Gu);var Hu=class extends yt{constructor(){super(...arguments);this.isOpen=!1}ready(){this.animation=this.attr("animation")||"pop",this.$bubble=this.$(".popup-body"),this.$bubble.hide(),this.$(".popup-target").on("click",()=>this.toggle()),this.on("clickOutside",()=>this.close());for(let t of this.$bubble.$$("a"))t.on("click",()=>this.close());E.onKey("escape",()=>this.close())}toggle(){this.isOpen?this.close():this.open()}open(){this.isOpen||(this.isOpen=!0,this.addClass("active"),this.$bubble.enter(this.animation,150),this.$bubble.setAttr("role","dialog"),this.$bubble.focus())}close(){!this.isOpen||(this.isOpen=!1,this.removeClass("active"),this.$bubble.exit(this.animation,150),this.$bubble.removeAttr("role"))}};Hu=Ns([vt("x-popup")],Hu);var qu=class extends yt{constructor(){super(...arguments);this.$options={}}ready(){let i=this.children;this.$active=this.$(".active")||i[0],this.$active.addClass("active");for(let[t,e]of i.entries())!J(e.tagName,"A","BUTTON")&&!e.hasAttr("tabindex")&&e.setAttr("tabindex",0),e.on("click",()=>this.makeActive(e)),this.$options[e.attr("value")||t]=e;this.trigger("change",this.$active)}makeActive(i){i!==this.$active&&(this.$active.removeClass("active"),this.$active=i,i.addClass("active"),this.trigger("change",i))}bindVariable(i,t){i[t]===void 0&&(i[t]=this.$active.attr("value")),this.on("change",e=>i[t]=e.attr("value")),i.watch(()=>{let e=this.$options[i[t]];e&&this.makeActive(e)})}};qu=Ns([vt("x-select")],qu);var Ha=12;function R0(i){return`M${i},${i/2}a${i/2},${i/2},0,0,1,0,${i}A${i/2},${i/2},0,0,1,${i},${i/2}`}function D0(i){return`M ${i},0 C ${i/2},0,0,${i/2},0,${i}  s ${i/2},${i},${i},${i} s ${i}-${i/2},${i}-${i}     S ${i*1.5},0,${i},0 z M ${i*44.6/50},${i*76.1/50} L ${i*19.2/50},${i*48.8/50} l ${i*4/50}-${i*4.2/50}     l ${i*19.8/50},${i*11.9/50} l ${i*34.2/50}-${i*32.6/50} l ${i*3.5/50},${i*3.5/50} L ${i*44.6/50},${i*76.1/50} z`}var qa=class extends yt{constructor(){super(...arguments);this.completed=!1}ready(){this.r=+this.attr("r")||10,this.r1=this.r+Ha,this.$svg=c("svg",{width:2*this.r1,height:2*this.r1},this),this.$progress=c("path",{class:"pie",d:R0(this.r),"stroke-width":this.r},this.$svg),this.onAttr("p",t=>this.setProgress(+t,!1))}setProgress(t,e=!0){if(t>.99)return this.complete(e);let s=Math.PI*this.r;this.$progress.css("stroke",t?"currentColor":"none"),this.$progress.css("stroke-dasharray",`${t*s} ${s}`)}complete(t=!0){if(this.completed||(this.completed=!0,this.$progress.css("stroke","none"),this.$progress.css("fill","currentColor"),this.$progress.setAttr("d",D0(this.r)),!t))return;let e=`translate(${this.r1} ${this.r1})`,s=c("g",{transform:e},this.$svg),n=D(()=>c("line",{},s),18);z(r=>{let o=this.r+Ha*Y("quint-out",r),a=this.r+Ha*r;for(let l=0;l<18;++l){let h=Math.cos(Math.PI*2*l/18),d=Math.sin(Math.PI*2*l/18);n[l].setLine({x:h*o,y:d*o},{x:h*a,y:d*a})}},800).promise.then(()=>s.remove())}};qa=Ee([vt("x-progress")],qa);var zu="2.4.1",za="i5iSjo",Bu="_av",Ba="_au",Fa="(not set)";var rr=[],or=class{static add(t,e,s){Fu(t,e).add(s)}static remove(t,e,s){Fu(t,e).remove(s)}constructor(t,e){this.context=t,this.methodName=e,this.isTask=/Task$/.test(e),this.originalMethodReference=this.isTask?t.get(e):t[e],this.methodChain=[],this.boundMethodChain=[],this.wrappedMethod=(...s)=>this.boundMethodChain[this.boundMethodChain.length-1](...s),this.isTask?t.set(e,this.wrappedMethod):t[e]=this.wrappedMethod}add(t){this.methodChain.push(t),this.rebindMethodChain()}remove(t){let e=this.methodChain.indexOf(t);e>-1&&(this.methodChain.splice(e,1),this.methodChain.length>0?this.rebindMethodChain():this.destroy())}rebindMethodChain(){this.boundMethodChain=[];for(let t,e=0;t=this.methodChain[e];e++){let s=this.boundMethodChain[e-1]||this.originalMethodReference.bind(this.context);this.boundMethodChain.push(t(s))}}destroy(){let t=rr.indexOf(this);t>-1&&(rr.splice(t,1),this.isTask?this.context.set(this.methodName,this.originalMethodReference):this.context[this.methodName]=this.originalMethodReference)}},Ce=or;function Fu(i,t){let e=rr.filter(s=>s.context==i&&s.methodName==t)[0];return e||(e=new or(i,t),rr.push(e)),e}var Yi=window.Element.prototype,qP=Yi.matches||Yi.matchesSelector||Yi.webkitMatchesSelector||Yi.mozMatchesSelector||Yi.msMatchesSelector||Yi.oMatchesSelector;var G0="80",H0="443",JP=RegExp(":("+G0+"|"+H0+")$"),QP=document.createElement("a");function ar(i,t,e=void 0,s=void 0,n=void 0,r=void 0){if(typeof s=="function"){let o=e.get("buildHitTask");return{buildHitTask:a=>{a.set(i,null,!0),a.set(t,null,!0),s(a,n,r),o(a)}}}else return Ge({},i,t)}var Za={};function Uu(i,t){let e=i.get("trackingId"),s=Za[e]=Za[e]||{},n=()=>{clearTimeout(s.timeout),s.send&&Ce.remove(i,"send",s.send),delete Za[e],s.queue.forEach(r=>r())};clearTimeout(s.timeout),s.timeout=setTimeout(n,0),s.queue=s.queue||[],s.queue.push(t),s.send||(s.send=r=>(...o)=>{n(),r(...o)},Ce.add(i,"send",s.send))}var Ge=Object.assign||function(i,...t){for(let e=0,s=t.length;e<s;e++){let n=Object(t[e]);for(let r in n)Object.prototype.hasOwnProperty.call(n,r)&&(i[r]=n[r])}return i};function ju(i){return i.charAt(0).toUpperCase()+i.slice(1)}function Wu(i){return typeof i=="object"&&i!==null}function He(){return+new Date}var _s=function i(t){return t?(t^Math.random()*16>>t/4).toString(16):([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,i)};function Ua(i,t){let e=window.GoogleAnalyticsObject||"ga";window[e]=window[e]||function(...s){(window[e].q=window[e].q||[]).push(s)},window.gaDevIds=window.gaDevIds||[],window.gaDevIds.indexOf(za)<0&&window.gaDevIds.push(za),window[e]("provide",i,t),window.gaplugins=window.gaplugins||{},window.gaplugins[ju(i)]=t}var ja=class{constructor(){this.registry_={}}on(t,e){this.getRegistry_(t).push(e)}off(t=void 0,e=void 0){if(t&&e){let s=this.getRegistry_(t),n=s.indexOf(e);n>-1&&s.splice(n,1)}else this.registry_={}}emit(t,...e){this.getRegistry_(t).forEach(s=>s(...e))}getEventCount(){let t=0;return Object.keys(this.registry_).forEach(e=>{t+=this.getRegistry_(e).length}),t}getRegistry_(t){return this.registry_[t]=this.registry_[t]||[]}},Ku=ja;var lr="autotrack",Ji={},Wa=!1,Gs,se=class extends Ku{static getOrCreate(t,e,s){let n=[lr,t,e].join(":");return Ji[n]||(Ji[n]=new se(n,s),Wa||z0()),Ji[n]}static isSupported_(){if(Gs!=null)return Gs;try{window.localStorage.setItem(lr,lr),window.localStorage.removeItem(lr),Gs=!0}catch(t){Gs=!1}return Gs}static get_(t){return window.localStorage.getItem(t)}static set_(t,e){window.localStorage.setItem(t,e)}static clear_(t){window.localStorage.removeItem(t)}constructor(t,e={}){super();this.key_=t,this.defaults_=e,this.cache_=null}get(){if(this.cache_)return this.cache_;if(se.isSupported_())try{this.cache_=Ka(se.get_(this.key_))}catch(t){}return this.cache_=Ge({},this.defaults_,this.cache_)}set(t){if(this.cache_=Ge({},this.defaults_,this.cache_,t),se.isSupported_())try{se.set_(this.key_,JSON.stringify(this.cache_))}catch(e){}}clear(){if(this.cache_={},se.isSupported_())try{se.clear_(this.key_)}catch(t){}}destroy(){delete Ji[this.key_],Object.keys(Ji).length||B0()}},hr=se;function z0(){window.addEventListener("storage",Xu),Wa=!0}function B0(){window.removeEventListener("storage",Xu),Wa=!1}function Xu(i){let t=Ji[i.key];if(t){let e=Ge({},t.defaults_,Ka(i.oldValue)),s=Ge({},t.defaults_,Ka(i.newValue));t.cache_=s,t.emit("externalSet",s,e)}}function Ka(i){let t={};if(i)try{t=JSON.parse(i)}catch(e){}return t}var F0=1e3,Z0=60*F0,cr={},yi=class{static getOrCreate(t,e,s){let n=t.get("trackingId");return cr[n]?cr[n]:cr[n]=new yi(t,e,s)}constructor(t,e,s){this.tracker=t,this.timeout=e||yi.DEFAULT_TIMEOUT,this.timeZone=s,this.sendHitTaskOverride=this.sendHitTaskOverride.bind(this),Ce.add(t,"sendHitTask",this.sendHitTaskOverride);try{this.dateTimeFormatter=new Intl.DateTimeFormat("en-US",{timeZone:this.timeZone})}catch(r){}let n={hitTime:0,isExpired:!1};this.store=hr.getOrCreate(t.get("trackingId"),"session",n),this.store.get().id||this.store.set({id:_s()})}getId(){return this.store.get().id}isExpired(t=this.getId()){if(t!=this.getId())return!0;let e=this.store.get();if(e.isExpired)return!0;let s=e.hitTime;if(s){let n=new Date,r=new Date(s);if(n-r>this.timeout*Z0||this.datesAreDifferentInTimezone(n,r))return!0}return!1}datesAreDifferentInTimezone(t,e){return this.dateTimeFormatter?this.dateTimeFormatter.format(t)!=this.dateTimeFormatter.format(e):!1}sendHitTaskOverride(t){return e=>{t(e);let s=e.get("sessionControl"),n=s=="start"||this.isExpired(),r=s=="end",o=this.store.get();o.hitTime=He(),n&&(o.isExpired=!1,o.id=_s()),r&&(o.isExpired=!0),this.store.set(o)}}destroy(){Ce.remove(this.tracker,"sendHitTask",this.sendHitTaskOverride),this.store.destroy(),delete cr[this.tracker.get("trackingId")]}},Xa=yi;yi.DEFAULT_TIMEOUT=30;var Ya={CLEAN_URL_TRACKER:1,EVENT_TRACKER:2,IMPRESSION_TRACKER:3,MEDIA_QUERY_TRACKER:4,OUTBOUND_FORM_TRACKER:5,OUTBOUND_LINK_TRACKER:6,PAGE_VISIBILITY_TRACKER:7,SOCIAL_WIDGET_TRACKER:8,URL_CHANGE_TRACKER:9,MAX_SCROLL_TRACKER:10},Yu=Object.keys(Ya).length;function Ju(i,t){j0(i),U0(i,t)}function W0(i){return parseInt(i||"0",16).toString(2)}function K0(i){return parseInt(i||"0",2).toString(16)}function X0(i,t){if(i.length<t){let e=t-i.length;for(;e;)i="0"+i,e--}return i}function Y0(i,t){return i.substr(0,t)+1+i.substr(t+1)}function U0(i,t){let e=i.get("&"+Ba),s=X0(W0(e),Yu);s=Y0(s,Yu-t),i.set("&"+Ba,K0(s))}function j0(i){i.set("&"+Bu,zu)}var Hs="hidden",ge="visible",Qi=_s(),Qu=1e3,td=class{constructor(t,e){if(Ju(t,Ya.PAGE_VISIBILITY_TRACKER),!document.visibilityState)return;let s={sessionTimeout:Xa.DEFAULT_TIMEOUT,visibleThreshold:5*Qu,sendInitialPageview:!1,fieldsObj:{}};this.opts=Ge(s,e),this.tracker=t,this.lastPageState=document.visibilityState,this.visibleThresholdTimeout_=null,this.isInitialPageviewSent_=!1,this.trackerSetOverride=this.trackerSetOverride.bind(this),this.handleChange=this.handleChange.bind(this),this.handleWindowUnload=this.handleWindowUnload.bind(this),this.handleExternalStoreSet=this.handleExternalStoreSet.bind(this),this.store=hr.getOrCreate(t.get("trackingId"),"plugins/page-visibility-tracker"),this.store.on("externalSet",this.handleExternalStoreSet),this.session=Xa.getOrCreate(t,this.opts.sessionTimeout,this.opts.timeZone),Ce.add(t,"set",this.trackerSetOverride),window.addEventListener("unload",this.handleWindowUnload),document.addEventListener("visibilitychange",this.handleChange),Uu(this.tracker,()=>{document.visibilityState==ge?(this.opts.sendInitialPageview&&(this.sendPageview({isPageLoad:!0}),this.isInitialPageviewSent_=!0),this.store.set({time:He(),state:ge,pageId:Qi,sessionId:this.session.getId()})):this.opts.sendInitialPageview&&this.opts.pageLoadsMetricIndex&&this.sendPageLoad()})}handleChange(){if(!(document.visibilityState==ge||document.visibilityState==Hs))return;let t=this.getAndValidateChangeData(),e={time:He(),state:document.visibilityState,pageId:Qi,sessionId:this.session.getId()};document.visibilityState==ge&&this.opts.sendInitialPageview&&!this.isInitialPageviewSent_&&(this.sendPageview(),this.isInitialPageviewSent_=!0),document.visibilityState==Hs&&this.visibleThresholdTimeout_&&clearTimeout(this.visibleThresholdTimeout_),this.session.isExpired(t.sessionId)?(this.store.clear(),this.lastPageState==Hs&&document.visibilityState==ge&&(clearTimeout(this.visibleThresholdTimeout_),this.visibleThresholdTimeout_=setTimeout(()=>{this.store.set(e),this.sendPageview({hitTime:e.time})},this.opts.visibleThreshold))):(t.pageId==Qi&&t.state==ge&&this.sendPageVisibilityEvent(t),this.store.set(e)),this.lastPageState=document.visibilityState}getAndValidateChangeData(){let t=this.store.get();return this.lastPageState==ge&&t.state==Hs&&t.pageId!=Qi&&(t.state=ge,t.pageId=Qi,this.store.set(t)),t}sendPageVisibilityEvent(t,{hitTime:e}={}){let s=this.getTimeSinceLastStoredChange(t,{hitTime:e});if(s&&s>=this.opts.visibleThreshold){let n=Math.round(s/Qu),r={transport:"beacon",nonInteraction:!0,eventCategory:"Page Visibility",eventAction:"track",eventValue:n,eventLabel:Fa};e&&(r.queueTime=He()-e),this.opts.visibleMetricIndex&&(r["metric"+this.opts.visibleMetricIndex]=n),this.tracker.send("event",ar(r,this.opts.fieldsObj,this.tracker,this.opts.hitFilter))}}sendPageLoad(){let t={transport:"beacon",eventCategory:"Page Visibility",eventAction:"page load",eventLabel:Fa,["metric"+this.opts.pageLoadsMetricIndex]:1,nonInteraction:!0};this.tracker.send("event",ar(t,this.opts.fieldsObj,this.tracker,this.opts.hitFilter))}sendPageview({hitTime:t,isPageLoad:e}={}){let s={transport:"beacon"};t&&(s.queueTime=He()-t),e&&this.opts.pageLoadsMetricIndex&&(s["metric"+this.opts.pageLoadsMetricIndex]=1),this.tracker.send("pageview",ar(s,this.opts.fieldsObj,this.tracker,this.opts.hitFilter))}trackerSetOverride(t){return(e,s)=>{let n=Wu(e)?e:{[e]:s};n.page&&n.page!==this.tracker.get("page")&&this.lastPageState==ge&&this.handleChange(),t(e,s)}}getTimeSinceLastStoredChange(t,{hitTime:e}={}){return t.time?(e||He())-t.time:0}handleExternalStoreSet(t,e){t.time!=e.time&&e.pageId==Qi&&e.state==ge&&!this.session.isExpired(e.sessionId)&&this.sendPageVisibilityEvent(e,{hitTime:t.time})}handleWindowUnload(){this.lastPageState!=Hs&&this.handleChange()}remove(){this.store.destroy(),this.session.destroy(),Ce.remove(this.tracker,"set",this.trackerSetOverride),window.removeEventListener("unload",this.handleWindowUnload),document.removeEventListener("visibilitychange",this.handleChange)}};Ua("pageVisibilityTracker",td);rh();Mt.addClass((E.isMobile?"is":"not")+"-mobile");E.isSafari&&Mt.addClass("is-safari");setTimeout(()=>Mt.addClass("ready"));window.addEventListener("keydown",i=>{i.keyCode===9&&Mt.addClass("is-tabbing")});window.addEventListener("mousedown",()=>{Mt.removeClass("is-tabbing")});var ed=R(".cookie-warning");ed&&R("#yes-to-cookies").on("click",function(){ed.exit("pop",300),E.setCookie("cookie_consent",1)});var Ja=R("x-modal#privacy");Ja&&Ja.$("form").on("submit",i=>{i.preventDefault(),fetch("/profile/accept-policies",{method:"POST"}),Ja.close()});var id;(id=navigator.serviceWorker)==null||id.register("/service_worker.js",{scope:"/"}).catch(()=>console.warn("Unable to register Service Worker."));window.addEventListener("beforeinstallprompt",i=>{i.prompt()});var sd;(sd=R("#skip-nav"))==null||sd.on("click",()=>{var t;(t=(R("article")||R(".panel.active")||R(".body")||X).$("input, button, a, textarea, [contenteditable], [tabindex]"))==null||t.focus()});var Qa=R("nav x-popup");if(Qa){let i=Qa.$$(".popup-body a, .popup-body button");for(let t of i)t.on("click",()=>Qa.close())}var J0=he("#language .locale-link");ns.on("change",i=>{for(let t of J0)t.setAttr("href",t.data.host+i)});var ur=R("#dark-mode");ur&&(ur.checked=E.theme.isDark,ur.on("change",()=>E.setTheme(ur.checked?"dark":"light")));var qs={},vi=R("#search"),qe=vi==null?void 0:vi.$(".form-field input"),dr=vi==null?void 0:vi.$(".search-body");qs[""]=(dr==null?void 0:dr.html)||"";function Q0(i){return i=i.trim().replace(/\s+/," ").toLowerCase().slice(0,50),i==="pi"||i.length>=3?i:""}function tg(i){return O(this,null,function*(){if(i=encodeURIComponent(Q0(i)),i in qs)return qs[i];let t=yield fetch(`/api/search?q=${i}`);return t.ok?qs[i]=yield t.text():qs[i]=""})}var eg=0,nd=0;function rd(i){return O(this,null,function*(){let t=eg+=1,e=yield tg(i);t<=nd||(nd=t,dr.html=e)})}qe==null||qe.change(i=>{E.setCookie("search",i,60*60*24),setTimeout(()=>{qe.value===i&&rd(i)},300)});(qe==null?void 0:qe.value)&&vi.one("open",()=>rd(qe.value));var tl=class extends yt{ready(){let t=Array.from(this._el.children);this.removeChildren();let e=c("svg",{class:"equation"},this),s=c("g",{transform:"translate(2 0)"},e),n=c("div",{class:"overlay"},this),r=parseFloat(this.css("font-size")),o=this.parents(".text-center").length||this.hasClass("display"),a=new ci(s,n,0,"",r,!!o);a.setValue(this.attr("expr")||t),this.css({width:a.root.width+4+"px",height:a.root.height+"px","vertical-align":`-${a.root.height-a.root.baseline}px`})}};tl=Ee([vt("x-math")],tl);window.$=R;window.$$=he;window.Browser=E;var pr=R("x-modal#privacy");pr&&pr.$("form").on("submit",i=>{i.preventDefault();let t=pr.$('input[name="newsletter"]');Lr("/settings/privacy",{policies:"on",newsletter:t.checked?"on":"off"}),pr.close()});var od="";function el(){return fetch("/joke").then(i=>i.text()).then(i=>od=i),od}var il=R(".error-box");il&&il.on("click",()=>il.html=el());el();window.tellMeAJoke=function(){return el().replace(/<p>/g,"").replace(/<\/p>/g,`
`).trim()};console.log(`%cWelcome to Mathigon!
%cYou can see our source code at https://github.com/mathigon
%cIf you want to contribute, visit https://mathigon.io
%cJust here for fun? Run tellMeAJoke()`,"color: #cd0e66; font-weight: bold; font-size: 18px;","color: #0f82f2; font-weight: bold;","color: #22ab24; font-weight: bold;","color: #fd8c00; font-weight: bold;");var ad=[38,38,40,40,37,39,37,39,66,65],zs=0;document.addEventListener("keydown",i=>{i.keyCode===ad[zs]?(zs+=1,zs===ad.length&&(fn(),zs=0)):zs=0});var ig=[[0,2,4,-90],[1,4,2,0],[2,6,4,0],[3,3,7,0],[4,7,2,-90],[5,4,5,0],[6,6,6,90]];E.ready(()=>{let i=R("x-polypad");for(let a of ig)new(fi("tangram"))(""+a[0],i).setTransform(new u((4.9+a[1])*25,(4.9+a[2])*25),a[3]);let t=R(".color-picker");t.$("x-color-picker").on("change",a=>{for(let l of i.selection.tiles)l.setColour(a.hex)});let s=R("#brush");s.on("click",()=>{t.toggleClass("active"),s.toggleClass("active")}),R("#flip").on("click",()=>i.selection.action("tangram","flip"));let n=R(".tangram-background"),r=R(".tangram-footer-tabs"),o;for(let a of he(".tangram-tile")){let l="url("+a.$("img").attr("src")+")";a.on("click",()=>{o&&o.removeClass("active"),o=a,o.addClass("active"),n.css("background-image",l)})}r.on("change",a=>{for(let l of he(".tangram-footer-wrap"))l.data.v===a.data.v?l.show():l.hide()}),R("#save").on("click",()=>i.$svg.downloadImage("tangram.png","png",800))});})();